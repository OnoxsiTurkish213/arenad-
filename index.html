<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no,viewport-fit=cover">
<title>HaxBall Mobile Pro v4</title>
<style>
*{margin:0;padding:0;box-sizing:border-box;-webkit-touch-callout:none;-webkit-user-select:none;user-select:none;-webkit-tap-highlight-color:transparent}
html,body{width:100%;height:100%;overflow:hidden;background:#0a0a1a;font-family:'Segoe UI',Tahoma,sans-serif;touch-action:none;position:fixed;top:0;left:0}
#rotateMsg{position:fixed;top:0;left:0;width:100%;height:100%;background:#0a0a1a;z-index:99999;display:none;align-items:center;justify-content:center;flex-direction:column;color:#fff;gap:12px;font-size:15px}
@media(max-width:640px) and (orientation:portrait){#rotateMsg{display:flex!important}}
.screen{position:absolute;top:0;left:0;width:100%;height:100%;display:none;overflow-y:auto}
#menuScreen{display:flex;flex-direction:column;align-items:center;justify-content:center;background:linear-gradient(145deg,#0b0920,#1a1545,#0d1b3e);z-index:100;padding:12px}
#menuScreen h1{color:#fff;font-size:28px;margin-bottom:3px}
#menuScreen .sub{color:#666;font-size:11px;margin-bottom:20px}
.mbox{background:rgba(255,255,255,.05);border-radius:16px;padding:20px;width:320px;max-width:92vw;border:1px solid rgba(255,255,255,.07)}
.mbox input,.mbox select{width:100%;padding:11px 14px;margin-bottom:9px;border:1px solid rgba(255,255,255,.1);border-radius:9px;background:rgba(255,255,255,.04);color:#fff;font-size:14px;outline:none;-webkit-appearance:none}
.mbox input:focus{border-color:rgba(255,255,255,.3)}
.mbox input::placeholder{color:rgba(255,255,255,.25)}
.mbox select option{background:#151530;color:#fff}
.mbox label{color:#888;font-size:11px;display:block;margin-bottom:4px;margin-top:2px}
.divider{display:flex;align-items:center;margin:12px 0;color:rgba(255,255,255,.18);font-size:11px;gap:8px}
.divider::before,.divider::after{content:'';flex:1;height:1px;background:rgba(255,255,255,.08)}
.btn{padding:11px 18px;border:none;border-radius:9px;font-size:14px;font-weight:600;cursor:pointer;text-align:center;color:#fff;display:inline-block}
.btn:active{transform:scale(.96)}
.btn-full{width:100%;margin-bottom:7px}
.btn-red{background:linear-gradient(135deg,#e74c3c,#b92d2d)}
.btn-blue{background:linear-gradient(135deg,#3498db,#2475a8)}
.btn-green{background:linear-gradient(135deg,#27ae60,#1c8a4a)}
.btn-gray{background:rgba(255,255,255,.08);color:#aaa;border:1px solid rgba(255,255,255,.08)}
.btn-small{padding:7px 14px;font-size:12px;border-radius:7px}
#lobbyScreen{flex-direction:column;align-items:center;background:linear-gradient(145deg,#0b0920,#1a1545,#0d1b3e);z-index:95;padding:14px}
#lobbyScreen h2{color:#fff;font-size:21px;margin-bottom:4px}
.room-code-box{background:rgba(243,156,18,.1);border:1px solid rgba(243,156,18,.2);color:#f39c12;font-size:15px;font-weight:700;padding:5px 16px;border-radius:8px;margin-bottom:4px}
.lobby-map-info{color:#777;font-size:11px;margin-bottom:12px}
.lobby-teams{display:flex;gap:10px;width:96%;max-width:920px;flex-wrap:wrap;justify-content:center}
.team-panel{background:rgba(255,255,255,.03);border-radius:12px;padding:12px;min-width:170px;flex:1;border:1px solid rgba(255,255,255,.05);min-height:110px}
.team-panel h3{text-align:center;margin-bottom:8px;font-size:13px;padding-bottom:6px;border-bottom:1px solid rgba(255,255,255,.06)}
.team-panel.t-red h3{color:#e74c3c}.team-panel.t-blue h3{color:#3498db}.team-panel.t-spec h3{color:#777}
.player-row{display:flex;align-items:center;justify-content:space-between;padding:5px 8px;margin-bottom:4px;border-radius:6px;background:rgba(255,255,255,.03);color:#fff;font-size:12px;gap:4px}
.player-row .p-info{display:flex;align-items:center;gap:5px;flex:1;min-width:0;overflow:hidden}
.player-row .p-name{overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.host-tag{background:#f39c12;color:#000;font-size:8px;padding:1px 4px;border-radius:3px;font-weight:700}
.pos-tag{font-size:8px;padding:1px 5px;border-radius:3px;font-weight:700}
.pos-GK{background:rgba(241,196,15,.2);color:#f1c40f}.pos-DEF{background:rgba(46,204,113,.2);color:#2ecc71}.pos-MID{background:rgba(52,152,219,.2);color:#3498db}.pos-FWD{background:rgba(231,76,60,.2);color:#e74c3c}
.admin-row-btns{display:flex;gap:2px}
.admin-row-btns button{padding:2px 5px;font-size:9px;border:none;border-radius:3px;cursor:pointer;font-weight:600;color:#fff}
.lobby-position-select{margin-top:10px;background:rgba(255,255,255,.03);border:1px solid rgba(255,255,255,.05);border-radius:10px;padding:12px;width:96%;max-width:400px}
.lobby-position-select h4{color:#ccc;font-size:12px;margin-bottom:6px}
.lobby-position-select select{width:100%;padding:9px 12px;border:1px solid rgba(255,255,255,.1);border-radius:7px;background:rgba(255,255,255,.04);color:#fff;font-size:13px;outline:none;-webkit-appearance:none}
.lobby-position-select select option{background:#151530}
.lobby-actions{margin-top:14px;display:flex;gap:7px;flex-wrap:wrap;justify-content:center}
.lobby-actions .btn{padding:9px 20px;font-size:12px}
#gameScreen{z-index:80;background:#1a472a}
#gameCanvas{display:block;width:100%;height:100%;outline:none}
#hud{position:absolute;top:0;left:50%;transform:translateX(-50%);display:flex;z-index:85;pointer-events:none;border-radius:0 0 10px 10px;overflow:hidden;box-shadow:0 2px 12px rgba(0,0,0,.5)}
.hud-score{padding:5px 18px;font-size:26px;font-weight:900;color:#fff;min-width:48px;text-align:center}
.hud-score-red{background:rgba(192,57,43,.9)}.hud-score-blue{background:rgba(41,128,185,.9)}
.hud-center{background:rgba(0,0,0,.78);padding:4px 14px;display:flex;flex-direction:column;align-items:center;justify-content:center}
.hud-timer{color:#fff;font-size:15px;font-weight:700}
.hud-status{color:#f39c12;font-size:8px;font-weight:700;text-transform:uppercase;margin-top:1px}
#joyZone{position:absolute;bottom:10px;left:10px;width:140px;height:140px;z-index:86;touch-action:none;pointer-events:auto}
#joyBase{position:absolute;bottom:10px;left:10px;width:120px;height:120px;border-radius:50%;background:rgba(255,255,255,.06);border:2px solid rgba(255,255,255,.1);pointer-events:none;z-index:87;opacity:.5}
#joyThumb{position:absolute;width:50px;height:50px;border-radius:50%;background:rgba(255,255,255,.2);border:2px solid rgba(255,255,255,.35);pointer-events:none;z-index:88;opacity:.5;display:none}
.action-btns{position:absolute;bottom:12px;right:12px;z-index:86;display:flex;flex-direction:column;gap:8px;align-items:flex-end;pointer-events:auto}
.act-btn{border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:700;touch-action:none;pointer-events:auto;opacity:.5;border:3px solid rgba(255,255,255,.25)}
.act-btn.active{opacity:.85;transform:scale(1.06)}
#btnKick{width:68px;height:68px;background:rgba(255,255,255,.1);color:rgba(255,255,255,.8);font-size:10px}
#btnPass{width:56px;height:56px;background:rgba(46,204,113,.12);border-color:rgba(46,204,113,.3);color:rgba(46,204,113,.9);font-size:9px}
#btnPower{width:56px;height:56px;background:rgba(231,76,60,.12);border-color:rgba(231,76,60,.3);color:rgba(231,76,60,.9);font-size:9px;position:relative}
#btnPower .cd-ov{position:absolute;top:0;left:0;width:100%;height:100%;border-radius:50%;background:rgba(0,0,0,.55);display:flex;align-items:center;justify-content:center;font-size:11px;color:#fff;font-weight:700}
#btnPower.ready .cd-ov{display:none}
#emojiBar{position:absolute;top:42px;left:50%;transform:translateX(-50%);z-index:88;display:flex;gap:4px;pointer-events:auto;opacity:.5}
.emoji-btn{width:30px;height:30px;border-radius:50%;background:rgba(0,0,0,.4);border:1px solid rgba(255,255,255,.08);display:flex;align-items:center;justify-content:center;font-size:15px;cursor:pointer;touch-action:none}
#chatToggle{width:30px;height:30px;border-radius:50%;background:rgba(0,0,0,.4);border:1px solid rgba(255,255,255,.08);display:flex;align-items:center;justify-content:center;font-size:13px;cursor:pointer;touch-action:none}
#chatPanel{position:absolute;top:76px;left:50%;transform:translateX(-50%);z-index:89;display:none;flex-direction:column;gap:3px;pointer-events:auto;background:rgba(0,0,0,.8);border-radius:8px;padding:6px;min-width:150px;border:1px solid rgba(255,255,255,.06)}
#chatPanel .cm{padding:6px 10px;background:rgba(255,255,255,.05);border:none;border-radius:5px;color:#fff;font-size:11px;cursor:pointer;text-align:left}
#chatPanel .cm:active{background:rgba(255,255,255,.12)}
#chatLog{position:absolute;bottom:160px;left:10px;z-index:87;pointer-events:none;max-width:200px}
.ce{background:rgba(0,0,0,.55);color:#fff;padding:2px 7px;border-radius:5px;font-size:10px;margin-bottom:2px;animation:cf 4s forwards;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
@keyframes cf{0%{opacity:1}70%{opacity:1}100%{opacity:0}}
#adminPanelGame{position:absolute;top:42px;right:6px;z-index:90;display:none;pointer-events:auto}
#adminToggleBtn{background:rgba(243,156,18,.82);color:#000;border:none;padding:6px 10px;border-radius:7px;font-weight:700;font-size:10px;cursor:pointer}
#adminMenuContent{display:none;background:rgba(5,5,20,.94);border-radius:10px;padding:8px;margin-top:4px;min-width:200px;max-width:260px;border:1px solid rgba(255,255,255,.06);max-height:75vh;overflow-y:auto}
#adminMenuContent .sec{color:#888;font-size:9px;padding:5px 6px 2px;text-transform:uppercase;border-bottom:1px solid rgba(255,255,255,.04);margin-bottom:4px}
#adminMenuContent button{display:block;width:100%;padding:8px 10px;margin-bottom:4px;border:none;border-radius:5px;font-size:11px;font-weight:600;cursor:pointer;color:#fff;text-align:left}
#adminMenuContent select{width:100%;padding:7px 10px;margin-bottom:5px;border:1px solid rgba(255,255,255,.1);border-radius:5px;background:rgba(255,255,255,.05);color:#fff;font-size:11px;outline:none;-webkit-appearance:none}
#adminMenuContent select option{background:#0a0a1a}
.apr{display:flex;align-items:center;gap:3px;margin-bottom:4px;padding:4px 6px;background:rgba(255,255,255,.03);border-radius:5px;flex-wrap:wrap}
.apr .an{color:#ccc;font-size:10px;flex:1;min-width:50px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.apr button{padding:3px 6px;font-size:9px;border:none;border-radius:3px;cursor:pointer;font-weight:600;color:#fff}
.apr select{padding:2px 4px;font-size:9px;border:1px solid rgba(255,255,255,.1);border-radius:3px;background:rgba(255,255,255,.05);color:#fff;-webkit-appearance:none;width:48px}
#goalOverlay{position:absolute;top:0;left:0;width:100%;height:100%;display:none;align-items:center;justify-content:center;z-index:89;pointer-events:none;background:rgba(0,0,0,.22)}
.goal-text{font-size:52px;font-weight:900;color:#fff;text-shadow:0 0 40px rgba(255,255,255,.35);animation:ga .4s cubic-bezier(.175,.885,.32,1.275)}
@keyframes ga{0%{transform:scale(.15);opacity:0}70%{transform:scale(1.1)}100%{transform:scale(1);opacity:1}}
#winOverlay{position:absolute;top:0;left:0;width:100%;height:100%;display:none;align-items:center;justify-content:center;flex-direction:column;z-index:95;pointer-events:auto;background:rgba(0,0,0,.85)}
#winOverlay h1{font-size:42px;font-weight:900;margin-bottom:10px}
#winOverlay p{color:#ccc;font-size:16px;margin-bottom:20px}
#winOverlay button{padding:14px 40px;border:none;border-radius:10px;font-size:16px;font-weight:700;cursor:pointer;color:#fff;background:linear-gradient(135deg,#27ae60,#1c8a4a)}
#toast{position:fixed;bottom:65px;left:50%;transform:translateX(-50%);background:rgba(0,0,0,.88);color:#fff;padding:7px 18px;border-radius:18px;font-size:11px;z-index:99990;display:none;white-space:nowrap;pointer-events:none}
.hidden{display:none!important}
</style>
</head>
<body>
<div id="rotateMsg"><div style="font-size:36px;margin-bottom:8px">üì±</div><p>L√ºtfen ekranƒ± yatay √ßevirin</p></div>
<div id="menuScreen" class="screen" style="display:flex">
<h1>‚öΩ HaxBall Mobile</h1><p class="sub">MULTIPLAYER FUTBOL</p>
<div class="mbox">
<input type="text" id="inpName" placeholder="Oyuncu Adƒ±n" maxlength="12">
<div class="divider">YENƒ∞ ODA</div>
<label>Harita</label>
<select id="inpMap"><option value="classic">Klasik</option><option value="big">B√ºy√ºk</option><option value="small">Mini</option><option value="hockey">Hokey</option><option value="futsal">Futsal</option></select>
<label>Gol Sƒ±nƒ±rƒ±</label>
<select id="inpGL"><option value="3">3</option><option value="5" selected>5</option><option value="10">10</option><option value="0">S√ºre Bitene Kadar</option></select>
<input type="text" id="inpPwd" placeholder="≈ûifre (opsiyonel)" maxlength="20">
<button class="btn btn-full btn-red" id="btnCreate">üèüÔ∏è Oda Kur</button>
<div class="divider">KATIL</div>
<input type="text" id="inpCode" placeholder="Oda Kodu" maxlength="6" style="text-transform:uppercase">
<input type="text" id="inpJP" placeholder="≈ûifre" maxlength="20">
<button class="btn btn-full btn-blue" id="btnJoin">üöÄ Katƒ±l</button>
</div></div>

<div id="lobbyScreen" class="screen">
<h2>üèüÔ∏è Lobi</h2><div class="room-code-box" id="lobbyCode">---</div><div class="lobby-map-info" id="lobbyMapName"></div>
<div class="lobby-teams">
<div class="team-panel t-red"><h3>üî¥ Kƒ±rmƒ±zƒ±</h3><div id="lRL"></div></div>
<div class="team-panel t-spec"><h3>üëÅÔ∏è ƒ∞zleyici</h3><div id="lSL"></div></div>
<div class="team-panel t-blue"><h3>üîµ Mavi</h3><div id="lBL"></div></div>
</div>
<div class="lobby-position-select" id="lobbyPB"><h4>üéΩ Mevki</h4><select id="lobbyPS"><option value="">-- Se√ß --</option><option value="GK">üß§ Kaleci</option><option value="DEF">üõ°Ô∏è Defans</option><option value="MID">üéØ Orta Saha</option><option value="FWD">‚ö° Forvet</option></select></div>
<div class="lobby-actions">
<button class="btn btn-red btn-small" id="btnTR">üî¥ Kƒ±rmƒ±zƒ±</button>
<button class="btn btn-gray btn-small" id="btnTS">üëÅÔ∏è ƒ∞zleyici</button>
<button class="btn btn-blue btn-small" id="btnTB">üîµ Mavi</button>
<button class="btn btn-green btn-small hidden" id="btnSt">üöÄ Ba≈ülat</button>
<button class="btn btn-small" id="btnLv" style="background:#7a2e2e;color:#fff">üö™ Ayrƒ±l</button>
</div></div>

<div id="gameScreen" class="screen">
<canvas id="gameCanvas" tabindex="0"></canvas>
<div id="hud"><div class="hud-score hud-score-red" id="hudR">0</div><div class="hud-center"><div class="hud-timer" id="hudT">0:00</div><div class="hud-status" id="hudS"></div></div><div class="hud-score hud-score-blue" id="hudB">0</div></div>
<div id="joyZone"></div><div id="joyBase"></div><div id="joyThumb"></div>
<div class="action-btns">
<div class="act-btn" id="btnPower"><span>üî•</span><div class="cd-ov" id="pwCD">45</div></div>
<div class="act-btn" id="btnKick">VURU≈û</div>
<div class="act-btn" id="btnPass">PAS</div>
</div>
<div id="emojiBar">
<div class="emoji-btn" data-e="üò≠">üò≠</div><div class="emoji-btn" data-e="üòÇ">üòÇ</div><div class="emoji-btn" data-e="üëè">üëè</div><div class="emoji-btn" data-e="üò†">üò†</div>
<div id="chatToggle">üí¨</div>
</div>
<div id="chatPanel">
<button class="cm" data-m="Ba≈üarƒ±lar">Ba≈üarƒ±lar</button><button class="cm" data-m="GG">GG</button><button class="cm" data-m="Tebrik ederim">Tebrik ederim</button><button class="cm" data-m="Aƒülama oyna">Aƒülama oyna</button><button class="cm" data-m="Ya sabƒ±r">Ya sabƒ±r</button>
</div>
<div id="chatLog"></div>
<div id="adminPanelGame"><button id="adminToggleBtn">‚öôÔ∏è</button><div id="adminMenuContent"></div></div>
<div id="goalOverlay"><div class="goal-text" id="goalText">GOL!</div></div>
<div id="winOverlay"><h1 id="winText">üèÜ</h1><p id="winSub"></p><button id="winBtn">Lobiye D√∂n</button></div>
</div>
<div id="toast"></div>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
<script>
(function(){
"use strict";

firebase.initializeApp({
    apiKey:"AIzaSyDXgndR3i2p0ovRXVxqGb24d7lMXdTTX9I",
    authDomain:"mobilgame1-f03ac.firebaseapp.com",
    databaseURL:"https://mobilgame1-f03ac-default-rtdb.europe-west1.firebasedatabase.app",
    projectId:"mobilgame1-f03ac",
    storageBucket:"mobilgame1-f03ac.firebasestorage.app",
    messagingSenderId:"188464433527",
    appId:"1:188464433527:web:baed82070bfed9652df972"
});
var db=firebase.database();

// ============================================================
// YARDIMCI FONKSƒ∞YONLAR
// ============================================================
var $=function(id){return document.getElementById(id)};
function uid(){return Math.random().toString(36).substr(2,9)+'_'+Date.now().toString(36)}
function rcode(){var c='ABCDEFGHJKLMNPQRSTUVWXYZ23456789',s='';for(var i=0;i<5;i++)s+=c[Math.floor(Math.random()*c.length)];return s}
function toast(m,d){d=d||2000;var t=$('toast');t.textContent=m;t.style.display='block';clearTimeout(t._t);t._t=setTimeout(function(){t.style.display='none'},d)}
function lerp(a,b,t){return a+(b-a)*t}
function dst(x1,y1,x2,y2){var dx=x2-x1,dy=y2-y1;return Math.sqrt(dx*dx+dy*dy)}
function clp(v,a,b){return v<a?a:v>b?b:v}
function nrm(x,y){var l=Math.sqrt(x*x+y*y);return l<1e-5?{x:0,y:0}:{x:x/l,y:y/l}}

// ============================================================
// HARƒ∞TA TANIMLARI
// ============================================================
var MAPS={
    classic:{name:'Klasik',fw:1200,fh:600,gh:150,gd:55,bg:'#2b7530',f1:'#3a8c3a',f2:'#358535',lc:'rgba(255,255,255,.5)',cr:85,pw:130,ph:270,bf:.987,pf:.91},
    big:{name:'B√ºy√ºk',fw:1500,fh:750,gh:180,gd:60,bg:'#1a5c1a',f1:'#2a7a2a',f2:'#257225',lc:'rgba(255,255,255,.45)',cr:100,pw:150,ph:300,bf:.988,pf:.92},
    small:{name:'Mini',fw:900,fh:450,gh:120,gd:45,bg:'#2d6b2d',f1:'#3a8530',f2:'#358028',lc:'rgba(255,255,255,.5)',cr:65,pw:100,ph:200,bf:.985,pf:.90},
    hockey:{name:'Hokey',fw:1100,fh:500,gh:130,gd:50,bg:'#152a44',f1:'#1f4470',f2:'#1b3d65',lc:'rgba(255,255,255,.55)',cr:75,pw:120,ph:240,bf:.993,pf:.955},
    futsal:{name:'Futsal',fw:1000,fh:520,gh:135,gd:48,bg:'#7a5a10',f1:'#A07828',f2:'#957020',lc:'rgba(255,255,255,.55)',cr:70,pw:110,ph:230,bf:.983,pf:.90}
};

// ============================================================
// Fƒ∞Zƒ∞K SABƒ∞TLERƒ∞ - D√úZELTƒ∞LDƒ∞
// ============================================================
var FM=70,PR=19,BR=11;
// Vuru≈ü √ßemberi k√º√ß√ºlt√ºld√º: PR+BR+2 (dokunu≈üta vuru≈ü)
var KICK_RANGE=PR+BR+2;  // Eskiden +14 vardƒ±, ≈üimdi sadece temas mesafesi
var KF=5.5;              // Normal vuru≈ü kuvveti
var PKF=17;              // Power shot kuvveti
var PSP=6.5;             // Pas hƒ±zƒ±
var KICK_HOLD_MAX=60;    // ≈ûuta basƒ±lƒ± tutma max (1 saniye = 60 frame)
var PA=.28,PMS=2.8,BMS=10,BD=.62,PBD=.24,BPF=.32,PSR=6;
var MDR=180,NSI=50,GRD=1800,PCD=2700,RCF=5;
var FDT=1000/60;

// ============================================================
// DURUM DEƒûƒ∞≈ûKENLERƒ∞
// ============================================================
var myId=uid(),myName='',roomCode='',roomRef=null,isHost=false,gameState='menu';
var roomData=null,cmk='classic',cm=MAPS.classic;
var P={},B={x:600,y:300,vx:0,vy:0,fire:false,ft:0};
var mT=0,mR=false,mP=false,gF=false,gC=0,rS=0,bS=0,lastNS=0,gLim=5;
var myIn={dx:0,dy:0},kH=false,pH=false,pwP=false,pwCD=0;
var jTid=null,jA=false,jSX=0,jSY=0,keys={};
var canvas,ctx,cW=0,cH=0,vS=1,vOX=0,vOY=0;
var animId=null,lastFT=0,acm=0,rLH=null,admO=false,uG=false;
var fireParts=[],pBubs={},chatEnts=[];

// Keep-alive
var kaInt=null;
function startKA(){
    stopKA();
    kaInt=setInterval(function(){
        if(roomRef&&myId)roomRef.child('players/'+myId+'/lastSeen').set(Date.now());
    },8000);
}
function stopKA(){if(kaInt){clearInterval(kaInt);kaInt=null}}

// Reconnect listener ‚Äî tek seferlik kurulur, her baƒülantƒ±da temizlenir
var connRef=null,connHandler=null;
function setupConn(){
    teardownConn();
    connRef=db.ref('.info/connected');
    connHandler=connRef.on('value',function(snap){
        if(snap.val()===true&&roomRef&&myId){
            roomRef.child('players/'+myId).update({online:true,lastSeen:Date.now()});
        }
    });
}
function teardownConn(){
    if(connRef&&connHandler){connRef.off('value',connHandler);connRef=null;connHandler=null}
}

document.addEventListener('visibilitychange',function(){
    if(!document.hidden&&roomRef&&myId){
        roomRef.child('players/'+myId).update({online:true,lastSeen:Date.now()});
    }
});

// ============================================================
// MEVKI / TAKIM YARDIMCILARI
// ============================================================
function slotCfg(ts){
    if(ts<=0)return{GK:0,DEF:0,MID:0,FWD:0};
    if(ts<=4)return{GK:1,DEF:1,MID:1,FWD:1};
    if(ts===5)return{GK:1,DEF:2,MID:1,FWD:1};
    if(ts===6)return{GK:1,DEF:2,MID:2,FWD:1};
    if(ts===7)return{GK:1,DEF:2,MID:2,FWD:2};
    if(ts===8)return{GK:1,DEF:3,MID:2,FWD:2};
    if(ts===9)return{GK:1,DEF:3,MID:3,FWD:2};
    if(ts===10)return{GK:1,DEF:3,MID:3,FWD:3};
    return{GK:1,DEF:4,MID:3,FWD:3};
}
function cntPos(pl,tm,ps,ex){var c=0;for(var p in pl){if(p===ex||(pl[p].online===false))continue;if(pl[p].team===tm&&pl[p].pos===ps)c++}return c}
function tmSz(pl,tm){var c=0;for(var p in pl){if(pl[p].online!==false&&pl[p].team===tm)c++}return c}
function posAv(pl,tm,ps,ex){return cntPos(pl,tm,ps,ex)<(slotCfg(tmSz(pl,tm))[ps]||0)}
function aPos(pl,tm,pid){
    var ts=tmSz(pl,tm);
    if(!(pl[pid]&&pl[pid].team===tm&&pl[pid].online!==false))ts++;
    var c=slotCfg(ts),o=['GK','DEF','MID','FWD'];
    for(var i=0;i<o.length;i++){if(cntPos(pl,tm,o[i],pid)<(c[o[i]]||0))return o[i]}
    return'MID';
}
function spPos(tm,ps,idx,tot,m){
    var bx=m.fw/2;
    if(tm==='red'){if(ps==='GK')bx=50;else if(ps==='DEF')bx=m.fw*.18;else if(ps==='MID')bx=m.fw*.34;else bx=m.fw*.45}
    else{if(ps==='GK')bx=m.fw-50;else if(ps==='DEF')bx=m.fw*.82;else if(ps==='MID')bx=m.fw*.66;else bx=m.fw*.55}
    var sp=Math.min(68,(m.fh-80)/Math.max(tot,1));
    return{x:bx,y:m.fh/2-(tot-1)*sp/2+idx*sp};
}
function spAll(pids,tm,pl,m,u){
    var g={GK:[],DEF:[],MID:[],FWD:[]};
    for(var i=0;i<pids.length;i++){var ps=(pl[pids[i]]&&pl[pids[i]].pos)||'MID';if(!g[ps])g[ps]=[];g[ps].push(pids[i])}
    for(var p in g){var a=g[p];for(var j=0;j<a.length;j++){var s=spPos(tm,p,j,a.length,m);u['players/'+a[j]+'/x']=s.x;u['players/'+a[j]+'/y']=s.y;u['players/'+a[j]+'/vx']=0;u['players/'+a[j]+'/vy']=0}}
}

// ============================================================
// CANVAS & EKRAN
// ============================================================
canvas=$('gameCanvas');ctx=canvas.getContext('2d',{alpha:false});

// Pre-render oyuncu g√∂rselleri
var redPlayerImg=null,bluePlayerImg=null;
function prerenderPlayers(){
    var sz=PR*2+6;
    var c1=document.createElement('canvas');c1.width=sz;c1.height=sz;var x1=c1.getContext('2d');
    x1.fillStyle='#c0392b';x1.beginPath();x1.arc(sz/2,sz/2,PR,0,Math.PI*2);x1.fill();
    x1.fillStyle='rgba(255,118,117,.4)';x1.beginPath();x1.arc(sz/2-3,sz/2-3,PR*.55,0,Math.PI*2);x1.fill();
    redPlayerImg=c1;
    var c2=document.createElement('canvas');c2.width=sz;c2.height=sz;var x2=c2.getContext('2d');
    x2.fillStyle='#2980b9';x2.beginPath();x2.arc(sz/2,sz/2,PR,0,Math.PI*2);x2.fill();
    x2.fillStyle='rgba(116,185,255,.4)';x2.beginPath();x2.arc(sz/2-3,sz/2-3,PR*.55,0,Math.PI*2);x2.fill();
    bluePlayerImg=c2;
}
prerenderPlayers();

function showScr(n){
    $('menuScreen').style.display='none';
    $('lobbyScreen').style.display='none';
    $('gameScreen').style.display='none';
    gameState=n;
    if(n==='menu'){$('menuScreen').style.display='flex';stopL()}
    else if(n==='lobby'){$('lobbyScreen').style.display='flex';stopL()}
    else if(n==='game'){$('gameScreen').style.display='block';resC();startL();setTimeout(function(){canvas.focus()},80)}
}
function resC(){
    cW=window.innerWidth;cH=window.innerHeight;
    canvas.width=cW;canvas.height=cH;
    var tw=cm.fw+FM*2,th=cm.fh+FM*2;
    vS=Math.min(cW/tw,cH/th);
    vOX=(cW-tw*vS)/2;vOY=(cH-th*vS)/2;
}
window.addEventListener('resize',function(){if(gameState==='game')resC()});
function tryFS(){if(!uG)return;try{if(!document.fullscreenElement)document.documentElement.requestFullscreen().catch(function(){})}catch(e){}}
function onGe(){uG=true;if(gameState==='game')tryFS()}
document.addEventListener('click',onGe,{passive:true});
document.addEventListener('touchend',onGe,{passive:true});
document.addEventListener('contextmenu',function(e){e.preventDefault()});

// ============================================================
// ODA OLU≈ûTUR
// ============================================================
$('btnCreate').addEventListener('click',function(){
    myName=$('inpName').value.trim()||('P'+myId.substr(0,4));
    if(myName.length>12)myName=myName.substr(0,12);
    cmk=$('inpMap').value||'classic';cm=MAPS[cmk]||MAPS.classic;
    gLim=parseInt($('inpGL').value)||0;
    roomCode=rcode();
    var init={
        code:roomCode,password:$('inpPwd').value.trim(),
        hostId:myId,state:'lobby',mapKey:cmk,goalLimit:gLim,
        players:{},chat:{},
        match:{redScore:0,blueScore:0,time:0,running:false,paused:false,
               ball:{x:cm.fw/2,y:cm.fh/2,vx:0,vy:0,fire:false}}
    };
    init.players[myId]={name:myName,team:'spectator',pos:'',x:cm.fw/2,y:cm.fh/2,vx:0,vy:0,kick:false,idx:0,idy:0,ik:false,ip:false,ipw:false,emoji:'',online:true,lastSeen:Date.now()};
    roomRef=db.ref('rooms/'+roomCode);
    roomRef.set(init).then(function(){
        isHost=true;setupL();setupDC();startKA();
        showScr('lobby');
        $('lobbyCode').textContent='ODA: '+roomCode;
        $('lobbyMapName').textContent=cm.name+(gLim?' | '+gLim+' Gol':'');
        toast('Kod: '+roomCode);
    }).catch(function(e){toast(e.message)});
});

// ============================================================
// ODAYA KATIL
// ============================================================
$('btnJoin').addEventListener('click',function(){
    myName=$('inpName').value.trim()||('P'+myId.substr(0,4));
    if(myName.length>12)myName=myName.substr(0,12);
    var code=$('inpCode').value.trim().toUpperCase();
    if(!code){toast('Kod girin!');return}
    var ref=db.ref('rooms/'+code);
    ref.once('value').then(function(s){
        if(!s.exists()){toast('Bulunamadƒ±!');return Promise.reject('notfound')}
        var d=s.val();
        if(d.password&&d.password!==$('inpJP').value.trim()){toast('Yanlƒ±≈ü ≈üifre!');return Promise.reject('badpwd')}
        roomCode=code;roomRef=ref;isHost=false;
        cmk=d.mapKey||'classic';cm=MAPS[cmk]||MAPS.classic;gLim=d.goalLimit||0;
        return roomRef.child('players/'+myId).set({name:myName,team:'spectator',pos:'',x:cm.fw/2,y:cm.fh/2,vx:0,vy:0,kick:false,idx:0,idy:0,ik:false,ip:false,ipw:false,emoji:'',online:true,lastSeen:Date.now()});
    }).then(function(){
        if(!roomRef)return;
        setupL();setupDC();startKA();
        showScr('lobby');
        $('lobbyCode').textContent='ODA: '+roomCode;
        $('lobbyMapName').textContent=cm.name;
        toast('Katƒ±ldƒ±n!');
    }).catch(function(e){if(e!=='notfound'&&e!=='badpwd')toast(String(e))});
});

// ============================================================
// DISCONNECT & RECONNECT
// ============================================================
function setupDC(){
    if(roomRef){
        roomRef.child('players/'+myId).onDisconnect().update({online:false});
        setupConn();
    }
}

// ============================================================
// CHAT
// ============================================================
var chatLS=false,chatRef=null,chatLH=null;
function setupChat(){
    if(chatLS||!roomRef)return;
    chatLS=true;
    chatRef=roomRef.child('chat');
    chatLH=chatRef.orderByChild('t').limitToLast(1).on('child_added',function(s){
        var d=s.val();if(!d)return;
        addChat(d.name,d.msg);
        if(d.pid&&P[d.pid])pBubs[d.pid]={text:d.msg,timer:180};
    });
}
function teardownChat(){
    if(chatRef&&chatLH){chatRef.off('child_added',chatLH);chatRef=null;chatLH=null}
    chatLS=false;
}
function addChat(n,m){
    chatEnts.push({name:n,msg:m,timer:240});
    if(chatEnts.length>5)chatEnts.shift();
    renderChatLog();
}
function renderChatLog(){
    var cl=$('chatLog');cl.innerHTML='';
    for(var i=0;i<chatEnts.length;i++){
        var d=document.createElement('div');d.className='ce';
        d.textContent=chatEnts[i].name+': '+chatEnts[i].msg;
        cl.appendChild(d);
    }
}

// ============================================================
// LOBI Dƒ∞NLEYƒ∞Cƒ∞
// ============================================================
function setupL(){
    if(rLH&&roomRef)roomRef.off('value',rLH);
    rLH=roomRef.on('value',function(s){
        if(!s.exists()){toast('Oda kapandƒ±!');cleanup();showScr('menu');return}
        roomData=s.val();gLim=roomData.goalLimit||0;

        // Host kontrol√º
        if(roomData.hostId&&roomData.players){
            var hp=roomData.players[roomData.hostId];
            if(!hp||hp.online===false){
                var on=[];
                for(var p in roomData.players){if(roomData.players[p].online!==false)on.push(p)}
                if(on.length>0&&on[0]===myId){isHost=true;roomRef.update({hostId:myId});toast('Yeni host!')}
            }
        }
        isHost=(roomData.hostId===myId);

        if(roomData.mapKey&&MAPS[roomData.mapKey]){
            var ok=cmk;cmk=roomData.mapKey;cm=MAPS[cmk];
            if(gameState==='game'&&ok!==cmk)resC();
        }

        // Emoji bubble g√ºncelle
        if(roomData.players){
            for(var pid in roomData.players){
                var p=roomData.players[pid];
                if(p.emoji&&p.emoji!==''&&(!pBubs[pid]||pBubs[pid].text!==p.emoji)){
                    pBubs[pid]={text:p.emoji,timer:150};
                }
            }
        }

        if(gameState==='lobby'){
            refLobby();
            if(roomData.state==='playing'){initG();showScr('game');setupChat()}
        } else if(gameState==='game'){
            if(roomData.state==='lobby'){stopL();showScr('lobby');return}
            if(!isHost)cSync();
            if(roomData.match){rS=roomData.match.redScore||0;bS=roomData.match.blueScore||0}
            $('adminPanelGame').style.display=isHost?'block':'none';
        }
    });
}

// ============================================================
// LOBƒ∞ RENDER
// ============================================================
function refLobby(){
    if(!roomData||!roomData.players)return;
    var rD=$('lRL'),bD=$('lBL'),sD=$('lSL');
    rD.innerHTML='';bD.innerHTML='';sD.innerHTML='';
    var ps=roomData.players,pl={GK:'KAL',DEF:'DEF',MID:'ORS',FWD:'FRV'};
    for(var pid in ps){
        var p=ps[pid];if(p.online===false)continue;
        var r=document.createElement('div');r.className='player-row';
        var hH=pid===roomData.hostId?'<span class="host-tag">HOST</span>':'';
        var posH='';if(p.pos&&p.team!=='spectator')posH='<span class="pos-tag pos-'+p.pos+'">'+(pl[p.pos]||p.pos)+'</span>';
        var aH='';
        if(isHost&&pid!==myId){
            aH='<div class="admin-row-btns"><button style="background:#e74c3c" data-ap="'+pid+'" data-at="red">K</button><button style="background:#3498db" data-ap="'+pid+'" data-at="blue">M</button><button style="background:#555" data-ap="'+pid+'" data-at="spectator">ƒ∞</button></div>';
        }
        r.innerHTML='<span class="p-info">'+hH+'<span class="p-name">'+(p.name||'?')+'</span>'+posH+'</span>'+aH;
        if(p.team==='red')rD.appendChild(r);else if(p.team==='blue')bD.appendChild(r);else sD.appendChild(r);
    }
    // Admin takƒ±m deƒüi≈ütirme
    rD.querySelectorAll('[data-ap]').forEach(attachTeamBtn);
    bD.querySelectorAll('[data-ap]').forEach(attachTeamBtn);
    sD.querySelectorAll('[data-ap]').forEach(attachTeamBtn);

    $('btnSt').classList.toggle('hidden',!isHost);
    $('lobbyMapName').textContent=cm.name+(gLim?' | '+gLim+' Gol':'');

    // Mevki se√ß
    if(!roomData.players[myId]||roomData.players[myId].team==='spectator'){
        $('lobbyPB').style.display='none';
    } else {
        $('lobbyPB').style.display='block';
        var sel=$('lobbyPS'),me=roomData.players[myId],tm=me.team,ts=tmSz(roomData.players,tm);
        var cfg=slotCfg(ts),pos=['GK','DEF','MID','FWD'],lab={GK:'üß§ Kaleci',DEF:'üõ°Ô∏è Defans',MID:'üéØ Orta Saha',FWD:'‚ö° Forvet'};
        var h='<option value="">-- Se√ß --</option>';
        for(var i=0;i<pos.length;i++){
            var pp=pos[i],mx=cfg[pp]||0,tk=cntPos(roomData.players,tm,pp,myId),av=tk<mx,im=me.pos===pp;
            h+='<option value="'+pp+'"'+(im?' selected':'')+(!av&&!im?' disabled':'')+'>'+lab[pp]+' ('+tk+'/'+mx+')</option>';
        }
        sel.innerHTML=h;
    }
}
function attachTeamBtn(b){
    b.onclick=function(){
        var tp=b.getAttribute('data-ap'),tt=b.getAttribute('data-at');
        if(!isHost||!roomRef)return;
        if(tt==='spectator')roomRef.child('players/'+tp).update({team:'spectator',pos:''});
        else{if(tmSz(roomData.players,tt)>=11)return;roomRef.child('players/'+tp).update({team:tt,pos:aPos(roomData.players,tt,tp)})}
    };
}

$('lobbyPS').addEventListener('change',function(){
    var v=$('lobbyPS').value;if(!v||!roomRef||!roomData)return;
    var me=roomData.players[myId];if(!me||me.team==='spectator')return;
    if(!posAv(roomData.players,me.team,v,myId)){toast('Dolu!');return}
    roomRef.child('players/'+myId).update({pos:v});
});
$('btnTR').onclick=function(){if(!roomRef||!roomData)return;if(tmSz(roomData.players,'red')>=11){toast('Dolu!');return}roomRef.child('players/'+myId).update({team:'red',pos:aPos(roomData.players,'red',myId)})};
$('btnTB').onclick=function(){if(!roomRef||!roomData)return;if(tmSz(roomData.players,'blue')>=11){toast('Dolu!');return}roomRef.child('players/'+myId).update({team:'blue',pos:aPos(roomData.players,'blue',myId)})};
$('btnTS').onclick=function(){if(roomRef)roomRef.child('players/'+myId).update({team:'spectator',pos:''})};
$('btnLv').onclick=function(){cleanup();showScr('menu')};

// ============================================================
// OYUNU BA≈ûLAT (HOST)
// ============================================================
$('btnSt').onclick=function(){
    if(!isHost||!roomRef||!roomData)return;
    var ps=roomData.players,rc=0,bc=0;
    for(var p in ps){if(ps[p].online===false)continue;if(ps[p].team==='red')rc++;if(ps[p].team==='blue')bc++}
    if(rc<1||bc<1){toast('Her takƒ±mda 1+');return}
    var u={},rP=[],bP=[];
    for(var p2 in ps){
        if(ps[p2].online===false)continue;
        if(ps[p2].team==='red')rP.push(p2);else if(ps[p2].team==='blue')bP.push(p2);
    }
    for(var r=0;r<rP.length;r++){if(!ps[rP[r]].pos){var ap=aPos(ps,'red',rP[r]);u['players/'+rP[r]+'/pos']=ap;ps[rP[r]].pos=ap}}
    for(var b=0;b<bP.length;b++){if(!ps[bP[b]].pos){var abp=aPos(ps,'blue',bP[b]);u['players/'+bP[b]+'/pos']=abp;ps[bP[b]].pos=abp}}
    spAll(rP,'red',ps,cm,u);spAll(bP,'blue',ps,cm,u);
    u['state']='playing';u['match/redScore']=0;u['match/blueScore']=0;
    u['match/time']=0;u['match/running']=true;u['match/paused']=false;
    u['match/ball']={x:cm.fw/2,y:cm.fh/2,vx:0,vy:0,fire:false};
    roomRef.update(u);
};

// ============================================================
// OYUN BA≈ûLATMA
// ============================================================
function initG(){
    if(!roomData)return;
    P={};
    if(roomData.players){
        for(var pid in roomData.players){
            var p=roomData.players[pid];
            if(p.online===false)continue;
            P[pid]={
                name:p.name||'?',team:p.team||'spectator',pos:p.pos||'',
                x:p.x||cm.fw/2,y:p.y||cm.fh/2,vx:0,vy:0,
                kick:false,kHF:0,iDx:0,iDy:0,iK:false,iP:false,iPw:false,
                pCD:0,rcVx:0,rcVy:0,rcT:0,kickHeld:0
            };
        }
    }
    var b=(roomData.match&&roomData.match.ball)||{};
    B={x:b.x||cm.fw/2,y:b.y||cm.fh/2,vx:b.vx||0,vy:b.vy||0,fire:b.fire||false,ft:0};
    mT=(roomData.match&&roomData.match.time)||0;
    mR=(roomData.match&&roomData.match.running)||false;
    mP=(roomData.match&&roomData.match.paused)||false;
    rS=(roomData.match&&roomData.match.redScore)||0;
    bS=(roomData.match&&roomData.match.blueScore)||0;
    gF=false;gC=0;lastNS=0;kH=false;pH=false;pwP=false;pwCD=0;
    fireParts=[];pBubs={};chatEnts=[];
    $('adminPanelGame').style.display=isHost?'block':'none';
    admO=false;$('adminMenuContent').style.display='none';
    $('goalOverlay').style.display='none';$('winOverlay').style.display='none';
    buildAdm();
}

// ============================================================
// CLIENT SYNC - LAG D√úZELTƒ∞LDƒ∞
// Interpolation ve prediction dengesi iyile≈ütirildi
// ============================================================
function cSync(){
    if(!roomData||!roomData.match)return;
    mR=roomData.match.running||false;
    mP=roomData.match.paused||false;
    mT=roomData.match.time||0;

    // Top sync - daha smooth interpolation
    if(roomData.match.ball){
        var tb=roomData.match.ball;
        // Eƒüer top √ßok uzakta ise direkt snap
        var ballDist=dst(B.x,B.y,tb.x,tb.y);
        if(ballDist>80){B.x=tb.x;B.y=tb.y;B.vx=tb.vx||0;B.vy=tb.vy||0}
        else{B.x=lerp(B.x,tb.x,.25);B.y=lerp(B.y,tb.y,.25);B.vx=lerp(B.vx,tb.vx||0,.3);B.vy=lerp(B.vy,tb.vy||0,.3)}
        B.fire=tb.fire||false;
    }

    if(roomData.players){
        for(var pid in roomData.players){
            var rd=roomData.players[pid];
            if(rd.online===false){delete P[pid];continue}
            if(!P[pid]){
                P[pid]={name:rd.name||'?',team:rd.team,pos:rd.pos||'',
                    x:rd.x||cm.fw/2,y:rd.y||cm.fh/2,vx:0,vy:0,
                    kick:false,kHF:0,iDx:0,iDy:0,iK:false,iP:false,iPw:false,
                    pCD:0,rcVx:0,rcVy:0,rcT:0,kickHeld:0};
            }
            var p=P[pid];
            p.team=rd.team;p.name=rd.name;p.pos=rd.pos||'';p.kick=rd.kick||false;

            if(pid===myId){
                // Kendi oyuncum i√ßin: lokal hareket + server correction
                if(p.team!=='spectator'){
                    var il=Math.sqrt(myIn.dx*myIn.dx+myIn.dy*myIn.dy);
                    if(il>.05){var n=nrm(myIn.dx,myIn.dy);p.vx+=n.x*PA*Math.min(il,1);p.vy+=n.y*PA*Math.min(il,1)}
                    var sp=Math.sqrt(p.vx*p.vx+p.vy*p.vy);
                    if(sp>PMS){p.vx=(p.vx/sp)*PMS;p.vy=(p.vy/sp)*PMS}
                    p.vx*=cm.pf;p.vy*=cm.pf;
                    if(Math.abs(p.vx)<.003)p.vx=0;if(Math.abs(p.vy)<.003)p.vy=0;
                    p.x+=p.vx;p.y+=p.vy;
                    // Soft server correction (k√º√ß√ºk kayma)
                    if(rd.x!=null){var corrStrength=.08;p.x=lerp(p.x,rd.x,corrStrength);p.y=lerp(p.y,rd.y,corrStrength)}
                    p.x=clp(p.x,PR,cm.fw-PR);p.y=clp(p.y,PR,cm.fh-PR);
                    p.kick=kH;
                    // Client'ta da pwCD say
                    if(p.pCD>0)p.pCD--;
                }
            } else {
                // Diƒüer oyuncular: daha yumu≈üak interpolation
                if(rd.x!=null){
                    var pDist=dst(p.x,p.y,rd.x,rd.y);
                    // √áok uzaksa snap
                    if(pDist>120){p.x=rd.x;p.y=rd.y}
                    else{p.x=lerp(p.x,rd.x,.2);p.y=lerp(p.y,rd.y,.2)}
                }
            }
        }
        // Silinmi≈ü oyuncularƒ± temizle
        for(var pid2 in P){
            if(!roomData.players[pid2]||roomData.players[pid2].online===false)delete P[pid2];
        }
    }
}

// ============================================================
// CLEANUP
// ============================================================
function cleanup(){
    stopKA();teardownConn();teardownChat();
    if(roomRef){
        if(rLH){roomRef.off('value',rLH);rLH=null}
        roomRef.child('players/'+myId).remove();
        roomRef=null;
    }
    stopL();roomData=null;roomCode='';isHost=false;P={};
    chatEnts=[];pBubs=[];fireParts=[];
}

// ============================================================
// OYUN D√ñNG√úS√ú
// ============================================================
function startL(){if(animId)cancelAnimationFrame(animId);lastFT=performance.now();acm=0;tick(lastFT)}
function stopL(){if(animId){cancelAnimationFrame(animId);animId=null}}
function tick(now){
    animId=requestAnimationFrame(tick);
    var dt=now-lastFT;lastFT=now;
    if(dt>100)dt=100;
    acm+=dt;
    var steps=0;
    while(acm>=FDT&&steps<3){fixUp();acm-=FDT;steps++}
    render();
    netTick(now);
}

// ============================================================
// NET TICK - G√úNCELLENDƒ∞ (Daha verimli)
// ============================================================
function netTick(now){
    if(!roomRef||now-lastNS<NSI)return;
    lastNS=now;
    if(isHost){
        var u={};
        u['match/ball']={x:+(B.x.toFixed(1)),y:+(B.y.toFixed(1)),vx:+(B.vx.toFixed(2)),vy:+(B.vy.toFixed(2)),fire:B.fire};
        u['match/time']=+(mT.toFixed(1));
        u['match/running']=mR;u['match/paused']=mP;
        u['match/redScore']=rS;u['match/blueScore']=bS;
        for(var pid in P){
            var p=P[pid];if(p.team==='spectator')continue;
            u['players/'+pid+'/x']=+(p.x.toFixed(1));
            u['players/'+pid+'/y']=+(p.y.toFixed(1));
            u['players/'+pid+'/vx']=+(p.vx.toFixed(2));
            u['players/'+pid+'/vy']=+(p.vy.toFixed(2));
            u['players/'+pid+'/kick']=p.kick||false;
            u['players/'+pid+'/pCD']=p.pCD||0; // Client'a CD bilgisi g√∂nder
        }
        roomRef.update(u);
    } else {
        roomRef.child('players/'+myId).update({
            idx:+(myIn.dx.toFixed(2)),idy:+(myIn.dy.toFixed(2)),
            ik:kH,ip:pH,ipw:pwP
        });
        if(pwP)pwP=false;
    }
}

// ============================================================
// FIX UP (Her frame)
// ============================================================
function fixUp(){
    if(isHost)hostPh();
    // Fire partik√ºller
    for(var fi=fireParts.length-1;fi>=0;fi--){
        var fp=fireParts[fi];fp.x+=fp.vx;fp.y+=fp.vy;fp.life--;fp.sz*=.93;
        if(fp.life<=0)fireParts.splice(fi,1);
    }
    // Power cooldown - hem host hem client
    if(pwCD>0)pwCD--;
    var cdEl=$('pwCD');
    cdEl.style.display=pwCD>0?'flex':'none';
    if(pwCD>0)cdEl.textContent=Math.ceil(pwCD/60);
    $('btnPower').classList.toggle('ready',pwCD<=0);

    // Bubble timer
    for(var bp in pBubs){pBubs[bp].timer--;if(pBubs[bp].timer<=0)delete pBubs[bp]}
    // Chat timer
    for(var ci=chatEnts.length-1;ci>=0;ci--){chatEnts[ci].timer--;if(chatEnts[ci].timer<=0)chatEnts.splice(ci,1)}
}

// ============================================================
// HOST Fƒ∞Zƒ∞K - B√úY√úK D√úZELTME
// ≈ûut mekaniƒüi, kale i√ßi girme, ate≈ü topu otomatik takip kaldƒ±rƒ±ldƒ±
// ============================================================
function hostPh(){
    var FW=cm.fw,FH=cm.fh,GH=cm.gh,GD=cm.gd,gT=FH/2-GH/2,gB=FH/2+GH/2,dtS=FDT/1000;

    // S√ºre say
    if(mR&&!mP&&!gF){
        mT+=dtS;
        if(mT>=MDR){mR=false;mT=MDR;if(roomRef)roomRef.update({'match/running':false})}
    }
    // Gol animasyonu bekleme
    if(gF){gC-=FDT;if(gC<=0){gF=false;resetP();$('goalOverlay').style.display='none'}return}
    if(mP||!mR)return;

    // Input oku
    if(roomData&&roomData.players){
        for(var pid in P){
            if(pid===myId){
                P[pid].iDx=myIn.dx;P[pid].iDy=myIn.dy;
                P[pid].iK=kH;P[pid].iP=pH;P[pid].iPw=pwP;
                if(pwP)pwP=false;
            } else {
                var rd=roomData.players[pid];
                if(rd){P[pid].iDx=rd.idx||0;P[pid].iDy=rd.idy||0;P[pid].iK=rd.ik||false;P[pid].iP=rd.ip||false;P[pid].iPw=rd.ipw||false}
            }
        }
    }

    // Yeni / ayrƒ±lan oyuncularƒ± sync et
    if(roomData&&roomData.players){
        for(var pid2 in roomData.players){
            var rd2=roomData.players[pid2];
            if(rd2.online===false){delete P[pid2];continue}
            if(!P[pid2]){
                var sp2=spPos(rd2.team,rd2.pos||'MID',0,1,cm);
                P[pid2]={name:rd2.name,team:rd2.team,pos:rd2.pos||'',x:sp2.x,y:sp2.y,vx:0,vy:0,kick:false,kHF:0,iDx:0,iDy:0,iK:false,iP:false,iPw:false,pCD:0,rcVx:0,rcVy:0,rcT:0,kickHeld:0};
            }
            P[pid2].team=rd2.team;P[pid2].name=rd2.name;P[pid2].pos=rd2.pos||'';
        }
        for(var pid3 in P){if(!roomData.players[pid3]||roomData.players[pid3].online===false)delete P[pid3]}
    }

    var acts=[];
    for(var ap in P){if(P[ap].team!=='spectator')acts.push(ap)}

    // ---- OYUNCU Fƒ∞Zƒ∞ƒûƒ∞ ----
    for(var ai=0;ai<acts.length;ai++){
        var pp=P[acts[ai]];

        // Recoil uygula
        if(pp.rcT>0){pp.x+=pp.rcVx;pp.y+=pp.rcVy;pp.rcVx*=.88;pp.rcVy*=.88;pp.rcT--}

        // Hareket
        var inL=Math.sqrt(pp.iDx*pp.iDx+pp.iDy*pp.iDy);
        if(inL>.05){var nm=nrm(pp.iDx,pp.iDy);pp.vx+=nm.x*PA*Math.min(inL,1);pp.vy+=nm.y*PA*Math.min(inL,1)}
        var spd=Math.sqrt(pp.vx*pp.vx+pp.vy*pp.vy);
        if(spd>PMS){pp.vx=(pp.vx/spd)*PMS;pp.vy=(pp.vy/spd)*PMS}
        pp.vx*=cm.pf;pp.vy*=cm.pf;
        if(Math.abs(pp.vx)<.003)pp.vx=0;if(Math.abs(pp.vy)<.003)pp.vy=0;
        pp.x+=pp.vx;pp.y+=pp.vy;

        // VURU≈û MEKANƒ∞ƒûƒ∞ D√úZELTƒ∞LDƒ∞
        // kickHeld: basƒ±lƒ± tutma sayacƒ± (1 saniye = 60 frame)
        if(pp.iK){
            if(pp.kickHeld<KICK_HOLD_MAX)pp.kickHeld++;
            pp.kick=true;
        } else {
            pp.kickHeld=0;pp.kick=false;
        }

        // Cooldown say
        if(pp.pCD>0)pp.pCD--;
        // Kale sƒ±nƒ±rlarƒ± KALDIRILDI - oyuncu kaleye girebilir
        pp.x=clp(pp.x,PR,FW-PR);
        pp.y=clp(pp.y,PR,FH-PR);
    }

    // ---- OYUNCU-OYUNCU √áARPI≈ûMA ----
    for(var ci=0;ci<acts.length;ci++){
        for(var cj=ci+1;cj<acts.length;cj++){
            var pa=P[acts[ci]],pb=P[acts[cj]];
            var cd=dst(pa.x,pa.y,pb.x,pb.y),mD=PR*2;
            if(cd<mD&&cd>.001){
                var cnx=(pb.x-pa.x)/cd,cny=(pb.y-pa.y)/cd,ov=mD-cd;
                pa.x-=cnx*ov*.5;pa.y-=cny*ov*.5;
                pb.x+=cnx*ov*.5;pb.y+=cny*ov*.5;
                var dvx=pa.vx-pb.vx,dvy=pa.vy-pb.vy,dvn=dvx*cnx+dvy*cny;
                if(dvn>0){pa.vx-=dvn*cnx*PBD;pa.vy-=dvn*cny*PBD;pb.vx+=dvn*cnx*PBD;pb.vy+=dvn*cny*PBD}
            }
        }
    }

    // ---- TOP Fƒ∞Zƒ∞ƒûƒ∞ ----
    if(B.ft>0){B.ft--;if(B.ft<=0)B.fire=false}
    if(B.fire&&fireParts.length<25){
        fireParts.push({x:B.x,y:B.y,vx:-B.vx*.08+(Math.random()-.5)*1.5,vy:-B.vy*.08+(Math.random()-.5)*1.5,life:15,sz:3+Math.random()*3,c:Math.random()>.5?'#ff6600':'#ffcc00'});
    }
    B.vx*=cm.bf;B.vy*=cm.bf;
    if(Math.abs(B.vx)<.004)B.vx=0;if(Math.abs(B.vy)<.004)B.vy=0;
    B.x+=B.vx;B.y+=B.vy;
    var bsp=Math.sqrt(B.vx*B.vx+B.vy*B.vy);
    var maxB=B.fire?BMS*2:BMS;
    if(bsp>maxB){B.vx=(B.vx/bsp)*maxB;B.vy=(B.vy/bsp)*maxB}

    // ---- OYUNCU-TOP √áARPI≈ûMA - D√úZELTƒ∞LDƒ∞ ----
    for(var bi=0;bi<acts.length;bi++){
        var bp=P[acts[bi]];
        var bd=dst(bp.x,bp.y,B.x,B.y);
        // Vuru≈ü √ßemberi: sadece temas mesafesi (PR+BR), vuru≈ü aktifse biraz daha (+2)
        var activeRange=PR+BR+(bp.kick?2:0);

        if(bd<activeRange&&bd>.001){
            var bnx=(B.x-bp.x)/bd,bny=(B.y-bp.y)/bd;
            // ƒ∞tme: √ßakƒ±≈üma √∂nle
            var minD=PR+BR;
            if(bd<minD){var bov=minD-bd;B.x+=bnx*bov;B.y+=bny*bov}

            // G√∂receli hƒ±z
            var bdvx=B.vx-bp.vx,bdvy=B.vy-bp.vy,bdvn=bdvx*bnx+bdvy*bny;

            if(bp.kick){
                if(bp.iPw&&bp.pCD<=0){
                    // POWER SHOT - basƒ±lƒ± tutma s√ºresi ile g√º√ß artar
                    var holdRatio=Math.min(bp.kickHeld/KICK_HOLD_MAX,1);
                    var pwForce=PKF*(0.7+holdRatio*0.5);
                    B.vx=bnx*pwForce;B.vy=bny*pwForce;
                    B.fire=true;B.ft=120;
                    bp.pCD=PCD;
                    if(acts[bi]===myId)pwCD=PCD;
                    bp.iPw=false;
                } else if(bp.iP){
                    // PAS - en yakƒ±n takƒ±m arkada≈üƒ±na
                    var tm8=findMate(acts[bi]);
                    if(tm8&&P[tm8]){
                        var dx=P[tm8].x-B.x,dy=P[tm8].y-B.y;
                        var dn=nrm(dx,dy);
                        B.vx=dn.x*PSP;B.vy=dn.y*PSP;
                    } else {
                        B.vx+=bnx*KF;B.vy+=bny*KF;
                    }
                } else {
                    // NORMAL VURU≈û - sadece topa deƒüince
                    // bdvn kontrol√º: top zaten uzakla≈üƒ±yorsa vurma
                    if(bdvn<KF){
                        var addForce=KF-Math.max(bdvn,0);
                        B.vx+=bnx*addForce;B.vy+=bny*addForce;
                    }
                }
            } else {
                // Kick yok, sadece √ßarpƒ±≈üma fiziƒüi
                if(bdvn<0){B.vx-=bdvn*bnx*BPF;B.vy-=bdvn*bny*BPF}
            }

            // Ate≈ü topu recoil - SADECE YAKLA≈ûIRKEN (otomatik takip YOK)
            if(B.fire&&bdvn<0){
                var spd2=Math.sqrt(B.vx*B.vx+B.vy*B.vy);
                if(spd2>6){
                    bp.rcVx=-bnx*RCF;bp.rcVy=-bny*RCF;bp.rcT=10;
                }
            }
        }
    }

    // ---- KALE Dƒ∞REKLERƒ∞ ----
    var posts=[{x:0,y:gT},{x:0,y:gB},{x:FW,y:gT},{x:FW,y:gB}];
    for(var pi=0;pi<posts.length;pi++){
        var po=posts[pi];var pd=dst(B.x,B.y,po.x,po.y);
        if(pd<BR+PSR&&pd>.001){
            var pnx=(B.x-po.x)/pd,pny=(B.y-po.y)/pd,pov=BR+PSR-pd;
            B.x+=pnx*pov;B.y+=pny*pov;
            var pdot=B.vx*pnx+B.vy*pny;
            if(pdot<0){B.vx-=2*pdot*pnx*BD;B.vy-=2*pdot*pny*BD}
        }
    }

    // ---- SINIR √áARPI≈ûMALARI & GOL ----
    // √úst/alt duvar
    if(B.y-BR<0){B.y=BR;if(B.vy<0)B.vy=-B.vy*BD}
    if(B.y+BR>FH){B.y=FH-BR;if(B.vy>0)B.vy=-B.vy*BD}

    // Sol duvar & kale
    if(B.x-BR<0){
        if(B.y>gT&&B.y<gB){
            // Kale i√ßinde
            if(B.x-BR<-GD){hGoal('blue');return}
            // Kale yan duvarlarƒ± (√ºst ve alt direkler arasƒ± kƒ±sƒ±tlama yok - top i√ßinde serbest√ße)
        } else {
            // Normal duvar
            B.x=BR;if(B.vx<0)B.vx=-B.vx*BD;
        }
    }
    // Saƒü duvar & kale
    if(B.x+BR>FW){
        if(B.y>gT&&B.y<gB){
            if(B.x+BR>FW+GD){hGoal('red');return}
        } else {
            B.x=FW-BR;if(B.vx>0)B.vx=-B.vx*BD;
        }
    }
    // Ek g√ºvenlik: kale arkasƒ±
    if(B.x<-GD){B.x=-GD+BR;if(B.vx<0)B.vx=Math.abs(B.vx)*BD}
    if(B.x>FW+GD){B.x=FW+GD-BR;if(B.vx>0)B.vx=-Math.abs(B.vx)*BD}
}

function findMate(pid){
    var me=P[pid];if(!me)return null;
    var best=null,bd=1e9;
    for(var p in P){
        if(p===pid||P[p].team!==me.team||P[p].team==='spectator')continue;
        var d=dst(me.x,me.y,P[p].x,P[p].y);
        if(d<bd){bd=d;best=p}
    }
    return best;
}

// ============================================================
// GOL
// ============================================================
function hGoal(tm){
    gF=true;gC=GRD;
    if(tm==='red'){rS++;$('goalText').textContent='üî¥ GOL!';$('goalText').style.color='#e74c3c'}
    else{bS++;$('goalText').textContent='üîµ GOL!';$('goalText').style.color='#3498db'}
    $('goalOverlay').style.display='flex';
    B.vx=0;B.vy=0;B.fire=false;B.ft=0;
    for(var pid in P){P[pid].vx=0;P[pid].vy=0;P[pid].kickHeld=0}
    if(roomRef)roomRef.update({'match/redScore':rS,'match/blueScore':bS});
    if(gLim>0&&(rS>=gLim||bS>=gLim)){
        setTimeout(function(){
            mR=false;$('goalOverlay').style.display='none';
            $('winText').textContent='üèÜ '+(rS>=gLim?'KIRMIZI':'MAVƒ∞')+' KAZANDI!';
            $('winText').style.color=rS>=gLim?'#e74c3c':'#3498db';
            $('winSub').textContent=rS+' - '+bS;
            $('winOverlay').style.display='flex';
            if(roomRef)roomRef.update({'match/running':false});
        },GRD+200);
    }
}

$('winBtn').onclick=function(){
    $('winOverlay').style.display='none';
    if(isHost&&roomRef){roomRef.update({state:'lobby','match/running':false,'match/paused':false});stopL();showScr('lobby')}
};

function resetP(){
    B.x=cm.fw/2;B.y=cm.fh/2;B.vx=0;B.vy=0;B.fire=false;B.ft=0;
    var rP=[],bP=[];
    for(var p in P){if(P[p].team==='red')rP.push(p);else if(P[p].team==='blue')bP.push(p)}
    spGrp(rP,'red');spGrp(bP,'blue');
}
function spGrp(pids,tm){
    var g={GK:[],DEF:[],MID:[],FWD:[]};
    for(var i=0;i<pids.length;i++){var ps=P[pids[i]].pos||'MID';if(!g[ps])g[ps]=[];g[ps].push(pids[i])}
    for(var pk in g){var a=g[pk];for(var j=0;j<a.length;j++){var s=spPos(tm,pk,j,a.length,cm);P[a[j]].x=s.x;P[a[j]].y=s.y;P[a[j]].vx=0;P[a[j]].vy=0;P[a[j]].kickHeld=0}}
}

// ============================================================
// RENDER - OPTƒ∞Mƒ∞ZE
// ============================================================
function render(){
    ctx.clearRect(0,0,cW,cH);
    ctx.fillStyle=cm.bg;ctx.fillRect(0,0,cW,cH);
    ctx.save();
    ctx.translate(vOX,vOY);ctx.scale(vS,vS);ctx.translate(FM,FM);
    drawField();drawFire();drawBall();drawPlayers();
    ctx.restore();
    updateHUD();
}

function drawField(){
    var FW=cm.fw,FH=cm.fh,GH=cm.gh,GD=cm.gd,gT=FH/2-GH/2,gB=FH/2+GH/2,lc=cm.lc;
    ctx.fillStyle=cm.f1;ctx.fillRect(0,0,FW,FH);
    ctx.fillStyle=cm.f2;var sw=FW/10;
    for(var i=0;i<10;i+=2)ctx.fillRect(i*sw,0,sw,FH);
    ctx.strokeStyle=lc;ctx.lineWidth=3;
    ctx.strokeRect(2,2,FW-4,FH-4);
    ctx.beginPath();ctx.moveTo(FW/2,0);ctx.lineTo(FW/2,FH);ctx.stroke();
    ctx.beginPath();ctx.arc(FW/2,FH/2,cm.cr,0,Math.PI*2);ctx.stroke();
    ctx.fillStyle=lc;ctx.beginPath();ctx.arc(FW/2,FH/2,4,0,Math.PI*2);ctx.fill();
    ctx.lineWidth=2;
    ctx.strokeRect(0,FH/2-cm.ph/2,cm.pw,cm.ph);
    ctx.strokeRect(FW-cm.pw,FH/2-cm.ph/2,cm.pw,cm.ph);
    // Kale - kƒ±rmƒ±zƒ±
    ctx.fillStyle='rgba(231,76,60,.06)';ctx.fillRect(-GD,gT,GD,GH);
    ctx.strokeStyle='rgba(231,76,60,.65)';ctx.lineWidth=3;
    ctx.beginPath();ctx.moveTo(0,gT);ctx.lineTo(-GD,gT);ctx.lineTo(-GD,gB);ctx.lineTo(0,gB);ctx.stroke();
    // Kale - mavi
    ctx.fillStyle='rgba(52,152,219,.06)';ctx.fillRect(FW,gT,GD,GH);
    ctx.strokeStyle='rgba(52,152,219,.65)';
    ctx.beginPath();ctx.moveTo(FW,gT);ctx.lineTo(FW+GD,gT);ctx.lineTo(FW+GD,gB);ctx.lineTo(FW,gB);ctx.stroke();
    // Direkler
    ctx.fillStyle='#ddd';
    [[0,gT],[0,gB],[FW,gT],[FW,gB]].forEach(function(pp){ctx.beginPath();ctx.arc(pp[0],pp[1],PSR,0,Math.PI*2);ctx.fill()});
}

function drawFire(){
    if(fireParts.length===0)return;
    for(var i=0;i<fireParts.length;i++){
        var fp=fireParts[i];
        ctx.globalAlpha=fp.life/15;ctx.fillStyle=fp.c;
        ctx.fillRect(fp.x-fp.sz/2,fp.y-fp.sz/2,fp.sz,fp.sz);
    }
    ctx.globalAlpha=1;
}

function drawBall(){
    // G√∂lge
    ctx.fillStyle='rgba(0,0,0,.15)';
    ctx.beginPath();ctx.arc(B.x+2,B.y+3,BR,0,Math.PI*2);ctx.fill();
    // Ate≈ü parlamasƒ±
    if(B.fire){ctx.fillStyle='rgba(255,100,0,.22)';ctx.beginPath();ctx.arc(B.x,B.y,BR*1.7,0,Math.PI*2);ctx.fill()}
    // Top
    ctx.fillStyle=B.fire?'#ffaa00':'#fff';
    ctx.beginPath();ctx.arc(B.x,B.y,BR,0,Math.PI*2);ctx.fill();
    ctx.strokeStyle=B.fire?'#ff4400':'#999';ctx.lineWidth=1.5;
    ctx.beginPath();ctx.arc(B.x,B.y,BR,0,Math.PI*2);ctx.stroke();
    // Desen
    ctx.strokeStyle=B.fire?'rgba(255,50,0,.4)':'rgba(0,0,0,.12)';ctx.lineWidth=1;
    ctx.beginPath();ctx.arc(B.x,B.y,BR*.6,0,Math.PI*2);ctx.stroke();
}

function drawPlayers(){
    var psl={GK:'GK',DEF:'DF',MID:'MF',FWD:'FW'};
    var sz=PR*2+6;
    for(var pid in P){
        var p=P[pid];if(p.team==='spectator')continue;
        var isMe=(pid===myId);
        // Vuru≈ü √ßemberi - k√º√ß√ºlt√ºld√º (sadece temas mesafesi g√∂ster)
        if(p.kick){
            ctx.strokeStyle=p.team==='red'?'rgba(255,80,80,.35)':'rgba(80,160,255,.35)';
            ctx.lineWidth=1.5;
            ctx.beginPath();ctx.arc(p.x,p.y,PR+BR+2,0,Math.PI*2);ctx.stroke();
        }
        // Oyuncu
        var img=p.team==='red'?redPlayerImg:bluePlayerImg;
        ctx.drawImage(img,p.x-sz/2,p.y-sz/2);
        // Kendi oyuncu border
        if(isMe){ctx.strokeStyle='rgba(255,255,255,.9)';ctx.lineWidth=2;ctx.beginPath();ctx.arc(p.x,p.y,PR+1,0,Math.PI*2);ctx.stroke()}
        // Mevki
        if(p.pos&&psl[p.pos]){
            ctx.fillStyle='rgba(255,255,255,.65)';ctx.font='bold 8px Arial';
            ctx.textAlign='center';ctx.textBaseline='middle';
            ctx.fillText(psl[p.pos],p.x,p.y);
        }
        // ƒ∞sim
        ctx.fillStyle='#fff';ctx.font='bold 9px Arial';ctx.textAlign='center';ctx.textBaseline='bottom';
        ctx.fillText(p.name||'?',p.x,p.y-PR-3);
        if(isMe){ctx.fillStyle='rgba(255,255,255,.5)';ctx.font='7px Arial';ctx.fillText('‚ñº',p.x,p.y-PR-12)}
        // Emoji bubble
        if(pBubs[pid]){ctx.font='14px Arial';ctx.textAlign='center';ctx.textBaseline='bottom';ctx.fillText(pBubs[pid].text,p.x,p.y-PR-17)}
    }
}

function updateHUD(){
    $('hudR').textContent=rS;$('hudB').textContent=bS;
    var m=Math.floor(mT/60),s=Math.floor(mT%60);
    $('hudT').textContent=m+':'+(s<10?'0':'')+s;
    if(mP)$('hudS').textContent='DURAKLADI';
    else if(!mR&&mT>=MDR)$('hudS').textContent='Bƒ∞TTƒ∞';
    else if(gF)$('hudS').textContent='GOL!';
    else $('hudS').textContent=gLim?gLim+' GOL':'';
}

// ============================================================
// ADMIN PANELƒ∞
// ============================================================
function buildAdm(){
    if(!isHost)return;
    var mc=$('adminMenuContent');
    // √ñnce temizle (memory leak √∂nlemi)
    mc.innerHTML='';

    var mo='';for(var mk in MAPS)mo+='<option value="'+mk+'"'+(mk===cmk?' selected':'')+'>'+MAPS[mk].name+'</option>';
    var pl2={GK:'KAL',DEF:'DEF',MID:'ORS',FWD:'FRV'},ph='';

    if(roomData&&roomData.players){
        for(var pid in roomData.players){
            var p=roomData.players[pid];if(p.online===false)continue;
            var tc=p.team==='red'?'#e74c3c':(p.team==='blue'?'#3498db':'#888');
            var po='<option value="">-</option>';
            ['GK','DEF','MID','FWD'].forEach(function(pp){po+='<option value="'+pp+'"'+(p.pos===pp?' selected':'')+'>'+pl2[pp]+'</option>'});
            ph+='<div class="apr"><span class="an" style="color:'+tc+'">'+(p.name||'?')+'</span><button style="background:#e74c3c" data-mp="'+pid+'" data-ma="red">K</button><button style="background:#3498db" data-mp="'+pid+'" data-ma="blue">M</button><button style="background:#555" data-mp="'+pid+'" data-ma="spectator">ƒ∞</button><select data-mp="'+pid+'" data-mt="pos">'+po+'</select></div>';
        }
    }

    mc.innerHTML='<div class="sec">KONTROL</div><button style="background:#f39c12" id="admP">'+(mP?'‚ñ∂':'‚è∏')+'</button><button style="background:#e74c3c" id="admR">üîÑ Sƒ±fƒ±rla</button><button style="background:#3498db" id="admL">üîô Lobi</button><div class="sec">HARƒ∞TA</div><select id="admMS">'+mo+'</select><button style="background:#27ae60" id="admMA">‚úÖ</button><div class="sec">OYUNCULAR</div>'+ph;

    $('admP').onclick=function(){mP=!mP;roomRef.update({'match/paused':mP});$('admP').textContent=mP?'‚ñ∂':'‚è∏'};
    $('admR').onclick=function(){rS=0;bS=0;mT=0;roomRef.update({'match/redScore':0,'match/blueScore':0,'match/time':0});resetP()};
    $('admL').onclick=function(){mR=false;mP=false;gF=false;roomRef.update({state:'lobby','match/running':false,'match/paused':false});stopL();showScr('lobby')};
    $('admMA').onclick=function(){var nk=$('admMS').value;if(nk===cmk)return;cmk=nk;cm=MAPS[cmk];roomRef.update({mapKey:cmk,'match/ball':{x:cm.fw/2,y:cm.fh/2,vx:0,vy:0,fire:false}});B.x=cm.fw/2;B.y=cm.fh/2;B.vx=0;B.vy=0;B.fire=false;resetP();resC()};

    mc.querySelectorAll('[data-ma]').forEach(function(b){
        b.onclick=function(){
            var tp=b.getAttribute('data-mp'),ta=b.getAttribute('data-ma');
            if(ta==='spectator')roomRef.child('players/'+tp).update({team:'spectator',pos:''});
            else{if(tmSz(roomData.players,ta)>=11)return;roomRef.child('players/'+tp).update({team:ta,pos:aPos(roomData.players,ta,tp)})}
            setTimeout(buildAdm,400);
        };
    });
    mc.querySelectorAll('[data-mt="pos"]').forEach(function(sel){
        sel.onchange=function(){
            var tp=sel.getAttribute('data-mp'),np=sel.value;
            roomRef.child('players/'+tp).update({pos:np});
            if(P[tp]&&np){var s=spPos(P[tp].team,np,0,1,cm);P[tp].x=s.x;P[tp].y=s.y;P[tp].vx=0;P[tp].vy=0;P[tp].pos=np}
        };
    });
}

$('adminToggleBtn').onclick=function(e){
    e.stopPropagation();admO=!admO;
    $('adminMenuContent').style.display=admO?'block':'none';
    if(admO)buildAdm();
};
['touchstart','touchmove','touchend'].forEach(function(ev){
    $('adminPanelGame').addEventListener(ev,function(e){e.stopPropagation()},{passive:false});
});

// ============================================================
// JOYSTƒ∞CK
// ============================================================
var jZ=$('joyZone'),jBs=$('joyBase'),jTh=$('joyThumb');
jZ.addEventListener('touchstart',function(e){
    e.preventDefault();
    if(jTid!==null)return;
    var t=e.changedTouches[0];jTid=t.identifier;jA=true;
    var r=jBs.getBoundingClientRect();
    jSX=r.left+r.width/2;jSY=r.top+r.height/2;
    updJ(t.clientX,t.clientY);
},{passive:false});
jZ.addEventListener('touchmove',function(e){
    e.preventDefault();
    for(var i=0;i<e.changedTouches.length;i++){
        if(e.changedTouches[i].identifier===jTid)updJ(e.changedTouches[i].clientX,e.changedTouches[i].clientY);
    }
},{passive:false});
jZ.addEventListener('touchend',function(e){
    e.preventDefault();
    for(var i=0;i<e.changedTouches.length;i++){
        if(e.changedTouches[i].identifier===jTid){jTid=null;jA=false;myIn.dx=0;myIn.dy=0;jTh.style.display='none'}
    }
},{passive:false});
jZ.addEventListener('touchcancel',function(e){
    for(var i=0;i<e.changedTouches.length;i++){
        if(e.changedTouches[i].identifier===jTid){jTid=null;jA=false;myIn.dx=0;myIn.dy=0;jTh.style.display='none'}
    }
},{passive:false});
function updJ(tx,ty){
    var dx=tx-jSX,dy=ty-jSY,mx=48,d=Math.sqrt(dx*dx+dy*dy);
    var cd=Math.min(d,mx),a=Math.atan2(dy,dx);
    myIn.dx=Math.cos(a)*cd/mx;myIn.dy=Math.sin(a)*cd/mx;
    jTh.style.display='block';
    jTh.style.left=(jSX+Math.cos(a)*cd-25)+'px';
    jTh.style.top=(jSY+Math.sin(a)*cd-25)+'px';
}

// ============================================================
// AKSƒ∞YON BUTONLARI
// ============================================================
$('btnKick').addEventListener('touchstart',function(e){e.preventDefault();e.stopPropagation();kH=true;$('btnKick').classList.add('active')},{passive:false});
$('btnKick').addEventListener('touchend',function(e){e.preventDefault();e.stopPropagation();kH=false;$('btnKick').classList.remove('active')},{passive:false});
$('btnKick').addEventListener('touchcancel',function(){kH=false;$('btnKick').classList.remove('active')});

$('btnPass').addEventListener('touchstart',function(e){e.preventDefault();e.stopPropagation();pH=true;kH=true;$('btnPass').classList.add('active')},{passive:false});
$('btnPass').addEventListener('touchend',function(e){e.preventDefault();e.stopPropagation();pH=false;kH=false;$('btnPass').classList.remove('active')},{passive:false});
$('btnPass').addEventListener('touchcancel',function(){pH=false;kH=false;$('btnPass').classList.remove('active')});

$('btnPower').addEventListener('touchstart',function(e){
    e.preventDefault();e.stopPropagation();
    if(pwCD<=0){pwP=true;kH=true;$('btnPower').classList.add('active')}
    else toast(Math.ceil(pwCD/60)+'s bekle');
},{passive:false});
$('btnPower').addEventListener('touchend',function(e){e.preventDefault();e.stopPropagation();kH=false;$('btnPower').classList.remove('active')},{passive:false});
$('btnPower').addEventListener('touchcancel',function(){kH=false;$('btnPower').classList.remove('active')});

// ============================================================
// EMOJƒ∞ & CHAT
// ============================================================
document.querySelectorAll('.emoji-btn').forEach(function(btn){
    btn.addEventListener('touchstart',function(e){
        e.preventDefault();e.stopPropagation();
        var em=btn.getAttribute('data-e');if(!em||!roomRef)return;
        pBubs[myId]={text:em,timer:150};
        roomRef.child('players/'+myId).update({emoji:em});
        setTimeout(function(){if(roomRef)roomRef.child('players/'+myId).update({emoji:''})},2500);
        roomRef.child('chat').push({pid:myId,name:myName,msg:em,t:Date.now()});
    },{passive:false});
});

var chatO=false;
function toggleChat(){chatO=!chatO;$('chatPanel').style.display=chatO?'flex':'none'}
$('chatToggle').addEventListener('touchstart',function(e){e.preventDefault();e.stopPropagation();toggleChat()},{passive:false});
$('chatToggle').addEventListener('click',function(e){e.stopPropagation();toggleChat()});

document.querySelectorAll('.cm').forEach(function(btn){
    var handler=function(e){
        e.preventDefault();e.stopPropagation();
        var msg=btn.getAttribute('data-m');if(!msg||!roomRef)return;
        pBubs[myId]={text:msg,timer:180};
        roomRef.child('players/'+myId).update({emoji:msg});
        setTimeout(function(){if(roomRef)roomRef.child('players/'+myId).update({emoji:''})},3000);
        roomRef.child('chat').push({pid:myId,name:myName,msg:msg,t:Date.now()});
        chatO=false;$('chatPanel').style.display='none';
    };
    btn.addEventListener('touchstart',handler,{passive:false});
    btn.addEventListener('click',handler);
});
$('chatPanel').addEventListener('touchstart',function(e){e.stopPropagation()},{passive:false});

// ============================================================
// KLAVYE KONTROL√ú
// ============================================================
document.addEventListener('keydown',function(e){
    if(gameState!=='game')return;
    var k=e.key.toLowerCase();keys[k]=true;
    if(k===' '||k==='x')kH=true;
    if(k==='z'){pH=true;kH=true}
    if(k==='c'&&pwCD<=0){pwP=true;kH=true}
    updK();
});
document.addEventListener('keyup',function(e){
    var k=e.key.toLowerCase();keys[k]=false;
    if(k===' '||k==='x')kH=false;
    if(k==='z'){pH=false;kH=false}
    if(k==='c')kH=false;
    updK();
});
function updK(){
    if(jA)return;
    var dx=0,dy=0;
    if(keys['w']||keys['arrowup'])dy=-1;
    if(keys['s']||keys['arrowdown'])dy=1;
    if(keys['a']||keys['arrowleft'])dx=-1;
    if(keys['d']||keys['arrowright'])dx=1;
    myIn.dx=dx;myIn.dy=dy;
}
document.addEventListener('click',function(){if(gameState==='game')canvas.focus()});

// ============================================================
// SAYFA KAPAT
// ============================================================
window.addEventListener('beforeunload',function(){
    if(roomRef)roomRef.child('players/'+myId).update({online:false});
});

// ============================================================
// BA≈ûLAT
// ============================================================
$('inpName').value='Oyuncu'+Math.floor(Math.random()*900+100);
showScr('menu');

})();
</script>
</body>
</html>
