<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
<title>HaxBall Arena</title>
<style>
*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent;user-select:none;-webkit-user-select:none}
html,body{width:100%;height:100%;overflow:hidden;background:#2b5c3a;font-family:'Segoe UI',Arial,sans-serif;color:#fff;touch-action:none}
canvas#field{position:fixed;top:0;left:0;z-index:1}

#rotate-msg{position:fixed;top:0;left:0;width:100%;height:100%;z-index:9999;background:#1a3d24;display:none;flex-direction:column;align-items:center;justify-content:center;font-size:16px;color:#8fc49f;text-align:center;padding:30px}
#rotate-msg .ri{font-size:50px;margin-bottom:15px;animation:rotspin 2s ease-in-out infinite}
@keyframes rotspin{0%,100%{transform:rotate(0)}50%{transform:rotate(90deg)}}
@media(orientation:portrait){#rotate-msg{display:flex!important}}

#score-hud{position:fixed;top:0;left:50%;transform:translateX(-50%);z-index:80;display:none;align-items:center;gap:0;font-weight:900}
#score-hud .ts{padding:8px 22px;font-size:28px;min-width:60px;text-align:center}
#score-hud .rsc{background:rgba(220,50,50,.85);border-radius:0 0 0 10px;color:#fff}
#score-hud .bsc{background:rgba(50,100,220,.85);border-radius:0 0 10px 0;color:#fff}
#score-hud .dv{background:rgba(0,0,0,.6);padding:6px 10px;font-size:14px;color:rgba(255,255,255,.5);letter-spacing:2px}

#win-target{position:fixed;top:44px;left:50%;transform:translateX(-50%);z-index:80;display:none;font-size:10px;color:rgba(255,255,255,.3);letter-spacing:1px;background:rgba(0,0,0,.25);padding:2px 10px;border-radius:3px}

#goal-overlay{position:fixed;top:0;left:0;width:100%;height:100%;z-index:100;display:none;align-items:center;justify-content:center;pointer-events:none;flex-direction:column}
#goal-text{font-size:clamp(40px,10vw,80px);font-weight:900;letter-spacing:8px;text-shadow:0 4px 20px rgba(0,0,0,.5);animation:goalPop .5s ease}
#goal-sub{font-size:16px;color:rgba(255,255,255,.5);margin-top:5px;letter-spacing:3px}
@keyframes goalPop{0%{transform:scale(0);opacity:0}50%{transform:scale(1.2)}100%{transform:scale(1);opacity:1}}

#win-screen{position:fixed;top:0;left:0;width:100%;height:100%;z-index:200;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.8);flex-direction:column;backdrop-filter:blur(5px)}
#win-screen .wt{font-size:clamp(28px,6vw,52px);font-weight:900;letter-spacing:5px;margin-bottom:8px}
#win-screen .wt.red{color:#ff4444;text-shadow:0 0 30px rgba(255,0,0,.4)}
#win-screen .wt.blue{color:#4488ff;text-shadow:0 0 30px rgba(0,100,255,.4)}
#win-screen .ws{font-size:20px;color:rgba(255,255,255,.5);margin-bottom:20px}

#joy-zone{position:fixed;bottom:15px;left:15px;z-index:70;display:none;pointer-events:all;width:160px;height:160px}
#joy-base{width:130px;height:130px;border-radius:50%;background:rgba(255,255,255,.06);border:2px solid rgba(255,255,255,.12);position:absolute;bottom:10px;left:10px}
#joy-knob{width:54px;height:54px;border-radius:50%;background:rgba(255,255,255,.15);border:2px solid rgba(255,255,255,.2);position:absolute;top:50%;left:50%;transform:translate(-50%,-50%)}

#kick-btn{position:fixed;bottom:30px;right:30px;z-index:70;display:none;pointer-events:all;width:85px;height:85px;border-radius:50%;background:rgba(255,255,255,.1);border:3px solid rgba(255,255,255,.25);color:rgba(255,255,255,.7);font-size:13px;font-weight:900;letter-spacing:1px;cursor:pointer;line-height:85px;text-align:center;font-family:inherit}
#kick-btn:active,#kick-btn.active{background:rgba(255,255,255,.25);border-color:rgba(255,255,255,.5);transform:scale(.92)}

#pinfo{position:fixed;bottom:8px;left:50%;transform:translateX(-50%);z-index:75;display:none;font-size:10px;color:rgba(255,255,255,.3);letter-spacing:1px;background:rgba(0,0,0,.2);padding:3px 10px;border-radius:4px;pointer-events:none}

/* MENU */
#menu{position:fixed;top:0;left:0;width:100%;height:100%;z-index:200;display:flex;flex-direction:column;align-items:center;justify-content:center;background:linear-gradient(135deg,#1a3d24,#2b5c3a,#1e4a2d)}
.mbg{position:absolute;top:0;left:0;width:100%;height:100%;opacity:.15;background-image:radial-gradient(rgba(255,255,255,.08) 1px,transparent 1px);background-size:25px 25px}
.mt{font-size:clamp(28px,6vw,48px);font-weight:900;letter-spacing:3px;color:#fff;text-shadow:0 2px 10px rgba(0,0,0,.3);z-index:1;text-align:center}
.ms{font-size:clamp(10px,2vw,14px);letter-spacing:5px;color:rgba(255,255,255,.3);z-index:1;margin-bottom:25px;text-transform:uppercase}
.mball{font-size:50px;margin-bottom:10px;z-index:1;animation:bounce 1s ease-in-out infinite}
@keyframes bounce{0%,100%{transform:translateY(0)}50%{transform:translateY(-10px)}}
.mi{background:rgba(255,255,255,.08);border:1px solid rgba(255,255,255,.2);border-radius:8px;padding:11px 18px;color:#fff;font-size:15px;width:250px;margin-bottom:8px;z-index:1;outline:none;text-align:center;font-family:inherit}
.mi:focus{border-color:rgba(255,255,255,.5)}
.mi::placeholder{color:rgba(255,255,255,.2)}
.mb{background:rgba(255,255,255,.1);border:1px solid rgba(255,255,255,.25);border-radius:8px;padding:12px 30px;color:#fff;font-size:14px;font-weight:700;cursor:pointer;letter-spacing:2px;text-transform:uppercase;z-index:1;transition:all .2s;margin:4px;min-width:210px;font-family:inherit;pointer-events:all}
.mb:active{background:rgba(255,255,255,.2);transform:scale(.97)}
.mb.red{background:rgba(220,50,50,.3);border-color:rgba(220,50,50,.5);color:#ff8888}
.mb.blue{background:rgba(50,100,220,.3);border-color:rgba(50,100,220,.5);color:#88aaff}
.mb.sec{opacity:.6}
.mb.sm{min-width:auto;padding:8px 16px;font-size:11px}
.mb.danger{background:rgba(220,50,50,.2);border-color:rgba(220,50,50,.4);color:#ff6666}
#mst{margin-top:10px;font-size:11px;color:rgba(255,255,255,.25);z-index:1;min-height:16px;text-align:center}

/* LOBBY */
#lobby{position:fixed;top:0;left:0;width:100%;height:100%;z-index:200;display:none;flex-direction:column;align-items:center;justify-content:center;background:linear-gradient(135deg,#1a3d24,#2b5c3a)}
.lc{font-size:30px;font-weight:900;letter-spacing:8px;color:#fff;background:rgba(255,255,255,.1);border:1px solid rgba(255,255,255,.2);border-radius:8px;padding:8px 22px;margin:8px 0;z-index:1}
#plist{z-index:1;margin:12px 0;text-align:center;display:flex;gap:30px}
.tcol{min-width:110px}
.tcol .th{font-size:11px;font-weight:700;letter-spacing:2px;margin-bottom:6px;padding-bottom:4px;border-bottom:2px solid rgba(255,255,255,.1)}
.tcol.rc .th{color:#ff6666;border-color:rgba(220,50,50,.3)}
.tcol.bc .th{color:#6688ff;border-color:rgba(50,100,220,.3)}
.pli{font-size:12px;color:rgba(255,255,255,.5);margin:3px 0;letter-spacing:1px;display:flex;align-items:center;justify-content:center;gap:6px}
.pli.self{font-weight:700}
.tcol.rc .pli.self{color:#ff8888}
.tcol.bc .pli.self{color:#88aaff}
.pli .admin-btn{font-size:9px;background:rgba(255,255,255,.1);border:1px solid rgba(255,255,255,.15);border-radius:3px;padding:1px 5px;cursor:pointer;color:rgba(255,255,255,.4);pointer-events:all}
.pli .admin-btn:active{background:rgba(255,255,255,.2)}

/* Admin panel */
#admin-panel{position:fixed;top:8px;left:8px;z-index:85;display:none;pointer-events:all}
#admin-panel button{display:block;margin:2px 0}

/* Settings dropdown in lobby */
#settings-panel{z-index:1;display:none;background:rgba(0,0,0,.3);border:1px solid rgba(255,255,255,.1);border-radius:8px;padding:12px 18px;margin:10px 0;width:280px}
#settings-panel .sh{font-size:11px;color:rgba(255,255,255,.5);letter-spacing:2px;margin-bottom:8px;text-transform:uppercase}
.srow{display:flex;align-items:center;justify-content:space-between;margin-bottom:6px;font-size:12px;color:rgba(255,255,255,.5)}
.srow select,.srow input{background:rgba(255,255,255,.08);border:1px solid rgba(255,255,255,.15);color:#fff;border-radius:4px;padding:4px 8px;font-size:12px;font-family:inherit;outline:none}
</style>
</head>
<body>
<div id="rotate-msg"><div class="ri">ğŸ“±</div>LÃ¼tfen cihazÄ± yatay Ã§evirin</div>

<canvas id="field"></canvas>

<div id="score-hud">
  <div class="ts rsc" id="rsc">0</div>
  <div class="dv">VS</div>
  <div class="ts bsc" id="bsc">0</div>
</div>
<div id="win-target">20 GOL</div>

<div id="goal-overlay"><div id="goal-text">GOL!</div><div id="goal-sub"></div></div>

<div id="win-screen">
  <div class="wt" id="win-text">KIRMIZI KAZANDI!</div>
  <div class="ws" id="win-score">10 - 5</div>
  <button class="mb" onclick="backToMenu()">ANA MENÃœ</button>
</div>

<div id="pinfo"></div>

<div id="joy-zone"><div id="joy-base"><div id="joy-knob"></div></div></div>
<div id="kick-btn">VURUÅ</div>

<!-- Host admin panel (in-game) -->
<div id="admin-panel">
  <button class="mb sm danger" id="btn-endgame">â¹ BÄ°TÄ°R</button>
</div>

<!-- MENU -->
<div id="menu">
  <div class="mbg"></div>
  <div class="mball">âš½</div>
  <div class="mt">HAXBALL</div>
  <div class="ms">A R E N A</div>
  <input type="text" id="inp-name" class="mi" placeholder="Oyuncu AdÄ±n" maxlength="12">
  <button class="mb" id="btn-host">âš¡ ODA KUR</button>
  <input type="text" id="inp-code" class="mi" placeholder="Oda Kodu" maxlength="6" style="text-transform:uppercase;margin-top:6px">
  <button class="mb sec" id="btn-join">â†’ ODAYA KATIL</button>
  <div id="mst"></div>
</div>

<!-- LOBBY -->
<div id="lobby">
  <div class="mbg"></div>
  <div class="mt" style="font-size:24px">âš½ HAXBALL ARENA</div>
  <div style="font-size:10px;color:rgba(255,255,255,.2);z-index:1;margin:6px 0;letter-spacing:2px">ODA KODU</div>
  <div class="lc" id="lob-code">-----</div>

  <div id="plist">
    <div class="tcol rc"><div class="th">ğŸ”´ KIRMIZI</div><div id="red-list"></div></div>
    <div class="tcol bc"><div class="th">ğŸ”µ MAVÄ°</div><div id="blue-list"></div></div>
  </div>

  <div style="display:flex;gap:8px;z-index:1;margin:6px 0">
    <button class="mb sm red" onclick="switchTeam('red')">KIRMIZI</button>
    <button class="mb sm blue" onclick="switchTeam('blue')">MAVÄ°</button>
  </div>

  <!-- Settings (host only) -->
  <div id="settings-panel">
    <div class="sh">âš™ï¸ AYARLAR (Admin)</div>
    <div class="srow"><span>Kazanma Skoru</span><select id="set-winscore"><option value="5">5</option><option value="10">10</option><option value="15">15</option><option value="20" selected>20</option><option value="50">50</option></select></div>
  </div>

  <button class="mb" id="btn-start" style="display:none;margin-top:6px">â–¶ BAÅLAT</button>
  <button class="mb sec" id="btn-leave" style="margin-top:4px;font-size:11px">âœ• AYRIL</button>
</div>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<script>
firebase.initializeApp({
  apiKey: "AIzaSyDHIFw7LYjMTpRMpe-ONkSm91fdXk4JWY4",
    authDomain: "gravityarena-14578.firebaseapp.com",
    databaseURL: "https://gravityarena-14578-default-rtdb.europe-west1.firebasedatabase.app",
    projectId: "gravityarena-14578",
    storageBucket: "gravityarena-14578.firebasestorage.app",
    messagingSenderId: "781898977885",
    appId: "1:781898977885:web:a047f4ed10ef296bee73b4",
});
const db=firebase.database();

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PHYSICS CONSTANTS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const ACCEL=0.1;
const FRIC=0.96;
const MAX_SPD=4.5;
const KICK_F=8;
const KICK_RNG=6;
const BALL_FRIC=0.985;
const BALL_MAX=15;
const BALL_BNC=0.7;
const PLR_R=15;
const BALL_R=10;
const PLR_M=1;
const BALL_M=0.5;
const PLR_PLR_BOUNCE=0.5;

// Field
const FW=900,FH=480,BRD=30;
const GOAL_W=12,GOAL_H=110,CORNER_R=40;
const GT=FH/2-GOAL_H/2,GB=FH/2+GOAL_H/2;

// Sync
const SYNC_MS=40,LERP_F=0.15;

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// STATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let state='menu';
let roomId=null,myId=null,myName='Player',isHost=false;
let roomRef=null;
let cvs,ctx;
let winScore=20;
let hostId=null;

// Player
let me={x:300,y:FH/2,vx:0,vy:0,team:'red',kicking:false,num:1};
let kickPressed=false;

// Ball
let ball={x:FW/2,y:FH/2,vx:0,vy:0};
let ballTarget={x:FW/2,y:FH/2};

// Remote
let rPlayers={};
let allPlayersData={};
let redScore=0,blueScore=0;
let goalCD=0;
let lastGoalTeam=null;

// Joy
let joyTid=null,joyOX=0,joyOY=0,joyDX=0,joyDY=0;

// Keys
let keys={};

// Cam
let camScale=1;

// Sync
let lastSync=0;

// Audio
let audioCtx=null;

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// AUDIO
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function initAudio(){if(audioCtx)return;try{audioCtx=new(window.AudioContext||window.webkitAudioContext)()}catch(e){}}
function snd(type){
  if(!audioCtx)return;
  try{
    const t=audioCtx.currentTime;
    if(type==='kick'){
      const o=audioCtx.createOscillator(),g=audioCtx.createGain();
      o.type='triangle';o.frequency.setValueAtTime(300,t);o.frequency.exponentialRampToValueAtTime(100,t+.08);
      g.gain.setValueAtTime(.15,t);g.gain.exponentialRampToValueAtTime(.001,t+.1);
      o.connect(g);g.connect(audioCtx.destination);o.start(t);o.stop(t+.1);
    }else if(type==='wall'){
      const o=audioCtx.createOscillator(),g=audioCtx.createGain();
      o.type='sine';o.frequency.value=800+Math.random()*400;
      g.gain.setValueAtTime(.06,t);g.gain.exponentialRampToValueAtTime(.001,t+.04);
      o.connect(g);g.connect(audioCtx.destination);o.start(t);o.stop(t+.04);
    }else if(type==='goal'){
      [523,659,784,1047].forEach((f,i)=>{
        const o=audioCtx.createOscillator(),g=audioCtx.createGain();
        o.type='sine';o.frequency.value=f;
        g.gain.setValueAtTime(.12,t+i*.1);g.gain.exponentialRampToValueAtTime(.001,t+i*.1+.2);
        o.connect(g);g.connect(audioCtx.destination);o.start(t+i*.1);o.stop(t+i*.1+.2);
      });
    }else if(type==='whistle'){
      const o=audioCtx.createOscillator(),g=audioCtx.createGain();
      o.type='sine';o.frequency.setValueAtTime(900,t);o.frequency.setValueAtTime(700,t+.15);o.frequency.setValueAtTime(900,t+.3);
      g.gain.setValueAtTime(.1,t);g.gain.exponentialRampToValueAtTime(.001,t+.5);
      o.connect(g);g.connect(audioCtx.destination);o.start(t);o.stop(t+.5);
    }else if(type==='bump'){
      const o=audioCtx.createOscillator(),g=audioCtx.createGain();
      o.type='sine';o.frequency.value=200;
      g.gain.setValueAtTime(.04,t);g.gain.exponentialRampToValueAtTime(.001,t+.05);
      o.connect(g);g.connect(audioCtx.destination);o.start(t);o.stop(t+.05);
    }else if(type==='win'){
      [523,659,784,1047,1319].forEach((f,i)=>{
        const o=audioCtx.createOscillator(),g=audioCtx.createGain();
        o.type='sine';o.frequency.value=f;
        g.gain.setValueAtTime(.1,t+i*.12);g.gain.exponentialRampToValueAtTime(.001,t+i*.12+.25);
        o.connect(g);g.connect(audioCtx.destination);o.start(t+i*.12);o.stop(t+i*.12+.25);
      });
    }
  }catch(e){}
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// HELPERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function genCode(){const c='ABCDEFGHJKLMNPQRSTUVWXYZ23456789';let r='';for(let i=0;i<4;i++)r+=c[Math.floor(Math.random()*c.length)];return r}
function setSt(m){document.getElementById('mst').textContent=m}
function sho(id,v){document.getElementById(id).style.display=v}
function dst(a,b){return Math.sqrt((a.x-b.x)**2+(a.y-b.y)**2)}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CANVAS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function initCanvas(){
  cvs=document.getElementById('field');
  ctx=cvs.getContext('2d');
  rsz();
  window.addEventListener('resize',rsz);
}
function rsz(){
  cvs.width=window.innerWidth;cvs.height=window.innerHeight;
  const sx=cvs.width/(FW+120),sy=cvs.height/(FH+80);
  camScale=Math.min(sx,sy);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CIRCLE-CIRCLE ELASTIC COLLISION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function circleCollide(a,ar,am,b,br,bm,restitution){
  const dx=b.x-a.x,dy=b.y-a.y;
  const d=Math.sqrt(dx*dx+dy*dy);
  const minD=ar+br;
  if(d<minD&&d>0.001){
    const nx=dx/d,ny=dy/d;
    const overlap=minD-d;
    const totalM=am+bm;
    a.x-=nx*overlap*(bm/totalM);
    a.y-=ny*overlap*(bm/totalM);
    b.x+=nx*overlap*(am/totalM);
    b.y+=ny*overlap*(am/totalM);
    const dvx=a.vx-b.vx,dvy=a.vy-b.vy;
    const dvn=dvx*nx+dvy*ny;
    if(dvn>0){
      const rest=restitution!==undefined?restitution:0.7;
      const j=-(1+rest)*dvn/totalM;
      a.vx+=j*bm*nx;a.vy+=j*bm*ny;
      b.vx-=j*am*nx;b.vy-=j*am*ny;
    }
    return true;
  }
  return false;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// FIELD COLLISION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function fieldCollide(obj,r){
  let bounced=false;
  const inGoalY=obj.y>GT&&obj.y<GB;

  if(!inGoalY||obj.x>BRD+GOAL_W){
    if(obj.x-r<BRD){obj.x=BRD+r;obj.vx=-obj.vx*BALL_BNC;bounced=true}
  }
  if(!inGoalY||obj.x<FW-BRD-GOAL_W){
    if(obj.x+r>FW-BRD){obj.x=FW-BRD-r;obj.vx=-obj.vx*BALL_BNC;bounced=true}
  }
  if(obj.y-r<BRD){obj.y=BRD+r;obj.vy=-obj.vy*BALL_BNC;bounced=true}
  if(obj.y+r>FH-BRD){obj.y=FH-BRD-r;obj.vy=-obj.vy*BALL_BNC;bounced=true}

  if(inGoalY){
    if(obj.x-r<BRD-GOAL_W){obj.x=BRD-GOAL_W+r;obj.vx=-obj.vx*BALL_BNC;bounced=true}
    if(obj.x+r>FW-BRD+GOAL_W){obj.x=FW-BRD+GOAL_W-r;obj.vx=-obj.vx*BALL_BNC;bounced=true}
  }

  // Goal posts
  [{x:BRD,y:GT},{x:BRD,y:GB},{x:FW-BRD,y:GT},{x:FW-BRD,y:GB}].forEach(p=>{
    const dx=obj.x-p.x,dy=obj.y-p.y,d=Math.sqrt(dx*dx+dy*dy);
    if(d<r+5&&d>0.01){
      const nx=dx/d,ny=dy/d;
      obj.x=p.x+nx*(r+5);obj.y=p.y+ny*(r+5);
      const vn=obj.vx*nx+obj.vy*ny;
      obj.vx-=2*vn*nx*(1-BALL_BNC*0.5);
      obj.vy-=2*vn*ny*(1-BALL_BNC*0.5);
      bounced=true;
    }
  });

  // Corners
  [{x:BRD,y:BRD},{x:FW-BRD,y:BRD},{x:BRD,y:FH-BRD},{x:FW-BRD,y:FH-BRD}].forEach(c=>{
    const isC=(
      (obj.x<BRD+CORNER_R&&obj.y<BRD+CORNER_R)||
      (obj.x>FW-BRD-CORNER_R&&obj.y<BRD+CORNER_R)||
      (obj.x<BRD+CORNER_R&&obj.y>FH-BRD-CORNER_R)||
      (obj.x>FW-BRD-CORNER_R&&obj.y>FH-BRD-CORNER_R)
    );
    if(isC){
      const d2=Math.sqrt((obj.x-c.x)**2+(obj.y-c.y)**2);
      if(d2>0.01&&d2<CORNER_R){
        const nx=(obj.x-c.x)/d2,ny=(obj.y-c.y)/d2;
        obj.x=c.x+nx*(CORNER_R+r);obj.y=c.y+ny*(CORNER_R+r);
        const vn=obj.vx*nx+obj.vy*ny;
        if(vn<0){obj.vx-=2*vn*nx*BALL_BNC;obj.vy-=2*vn*ny*BALL_BNC}
        bounced=true;
      }
    }
  });

  return bounced;
}

function playerFieldCollide(p){
  const r=PLR_R;
  if(p.x-r<BRD){p.x=BRD+r;p.vx=0}
  if(p.x+r>FW-BRD){p.x=FW-BRD-r;p.vx=0}
  if(p.y-r<BRD){p.y=BRD+r;p.vy=0}
  if(p.y+r>FH-BRD){p.y=FH-BRD-r;p.vy=0}

  [{x:BRD,y:GT},{x:BRD,y:GB},{x:FW-BRD,y:GT},{x:FW-BRD,y:GB}].forEach(post=>{
    const dx=p.x-post.x,dy=p.y-post.y,d=Math.sqrt(dx*dx+dy*dy);
    if(d<r+5&&d>0.01){
      const nx=dx/d,ny=dy/d;
      p.x=post.x+nx*(r+5);p.y=post.y+ny*(r+5);
      const vn=p.vx*nx+p.vy*ny;
      if(vn<0){p.vx-=vn*nx;p.vy-=vn*ny}
    }
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SPAWN POSITIONS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function getSpawnPositions(scoringTeam){
  // Scoring team's ball start: closer to their opponent's side (advantage)
  // Actually in Haxball, after goal the ball goes to center and
  // the team that conceded kicks off (ball closer to them)
  // Let's do: ball center, conceding team closer to ball

  const positions={red:[],blue:[]};
  const redPlayers=[];
  const bluePlayers=[];

  // Count players per team
  Object.keys(allPlayersData).forEach(pid=>{
    const p=allPlayersData[pid];
    if(p.team==='red') redPlayers.push(pid);
    else bluePlayers.push(pid);
  });

  // Red spawns on left side
  const redCount=redPlayers.length||1;
  const blueCount=bluePlayers.length||1;

  // If red scored, blue kicks off (blue closer to center)
  // If blue scored, red kicks off (red closer to center)
  const redBaseX = scoringTeam==='red' ? FW*0.2 : FW*0.35;
  const blueBaseX = scoringTeam==='blue' ? FW*0.8 : FW*0.65;

  for(let i=0;i<redCount;i++){
    const spread=Math.min(redCount,5);
    const yOff=(i-(redCount-1)/2)*(80/Math.max(spread-1,1));
    positions.red.push({x:redBaseX,y:FH/2+yOff});
  }

  for(let i=0;i<blueCount;i++){
    const spread=Math.min(blueCount,5);
    const yOff=(i-(blueCount-1)/2)*(80/Math.max(spread-1,1));
    positions.blue.push({x:blueBaseX,y:FH/2+yOff});
  }

  return positions;
}

function resetPositions(scoringTeam){
  const spawns=getSpawnPositions(scoringTeam);

  // Find my index in my team
  let myTeammates=[];
  Object.keys(allPlayersData).forEach(pid=>{
    if(allPlayersData[pid].team===me.team) myTeammates.push(pid);
  });
  // Sort so consistent
  myTeammates.sort();
  const myIdx=myTeammates.indexOf(myId);
  const idx=myIdx>=0?myIdx:0;

  const teamSpawns=spawns[me.team]||[{x:FW/4,y:FH/2}];
  const sp=teamSpawns[idx%teamSpawns.length];

  me.x=sp.x;me.y=sp.y;me.vx=0;me.vy=0;

  // Ball center but slightly toward conceding team
  ball.x=FW/2;
  ball.y=FH/2;
  ball.vx=0;ball.vy=0;
  ballTarget.x=FW/2;ballTarget.y=FH/2;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PHYSICS UPDATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function updatePhysics(dt){
  if(state!=='playing')return;

  // Input
  let ax=0,ay=0;
  if(keys['KeyW']||keys['ArrowUp'])ay=-1;
  if(keys['KeyS']||keys['ArrowDown'])ay=1;
  if(keys['KeyA']||keys['ArrowLeft'])ax=-1;
  if(keys['KeyD']||keys['ArrowRight'])ax=1;
  if(Math.abs(joyDX)>0.1||Math.abs(joyDY)>0.1){ax=joyDX;ay=joyDY}
  const alen=Math.sqrt(ax*ax+ay*ay);
  if(alen>1){ax/=alen;ay/=alen}

  me.vx+=ax*ACCEL;me.vy+=ay*ACCEL;
  me.vx*=FRIC;me.vy*=FRIC;
  const spd=Math.sqrt(me.vx*me.vx+me.vy*me.vy);
  if(spd>MAX_SPD){me.vx=me.vx/spd*MAX_SPD;me.vy=me.vy/spd*MAX_SPD}

  me.x+=me.vx;me.y+=me.vy;
  playerFieldCollide(me);

  // Player-Player collision (local vs remote)
  Object.keys(rPlayers).forEach(pid=>{
    if(pid===myId)return;
    const rp=rPlayers[pid];
    if(!rp)return;
    const rpx=rp.rx!==undefined?rp.rx:rp.x;
    const rpy=rp.ry2!==undefined?rp.ry2:rp.y;
    const rpObj={x:rpx,y:rpy,vx:rp.vx||0,vy:rp.vy||0};

    if(circleCollide(me,PLR_R,PLR_M,rpObj,PLR_R,PLR_M,PLR_PLR_BOUNCE)){
      snd('bump');
    }
  });

  // Kick
  if(kickPressed&&!me.kicking){
    me.kicking=true;
    doKick();
  }
  if(!kickPressed)me.kicking=false;

  // Ball (host)
  if(isHost){
    ball.vx*=BALL_FRIC;ball.vy*=BALL_FRIC;
    const bs=Math.sqrt(ball.vx*ball.vx+ball.vy*ball.vy);
    if(bs>BALL_MAX){ball.vx=ball.vx/bs*BALL_MAX;ball.vy=ball.vy/bs*BALL_MAX}
    ball.x+=ball.vx;ball.y+=ball.vy;
    if(fieldCollide(ball,BALL_R))snd('wall');

    // Remote player-ball
    Object.values(rPlayers).forEach(rp=>{
      if(!rp)return;
      const rpObj={x:rp.rx||rp.x,y:rp.ry2||rp.y,vx:rp.vx||0,vy:rp.vy||0};
      circleCollide(rpObj,PLR_R,PLR_M,ball,BALL_R,BALL_M);
    });

    // Goal
    if(goalCD<=0){
      if(ball.x<BRD&&ball.y>GT&&ball.y<GB) scoreGoal('blue');
      else if(ball.x>FW-BRD&&ball.y>GT&&ball.y<GB) scoreGoal('red');
    }
  }else{
    ball.x+=(ballTarget.x-ball.x)*LERP_F;
    ball.y+=(ballTarget.y-ball.y)*LERP_F;
  }

  // Local player-ball
  circleCollide(me,PLR_R,PLR_M,ball,BALL_R,BALL_M);

  if(goalCD>0)goalCD-=dt;
}

function doKick(){
  const d=dst(me,ball);
  if(d<PLR_R+BALL_R+KICK_RNG){
    const dx=ball.x-me.x,dy=ball.y-me.y;
    const dd=Math.sqrt(dx*dx+dy*dy);
    if(dd>0.01){
      ball.vx+=(dx/dd)*KICK_F;
      ball.vy+=(dy/dd)*KICK_F;
      snd('kick');
      if(roomRef){
        roomRef.child('kicks').push({
          dx:Math.round(dx/dd*1000)/1000,
          dy:Math.round(dy/dd*1000)/1000,
          f:KICK_F,t:Date.now()
        });
      }
    }
  }
}

function scoreGoal(team){
  goalCD=3;
  lastGoalTeam=team;
  snd('goal');snd('whistle');

  if(team==='red')redScore++;else blueScore++;
  document.getElementById('rsc').textContent=redScore;
  document.getElementById('bsc').textContent=blueScore;

  // Goal overlay
  const ov=document.getElementById('goal-overlay');
  const txt=document.getElementById('goal-text');
  const sub=document.getElementById('goal-sub');
  txt.textContent='GOL!';
  txt.style.color=team==='red'?'#ff4444':'#4488ff';
  sub.textContent=(team==='red'?'KIRMIZI':'MAVÄ°')+' TAKIM!';
  ov.style.display='flex';

  // Reset positions after delay
  setTimeout(()=>{
    ov.style.display='none';
    resetPositions(team);

    if(isHost){
      roomRef.child('game').update({
        rs:redScore,bs:blueScore,
        bx:FW/2,by:FH/2,bvx:0,bvy:0,
        reset:team+'_'+Date.now()
      });
    }
  },1500);

  // Win check
  if(redScore>=winScore||blueScore>=winScore){
    setTimeout(()=>endGame(team),2000);
  }
}

function endGame(winTeam){
  state='result';
  snd('win');

  const wt=document.getElementById('win-text');
  wt.textContent=(winTeam==='red'?'KIRMIZI':'MAVÄ°')+' KAZANDI!';
  wt.className='wt '+(winTeam);
  document.getElementById('win-score').textContent=redScore+' - '+blueScore;
  sho('win-screen','flex');

  if(isHost&&roomRef) roomRef.child('game/status').set('ended_'+winTeam);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// RENDER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function render(){
  const W=cvs.width,H=cvs.height;
  ctx.fillStyle='#2b5c3a';
  ctx.fillRect(0,0,W,H);
  ctx.save();
  const ox=W/2-FW/2*camScale,oy=H/2-FH/2*camScale;
  ctx.translate(ox,oy);ctx.scale(camScale,camScale);

  // Field bg
  ctx.fillStyle='#3a7a4f';
  ctx.fillRect(BRD,BRD,FW-BRD*2,FH-BRD*2);

  // Field lines
  ctx.strokeStyle='rgba(255,255,255,.3)';ctx.lineWidth=1.5;

  // Border
  ctx.beginPath();
  const cr=CORNER_R;
  ctx.moveTo(BRD+cr,BRD);
  ctx.lineTo(FW-BRD-cr,BRD);
  ctx.arc(FW-BRD-cr,BRD+cr,cr,-Math.PI/2,0);
  ctx.lineTo(FW-BRD,GT);
  ctx.moveTo(FW-BRD,GB);
  ctx.lineTo(FW-BRD,FH-BRD-cr);
  ctx.arc(FW-BRD-cr,FH-BRD-cr,cr,0,Math.PI/2);
  ctx.lineTo(BRD+cr,FH-BRD);
  ctx.arc(BRD+cr,FH-BRD-cr,cr,Math.PI/2,Math.PI);
  ctx.lineTo(BRD,GB);
  ctx.moveTo(BRD,GT);
  ctx.lineTo(BRD,BRD+cr);
  ctx.arc(BRD+cr,BRD+cr,cr,Math.PI,Math.PI*1.5);
  ctx.strokeStyle='rgba(255,255,255,.6)';ctx.lineWidth=2.5;ctx.stroke();

  // Center
  ctx.beginPath();ctx.moveTo(FW/2,BRD);ctx.lineTo(FW/2,FH-BRD);
  ctx.strokeStyle='rgba(255,255,255,.25)';ctx.lineWidth=1.5;ctx.stroke();
  ctx.beginPath();ctx.arc(FW/2,FH/2,60,0,Math.PI*2);ctx.stroke();
  ctx.beginPath();ctx.arc(FW/2,FH/2,4,0,Math.PI*2);ctx.fillStyle='rgba(255,255,255,.3)';ctx.fill();

  // Penalty
  ctx.strokeStyle='rgba(255,255,255,.2)';ctx.lineWidth=1.5;
  ctx.strokeRect(BRD,FH/2-80,60,160);
  ctx.strokeRect(FW-BRD-60,FH/2-80,60,160);

  // Goals
  // Left
  ctx.fillStyle='rgba(220,50,50,.12)';ctx.fillRect(BRD-GOAL_W,GT,GOAL_W,GOAL_H);
  ctx.strokeStyle='rgba(220,50,50,.5)';ctx.lineWidth=2;
  ctx.beginPath();ctx.moveTo(BRD,GT);ctx.lineTo(BRD-GOAL_W,GT);ctx.lineTo(BRD-GOAL_W,GB);ctx.lineTo(BRD,GB);ctx.stroke();
  ctx.strokeStyle='rgba(220,50,50,.15)';ctx.lineWidth=.5;
  for(let ny=GT;ny<GB;ny+=10){ctx.beginPath();ctx.moveTo(BRD-GOAL_W,ny);ctx.lineTo(BRD,ny);ctx.stroke()}
  for(let nx=BRD-GOAL_W;nx<BRD;nx+=8){ctx.beginPath();ctx.moveTo(nx,GT);ctx.lineTo(nx,GB);ctx.stroke()}

  // Right
  ctx.fillStyle='rgba(50,100,220,.12)';ctx.fillRect(FW-BRD,GT,GOAL_W,GOAL_H);
  ctx.strokeStyle='rgba(50,100,220,.5)';ctx.lineWidth=2;
  ctx.beginPath();ctx.moveTo(FW-BRD,GT);ctx.lineTo(FW-BRD+GOAL_W,GT);ctx.lineTo(FW-BRD+GOAL_W,GB);ctx.lineTo(FW-BRD,GB);ctx.stroke();
  ctx.strokeStyle='rgba(50,100,220,.15)';ctx.lineWidth=.5;
  for(let ny=GT;ny<GB;ny+=10){ctx.beginPath();ctx.moveTo(FW-BRD,ny);ctx.lineTo(FW-BRD+GOAL_W,ny);ctx.stroke()}
  for(let nx=FW-BRD;nx<FW-BRD+GOAL_W;nx+=8){ctx.beginPath();ctx.moveTo(nx,GT);ctx.lineTo(nx,GB);ctx.stroke()}

  // Posts
  [{x:BRD,y:GT},{x:BRD,y:GB},{x:FW-BRD,y:GT},{x:FW-BRD,y:GB}].forEach(p=>{
    ctx.beginPath();ctx.arc(p.x,p.y,5,0,Math.PI*2);
    ctx.fillStyle='#ddd';ctx.fill();
    ctx.strokeStyle='#999';ctx.lineWidth=1;ctx.stroke();
  });

  // Remote players
  Object.keys(rPlayers).forEach(pid=>{
    if(pid===myId)return;
    const rp=rPlayers[pid];if(!rp)return;
    if(rp.rx===undefined){rp.rx=rp.x;rp.ry2=rp.y}
    rp.rx+=(rp.x-rp.rx)*LERP_F;
    rp.ry2+=(rp.y-rp.ry2)*LERP_F;
    drawPlayer(rp.rx,rp.ry2,rp.team||'red',rp.nm||'?',rp.num||0,false,rp.kk);
  });

  // Me
  drawPlayer(me.x,me.y,me.team,myName,me.num,true,kickPressed);

  // Ball
  drawBall(ball.x,ball.y);

  // Kick range
  if(kickPressed){
    const d=dst(me,ball);
    if(d<PLR_R+BALL_R+KICK_RNG+15){
      ctx.beginPath();ctx.arc(me.x,me.y,PLR_R+KICK_RNG+BALL_R,0,Math.PI*2);
      ctx.strokeStyle='rgba(255,255,100,.2)';ctx.lineWidth=1;ctx.setLineDash([4,4]);ctx.stroke();ctx.setLineDash([]);
    }
  }

  ctx.restore();

  // Vignette
  const vg=ctx.createRadialGradient(W/2,H/2,W*0.35,W/2,H/2,W*0.7);
  vg.addColorStop(0,'transparent');vg.addColorStop(1,'rgba(0,0,0,.3)');
  ctx.fillStyle=vg;ctx.fillRect(0,0,W,H);
}

function drawPlayer(x,y,team,name,num,isMe,kicking){
  const col=team==='red'?'#e63946':'#457b9d';
  const lt=team==='red'?'#ff6b6b':'#6baaff';

  // Shadow
  ctx.beginPath();ctx.ellipse(x,y+PLR_R-2,PLR_R*.8,4,0,0,Math.PI*2);
  ctx.fillStyle='rgba(0,0,0,.15)';ctx.fill();

  // Kick ring
  if(kicking){
    ctx.beginPath();ctx.arc(x,y,PLR_R+4,0,Math.PI*2);
    ctx.strokeStyle='rgba(255,255,100,.5)';ctx.lineWidth=2;ctx.stroke();
  }

  // Main
  ctx.beginPath();ctx.arc(x,y,PLR_R,0,Math.PI*2);
  ctx.fillStyle=col;ctx.fill();

  // Highlight
  ctx.beginPath();ctx.arc(x-3,y-3,PLR_R*.55,0,Math.PI*2);
  ctx.fillStyle=lt+'33';ctx.fill();

  // Border
  ctx.beginPath();ctx.arc(x,y,PLR_R,0,Math.PI*2);
  ctx.strokeStyle=isMe?'#fff':'rgba(255,255,255,.35)';
  ctx.lineWidth=isMe?2.5:1.5;ctx.stroke();

  // Number
  ctx.fillStyle='#fff';ctx.font='bold 11px Arial';
  ctx.textAlign='center';ctx.textBaseline='middle';
  ctx.fillText(num,x,y+1);

  // Name
  ctx.fillStyle='rgba(255,255,255,.75)';ctx.font='bold 9px Arial';
  ctx.textAlign='center';ctx.fillText(name,x,y-PLR_R-6);
}

function drawBall(x,y){
  ctx.beginPath();ctx.ellipse(x+1,y+BALL_R,BALL_R*.7,3,0,0,Math.PI*2);
  ctx.fillStyle='rgba(0,0,0,.2)';ctx.fill();

  ctx.beginPath();ctx.arc(x,y,BALL_R,0,Math.PI*2);
  ctx.fillStyle='#fff';ctx.fill();
  ctx.strokeStyle='#ccc';ctx.lineWidth=.8;ctx.stroke();

  for(let i=0;i<5;i++){
    const a=(i/5)*Math.PI*2-Math.PI/2;
    ctx.beginPath();ctx.arc(x+Math.cos(a)*BALL_R*.55,y+Math.sin(a)*BALL_R*.55,2.5,0,Math.PI*2);
    ctx.fillStyle='#aaa';ctx.fill();
  }

  ctx.beginPath();ctx.arc(x-2,y-2,BALL_R*.35,0,Math.PI*2);
  ctx.fillStyle='rgba(255,255,255,.4)';ctx.fill();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// INPUT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function initInput(){
  document.addEventListener('keydown',e=>{
    keys[e.code]=true;
    if(e.code==='Space'||e.code==='KeyX'){e.preventDefault();kickPressed=true}
  });
  document.addEventListener('keyup',e=>{
    keys[e.code]=false;
    if(e.code==='Space'||e.code==='KeyX')kickPressed=false;
  });

  // Joystick
  const jz=document.getElementById('joy-zone');
  const jb=document.getElementById('joy-base');
  const jk=document.getElementById('joy-knob');
  const maxD=45;

  jz.addEventListener('touchstart',e=>{
    e.preventDefault();if(joyTid!==null)return;initAudio();
    const t=e.changedTouches[0];joyTid=t.identifier;
    const r=jb.getBoundingClientRect();joyOX=r.left+r.width/2;joyOY=r.top+r.height/2;
  },{passive:false});

  jz.addEventListener('touchmove',e=>{
    e.preventDefault();
    for(let i=0;i<e.changedTouches.length;i++){
      const t=e.changedTouches[i];
      if(t.identifier===joyTid){
        let dx=t.clientX-joyOX,dy=t.clientY-joyOY;
        const d=Math.sqrt(dx*dx+dy*dy);
        if(d>maxD){dx=dx/d*maxD;dy=dy/d*maxD}
        joyDX=dx/maxD;joyDY=dy/maxD;
        jk.style.transform=`translate(calc(-50% + ${dx}px),calc(-50% + ${dy}px))`;
      }
    }
  },{passive:false});

  const ej=e=>{
    for(let i=0;i<e.changedTouches.length;i++){
      if(e.changedTouches[i].identifier===joyTid){
        joyTid=null;joyDX=0;joyDY=0;
        jk.style.transform='translate(-50%,-50%)';
      }
    }
  };
  jz.addEventListener('touchend',ej);jz.addEventListener('touchcancel',ej);

  const kb=document.getElementById('kick-btn');
  kb.addEventListener('touchstart',e=>{e.preventDefault();kickPressed=true;kb.classList.add('active');initAudio()},{passive:false});
  kb.addEventListener('touchend',()=>{kickPressed=false;kb.classList.remove('active')});
  kb.addEventListener('touchcancel',()=>{kickPressed=false;kb.classList.remove('active')});

  window.addEventListener('resize',rsz);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// FIREBASE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function syncMe(){
  if(!roomRef||state!=='playing')return;
  const now=performance.now();if(now-lastSync<SYNC_MS)return;lastSync=now;

  const u={};
  u['players/'+myId+'/x']=Math.round(me.x*10)/10;
  u['players/'+myId+'/y']=Math.round(me.y*10)/10;
  u['players/'+myId+'/vx']=Math.round(me.vx*100)/100;
  u['players/'+myId+'/vy']=Math.round(me.vy*100)/100;
  u['players/'+myId+'/kk']=kickPressed;

  if(isHost){
    u['game/bx']=Math.round(ball.x*10)/10;
    u['game/by']=Math.round(ball.y*10)/10;
    u['game/bvx']=Math.round(ball.vx*100)/100;
    u['game/bvy']=Math.round(ball.vy*100)/100;
  }
  roomRef.update(u);
}

function setupGameListeners(){
  roomRef.child('players').on('value',snap=>{
    const data=snap.val()||{};
    allPlayersData=data;
    Object.keys(data).forEach(pid=>{
      if(pid===myId)return;
      rPlayers[pid]=data[pid];
    });
    Object.keys(rPlayers).forEach(pid=>{
      if(!data[pid])delete rPlayers[pid];
    });
    updatePlayerInfo();
  });

  if(!isHost){
    roomRef.child('game').on('value',snap=>{
      const d=snap.val();if(!d)return;
      ballTarget.x=d.bx||FW/2;ballTarget.y=d.by||FH/2;
      ball.vx=d.bvx||0;ball.vy=d.bvy||0;
      if(d.rs!==undefined){redScore=d.rs;document.getElementById('rsc').textContent=redScore}
      if(d.bs!==undefined){blueScore=d.bs;document.getElementById('bsc').textContent=blueScore}

      // Reset trigger
      if(d.reset){
        const parts=d.reset.split('_');
        const scoringTeam=parts[0];
        resetPositions(scoringTeam);
      }

      // Win
      if(d.status&&d.status.startsWith('ended_')){
        const wTeam=d.status.replace('ended_','');
        if(state==='playing') endGame(wTeam);
      }
    });
  }

  if(isHost){
    roomRef.child('kicks').on('child_added',snap=>{
      const k=snap.val();if(!k)return;
      if(Date.now()-k.t>1000)return;
      ball.vx+=k.dx*k.f;ball.vy+=k.dy*k.f;
      snap.ref.remove();snd('kick');
    });
  }

  if(isHost){
    roomRef.child('game').update({rs:0,bs:0,bx:FW/2,by:FH/2,bvx:0,bvy:0,reset:null,status:null});
  }
}

function updatePlayerInfo(){
  let rc=0,bc=0;
  Object.values(allPlayersData).forEach(p=>{
    if(p.team==='red')rc++;else bc++;
  });
  document.getElementById('pinfo').textContent='ğŸ”´ '+rc+' vs '+bc+' ğŸ”µ';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// LOBBY
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
document.getElementById('btn-host').onclick=()=>{
  myName=document.getElementById('inp-name').value.trim()||'Player';
  roomId=genCode();myId='p_'+Date.now();isHost=true;
  roomRef=db.ref('rooms/'+roomId);
  hostId=myId;

  me.team='red';me.num=1;

  setSt('Oda kuruluyor...');

  roomRef.set({
    host:myId,status:'lobby',winScore:20,
    players:{[myId]:{nm:myName,x:0,y:0,vx:0,vy:0,team:'red',num:1,kk:false}},
    game:{rs:0,bs:0,bx:FW/2,by:FH/2,bvx:0,bvy:0}
  }).then(()=>{
    console.log("[HX] Oda: "+roomId);
    document.getElementById('lob-code').textContent=roomId;
    sho('menu','none');sho('lobby','flex');
    sho('btn-start','inline-block');
    sho('settings-panel','block');
    state='lobby';
    listenLobby();
  }).catch(e=>setSt('Hata: '+e.message));

  roomRef.child('players/'+myId).onDisconnect().remove();
};

document.getElementById('btn-join').onclick=()=>{
  myName=document.getElementById('inp-name').value.trim()||'Player';
  const code=document.getElementById('inp-code').value.trim().toUpperCase();
  if(!code||code.length<3){setSt('GeÃ§erli kod girin!');return}

  roomId=code;myId='p_'+Date.now();isHost=false;
  roomRef=db.ref('rooms/'+roomId);
  setSt('BaÄŸlanÄ±lÄ±yor...');

  roomRef.once('value').then(snap=>{
    const d=snap.val();
    if(!d){setSt('Oda bulunamadÄ±!');return}
    if(d.status==='playing'){setSt('Oyun baÅŸlamÄ±ÅŸ!');return}

    hostId=d.host;
    const players=d.players?Object.values(d.players):[];
    const rc=players.filter(p=>p.team==='red').length;
    const bc=players.filter(p=>p.team==='blue').length;
    me.team=bc<=rc?'blue':'red';
    me.num=players.length+1;

    roomRef.child('players/'+myId).set({
      nm:myName,x:0,y:0,vx:0,vy:0,team:me.team,num:me.num,kk:false
    }).then(()=>{
      console.log("[HX] KatÄ±ldÄ±: "+roomId);
      document.getElementById('lob-code').textContent=roomId;
      sho('menu','none');sho('lobby','flex');
      sho('btn-start','none');
      sho('settings-panel','none');
      state='lobby';
      listenLobby();
    });

    roomRef.child('players/'+myId).onDisconnect().remove();
  }).catch(e=>setSt('Hata: '+e.message));
};

function switchTeam(team){
  me.team=team;
  if(roomRef)roomRef.child('players/'+myId+'/team').set(team);
}

// Admin: move player to team
function adminMovePlayer(pid,toTeam){
  if(!isHost||!roomRef)return;
  roomRef.child('players/'+pid+'/team').set(toTeam);
}

function listenLobby(){
  roomRef.child('players').on('value',snap=>{
    const data=snap.val()||{};
    allPlayersData=data;
    const rl=document.getElementById('red-list');
    const bl=document.getElementById('blue-list');
    rl.innerHTML='';bl.innerHTML='';

    let rn=0,bn=0;
    Object.keys(data).forEach(pid=>{
      const p=data[pid];
      const div=document.createElement('div');
      div.className='pli'+(pid===myId?' self':'');

      let html=(p.nm||'Player')+(pid===myId?' (Sen)':'');

      // Admin buttons (host can move others)
      if(isHost&&pid!==myId){
        if(p.team==='red'){
          html+=` <span class="admin-btn" onclick="adminMovePlayer('${pid}','blue')">â†’ğŸ”µ</span>`;
        }else{
          html+=` <span class="admin-btn" onclick="adminMovePlayer('${pid}','red')">â†’ğŸ”´</span>`;
        }
      }

      div.innerHTML=html;

      if(p.team==='blue'){bl.appendChild(div);bn++}
      else{rl.appendChild(div);rn++}

      // Update my team if admin changed it
      if(pid===myId&&p.team!==me.team){
        me.team=p.team;
      }
    });
  });

  roomRef.child('status').on('value',snap=>{
    if(snap.val()==='playing'&&state==='lobby'){
      roomRef.once('value').then(s=>{
        const d=s.val();
        winScore=d.winScore||20;
        startGame();
      });
    }
  });

  // Win score setting
  const wsSel=document.getElementById('set-winscore');
  wsSel.onchange=()=>{
    if(isHost&&roomRef){
      winScore=parseInt(wsSel.value);
      roomRef.child('winScore').set(winScore);
    }
  };
}

document.getElementById('btn-start').onclick=()=>{
  if(!isHost)return;
  const ws=parseInt(document.getElementById('set-winscore').value)||20;
  winScore=ws;
  roomRef.child('winScore').set(ws);
  roomRef.child('status').set('playing');
};

document.getElementById('btn-leave').onclick=()=>{
  if(roomRef)roomRef.child('players/'+myId).remove();
  roomRef=null;state='menu';
  sho('lobby','none');sho('menu','flex');
};

document.getElementById('btn-endgame').onclick=()=>{
  if(!isHost||!roomRef)return;
  const wTeam=redScore>=blueScore?'red':'blue';
  roomRef.child('game/status').set('ended_'+wTeam);
  endGame(wTeam);
};

function backToMenu(){
  if(roomRef)roomRef.child('players/'+myId).remove();
  roomRef=null;state='menu';rPlayers={};
  sho('menu','flex');sho('lobby','none');
  sho('score-hud','none');sho('win-target','none');
  sho('joy-zone','none');sho('kick-btn','none');
  sho('pinfo','none');sho('admin-panel','none');
  sho('win-screen','none');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// GAME START
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function startGame(){
  state='playing';
  sho('lobby','none');sho('menu','none');
  sho('score-hud','flex');sho('win-target','block');
  sho('joy-zone','block');sho('kick-btn','block');
  sho('pinfo','block');

  if(isHost) sho('admin-panel','block');

  document.getElementById('win-target').textContent=winScore+' GOL';

  redScore=0;blueScore=0;goalCD=0;
  document.getElementById('rsc').textContent='0';
  document.getElementById('bsc').textContent='0';

  // Spawn
  resetPositions(null);

  ball.x=FW/2;ball.y=FH/2;ball.vx=0;ball.vy=0;
  ballTarget.x=FW/2;ballTarget.y=FH/2;

  setupGameListeners();
  initAudio();
  snd('whistle');

  console.log("[HX] Oyun baÅŸladÄ±! TakÄ±m:"+me.team+" WinScore:"+winScore);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// MAIN LOOP
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let lastTime=0;
function gameLoop(time){
  requestAnimationFrame(gameLoop);
  const dt=Math.min((time-lastTime)/1000,0.05);
  lastTime=time;
  if(state==='playing'){updatePhysics(dt);syncMe()}
  if(cvs)render();
}

function init(){
  console.log("[HX] HaxBall Arena V2 baÅŸlatÄ±lÄ±yor...");
  initCanvas();initInput();
  sho('menu','flex');
  requestAnimationFrame(gameLoop);
  console.log("[HX] HazÄ±r!");
}

window.addEventListener('load',init);
</script>
</body>
</html>
