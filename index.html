<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no,viewport-fit=cover">
<title>HaxBall Mobile Pro</title>
<style>
*{margin:0;padding:0;box-sizing:border-box;-webkit-touch-callout:none;-webkit-user-select:none;user-select:none;-webkit-tap-highlight-color:transparent}
html,body{width:100%;height:100%;overflow:hidden;background:#0a0a1a;font-family:'Segoe UI',Tahoma,sans-serif;touch-action:none;position:fixed;top:0;left:0}

/* ====== ROTATE MESSAGE ====== */
#rotateMsg{position:fixed;top:0;left:0;width:100%;height:100%;background:#0a0a1a;z-index:99999;display:none;align-items:center;justify-content:center;flex-direction:column;color:#fff;gap:12px;font-size:15px}
@media(max-width:640px) and (orientation:portrait){#rotateMsg{display:flex!important}}

/* ====== SCREENS ====== */
.screen{position:absolute;top:0;left:0;width:100%;height:100%;display:none;overflow-y:auto}

/* ====== MENU ====== */
#menuScreen{display:flex;flex-direction:column;align-items:center;justify-content:center;background:linear-gradient(145deg,#0b0920,#1a1545,#0d1b3e);z-index:100;padding:12px}
#menuScreen h1{color:#fff;font-size:28px;margin-bottom:3px;text-shadow:0 0 25px rgba(255,200,0,.2)}
#menuScreen .sub{color:#666;font-size:11px;margin-bottom:20px;letter-spacing:.5px}
.mbox{background:rgba(255,255,255,.05);border-radius:16px;padding:20px;width:320px;max-width:92vw;border:1px solid rgba(255,255,255,.07);backdrop-filter:blur(8px)}
.mbox input,.mbox select{width:100%;padding:11px 14px;margin-bottom:9px;border:1px solid rgba(255,255,255,.1);border-radius:9px;background:rgba(255,255,255,.04);color:#fff;font-size:14px;outline:none;transition:border .2s;-webkit-appearance:none}
.mbox input:focus{border-color:rgba(255,255,255,.3)}
.mbox input::placeholder{color:rgba(255,255,255,.25)}
.mbox select option{background:#151530;color:#fff}
.mbox label{color:#888;font-size:11px;display:block;margin-bottom:4px;margin-top:2px}
.divider{display:flex;align-items:center;margin:12px 0;color:rgba(255,255,255,.18);font-size:11px;gap:8px}
.divider::before,.divider::after{content:'';flex:1;height:1px;background:rgba(255,255,255,.08)}

/* ====== BUTTONS ====== */
.btn{padding:11px 18px;border:none;border-radius:9px;font-size:14px;font-weight:600;cursor:pointer;transition:transform .08s;text-align:center;color:#fff;display:inline-block;letter-spacing:.3px}
.btn:active{transform:scale(.96)}
.btn-full{width:100%;margin-bottom:7px}
.btn-red{background:linear-gradient(135deg,#e74c3c,#b92d2d)}
.btn-blue{background:linear-gradient(135deg,#3498db,#2475a8)}
.btn-green{background:linear-gradient(135deg,#27ae60,#1c8a4a)}
.btn-orange{background:linear-gradient(135deg,#f39c12,#d4850a)}
.btn-gray{background:rgba(255,255,255,.08);color:#aaa;border:1px solid rgba(255,255,255,.08)}
.btn-small{padding:7px 14px;font-size:12px;border-radius:7px}

/* ====== LOBBY ====== */
#lobbyScreen{flex-direction:column;align-items:center;background:linear-gradient(145deg,#0b0920,#1a1545,#0d1b3e);z-index:95;padding:14px}
#lobbyScreen h2{color:#fff;font-size:21px;margin-bottom:4px}
.room-code-box{background:rgba(243,156,18,.1);border:1px solid rgba(243,156,18,.2);color:#f39c12;font-size:15px;font-weight:700;padding:5px 16px;border-radius:8px;margin-bottom:4px}
.lobby-map-info{color:#777;font-size:11px;margin-bottom:12px}

.lobby-teams{display:flex;gap:10px;width:96%;max-width:920px;flex-wrap:wrap;justify-content:center}
.team-panel{background:rgba(255,255,255,.03);border-radius:12px;padding:12px;min-width:170px;flex:1;border:1px solid rgba(255,255,255,.05);min-height:110px}
.team-panel h3{text-align:center;margin-bottom:8px;font-size:13px;padding-bottom:6px;border-bottom:1px solid rgba(255,255,255,.06)}
.team-panel.t-red h3{color:#e74c3c}
.team-panel.t-blue h3{color:#3498db}
.team-panel.t-spec h3{color:#777}

.player-row{display:flex;align-items:center;justify-content:space-between;padding:5px 8px;margin-bottom:4px;border-radius:6px;background:rgba(255,255,255,.03);color:#fff;font-size:12px;gap:4px}
.player-row .p-info{display:flex;align-items:center;gap:5px;flex:1;min-width:0;overflow:hidden}
.player-row .p-info .p-name{overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.host-tag{background:#f39c12;color:#000;font-size:8px;padding:1px 4px;border-radius:3px;font-weight:700;flex-shrink:0}
.pos-tag{font-size:8px;padding:1px 5px;border-radius:3px;font-weight:700;flex-shrink:0}
.pos-GK{background:rgba(241,196,15,.2);color:#f1c40f}
.pos-DEF{background:rgba(46,204,113,.2);color:#2ecc71}
.pos-MID{background:rgba(52,152,219,.2);color:#3498db}
.pos-FWD{background:rgba(231,76,60,.2);color:#e74c3c}
.admin-row-btns{display:flex;gap:2px;flex-shrink:0}
.admin-row-btns button{padding:2px 5px;font-size:9px;border:none;border-radius:3px;cursor:pointer;font-weight:600;color:#fff}

.lobby-position-select{margin-top:10px;background:rgba(255,255,255,.03);border:1px solid rgba(255,255,255,.05);border-radius:10px;padding:12px;width:96%;max-width:400px}
.lobby-position-select h4{color:#ccc;font-size:12px;margin-bottom:6px}
.lobby-position-select select{width:100%;padding:9px 12px;border:1px solid rgba(255,255,255,.1);border-radius:7px;background:rgba(255,255,255,.04);color:#fff;font-size:13px;outline:none;-webkit-appearance:none}
.lobby-position-select select option{background:#151530;color:#fff}

.lobby-actions{margin-top:14px;display:flex;gap:7px;flex-wrap:wrap;justify-content:center}
.lobby-actions .btn{padding:9px 20px;font-size:12px}

/* ====== GAME SCREEN ====== */
#gameScreen{z-index:80;background:#1a472a}
#gameCanvas{display:block;width:100%;height:100%;outline:none}

/* ====== HUD ====== */
#hud{position:absolute;top:0;left:50%;transform:translateX(-50%);display:flex;z-index:85;pointer-events:none;border-radius:0 0 10px 10px;overflow:hidden;box-shadow:0 2px 12px rgba(0,0,0,.5)}
.hud-score{padding:5px 18px;font-size:26px;font-weight:900;color:#fff;min-width:48px;text-align:center;display:flex;align-items:center;justify-content:center}
.hud-score-red{background:rgba(192,57,43,.9)}
.hud-score-blue{background:rgba(41,128,185,.9)}
.hud-center{background:rgba(0,0,0,.78);padding:4px 14px;display:flex;flex-direction:column;align-items:center;justify-content:center}
.hud-timer{color:#fff;font-size:15px;font-weight:700;font-variant-numeric:tabular-nums}
.hud-status{color:#f39c12;font-size:8px;font-weight:700;text-transform:uppercase;margin-top:1px;letter-spacing:.5px}

/* ====== MOBILE CONTROLS ====== */
#joyZone{position:absolute;bottom:0;left:0;width:44%;height:58%;z-index:86;touch-action:none;pointer-events:auto}
#joyBase{position:absolute;width:108px;height:108px;border-radius:50%;background:rgba(255,255,255,.05);border:2px solid rgba(255,255,255,.08);pointer-events:none;display:none;z-index:87}
#joyThumb{position:absolute;width:44px;height:44px;border-radius:50%;background:rgba(255,255,255,.18);border:2px solid rgba(255,255,255,.35);pointer-events:none;display:none;z-index:88}
#kickButton{position:absolute;bottom:22px;right:22px;width:74px;height:74px;border-radius:50%;background:rgba(255,255,255,.08);border:3px solid rgba(255,255,255,.22);z-index:86;display:flex;align-items:center;justify-content:center;color:rgba(255,255,255,.65);font-size:11px;font-weight:700;touch-action:none;pointer-events:auto;transition:transform .07s,background .07s,border-color .07s}
#kickButton.active{background:rgba(255,255,255,.3);border-color:rgba(255,255,255,.8);transform:scale(1.08);color:#fff}

/* ====== ADMIN PANEL IN GAME ====== */
#adminPanelGame{position:absolute;top:42px;right:6px;z-index:90;display:none;pointer-events:auto}
#adminToggleBtn{background:rgba(243,156,18,.82);color:#000;border:none;padding:6px 10px;border-radius:7px;font-weight:700;font-size:10px;cursor:pointer}
#adminMenuContent{display:none;background:rgba(5,5,20,.94);border-radius:10px;padding:8px;margin-top:4px;min-width:200px;max-width:260px;border:1px solid rgba(255,255,255,.06);max-height:75vh;overflow-y:auto;backdrop-filter:blur(8px)}
#adminMenuContent .sec{color:#888;font-size:9px;padding:5px 6px 2px;text-transform:uppercase;letter-spacing:.8px;border-bottom:1px solid rgba(255,255,255,.04);margin-bottom:4px}
#adminMenuContent button{display:block;width:100%;padding:8px 10px;margin-bottom:4px;border:none;border-radius:5px;font-size:11px;font-weight:600;cursor:pointer;color:#fff;text-align:left}
#adminMenuContent select{width:100%;padding:7px 10px;margin-bottom:5px;border:1px solid rgba(255,255,255,.1);border-radius:5px;background:rgba(255,255,255,.05);color:#fff;font-size:11px;outline:none;-webkit-appearance:none}
#adminMenuContent select option{background:#0a0a1a}
.adm-player-row{display:flex;align-items:center;gap:3px;margin-bottom:4px;padding:4px 6px;background:rgba(255,255,255,.03);border-radius:5px;flex-wrap:wrap}
.adm-player-row .apr-name{color:#ccc;font-size:10px;flex:1;min-width:50px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.adm-player-row button{padding:3px 6px;font-size:9px;border:none;border-radius:3px;cursor:pointer;font-weight:600;color:#fff;flex-shrink:0}
.adm-player-row select{padding:2px 4px;font-size:9px;border:1px solid rgba(255,255,255,.1);border-radius:3px;background:rgba(255,255,255,.05);color:#fff;-webkit-appearance:none;width:48px;flex-shrink:0}

/* ====== GOAL OVERLAY ====== */
#goalOverlay{position:absolute;top:0;left:0;width:100%;height:100%;display:none;align-items:center;justify-content:center;z-index:89;pointer-events:none;background:rgba(0,0,0,.22)}
#goalOverlay .goal-text{font-size:52px;font-weight:900;color:#fff;text-shadow:0 0 40px rgba(255,255,255,.35),0 4px 20px rgba(0,0,0,.5);animation:goalAnim .4s cubic-bezier(.175,.885,.32,1.275)}
@keyframes goalAnim{0%{transform:scale(.15);opacity:0}70%{transform:scale(1.1)}100%{transform:scale(1);opacity:1}}

/* ====== TOAST ====== */
#toast{position:fixed;bottom:65px;left:50%;transform:translateX(-50%);background:rgba(0,0,0,.88);color:#fff;padding:7px 18px;border-radius:18px;font-size:11px;z-index:99990;display:none;white-space:nowrap;pointer-events:none;backdrop-filter:blur(6px)}

.hidden{display:none!important}
</style>
</head>
<body>

<!-- ROTATE MSG -->
<div id="rotateMsg">
<div style="font-size:36px;margin-bottom:8px">üì±</div>
<p>L√ºtfen ekranƒ± yatay √ßevirin</p>
</div>

<!-- MENU SCREEN -->
<div id="menuScreen" class="screen" style="display:flex">
<h1>‚öΩ HaxBall Mobile</h1>
<p class="sub">GER√áEK ZAMANLI √áOK OYUNCULU FUTBOL</p>
<div class="mbox">
  <input type="text" id="inpName" placeholder="Oyuncu Adƒ±n" maxlength="12">
  <div class="divider">YENƒ∞ ODA OLU≈ûTUR</div>
  <label>Harita</label>
  <select id="inpMap">
    <option value="classic">‚öΩ Klasik Saha</option>
    <option value="big">üèüÔ∏è B√ºy√ºk Saha</option>
    <option value="small">üéØ Mini Saha</option>
    <option value="hockey">üèí Buz Hokeyi</option>
    <option value="futsal">üëü Futsal</option>
  </select>
  <input type="text" id="inpPwd" placeholder="Oda ≈ûifresi (opsiyonel)" maxlength="20">
  <button class="btn btn-full btn-red" id="btnCreate">üèüÔ∏è Oda Kur (Host)</button>
  <div class="divider">MEVCUT ODAYA KATIL</div>
  <input type="text" id="inpCode" placeholder="Oda Kodu (5 karakter)" maxlength="6" style="text-transform:uppercase">
  <input type="text" id="inpJoinPwd" placeholder="≈ûifre (varsa)" maxlength="20">
  <button class="btn btn-full btn-blue" id="btnJoin">üöÄ Odaya Katƒ±l</button>
</div>
</div>

<!-- LOBBY SCREEN -->
<div id="lobbyScreen" class="screen">
<h2>üèüÔ∏è Oyun Lobisi</h2>
<div class="room-code-box" id="lobbyCode">ODA: -----</div>
<div class="lobby-map-info" id="lobbyMapName">Harita: -</div>

<div class="lobby-teams">
  <div class="team-panel t-red"><h3>üî¥ Kƒ±rmƒ±zƒ± Takƒ±m</h3><div id="lobbyRedList"></div></div>
  <div class="team-panel t-spec"><h3>üëÅÔ∏è ƒ∞zleyiciler</h3><div id="lobbySpecList"></div></div>
  <div class="team-panel t-blue"><h3>üîµ Mavi Takƒ±m</h3><div id="lobbyBlueList"></div></div>
</div>

<div class="lobby-position-select" id="lobbyPosBox">
  <h4>üéΩ Mevki Se√ßimi</h4>
  <select id="lobbyPosSelect">
    <option value="">-- Mevki Se√ß --</option>
    <option value="GK">üß§ Kaleci (GK)</option>
    <option value="DEF">üõ°Ô∏è Defans (DEF)</option>
    <option value="MID">üéØ Orta Saha (MID)</option>
    <option value="FWD">‚ö° Forvet (FWD)</option>
  </select>
</div>

<div class="lobby-actions">
  <button class="btn btn-red btn-small" id="btnTeamRed">üî¥ Kƒ±rmƒ±zƒ±ya Ge√ß</button>
  <button class="btn btn-gray btn-small" id="btnTeamSpec">üëÅÔ∏è ƒ∞zleyici</button>
  <button class="btn btn-blue btn-small" id="btnTeamBlue">üîµ Maviye Ge√ß</button>
  <button class="btn btn-green btn-small hidden" id="btnStart">üöÄ Ma√ßƒ± Ba≈ülat</button>
  <button class="btn btn-red btn-small" id="btnLeave" style="background:linear-gradient(135deg,#95433e,#7a2e2e)">üö™ Ayrƒ±l</button>
</div>
</div>

<!-- GAME SCREEN -->
<div id="gameScreen" class="screen">
<canvas id="gameCanvas" tabindex="0"></canvas>

<div id="hud">
  <div class="hud-score hud-score-red" id="hudRed">0</div>
  <div class="hud-center">
    <div class="hud-timer" id="hudTimer">0:00</div>
    <div class="hud-status" id="hudStatus"></div>
  </div>
  <div class="hud-score hud-score-blue" id="hudBlue">0</div>
</div>

<div id="joyZone"></div>
<div id="joyBase"></div>
<div id="joyThumb"></div>
<div id="kickButton">VURU≈û</div>

<div id="adminPanelGame">
  <button id="adminToggleBtn">‚öôÔ∏è Admin</button>
  <div id="adminMenuContent"></div>
</div>

<div id="goalOverlay"><div class="goal-text" id="goalText">GOL!</div></div>
</div>

<div id="toast"></div>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
<script>
(function(){
"use strict";

// ============================================================
//                    FIREBASE INIT
// ============================================================
firebase.initializeApp({
    apiKey:"AIzaSyDXgndR3i2p0ovRXVxqGb24d7lMXdTTX9I",
    authDomain:"mobilgame1-f03ac.firebaseapp.com",
    databaseURL:"https://mobilgame1-f03ac-default-rtdb.europe-west1.firebasedatabase.app",
    projectId:"mobilgame1-f03ac",
    storageBucket:"mobilgame1-f03ac.firebasestorage.app",
    messagingSenderId:"188464433527",
    appId:"1:188464433527:web:baed82070bfed9652df972"
});
var db = firebase.database();

// ============================================================
//                    UTILITY FUNCTIONS
// ============================================================
var $ = function(id){ return document.getElementById(id); };
function uid(){ return Math.random().toString(36).substr(2,10) + Date.now().toString(36).substr(-4); }
function roomCodeGen(){
    var ch = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789', s = '';
    for(var i=0;i<5;i++) s += ch[Math.floor(Math.random()*ch.length)];
    return s;
}
function toast(msg, dur){
    dur = dur || 2200;
    var t = $('toast');
    t.textContent = msg;
    t.style.display = 'block';
    clearTimeout(t._tm);
    t._tm = setTimeout(function(){ t.style.display = 'none'; }, dur);
}
function lerp(a,b,t){ return a + (b - a) * t; }
function dist(x1,y1,x2,y2){ return Math.sqrt((x2-x1)*(x2-x1)+(y2-y1)*(y2-y1)); }
function clamp(v,lo,hi){ return v < lo ? lo : (v > hi ? hi : v); }
function normVec(x,y){
    var l = Math.sqrt(x*x+y*y);
    if(l < 0.0001) return {x:0,y:0};
    return {x:x/l, y:y/l};
}

// ============================================================
//                    MAP DEFINITIONS
// ============================================================
var MAPS = {
    classic: {
        name:'Klasik Saha', fieldW:1200, fieldH:600,
        goalH:150, goalD:55,
        bgColor:'#2b7530', floorColor:'#3a8c3a', floorColor2:'#358535',
        lineColor:'rgba(255,255,255,0.50)',
        centerR:85, penW:130, penH:270,
        ballFric:0.988, playerFric:0.91
    },
    big: {
        name:'B√ºy√ºk Saha', fieldW:1500, fieldH:750,
        goalH:180, goalD:60,
        bgColor:'#1a5c1a', floorColor:'#2a7a2a', floorColor2:'#257225',
        lineColor:'rgba(255,255,255,0.45)',
        centerR:100, penW:150, penH:300,
        ballFric:0.989, playerFric:0.92
    },
    small: {
        name:'Mini Saha', fieldW:900, fieldH:450,
        goalH:120, goalD:45,
        bgColor:'#2d6b2d', floorColor:'#3a8530', floorColor2:'#358028',
        lineColor:'rgba(255,255,255,0.50)',
        centerR:65, penW:100, penH:200,
        ballFric:0.986, playerFric:0.90
    },
    hockey: {
        name:'Buz Hokeyi', fieldW:1100, fieldH:500,
        goalH:130, goalD:50,
        bgColor:'#152a44', floorColor:'#1f4470', floorColor2:'#1b3d65',
        lineColor:'rgba(255,255,255,0.55)',
        centerR:75, penW:120, penH:240,
        ballFric:0.994, playerFric:0.955
    },
    futsal: {
        name:'Futsal', fieldW:1000, fieldH:520,
        goalH:135, goalD:48,
        bgColor:'#7a5a10', floorColor:'#9a7020', floorColor2:'#8d6518',
        lineColor:'rgba(255,255,255,0.55)',
        centerR:70, penW:110, penH:230,
        ballFric:0.984, playerFric:0.90
    }
};

// ============================================================
//                    POSITION SLOT SYSTEM
// ============================================================
// Returns max count per position for given team size
function getSlotConfig(teamSize){
    if(teamSize <= 0) return {GK:0,DEF:0,MID:0,FWD:0};
    if(teamSize === 1) return {GK:1,DEF:0,MID:0,FWD:0};
    if(teamSize === 2) return {GK:1,DEF:0,MID:0,FWD:1};
    if(teamSize === 3) return {GK:1,DEF:1,MID:0,FWD:1};
    if(teamSize === 4) return {GK:1,DEF:1,MID:1,FWD:1};
    if(teamSize === 5) return {GK:1,DEF:2,MID:1,FWD:1};
    if(teamSize === 6) return {GK:1,DEF:2,MID:2,FWD:1};
    if(teamSize === 7) return {GK:1,DEF:2,MID:2,FWD:2};
    if(teamSize === 8) return {GK:1,DEF:3,MID:2,FWD:2};
    if(teamSize === 9) return {GK:1,DEF:3,MID:3,FWD:2};
    if(teamSize === 10) return {GK:1,DEF:3,MID:3,FWD:3};
    if(teamSize >= 11) return {GK:1,DEF:4,MID:3,FWD:3};
    return {GK:1,DEF:1,MID:1,FWD:1};
}

function countPosInTeam(players, team, pos, excludePid){
    var c = 0;
    for(var pid in players){
        if(pid === excludePid) continue;
        var p = players[pid];
        if(p.online === false) continue;
        if(p.team === team && p.pos === pos) c++;
    }
    return c;
}

function getTeamSize(players, team, excludePid){
    var c = 0;
    for(var pid in players){
        if(pid === excludePid) continue;
        var p = players[pid];
        if(p.online === false) continue;
        if(p.team === team) c++;
    }
    return c;
}

function isPosAvailable(players, team, pos, excludePid){
    var ts = getTeamSize(players, team, null);
    var cfg = getSlotConfig(ts);
    var taken = countPosInTeam(players, team, pos, excludePid);
    return taken < (cfg[pos] || 0);
}

function autoAssignPos(players, team, pid){
    var ts = getTeamSize(players, team, null);
    // include this player in count if not already counted
    var alreadyInTeam = false;
    if(players[pid] && players[pid].team === team && players[pid].online !== false) alreadyInTeam = true;
    if(!alreadyInTeam) ts++;
    var cfg = getSlotConfig(ts);
    var order = ['GK','DEF','MID','FWD'];
    for(var oi = 0; oi < order.length; oi++){
        var pos = order[oi];
        var taken = countPosInTeam(players, team, pos, pid);
        if(taken < (cfg[pos] || 0)) return pos;
    }
    return 'MID';
}

// ============================================================
//                    SPAWN POSITIONS
// ============================================================
function getSpawnPos(team, pos, indexInPos, totalInPos, map){
    var FW = map.fieldW, FH = map.fieldH;
    var baseX = FW / 2;
    if(team === 'red'){
        if(pos === 'GK') baseX = 50;
        else if(pos === 'DEF') baseX = FW * 0.18;
        else if(pos === 'MID') baseX = FW * 0.34;
        else if(pos === 'FWD') baseX = FW * 0.45;
    } else {
        if(pos === 'GK') baseX = FW - 50;
        else if(pos === 'DEF') baseX = FW * 0.82;
        else if(pos === 'MID') baseX = FW * 0.66;
        else if(pos === 'FWD') baseX = FW * 0.55;
    }
    var spacing = Math.min(68, (FH - 80) / Math.max(totalInPos, 1));
    var startY = FH / 2 - (totalInPos - 1) * spacing / 2;
    return { x: baseX, y: startY + indexInPos * spacing };
}

function spawnAllTeam(pids, team, players, map, updates){
    // Group by position
    var groups = {GK:[], DEF:[], MID:[], FWD:[]};
    for(var i = 0; i < pids.length; i++){
        var pid = pids[i];
        var pos = (players[pid] && players[pid].pos) || 'MID';
        if(!groups[pos]) groups[pos] = [];
        groups[pos].push(pid);
    }
    for(var p in groups){
        var arr = groups[p];
        for(var j = 0; j < arr.length; j++){
            var sp = getSpawnPos(team, p, j, arr.length, map);
            if(updates){
                updates['players/' + arr[j] + '/x'] = sp.x;
                updates['players/' + arr[j] + '/y'] = sp.y;
                updates['players/' + arr[j] + '/vx'] = 0;
                updates['players/' + arr[j] + '/vy'] = 0;
            }
        }
    }
    return groups;
}

// ============================================================
//                    PHYSICS CONSTANTS
// ============================================================
var FIELD_MARGIN = 70;
var PLAYER_RADIUS = 19;
var BALL_RADIUS = 11;
var KICK_HALO_RADIUS = 35;
var KICK_FORCE = 4.8;
var PLAYER_ACCEL = 0.26;
var PLAYER_MAX_SPEED = 2.75;
var BALL_MAX_SPEED = 9.5;
var BOUNCE_DAMP = 0.6;
var PLAYER_BOUNCE_DAMP = 0.22;
var BALL_PUSH_FORCE = 0.3;
var POST_RADIUS = 6;
var MATCH_DURATION = 180;
var NET_SEND_INTERVAL = 42;
var GOAL_RESET_MS = 1800;
var KICK_COOLDOWN_FRAMES = 10;

// ============================================================
//                    GAME STATE
// ============================================================
var myId = uid();
var myName = '';
var roomCode = '';
var roomRef = null;
var isHost = false;
var gameState = 'menu'; // menu, lobby, game
var roomData = null;
var curMapKey = 'classic';
var curMap = MAPS.classic;

// Local simulation objects
var localPlayers = {};
var localBall = {x:600, y:300, vx:0, vy:0};
var matchTime = 0;
var matchRunning = false;
var matchPaused = false;
var goalScoredFlag = false;
var goalResetCountdown = 0;
var redScore = 0;
var blueScore = 0;
var lastNetSendTime = 0;

// Input
var myInput = {dx:0, dy:0, kick:false};
var kickBtnDown = false;
var kickFiredThisPress = false; // prevents continuous kick while holding

// Joystick touch
var joyTouchId = null;
var joyActive = false;
var joySX = 0, joySY = 0;
var kickTouchId = null;

// Keyboard
var keysDown = {};

// Canvas
var canvas, ctx;
var canvasW = 0, canvasH = 0;
var viewScale = 1, viewOffX = 0, viewOffY = 0;

// Loop
var animFrameId = null;
var lastFrameTimestamp = 0;
var physicAccum = 0;
var FIXED_STEP = 1000 / 60;

// Firebase listener
var roomListenerHandle = null;
var adminMenuOpen = false;
var userGestureReceived = false;

// ============================================================
//                    DOM REFERENCES
// ============================================================
canvas = $('gameCanvas');
ctx = canvas.getContext('2d');

// ============================================================
//                    SCREEN MANAGEMENT
// ============================================================
function showScreen(name){
    $('menuScreen').style.display = 'none';
    $('lobbyScreen').style.display = 'none';
    $('gameScreen').style.display = 'none';
    gameState = name;
    if(name === 'menu'){
        $('menuScreen').style.display = 'flex';
        stopGameLoop();
    } else if(name === 'lobby'){
        $('lobbyScreen').style.display = 'flex';
        stopGameLoop();
    } else if(name === 'game'){
        $('gameScreen').style.display = 'block';
        resizeCanvas();
        startGameLoop();
        setTimeout(function(){ canvas.focus(); }, 80);
    }
}

// ============================================================
//                    CANVAS RESIZE
// ============================================================
function resizeCanvas(){
    canvasW = window.innerWidth;
    canvasH = window.innerHeight;
    canvas.width = canvasW;
    canvas.height = canvasH;
    var totalW = curMap.fieldW + FIELD_MARGIN * 2;
    var totalH = curMap.fieldH + FIELD_MARGIN * 2;
    var sx = canvasW / totalW;
    var sy = canvasH / totalH;
    viewScale = Math.min(sx, sy);
    viewOffX = (canvasW - totalW * viewScale) / 2;
    viewOffY = (canvasH - totalH * viewScale) / 2;
}
window.addEventListener('resize', function(){
    if(gameState === 'game') resizeCanvas();
});

// ============================================================
//                    FULLSCREEN (user gesture only)
// ============================================================
function tryFullscreen(){
    if(!userGestureReceived) return;
    try {
        var el = document.documentElement;
        if(!document.fullscreenElement && !document.webkitFullscreenElement){
            if(el.requestFullscreen) el.requestFullscreen().catch(function(){});
            else if(el.webkitRequestFullscreen) el.webkitRequestFullscreen();
        }
        if(screen.orientation && screen.orientation.lock){
            screen.orientation.lock('landscape').catch(function(){});
        }
    } catch(e){}
}
function onUserGesture(){
    userGestureReceived = true;
    if(gameState === 'game') tryFullscreen();
}
document.addEventListener('click', onUserGesture, {passive:true});
document.addEventListener('touchend', onUserGesture, {passive:true});
document.addEventListener('contextmenu', function(e){ e.preventDefault(); });
document.addEventListener('gesturestart', function(e){ e.preventDefault(); });
document.addEventListener('gesturechange', function(e){ e.preventDefault(); });

// ============================================================
//                    FIREBASE: CREATE ROOM
// ============================================================
$('btnCreate').addEventListener('click', function(){
    myName = $('inpName').value.trim() || ('Player' + myId.substr(0,4));
    if(myName.length > 12) myName = myName.substr(0,12);
    curMapKey = $('inpMap').value || 'classic';
    curMap = MAPS[curMapKey] || MAPS.classic;
    var pwd = $('inpPwd').value.trim();
    roomCode = roomCodeGen();

    var initData = {
        code: roomCode,
        password: pwd,
        hostId: myId,
        state: 'lobby',
        mapKey: curMapKey,
        createdAt: firebase.database.ServerValue.TIMESTAMP,
        players: {},
        match: {
            redScore: 0, blueScore: 0, time: 0,
            running: false, paused: false,
            ball: {x: curMap.fieldW/2, y: curMap.fieldH/2, vx:0, vy:0}
        }
    };
    initData.players[myId] = {
        name: myName, team: 'spectator', pos: '',
        x: curMap.fieldW/2, y: curMap.fieldH/2, vx:0, vy:0,
        kick: false, idx:0, idy:0, ik:false, online: true
    };

    roomRef = db.ref('rooms/' + roomCode);
    roomRef.set(initData).then(function(){
        isHost = true;
        setupRoomListener();
        setupOnDisconnect();
        showScreen('lobby');
        $('lobbyCode').textContent = 'ODA: ' + roomCode;
        $('lobbyMapName').textContent = 'Harita: ' + curMap.name;
        toast('Oda kuruldu! Kod: ' + roomCode);
    }).catch(function(e){
        toast('Hata: ' + e.message);
    });
});

// ============================================================
//                    FIREBASE: JOIN ROOM
// ============================================================
$('btnJoin').addEventListener('click', function(){
    myName = $('inpName').value.trim() || ('Player' + myId.substr(0,4));
    if(myName.length > 12) myName = myName.substr(0,12);
    var code = $('inpCode').value.trim().toUpperCase();
    var pwd = $('inpJoinPwd').value.trim();
    if(!code || code.length < 3){ toast('Oda kodu girin!'); return; }

    var ref = db.ref('rooms/' + code);
    ref.once('value').then(function(snap){
        if(!snap.exists()){ toast('Oda bulunamadƒ±!'); return; }
        var d = snap.val();
        if(d.password && d.password !== pwd){ toast('Yanlƒ±≈ü ≈üifre!'); return; }

        roomCode = code;
        roomRef = ref;
        isHost = false;
        curMapKey = d.mapKey || 'classic';
        curMap = MAPS[curMapKey] || MAPS.classic;

        var playerData = {
            name: myName, team: 'spectator', pos: '',
            x: curMap.fieldW/2, y: curMap.fieldH/2, vx:0, vy:0,
            kick: false, idx:0, idy:0, ik:false, online: true
        };
        return roomRef.child('players/' + myId).set(playerData);
    }).then(function(){
        if(!roomRef) return;
        setupRoomListener();
        setupOnDisconnect();
        showScreen('lobby');
        $('lobbyCode').textContent = 'ODA: ' + roomCode;
        $('lobbyMapName').textContent = 'Harita: ' + curMap.name;
        toast('Odaya katƒ±ldƒ±n!');
    }).catch(function(e){
        toast('Hata: ' + e.message);
    });
});

// ============================================================
//                    FIREBASE: ON DISCONNECT
// ============================================================
function setupOnDisconnect(){
    if(!roomRef) return;
    roomRef.child('players/' + myId).onDisconnect().update({online: false});
}

// ============================================================
//                    FIREBASE: ROOM LISTENER
// ============================================================
function setupRoomListener(){
    if(roomListenerHandle && roomRef){
        roomRef.off('value', roomListenerHandle);
    }
    roomListenerHandle = roomRef.on('value', function(snap){
        if(!snap.exists()){
            toast('Oda silindi!');
            cleanupRoom();
            showScreen('menu');
            return;
        }
        roomData = snap.val();

        // Host migration
        if(roomData.hostId && roomData.players){
            var hp = roomData.players[roomData.hostId];
            if(!hp || hp.online === false){
                var onlineIds = [];
                for(var pid in roomData.players){
                    if(roomData.players[pid].online !== false) onlineIds.push(pid);
                }
                if(onlineIds.length > 0 && onlineIds[0] === myId){
                    isHost = true;
                    roomRef.update({hostId: myId});
                    toast('Sen yeni hostsun!');
                }
            }
        }
        isHost = (roomData.hostId === myId);

        // Map sync
        if(roomData.mapKey && MAPS[roomData.mapKey]){
            var oldKey = curMapKey;
            curMapKey = roomData.mapKey;
            curMap = MAPS[curMapKey];
            if(gameState === 'game' && oldKey !== curMapKey){
                resizeCanvas();
            }
        }

        // Screen transitions
        if(gameState === 'lobby'){
            refreshLobbyUI();
            if(roomData.state === 'playing'){
                initGameState();
                showScreen('game');
            }
        } else if(gameState === 'game'){
            if(roomData.state === 'lobby'){
                stopGameLoop();
                showScreen('lobby');
                return;
            }
            // Client sync
            if(!isHost){
                clientSyncFromServer();
            }
            // Score sync
            if(roomData.match){
                redScore = roomData.match.redScore || 0;
                blueScore = roomData.match.blueScore || 0;
            }
            $('adminPanelGame').style.display = isHost ? 'block' : 'none';
        }
    });
}

// ============================================================
//                    LOBBY UI REFRESH
// ============================================================
function refreshLobbyUI(){
    if(!roomData || !roomData.players) return;
    var redDiv = $('lobbyRedList');
    var blueDiv = $('lobbyBlueList');
    var specDiv = $('lobbySpecList');
    redDiv.innerHTML = '';
    blueDiv.innerHTML = '';
    specDiv.innerHTML = '';

    var players = roomData.players;
    var posLabels = {GK:'KAL', DEF:'DEF', MID:'ORS', FWD:'FRV'};

    for(var pid in players){
        var p = players[pid];
        if(p.online === false) continue;

        var row = document.createElement('div');
        row.className = 'player-row';

        var isHostPlayer = (pid === roomData.hostId);
        var hostHTML = isHostPlayer ? '<span class="host-tag">HOST</span>' : '';

        var posHTML = '';
        if(p.pos && p.team !== 'spectator'){
            posHTML = '<span class="pos-tag pos-' + p.pos + '">' + (posLabels[p.pos] || p.pos) + '</span>';
        }

        var adminHTML = '';
        if(isHost && pid !== myId){
            adminHTML = '<div class="admin-row-btns">' +
                '<button style="background:#e74c3c" data-apid="' + pid + '" data-atm="red">K</button>' +
                '<button style="background:#3498db" data-apid="' + pid + '" data-atm="blue">M</button>' +
                '<button style="background:#555" data-apid="' + pid + '" data-atm="spectator">ƒ∞</button>' +
                '</div>';
        }

        row.innerHTML = '<span class="p-info">' + hostHTML +
            '<span class="p-name">' + (p.name || '?') + '</span>' + posHTML +
            '</span>' + adminHTML;

        if(p.team === 'red') redDiv.appendChild(row);
        else if(p.team === 'blue') blueDiv.appendChild(row);
        else specDiv.appendChild(row);
    }

    // Bind admin move buttons
    document.querySelectorAll('[data-apid]').forEach(function(btn){
        btn.addEventListener('click', function(){
            var tPid = btn.getAttribute('data-apid');
            var tTeam = btn.getAttribute('data-atm');
            if(!isHost || !roomRef) return;
            if(tTeam === 'spectator'){
                roomRef.child('players/' + tPid).update({team:'spectator', pos:''});
            } else {
                // Check team limit
                var ts = getTeamSize(roomData.players, tTeam, null);
                if(ts >= 11){ toast('Takƒ±m dolu! (max 11)'); return; }
                var newPos = autoAssignPos(roomData.players, tTeam, tPid);
                roomRef.child('players/' + tPid).update({team: tTeam, pos: newPos});
            }
        });
    });

    // Show/hide start button
    $('btnStart').classList.toggle('hidden', !isHost);

    // Map info
    $('lobbyMapName').textContent = 'Harita: ' + curMap.name;

    // Position select
    refreshPosSelect();
}

function refreshPosSelect(){
    if(!roomData || !roomData.players) return;
    var me = roomData.players[myId];
    if(!me || me.team === 'spectator'){
        $('lobbyPosBox').style.display = 'none';
        return;
    }
    $('lobbyPosBox').style.display = 'block';

    var sel = $('lobbyPosSelect');
    var team = me.team;
    var ts = getTeamSize(roomData.players, team, null);
    var cfg = getSlotConfig(ts);
    var positions = ['GK','DEF','MID','FWD'];
    var labels = {GK:'üß§ Kaleci', DEF:'üõ°Ô∏è Defans', MID:'üéØ Orta Saha', FWD:'‚ö° Forvet'};

    var html = '<option value="">-- Mevki Se√ß --</option>';
    for(var i = 0; i < positions.length; i++){
        var pos = positions[i];
        var max = cfg[pos] || 0;
        var taken = countPosInTeam(roomData.players, team, pos, myId);
        var avail = taken < max;
        var isMine = (me.pos === pos);
        html += '<option value="' + pos + '"';
        if(isMine) html += ' selected';
        if(!avail && !isMine) html += ' disabled';
        html += '>' + labels[pos] + ' (' + taken + '/' + max + ')';
        if(!avail && !isMine) html += ' - DOLU';
        html += '</option>';
    }
    sel.innerHTML = html;
}

// ============================================================
//                    LOBBY POSITION SELECT
// ============================================================
$('lobbyPosSelect').addEventListener('change', function(){
    var val = $('lobbyPosSelect').value;
    if(!val || !roomRef || !roomData) return;
    var me = roomData.players[myId];
    if(!me || me.team === 'spectator') return;
    if(!isPosAvailable(roomData.players, me.team, val, myId)){
        toast('Bu mevki dolu!');
        return;
    }
    roomRef.child('players/' + myId).update({pos: val});
    toast('Mevki: ' + val);
});

// ============================================================
//                    LOBBY ACTION BUTTONS
// ============================================================
$('btnTeamRed').addEventListener('click', function(){
    if(!roomRef || !roomData) return;
    var ts = getTeamSize(roomData.players, 'red', null);
    if(ts >= 11){ toast('Kƒ±rmƒ±zƒ± takƒ±m dolu! (max 11)'); return; }
    var newPos = autoAssignPos(roomData.players, 'red', myId);
    roomRef.child('players/' + myId).update({team:'red', pos: newPos});
});

$('btnTeamBlue').addEventListener('click', function(){
    if(!roomRef || !roomData) return;
    var ts = getTeamSize(roomData.players, 'blue', null);
    if(ts >= 11){ toast('Mavi takƒ±m dolu! (max 11)'); return; }
    var newPos = autoAssignPos(roomData.players, 'blue', myId);
    roomRef.child('players/' + myId).update({team:'blue', pos: newPos});
});

$('btnTeamSpec').addEventListener('click', function(){
    if(!roomRef) return;
    roomRef.child('players/' + myId).update({team:'spectator', pos:''});
});

$('btnLeave').addEventListener('click', function(){
    cleanupRoom();
    showScreen('menu');
});

// ============================================================
//                    START MATCH
// ============================================================
$('btnStart').addEventListener('click', function(){
    if(!isHost || !roomRef || !roomData) return;
    var players = roomData.players;
    var rc = 0, bc = 0;
    for(var pid in players){
        if(players[pid].online === false) continue;
        if(players[pid].team === 'red') rc++;
        if(players[pid].team === 'blue') bc++;
    }
    if(rc < 1 || bc < 1){
        toast('Her takƒ±mda en az 1 oyuncu olmalƒ±!');
        return;
    }

    var updates = {};
    var redPids = [], bluePids = [];
    for(var pid2 in players){
        if(players[pid2].online === false) continue;
        if(players[pid2].team === 'red') redPids.push(pid2);
        else if(players[pid2].team === 'blue') bluePids.push(pid2);
    }

    // Auto-assign positions for anyone without one
    for(var r = 0; r < redPids.length; r++){
        var rp = redPids[r];
        if(!players[rp].pos || players[rp].pos === ''){
            var ap = autoAssignPos(players, 'red', rp);
            updates['players/' + rp + '/pos'] = ap;
            players[rp].pos = ap; // update local copy for spawn calc
        }
    }
    for(var b = 0; b < bluePids.length; b++){
        var bp = bluePids[b];
        if(!players[bp].pos || players[bp].pos === ''){
            var abp = autoAssignPos(players, 'blue', bp);
            updates['players/' + bp + '/pos'] = abp;
            players[bp].pos = abp;
        }
    }

    spawnAllTeam(redPids, 'red', players, curMap, updates);
    spawnAllTeam(bluePids, 'blue', players, curMap, updates);

    updates['state'] = 'playing';
    updates['match/redScore'] = 0;
    updates['match/blueScore'] = 0;
    updates['match/time'] = 0;
    updates['match/running'] = true;
    updates['match/paused'] = false;
    updates['match/ball'] = {x: curMap.fieldW/2, y: curMap.fieldH/2, vx:0, vy:0};

    roomRef.update(updates);
});

// ============================================================
//                    INIT GAME STATE
// ============================================================
function initGameState(){
    if(!roomData) return;
    localPlayers = {};
    if(roomData.players){
        for(var pid in roomData.players){
            var p = roomData.players[pid];
            if(p.online === false) continue;
            localPlayers[pid] = {
                name: p.name || '?',
                team: p.team || 'spectator',
                pos: p.pos || '',
                x: p.x || curMap.fieldW/2,
                y: p.y || curMap.fieldH/2,
                vx: p.vx || 0,
                vy: p.vy || 0,
                kick: false,
                kickCooldown: 0,
                inputDx: 0, inputDy: 0, inputKick: false
            };
        }
    }
    var b = (roomData.match && roomData.match.ball) || {};
    localBall = {
        x: b.x || curMap.fieldW/2,
        y: b.y || curMap.fieldH/2,
        vx: b.vx || 0,
        vy: b.vy || 0
    };
    matchTime = (roomData.match && roomData.match.time) || 0;
    matchRunning = (roomData.match && roomData.match.running) || false;
    matchPaused = (roomData.match && roomData.match.paused) || false;
    redScore = (roomData.match && roomData.match.redScore) || 0;
    blueScore = (roomData.match && roomData.match.blueScore) || 0;
    goalScoredFlag = false;
    goalResetCountdown = 0;
    lastNetSendTime = 0;
    kickBtnDown = false;
    kickFiredThisPress = false;
    $('adminPanelGame').style.display = isHost ? 'block' : 'none';
    adminMenuOpen = false;
    $('adminMenuContent').style.display = 'none';
    $('goalOverlay').style.display = 'none';
    buildAdminMenu();
}

// ============================================================
//                    CLIENT SYNC FROM SERVER
// ============================================================
function clientSyncFromServer(){
    if(!roomData || !roomData.match) return;

    matchRunning = roomData.match.running || false;
    matchPaused = roomData.match.paused || false;
    matchTime = roomData.match.time || 0;

    // Ball interpolation
    if(roomData.match.ball){
        var tb = roomData.match.ball;
        localBall.x = lerp(localBall.x, tb.x, 0.32);
        localBall.y = lerp(localBall.y, tb.y, 0.32);
        localBall.vx = lerp(localBall.vx, tb.vx || 0, 0.38);
        localBall.vy = lerp(localBall.vy, tb.vy || 0, 0.38);
    }

    // Players
    if(roomData.players){
        for(var pid in roomData.players){
            var rd = roomData.players[pid];
            if(rd.online === false){ delete localPlayers[pid]; continue; }
            if(!localPlayers[pid]){
                localPlayers[pid] = {
                    name: rd.name || '?', team: rd.team, pos: rd.pos || '',
                    x: rd.x || curMap.fieldW/2, y: rd.y || curMap.fieldH/2,
                    vx:0, vy:0, kick:false, kickCooldown:0,
                    inputDx:0, inputDy:0, inputKick:false
                };
            }
            var lp2 = localPlayers[pid];
            lp2.team = rd.team;
            lp2.name = rd.name;
            lp2.pos = rd.pos || '';
            lp2.kick = rd.kick || false;

            if(pid === myId && lp2.team !== 'spectator'){
                // Client-side prediction for own player
                var il = Math.sqrt(myInput.dx*myInput.dx + myInput.dy*myInput.dy);
                if(il > 0.05){
                    var n = normVec(myInput.dx, myInput.dy);
                    var str = Math.min(il, 1);
                    lp2.vx += n.x * PLAYER_ACCEL * str;
                    lp2.vy += n.y * PLAYER_ACCEL * str;
                }
                var sp = Math.sqrt(lp2.vx*lp2.vx + lp2.vy*lp2.vy);
                if(sp > PLAYER_MAX_SPEED){
                    lp2.vx = (lp2.vx/sp)*PLAYER_MAX_SPEED;
                    lp2.vy = (lp2.vy/sp)*PLAYER_MAX_SPEED;
                }
                lp2.vx *= curMap.playerFric;
                lp2.vy *= curMap.playerFric;
                if(Math.abs(lp2.vx) < 0.003) lp2.vx = 0;
                if(Math.abs(lp2.vy) < 0.003) lp2.vy = 0;
                lp2.x += lp2.vx;
                lp2.y += lp2.vy;
                // Blend with server
                if(rd.x !== undefined){
                    lp2.x = lerp(lp2.x, rd.x, 0.10);
                    lp2.y = lerp(lp2.y, rd.y, 0.10);
                }
                lp2.x = clamp(lp2.x, PLAYER_RADIUS, curMap.fieldW - PLAYER_RADIUS);
                lp2.y = clamp(lp2.y, PLAYER_RADIUS, curMap.fieldH - PLAYER_RADIUS);
                lp2.kick = (kickBtnDown && !kickFiredThisPress);
            } else {
                // Other players: interpolate
                if(rd.x !== undefined){
                    lp2.x = lerp(lp2.x, rd.x, 0.22);
                    lp2.y = lerp(lp2.y, rd.y, 0.22);
                }
            }
        }
        // Remove disconnected
        for(var pid2 in localPlayers){
            if(!roomData.players[pid2] || roomData.players[pid2].online === false){
                delete localPlayers[pid2];
            }
        }
    }
}

// ============================================================
//                    CLEANUP ROOM
// ============================================================
function cleanupRoom(){
    if(roomRef){
        if(roomListenerHandle) roomRef.off('value', roomListenerHandle);
        roomListenerHandle = null;
        roomRef.child('players/' + myId).remove();
        roomRef = null;
    }
    stopGameLoop();
    roomData = null;
    roomCode = '';
    isHost = false;
    localPlayers = {};
}

// ============================================================
//                    GAME LOOP
// ============================================================
function startGameLoop(){
    if(animFrameId) cancelAnimationFrame(animFrameId);
    lastFrameTimestamp = performance.now();
    physicAccum = 0;
    gameTick(lastFrameTimestamp);
}
function stopGameLoop(){
    if(animFrameId){ cancelAnimationFrame(animFrameId); animFrameId = null; }
}

function gameTick(now){
    animFrameId = requestAnimationFrame(gameTick);
    var dt = now - lastFrameTimestamp;
    lastFrameTimestamp = now;
    if(dt > 80) dt = 80;

    physicAccum += dt;
    var steps = 0;
    while(physicAccum >= FIXED_STEP && steps < 3){
        fixedUpdate(FIXED_STEP / 1000);
        physicAccum -= FIXED_STEP;
        steps++;
    }

    renderGame();
    networkTick(now);
}

// ============================================================
//                    NETWORK TICK
// ============================================================
function networkTick(now){
    if(!roomRef) return;
    if(now - lastNetSendTime < NET_SEND_INTERVAL) return;
    lastNetSendTime = now;

    if(isHost){
        // Host sends everything
        var u = {};
        u['match/ball'] = {
            x: Math.round(localBall.x * 10) / 10,
            y: Math.round(localBall.y * 10) / 10,
            vx: Math.round(localBall.vx * 100) / 100,
            vy: Math.round(localBall.vy * 100) / 100
        };
        u['match/time'] = Math.round(matchTime * 10) / 10;
        u['match/running'] = matchRunning;
        u['match/paused'] = matchPaused;
        u['match/redScore'] = redScore;
        u['match/blueScore'] = blueScore;

        for(var pid in localPlayers){
            var p = localPlayers[pid];
            if(p.team === 'spectator') continue;
            u['players/' + pid + '/x'] = Math.round(p.x * 10) / 10;
            u['players/' + pid + '/y'] = Math.round(p.y * 10) / 10;
            u['players/' + pid + '/vx'] = Math.round(p.vx * 100) / 100;
            u['players/' + pid + '/vy'] = Math.round(p.vy * 100) / 100;
            u['players/' + pid + '/kick'] = p.kick || false;
        }
        roomRef.update(u);
    } else {
        // Client sends only input
        var iu = {};
        iu['players/' + myId + '/idx'] = Math.round(myInput.dx * 100) / 100;
        iu['players/' + myId + '/idy'] = Math.round(myInput.dy * 100) / 100;
        iu['players/' + myId + '/ik'] = (kickBtnDown && !kickFiredThisPress);
        roomRef.update(iu);
    }
}

// ============================================================
//                    FIXED PHYSICS UPDATE (HOST)
// ============================================================
function fixedUpdate(dtSec){
    if(isHost){
        hostPhysicsUpdate(dtSec);
    }
    // Client updates via syncClientState in the Firebase listener
}

function hostPhysicsUpdate(dtSec){
    var FW = curMap.fieldW;
    var FH = curMap.fieldH;
    var GH = curMap.goalH;
    var GD = curMap.goalD;
    var goalTop = FH/2 - GH/2;
    var goalBot = FH/2 + GH/2;

    // ---- MATCH TIME ----
    if(matchRunning && !matchPaused && !goalScoredFlag){
        matchTime += dtSec;
        if(matchTime >= MATCH_DURATION){
            matchRunning = false;
            matchTime = MATCH_DURATION;
            if(roomRef) roomRef.update({'match/running': false});
        }
    }

    // ---- GOAL RESET ----
    if(goalScoredFlag){
        goalResetCountdown -= dtSec * 1000;
        if(goalResetCountdown <= 0){
            goalScoredFlag = false;
            resetAllPositions();
            $('goalOverlay').style.display = 'none';
        }
        return; // freeze during goal celebration
    }

    if(matchPaused || !matchRunning) return;

    // ---- READ INPUTS ----
    if(roomData && roomData.players){
        for(var pid in localPlayers){
            if(pid === myId){
                localPlayers[pid].inputDx = myInput.dx;
                localPlayers[pid].inputDy = myInput.dy;
                localPlayers[pid].inputKick = (kickBtnDown && !kickFiredThisPress);
            } else {
                var rd = roomData.players[pid];
                if(rd){
                    localPlayers[pid].inputDx = rd.idx || 0;
                    localPlayers[pid].inputDy = rd.idy || 0;
                    localPlayers[pid].inputKick = rd.ik || false;
                }
            }
        }
    }

    // ---- SYNC PLAYER LIST ----
    if(roomData && roomData.players){
        for(var pid2 in roomData.players){
            var rd2 = roomData.players[pid2];
            if(rd2.online === false){ delete localPlayers[pid2]; continue; }
            if(!localPlayers[pid2]){
                var sp = getSpawnPos(rd2.team, rd2.pos || 'MID', 0, 1, curMap);
                localPlayers[pid2] = {
                    name: rd2.name, team: rd2.team, pos: rd2.pos || '',
                    x: sp.x, y: sp.y, vx:0, vy:0,
                    kick:false, kickCooldown:0,
                    inputDx:0, inputDy:0, inputKick:false
                };
            }
            localPlayers[pid2].team = rd2.team;
            localPlayers[pid2].name = rd2.name;
            localPlayers[pid2].pos = rd2.pos || '';
        }
        for(var pid3 in localPlayers){
            if(!roomData.players[pid3] || roomData.players[pid3].online === false){
                delete localPlayers[pid3];
            }
        }
    }

    // ---- ACTIVE PLAYER LIST ----
    var activePids = [];
    for(var apid in localPlayers){
        if(localPlayers[apid].team !== 'spectator') activePids.push(apid);
    }

    // ---- PLAYER MOVEMENT ----
    for(var ai = 0; ai < activePids.length; ai++){
        var pp = localPlayers[activePids[ai]];

        // Input acceleration
        var inLen = Math.sqrt(pp.inputDx*pp.inputDx + pp.inputDy*pp.inputDy);
        if(inLen > 0.05){
            var n = normVec(pp.inputDx, pp.inputDy);
            var strength = Math.min(inLen, 1);
            pp.vx += n.x * PLAYER_ACCEL * strength;
            pp.vy += n.y * PLAYER_ACCEL * strength;
        }

        // Speed cap
        var spd = Math.sqrt(pp.vx*pp.vx + pp.vy*pp.vy);
        if(spd > PLAYER_MAX_SPEED){
            pp.vx = (pp.vx / spd) * PLAYER_MAX_SPEED;
            pp.vy = (pp.vy / spd) * PLAYER_MAX_SPEED;
        }

        // Friction
        pp.vx *= curMap.playerFric;
        pp.vy *= curMap.playerFric;
        if(Math.abs(pp.vx) < 0.003) pp.vx = 0;
        if(Math.abs(pp.vy) < 0.003) pp.vy = 0;

        // Move
        pp.x += pp.vx;
        pp.y += pp.vy;

        // ---- SINGLE-PRESS KICK ----
        if(pp.kickCooldown > 0) pp.kickCooldown--;

        if(pp.inputKick && pp.kickCooldown <= 0){
            pp.kick = true;
            pp.kickCooldown = KICK_COOLDOWN_FRAMES;
        } else {
            pp.kick = false;
        }

        // Bounds
        pp.x = clamp(pp.x, PLAYER_RADIUS, FW - PLAYER_RADIUS);
        pp.y = clamp(pp.y, PLAYER_RADIUS, FH - PLAYER_RADIUS);
    }

    // ---- PLAYER-PLAYER COLLISIONS (soft, no strong push) ----
    for(var ci = 0; ci < activePids.length; ci++){
        for(var cj = ci + 1; cj < activePids.length; cj++){
            var pa = localPlayers[activePids[ci]];
            var pb = localPlayers[activePids[cj]];
            var cd = dist(pa.x, pa.y, pb.x, pb.y);
            var minD = PLAYER_RADIUS * 2;
            if(cd < minD && cd > 0.001){
                var cnx = (pb.x - pa.x) / cd;
                var cny = (pb.y - pa.y) / cd;
                var overlap = minD - cd;
                // Separate
                pa.x -= cnx * overlap * 0.5;
                pa.y -= cny * overlap * 0.5;
                pb.x += cnx * overlap * 0.5;
                pb.y += cny * overlap * 0.5;
                // Very soft velocity exchange
                var rdvx = pa.vx - pb.vx;
                var rdvy = pa.vy - pb.vy;
                var rdvn = rdvx * cnx + rdvy * cny;
                if(rdvn > 0){
                    pa.vx -= rdvn * cnx * PLAYER_BOUNCE_DAMP;
                    pa.vy -= rdvn * cny * PLAYER_BOUNCE_DAMP;
                    pb.vx += rdvn * cnx * PLAYER_BOUNCE_DAMP;
                    pb.vy += rdvn * cny * PLAYER_BOUNCE_DAMP;
                }
            }
        }
    }

    // ---- BALL PHYSICS ----
    localBall.vx *= curMap.ballFric;
    localBall.vy *= curMap.ballFric;
    if(Math.abs(localBall.vx) < 0.004) localBall.vx = 0;
    if(Math.abs(localBall.vy) < 0.004) localBall.vy = 0;
    localBall.x += localBall.vx;
    localBall.y += localBall.vy;

    // Ball speed cap
    var bspd = Math.sqrt(localBall.vx*localBall.vx + localBall.vy*localBall.vy);
    if(bspd > BALL_MAX_SPEED){
        localBall.vx = (localBall.vx / bspd) * BALL_MAX_SPEED;
        localBall.vy = (localBall.vy / bspd) * BALL_MAX_SPEED;
    }

    // ---- BALL-PLAYER COLLISIONS ----
    for(var bi = 0; bi < activePids.length; bi++){
        var bp = localPlayers[activePids[bi]];
        var bd = dist(bp.x, bp.y, localBall.x, localBall.y);
        var bMinD = PLAYER_RADIUS + BALL_RADIUS;

        if(bd < bMinD && bd > 0.001){
            var bnx = (localBall.x - bp.x) / bd;
            var bny = (localBall.y - bp.y) / bd;
            var bOverlap = bMinD - bd;

            // Separate ball
            localBall.x += bnx * bOverlap;
            localBall.y += bny * bOverlap;

            // Relative velocity
            var bdvx = localBall.vx - bp.vx;
            var bdvy = localBall.vy - bp.vy;
            var bdvn = bdvx * bnx + bdvy * bny;

            if(bdvn < 0){
                localBall.vx -= bdvn * bnx * 0.7;
                localBall.vy -= bdvn * bny * 0.7;
            }

            if(bp.kick){
                // Single kick impulse
                localBall.vx += bnx * KICK_FORCE;
                localBall.vy += bny * KICK_FORCE;
                bp.kick = false;
                bp.kickCooldown = KICK_COOLDOWN_FRAMES;
                // Mark fired for local player
                if(activePids[bi] === myId){
                    kickFiredThisPress = true;
                }
            } else {
                // Very gentle push (dribble feel)
                localBall.vx += bnx * BALL_PUSH_FORCE;
                localBall.vy += bny * BALL_PUSH_FORCE;
            }
        }
    }

    // ---- GOAL POST COLLISIONS ----
    var posts = [
        {x:0, y:goalTop}, {x:0, y:goalBot},
        {x:FW, y:goalTop}, {x:FW, y:goalBot}
    ];
    for(var pi = 0; pi < posts.length; pi++){
        var po = posts[pi];
        var pd = dist(localBall.x, localBall.y, po.x, po.y);
        if(pd < BALL_RADIUS + POST_RADIUS && pd > 0.001){
            var pnx = (localBall.x - po.x) / pd;
            var pny = (localBall.y - po.y) / pd;
            var pov = BALL_RADIUS + POST_RADIUS - pd;
            localBall.x += pnx * pov;
            localBall.y += pny * pov;
            var pdot = localBall.vx * pnx + localBall.vy * pny;
            if(pdot < 0){
                localBall.vx -= 2 * pdot * pnx * BOUNCE_DAMP;
                localBall.vy -= 2 * pdot * pny * BOUNCE_DAMP;
            }
        }
    }

    // ---- WALL COLLISIONS ----
    // Top wall
    if(localBall.y - BALL_RADIUS < 0){
        localBall.y = BALL_RADIUS;
        localBall.vy = Math.abs(localBall.vy) * BOUNCE_DAMP;
    }
    // Bottom wall
    if(localBall.y + BALL_RADIUS > FH){
        localBall.y = FH - BALL_RADIUS;
        localBall.vy = -Math.abs(localBall.vy) * BOUNCE_DAMP;
    }

    // Left wall / left goal
    if(localBall.x - BALL_RADIUS < 0){
        if(localBall.y > goalTop && localBall.y < goalBot){
            // In goal mouth
            if(localBall.x - BALL_RADIUS < -GD){
                handleGoal('blue');
                return;
            }
            // Inner goal walls
            if(localBall.x < 0){
                if(localBall.y - BALL_RADIUS < goalTop){
                    localBall.y = goalTop + BALL_RADIUS;
                    localBall.vy = Math.abs(localBall.vy) * BOUNCE_DAMP;
                }
                if(localBall.y + BALL_RADIUS > goalBot){
                    localBall.y = goalBot - BALL_RADIUS;
                    localBall.vy = -Math.abs(localBall.vy) * BOUNCE_DAMP;
                }
            }
        } else {
            localBall.x = BALL_RADIUS;
            localBall.vx = Math.abs(localBall.vx) * BOUNCE_DAMP;
        }
    }

    // Right wall / right goal
    if(localBall.x + BALL_RADIUS > FW){
        if(localBall.y > goalTop && localBall.y < goalBot){
            if(localBall.x + BALL_RADIUS > FW + GD){
                handleGoal('red');
                return;
            }
            if(localBall.x > FW){
                if(localBall.y - BALL_RADIUS < goalTop){
                    localBall.y = goalTop + BALL_RADIUS;
                    localBall.vy = Math.abs(localBall.vy) * BOUNCE_DAMP;
                }
                if(localBall.y + BALL_RADIUS > goalBot){
                    localBall.y = goalBot - BALL_RADIUS;
                    localBall.vy = -Math.abs(localBall.vy) * BOUNCE_DAMP;
                }
            }
        } else {
            localBall.x = FW - BALL_RADIUS;
            localBall.vx = -Math.abs(localBall.vx) * BOUNCE_DAMP;
        }
    }

    // Goal back walls
    if(localBall.x < 0 && localBall.y > goalTop && localBall.y < goalBot){
        if(localBall.x - BALL_RADIUS < -GD){
            localBall.x = -GD + BALL_RADIUS;
            localBall.vx = Math.abs(localBall.vx) * BOUNCE_DAMP;
        }
    }
    if(localBall.x > FW && localBall.y > goalTop && localBall.y < goalBot){
        if(localBall.x + BALL_RADIUS > FW + GD){
            localBall.x = FW + GD - BALL_RADIUS;
            localBall.vx = -Math.abs(localBall.vx) * BOUNCE_DAMP;
        }
    }
}

// ============================================================
//                    GOAL HANDLING
// ============================================================
function handleGoal(scoringTeam){
    goalScoredFlag = true;
    goalResetCountdown = GOAL_RESET_MS;

    if(scoringTeam === 'red'){
        redScore++;
        $('goalText').textContent = 'üî¥ GOL!';
        $('goalText').style.color = '#e74c3c';
    } else {
        blueScore++;
        $('goalText').textContent = 'üîµ GOL!';
        $('goalText').style.color = '#3498db';
    }
    $('goalOverlay').style.display = 'flex';

    // Freeze everything
    localBall.vx = 0; localBall.vy = 0;
    for(var pid in localPlayers){
        localPlayers[pid].vx = 0;
        localPlayers[pid].vy = 0;
    }

    if(roomRef){
        roomRef.update({'match/redScore': redScore, 'match/blueScore': blueScore});
    }
}

function resetAllPositions(){
    localBall.x = curMap.fieldW / 2;
    localBall.y = curMap.fieldH / 2;
    localBall.vx = 0;
    localBall.vy = 0;

    var redPids = [], bluePids = [];
    for(var pid in localPlayers){
        if(localPlayers[pid].team === 'red') redPids.push(pid);
        else if(localPlayers[pid].team === 'blue') bluePids.push(pid);
    }
    spawnGroupLocal(redPids, 'red');
    spawnGroupLocal(bluePids, 'blue');
}

function spawnGroupLocal(pids, team){
    var groups = {GK:[], DEF:[], MID:[], FWD:[]};
    for(var i = 0; i < pids.length; i++){
        var p = localPlayers[pids[i]];
        var pos = p.pos || 'MID';
        if(!groups[pos]) groups[pos] = [];
        groups[pos].push(pids[i]);
    }
    for(var posKey in groups){
        var arr = groups[posKey];
        for(var j = 0; j < arr.length; j++){
            var sp = getSpawnPos(team, posKey, j, arr.length, curMap);
            localPlayers[arr[j]].x = sp.x;
            localPlayers[arr[j]].y = sp.y;
            localPlayers[arr[j]].vx = 0;
            localPlayers[arr[j]].vy = 0;
        }
    }
}

// ============================================================
//                    RENDER
// ============================================================
function renderGame(){
    ctx.clearRect(0, 0, canvasW, canvasH);

    // Background
    ctx.fillStyle = curMap.bgColor;
    ctx.fillRect(0, 0, canvasW, canvasH);

    ctx.save();
    ctx.translate(viewOffX, viewOffY);
    ctx.scale(viewScale, viewScale);
    ctx.translate(FIELD_MARGIN, FIELD_MARGIN);

    drawField();
    drawBall();
    drawPlayers();

    ctx.restore();

    updateHUD();
}

// ============================================================
//                    DRAW FIELD
// ============================================================
function drawField(){
    var FW = curMap.fieldW, FH = curMap.fieldH;
    var GH = curMap.goalH, GD = curMap.goalD;
    var gT = FH/2 - GH/2, gB = FH/2 + GH/2;
    var lc = curMap.lineColor;

    // Floor
    ctx.fillStyle = curMap.floorColor;
    ctx.fillRect(0, 0, FW, FH);

    // Stripe pattern
    ctx.fillStyle = curMap.floorColor2;
    var strW = FW / 14;
    for(var si = 0; si < 14; si += 2){
        ctx.fillRect(si * strW, 0, strW, FH);
    }

    // Border
    ctx.strokeStyle = lc;
    ctx.lineWidth = 3;
    ctx.strokeRect(0, 0, FW, FH);

    // Center line
    ctx.beginPath(); ctx.moveTo(FW/2, 0); ctx.lineTo(FW/2, FH); ctx.stroke();

    // Center circle
    ctx.beginPath(); ctx.arc(FW/2, FH/2, curMap.centerR, 0, Math.PI*2); ctx.stroke();

    // Center dot
    ctx.fillStyle = lc;
    ctx.beginPath(); ctx.arc(FW/2, FH/2, 4, 0, Math.PI*2); ctx.fill();

    // Penalty areas
    ctx.lineWidth = 2;
    ctx.strokeRect(0, FH/2 - curMap.penH/2, curMap.penW, curMap.penH);
    ctx.strokeRect(FW - curMap.penW, FH/2 - curMap.penH/2, curMap.penW, curMap.penH);

    // Penalty dots
    ctx.fillStyle = lc;
    ctx.beginPath(); ctx.arc(curMap.penW * 0.75, FH/2, 3, 0, Math.PI*2); ctx.fill();
    ctx.beginPath(); ctx.arc(FW - curMap.penW * 0.75, FH/2, 3, 0, Math.PI*2); ctx.fill();

    // Penalty arcs
    ctx.beginPath(); ctx.arc(curMap.penW, FH/2, curMap.penH*0.26, -Math.PI/2, Math.PI/2); ctx.stroke();
    ctx.beginPath(); ctx.arc(FW - curMap.penW, FH/2, curMap.penH*0.26, Math.PI/2, Math.PI*1.5); ctx.stroke();

    // Corner arcs
    var cr = 22;
    ctx.beginPath(); ctx.arc(0, 0, cr, 0, Math.PI/2); ctx.stroke();
    ctx.beginPath(); ctx.arc(FW, 0, cr, Math.PI/2, Math.PI); ctx.stroke();
    ctx.beginPath(); ctx.arc(0, FH, cr, -Math.PI/2, 0); ctx.stroke();
    ctx.beginPath(); ctx.arc(FW, FH, cr, Math.PI, Math.PI*1.5); ctx.stroke();

    // Position guide lines (subtle)
    ctx.strokeStyle = 'rgba(255,255,255,0.04)';
    ctx.lineWidth = 1;
    ctx.setLineDash([4, 8]);
    ctx.beginPath(); ctx.moveTo(FW*0.25, 0); ctx.lineTo(FW*0.25, FH); ctx.stroke();
    ctx.beginPath(); ctx.moveTo(FW*0.75, 0); ctx.lineTo(FW*0.75, FH); ctx.stroke();
    ctx.beginPath(); ctx.moveTo(FW*0.18, 0); ctx.lineTo(FW*0.18, FH); ctx.stroke();
    ctx.beginPath(); ctx.moveTo(FW*0.82, 0); ctx.lineTo(FW*0.82, FH); ctx.stroke();
    ctx.setLineDash([]);

    // ---- LEFT GOAL ----
    ctx.fillStyle = 'rgba(231,76,60,0.07)';
    ctx.fillRect(-GD, gT, GD, GH);
    ctx.strokeStyle = 'rgba(231,76,60,0.12)';
    ctx.lineWidth = 1;
    for(var gy = gT; gy <= gB; gy += 10){
        ctx.beginPath(); ctx.moveTo(-GD, gy); ctx.lineTo(0, gy); ctx.stroke();
    }
    for(var gx = -GD; gx <= 0; gx += 10){
        ctx.beginPath(); ctx.moveTo(gx, gT); ctx.lineTo(gx, gB); ctx.stroke();
    }
    ctx.strokeStyle = 'rgba(231,76,60,0.7)';
    ctx.lineWidth = 3.5;
    ctx.beginPath();
    ctx.moveTo(0, gT); ctx.lineTo(-GD, gT); ctx.lineTo(-GD, gB); ctx.lineTo(0, gB);
    ctx.stroke();

    // ---- RIGHT GOAL ----
    ctx.fillStyle = 'rgba(52,152,219,0.07)';
    ctx.fillRect(FW, gT, GD, GH);
    ctx.strokeStyle = 'rgba(52,152,219,0.12)';
    ctx.lineWidth = 1;
    for(var gy2 = gT; gy2 <= gB; gy2 += 10){
        ctx.beginPath(); ctx.moveTo(FW, gy2); ctx.lineTo(FW+GD, gy2); ctx.stroke();
    }
    for(var gx2 = FW; gx2 <= FW+GD; gx2 += 10){
        ctx.beginPath(); ctx.moveTo(gx2, gT); ctx.lineTo(gx2, gB); ctx.stroke();
    }
    ctx.strokeStyle = 'rgba(52,152,219,0.7)';
    ctx.lineWidth = 3.5;
    ctx.beginPath();
    ctx.moveTo(FW, gT); ctx.lineTo(FW+GD, gT); ctx.lineTo(FW+GD, gB); ctx.lineTo(FW, gB);
    ctx.stroke();

    // ---- GOAL POSTS ----
    ctx.fillStyle = '#ddd';
    ctx.strokeStyle = '#999';
    ctx.lineWidth = 1.5;
    ctx.beginPath(); ctx.arc(0, gT, POST_RADIUS, 0, Math.PI*2); ctx.fill(); ctx.stroke();
    ctx.beginPath(); ctx.arc(0, gB, POST_RADIUS, 0, Math.PI*2); ctx.fill(); ctx.stroke();
    ctx.beginPath(); ctx.arc(FW, gT, POST_RADIUS, 0, Math.PI*2); ctx.fill(); ctx.stroke();
    ctx.beginPath(); ctx.arc(FW, gB, POST_RADIUS, 0, Math.PI*2); ctx.fill(); ctx.stroke();
}

// ============================================================
//                    DRAW BALL
// ============================================================
function drawBall(){
    // Shadow
    ctx.fillStyle = 'rgba(0,0,0,0.14)';
    ctx.beginPath();
    ctx.arc(localBall.x + 1.5, localBall.y + 2.5, BALL_RADIUS, 0, Math.PI*2);
    ctx.fill();

    // Ball gradient
    var bg = ctx.createRadialGradient(localBall.x - 2, localBall.y - 2, 1, localBall.x, localBall.y, BALL_RADIUS);
    bg.addColorStop(0, '#ffffff');
    bg.addColorStop(1, '#dddddd');
    ctx.fillStyle = bg;
    ctx.beginPath();
    ctx.arc(localBall.x, localBall.y, BALL_RADIUS, 0, Math.PI*2);
    ctx.fill();

    // Outline
    ctx.strokeStyle = '#aaa';
    ctx.lineWidth = 1;
    ctx.beginPath();
    ctx.arc(localBall.x, localBall.y, BALL_RADIUS, 0, Math.PI*2);
    ctx.stroke();

    // Pentagon pattern
    ctx.fillStyle = 'rgba(0,0,0,0.06)';
    for(var pi = 0; pi < 5; pi++){
        var pa = (pi / 5) * Math.PI * 2 - Math.PI / 2;
        var ppx = localBall.x + Math.cos(pa) * BALL_RADIUS * 0.5;
        var ppy = localBall.y + Math.sin(pa) * BALL_RADIUS * 0.5;
        ctx.beginPath();
        ctx.arc(ppx, ppy, BALL_RADIUS * 0.2, 0, Math.PI*2);
        ctx.fill();
    }

    // Speed trail
    var bsp = Math.sqrt(localBall.vx*localBall.vx + localBall.vy*localBall.vy);
    if(bsp > 2.5){
        var alpha = Math.min((bsp - 2.5) / 8, 0.25);
        ctx.strokeStyle = 'rgba(255,255,255,' + alpha + ')';
        ctx.lineWidth = 1.5;
        ctx.beginPath();
        ctx.moveTo(localBall.x, localBall.y);
        ctx.lineTo(localBall.x - localBall.vx * 2.5, localBall.y - localBall.vy * 2.5);
        ctx.stroke();
    }
}

// ============================================================
//                    DRAW PLAYERS
// ============================================================
function drawPlayers(){
    var posShort = {GK:'GK', DEF:'DF', MID:'MF', FWD:'FW'};

    for(var pid in localPlayers){
        var p = localPlayers[pid];
        if(p.team === 'spectator') continue;

        var isMe = (pid === myId);

        // ---- KICK HALO ----
        if(p.kick || p.kickCooldown > KICK_COOLDOWN_FRAMES - 3){
            var haloGrad = ctx.createRadialGradient(p.x, p.y, PLAYER_RADIUS, p.x, p.y, KICK_HALO_RADIUS);
            haloGrad.addColorStop(0, 'rgba(255,255,255,0.14)');
            haloGrad.addColorStop(1, 'rgba(255,255,255,0)');
            ctx.fillStyle = haloGrad;
            ctx.beginPath();
            ctx.arc(p.x, p.y, KICK_HALO_RADIUS, 0, Math.PI*2);
            ctx.fill();

            ctx.strokeStyle = 'rgba(255,255,255,0.4)';
            ctx.lineWidth = 2;
            ctx.setLineDash([3, 3]);
            ctx.beginPath();
            ctx.arc(p.x, p.y, KICK_HALO_RADIUS, 0, Math.PI*2);
            ctx.stroke();
            ctx.setLineDash([]);
        }

        // ---- SHADOW ----
        ctx.fillStyle = 'rgba(0,0,0,0.12)';
        ctx.beginPath();
        ctx.arc(p.x + 1.5, p.y + 2.5, PLAYER_RADIUS, 0, Math.PI*2);
        ctx.fill();

        // ---- BODY GRADIENT ----
        var grad;
        if(p.team === 'red'){
            grad = ctx.createRadialGradient(p.x - 4, p.y - 4, 1, p.x, p.y, PLAYER_RADIUS);
            grad.addColorStop(0, '#ff7675');
            grad.addColorStop(1, '#c0392b');
        } else {
            grad = ctx.createRadialGradient(p.x - 4, p.y - 4, 1, p.x, p.y, PLAYER_RADIUS);
            grad.addColorStop(0, '#74b9ff');
            grad.addColorStop(1, '#2980b9');
        }
        ctx.fillStyle = grad;
        ctx.beginPath();
        ctx.arc(p.x, p.y, PLAYER_RADIUS, 0, Math.PI*2);
        ctx.fill();

        // ---- BORDER ----
        ctx.strokeStyle = isMe ? '#ffffff' : 'rgba(255,255,255,0.3)';
        ctx.lineWidth = isMe ? 2.5 : 1.2;
        ctx.beginPath();
        ctx.arc(p.x, p.y, PLAYER_RADIUS, 0, Math.PI*2);
        ctx.stroke();

        // ---- POSITION TEXT ON PLAYER ----
        if(p.pos && posShort[p.pos]){
            ctx.fillStyle = 'rgba(0,0,0,0.25)';
            ctx.font = 'bold 8px Arial';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            ctx.fillText(posShort[p.pos], p.x + 0.5, p.y + 0.5);
            ctx.fillStyle = 'rgba(255,255,255,0.65)';
            ctx.fillText(posShort[p.pos], p.x, p.y);
        }

        // ---- DIRECTION DOT ----
        var pSpd = Math.sqrt(p.vx*p.vx + p.vy*p.vy);
        if(pSpd > 0.3){
            var dn = normVec(p.vx, p.vy);
            ctx.fillStyle = 'rgba(255,255,255,0.4)';
            ctx.beginPath();
            ctx.arc(p.x + dn.x * PLAYER_RADIUS * 0.65, p.y + dn.y * PLAYER_RADIUS * 0.65, 2.5, 0, Math.PI*2);
            ctx.fill();
        }

        // ---- NAME ----
        ctx.fillStyle = '#fff';
        ctx.font = 'bold 9px Arial';
        ctx.textAlign = 'center';
        ctx.textBaseline = 'bottom';
        ctx.strokeStyle = 'rgba(0,0,0,0.5)';
        ctx.lineWidth = 2;
        ctx.strokeText(p.name || '?', p.x, p.y - PLAYER_RADIUS - 4);
        ctx.fillText(p.name || '?', p.x, p.y - PLAYER_RADIUS - 4);

        // ---- "YOU" INDICATOR ----
        if(isMe){
            ctx.fillStyle = 'rgba(255,255,255,0.5)';
            ctx.font = '8px Arial';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'bottom';
            ctx.fillText('‚ñº', p.x, p.y - PLAYER_RADIUS - 13);
        }
    }
}

// ============================================================
//                    HUD UPDATE
// ============================================================
function updateHUD(){
    $('hudRed').textContent = redScore;
    $('hudBlue').textContent = blueScore;

    var mins = Math.floor(matchTime / 60);
    var secs = Math.floor(matchTime % 60);
    $('hudTimer').textContent = mins + ':' + (secs < 10 ? '0' : '') + secs;

    if(matchPaused){
        $('hudStatus').textContent = 'DURAKLATILDI';
    } else if(!matchRunning && matchTime >= MATCH_DURATION){
        $('hudStatus').textContent = 'MA√á Bƒ∞TTƒ∞';
    } else if(goalScoredFlag){
        $('hudStatus').textContent = 'GOL!';
    } else {
        $('hudStatus').textContent = '';
    }
}

// ============================================================
//                    ADMIN MENU (IN GAME)
// ============================================================
function buildAdminMenu(){
    if(!isHost) return;
    var mc = $('adminMenuContent');

    var posLabels = {GK:'KAL', DEF:'DEF', MID:'ORS', FWD:'FRV'};
    var mapOptions = '';
    for(var mk in MAPS){
        mapOptions += '<option value="' + mk + '"' + (mk === curMapKey ? ' selected' : '') + '>' + MAPS[mk].name + '</option>';
    }

    var playersHTML = '';
    if(roomData && roomData.players){
        for(var pid in roomData.players){
            var p = roomData.players[pid];
            if(p.online === false) continue;
            var tc = p.team === 'red' ? '#e74c3c' : (p.team === 'blue' ? '#3498db' : '#888');
            var posOpts = '<option value="">-</option>';
            var allPos = ['GK','DEF','MID','FWD'];
            for(var pi2 = 0; pi2 < allPos.length; pi2++){
                posOpts += '<option value="' + allPos[pi2] + '"' + (p.pos === allPos[pi2] ? ' selected' : '') + '>' + posLabels[allPos[pi2]] + '</option>';
            }
            playersHTML += '<div class="adm-player-row">' +
                '<span class="apr-name" style="color:' + tc + '">' + (p.name || '?') + '</span>' +
                '<button style="background:#e74c3c" data-mpid="' + pid + '" data-mact="red">K</button>' +
                '<button style="background:#3498db" data-mpid="' + pid + '" data-mact="blue">M</button>' +
                '<button style="background:#555" data-mpid="' + pid + '" data-mact="spectator">ƒ∞</button>' +
                '<select data-mpid="' + pid + '" data-mtype="pos">' + posOpts + '</select>' +
                '</div>';
        }
    }

    mc.innerHTML =
        '<div class="sec">‚öôÔ∏è KONTROL</div>' +
        '<button style="background:#f39c12" id="admPause">' + (matchPaused ? '‚ñ∂ Devam Et' : '‚è∏ Duraklat') + '</button>' +
        '<button style="background:#e74c3c" id="admReset">üîÑ Skor Sƒ±fƒ±rla</button>' +
        '<button style="background:#3498db" id="admLobby">üîô Lobiye D√∂n</button>' +
        '<div class="sec">üó∫Ô∏è HARƒ∞TA DEƒûƒ∞≈ûTƒ∞R</div>' +
        '<select id="admMapSel">' + mapOptions + '</select>' +
        '<button style="background:#27ae60" id="admMapApply">‚úÖ Haritayƒ± Uygula</button>' +
        '<div class="sec">üë• TAKIM & MEVKƒ∞</div>' +
        playersHTML;

    // ---- EVENT LISTENERS ----

    // Pause
    var pauseBtn = $('admPause');
    if(pauseBtn){
        pauseBtn.onclick = function(){
            matchPaused = !matchPaused;
            roomRef.update({'match/paused': matchPaused});
            pauseBtn.textContent = matchPaused ? '‚ñ∂ Devam Et' : '‚è∏ Duraklat';
            toast(matchPaused ? 'Duraklatƒ±ldƒ±' : 'Devam ediyor');
        };
    }

    // Reset Score
    var resetBtn = $('admReset');
    if(resetBtn){
        resetBtn.onclick = function(){
            redScore = 0;
            blueScore = 0;
            matchTime = 0;
            roomRef.update({
                'match/redScore': 0,
                'match/blueScore': 0,
                'match/time': 0
            });
            resetAllPositions();
            toast('Skor sƒ±fƒ±rlandƒ±');
        };
    }

    // Back to lobby
    var lobbyBtn = $('admLobby');
    if(lobbyBtn){
        lobbyBtn.onclick = function(){
            matchRunning = false;
            matchPaused = false;
            goalScoredFlag = false;
            roomRef.update({
                state: 'lobby',
                'match/running': false,
                'match/paused': false
            });
            stopGameLoop();
            showScreen('lobby');
            toast('Lobiye d√∂n√ºld√º');
        };
    }

    // Map apply
    var mapApplyBtn = $('admMapApply');
    if(mapApplyBtn){
        mapApplyBtn.onclick = function(){
            var newKey = $('admMapSel').value;
            if(newKey === curMapKey){ toast('Zaten bu harita aktif'); return; }
            curMapKey = newKey;
            curMap = MAPS[curMapKey];
            // Update in Firebase - keep scores
            roomRef.update({
                mapKey: curMapKey,
                'match/ball': {x: curMap.fieldW/2, y: curMap.fieldH/2, vx:0, vy:0}
            });
            localBall.x = curMap.fieldW / 2;
            localBall.y = curMap.fieldH / 2;
            localBall.vx = 0;
            localBall.vy = 0;
            resetAllPositions();
            resizeCanvas();
            toast('Harita deƒüi≈ütirildi: ' + curMap.name);
        };
    }

    // Player team/pos change buttons
    mc.querySelectorAll('[data-mact]').forEach(function(btn){
        btn.onclick = function(){
            var tPid = btn.getAttribute('data-mpid');
            var tAct = btn.getAttribute('data-mact');
            if(tAct === 'spectator'){
                roomRef.child('players/' + tPid).update({team: 'spectator', pos: ''});
            } else {
                var ts = getTeamSize(roomData.players, tAct, null);
                if(ts >= 11){ toast('Takƒ±m dolu!'); return; }
                var np = autoAssignPos(roomData.players, tAct, tPid);
                roomRef.child('players/' + tPid).update({team: tAct, pos: np});
                // Respawn
                setTimeout(function(){
                    if(localPlayers[tPid]){
                        var sp = getSpawnPos(tAct, np, 0, 1, curMap);
                        localPlayers[tPid].x = sp.x;
                        localPlayers[tPid].y = sp.y;
                        localPlayers[tPid].vx = 0;
                        localPlayers[tPid].vy = 0;
                        localPlayers[tPid].team = tAct;
                        localPlayers[tPid].pos = np;
                    }
                }, 150);
            }
            setTimeout(buildAdminMenu, 400);
        };
    });

    // Position change selects
    mc.querySelectorAll('[data-mtype="pos"]').forEach(function(sel){
        sel.onchange = function(){
            var tPid = sel.getAttribute('data-mpid');
            var newPos = sel.value;
            roomRef.child('players/' + tPid).update({pos: newPos});
            if(localPlayers[tPid] && newPos){
                var sp = getSpawnPos(localPlayers[tPid].team, newPos, 0, 1, curMap);
                localPlayers[tPid].x = sp.x;
                localPlayers[tPid].y = sp.y;
                localPlayers[tPid].vx = 0;
                localPlayers[tPid].vy = 0;
                localPlayers[tPid].pos = newPos;
            }
        };
    });
}

// Admin toggle
$('adminToggleBtn').addEventListener('click', function(e){
    e.stopPropagation();
    adminMenuOpen = !adminMenuOpen;
    $('adminMenuContent').style.display = adminMenuOpen ? 'block' : 'none';
    if(adminMenuOpen) buildAdminMenu();
});

// Prevent admin panel touch from propagating
$('adminPanelGame').addEventListener('touchstart', function(e){ e.stopPropagation(); }, {passive:false});
$('adminPanelGame').addEventListener('touchmove', function(e){ e.stopPropagation(); }, {passive:false});
$('adminPanelGame').addEventListener('touchend', function(e){ e.stopPropagation(); }, {passive:false});
$('adminPanelGame').addEventListener('click', function(e){ e.stopPropagation(); });

// ============================================================
//                    TOUCH CONTROLS - JOYSTICK
// ============================================================
var joyZone = $('joyZone');
var joyBaseEl = $('joyBase');
var joyThumbEl = $('joyThumb');

joyZone.addEventListener('touchstart', function(e){
    e.preventDefault();
    if(joyTouchId !== null) return;
    var t = e.changedTouches[0];
    joyTouchId = t.identifier;
    joyActive = true;
    joySX = t.clientX;
    joySY = t.clientY;
    showJoystick(t.clientX, t.clientY, t.clientX, t.clientY);
}, {passive:false});

joyZone.addEventListener('touchmove', function(e){
    e.preventDefault();
    for(var i = 0; i < e.changedTouches.length; i++){
        var t = e.changedTouches[i];
        if(t.identifier !== joyTouchId) continue;
        var dx = t.clientX - joySX;
        var dy = t.clientY - joySY;
        var maxR = 48;
        var d = Math.sqrt(dx*dx + dy*dy);
        var clamped = Math.min(d, maxR);
        var angle = Math.atan2(dy, dx);
        var cx = Math.cos(angle) * clamped;
        var cy = Math.sin(angle) * clamped;
        myInput.dx = cx / maxR;
        myInput.dy = cy / maxR;
        showJoystick(joySX, joySY, joySX + cx, joySY + cy);
    }
}, {passive:false});

joyZone.addEventListener('touchend', function(e){
    e.preventDefault();
    for(var i = 0; i < e.changedTouches.length; i++){
        if(e.changedTouches[i].identifier === joyTouchId){
            joyTouchId = null;
            joyActive = false;
            myInput.dx = 0;
            myInput.dy = 0;
            hideJoystick();
        }
    }
}, {passive:false});

joyZone.addEventListener('touchcancel', function(e){
    for(var i = 0; i < e.changedTouches.length; i++){
        if(e.changedTouches[i].identifier === joyTouchId){
            joyTouchId = null;
            joyActive = false;
            myInput.dx = 0;
            myInput.dy = 0;
            hideJoystick();
        }
    }
}, {passive:false});

function showJoystick(bx, by, tx, ty){
    joyBaseEl.style.display = 'block';
    joyBaseEl.style.left = (bx - 54) + 'px';
    joyBaseEl.style.top = (by - 54) + 'px';
    joyThumbEl.style.display = 'block';
    joyThumbEl.style.left = (tx - 22) + 'px';
    joyThumbEl.style.top = (ty - 22) + 'px';
}

function hideJoystick(){
    joyBaseEl.style.display = 'none';
    joyThumbEl.style.display = 'none';
}

// ============================================================
//              TOUCH CONTROLS - KICK BUTTON
//              (Single press - not hold!)
// ============================================================
var kickButtonEl = $('kickButton');

kickButtonEl.addEventListener('touchstart', function(e){
    e.preventDefault();
    e.stopPropagation();
    if(!kickBtnDown){
        kickBtnDown = true;
        kickFiredThisPress = false;
        myInput.kick = true;
        kickButtonEl.classList.add('active');
    }
}, {passive:false});

kickButtonEl.addEventListener('touchend', function(e){
    e.preventDefault();
    e.stopPropagation();
    kickBtnDown = false;
    kickFiredThisPress = false;
    myInput.kick = false;
    kickButtonEl.classList.remove('active');
}, {passive:false});

kickButtonEl.addEventListener('touchcancel', function(e){
    kickBtnDown = false;
    kickFiredThisPress = false;
    myInput.kick = false;
    kickButtonEl.classList.remove('active');
}, {passive:false});

// ============================================================
//                    KEYBOARD CONTROLS
// ============================================================
document.addEventListener('keydown', function(e){
    if(gameState !== 'game') return;
    var key = e.key.toLowerCase();
    keysDown[key] = true;
    if((key === ' ' || key === 'x') && !kickBtnDown){
        kickBtnDown = true;
        kickFiredThisPress = false;
        myInput.kick = true;
    }
    updateKeyboardInput();
});

document.addEventListener('keyup', function(e){
    var key = e.key.toLowerCase();
    keysDown[key] = false;
    if(key === ' ' || key === 'x'){
        kickBtnDown = false;
        kickFiredThisPress = false;
        myInput.kick = false;
    }
    updateKeyboardInput();
});

function updateKeyboardInput(){
    if(joyActive) return;
    var dx = 0, dy = 0;
    if(keysDown['w'] || keysDown['arrowup']) dy = -1;
    if(keysDown['s'] || keysDown['arrowdown']) dy = 1;
    if(keysDown['a'] || keysDown['arrowleft']) dx = -1;
    if(keysDown['d'] || keysDown['arrowright']) dx = 1;
    myInput.dx = dx;
    myInput.dy = dy;
}

// Focus fix for keyboard on non-host windows
document.addEventListener('click', function(){
    if(gameState === 'game') canvas.focus();
});
document.addEventListener('touchstart', function(){
    if(gameState === 'game') canvas.focus();
}, {passive:true});

// ============================================================
//                    WINDOW EVENTS
// ============================================================
window.addEventListener('beforeunload', function(){
    if(roomRef){
        roomRef.child('players/' + myId).update({online: false});
    }
});

// ============================================================
//                    INITIALIZATION
// ============================================================
$('inpName').value = 'Oyuncu' + Math.floor(Math.random() * 900 + 100);
showScreen('menu');
hideJoystick();

// Set canvas focusable
canvas.setAttribute('tabindex', '0');

})();
</script>
</body>
</html>
