<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
<title>HaxBall Arena</title>
<style>
*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent;user-select:none;-webkit-user-select:none}
html,body{width:100%;height:100%;overflow:hidden;background:#2b5c3a;font-family:'Segoe UI',Arial,sans-serif;color:#fff;touch-action:none}
canvas#field{position:fixed;top:0;left:0;z-index:1}
#rotate-msg{position:fixed;top:0;left:0;width:100%;height:100%;z-index:9999;background:#1a3d24;display:none;flex-direction:column;align-items:center;justify-content:center;font-size:16px;color:#8fc49f;text-align:center;padding:30px}
#rotate-msg .ri{font-size:50px;margin-bottom:15px;animation:rot 2s ease-in-out infinite}
@keyframes rot{0%,100%{transform:rotate(0)}50%{transform:rotate(90deg)}}
@media(orientation:portrait){#rotate-msg{display:flex!important}}

#score-hud{position:fixed;top:0;left:50%;transform:translateX(-50%);z-index:80;display:none;align-items:center;font-weight:900}
.ts{padding:8px 22px;font-size:28px;min-width:55px;text-align:center}
.rsc{background:rgba(220,50,50,.85);border-radius:0 0 0 10px;color:#fff}
.bsc{background:rgba(50,100,220,.85);border-radius:0 0 10px 0;color:#fff}
.dv{background:rgba(0,0,0,.6);padding:6px 10px;font-size:14px;color:rgba(255,255,255,.5);letter-spacing:2px}
#map-name{position:fixed;top:44px;left:50%;transform:translateX(-50%);z-index:80;display:none;font-size:9px;color:rgba(255,255,255,.25);letter-spacing:2px;background:rgba(0,0,0,.3);padding:2px 10px;border-radius:3px;pointer-events:none}
#win-tgt{position:fixed;top:58px;left:50%;transform:translateX(-50%);z-index:80;display:none;font-size:9px;color:rgba(255,255,255,.2);letter-spacing:1px;pointer-events:none}

#goal-ov{position:fixed;top:0;left:0;width:100%;height:100%;z-index:100;display:none;align-items:center;justify-content:center;pointer-events:none;flex-direction:column}
#goal-txt{font-size:clamp(40px,10vw,80px);font-weight:900;letter-spacing:8px;text-shadow:0 4px 20px rgba(0,0,0,.5);animation:gp .5s ease}
#goal-sub{font-size:16px;color:rgba(255,255,255,.5);margin-top:5px;letter-spacing:3px}
@keyframes gp{0%{transform:scale(0);opacity:0}50%{transform:scale(1.2)}100%{transform:scale(1);opacity:1}}

#win-scr{position:fixed;top:0;left:0;width:100%;height:100%;z-index:200;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.8);flex-direction:column;backdrop-filter:blur(5px);pointer-events:none}
#win-scr .wt{font-size:clamp(24px,5vw,48px);font-weight:900;letter-spacing:5px;margin-bottom:8px}
#win-scr .wt.red{color:#ff4444;text-shadow:0 0 30px rgba(255,0,0,.4)}
#win-scr .wt.blue{color:#4488ff;text-shadow:0 0 30px rgba(0,100,255,.4)}
#win-scr .ws{font-size:20px;color:rgba(255,255,255,.5);margin-bottom:15px}

#pinfo{position:fixed;bottom:8px;left:50%;transform:translateX(-50%);z-index:75;display:none;font-size:10px;color:rgba(255,255,255,.3);letter-spacing:1px;background:rgba(0,0,0,.2);padding:3px 10px;border-radius:4px;pointer-events:none}

#joy-zone{position:fixed;bottom:15px;left:15px;z-index:70;display:none;pointer-events:all;width:160px;height:160px}
#joy-base{width:130px;height:130px;border-radius:50%;background:rgba(255,255,255,.06);border:2px solid rgba(255,255,255,.12);position:absolute;bottom:10px;left:10px}
#joy-knob{width:54px;height:54px;border-radius:50%;background:rgba(255,255,255,.15);border:2px solid rgba(255,255,255,.2);position:absolute;top:50%;left:50%;transform:translate(-50%,-50%)}
#kick-btn{position:fixed;bottom:30px;right:30px;z-index:70;display:none;pointer-events:all;width:85px;height:85px;border-radius:50%;background:rgba(255,255,255,.1);border:3px solid rgba(255,255,255,.25);color:rgba(255,255,255,.7);font-size:13px;font-weight:900;letter-spacing:1px;cursor:pointer;line-height:85px;text-align:center;font-family:inherit}
#kick-btn:active,#kick-btn.active{background:rgba(255,255,255,.25);border-color:rgba(255,255,255,.5);transform:scale(.92)}

/* Admin bar */
#admin-bar{position:fixed;top:8px;left:8px;z-index:85;display:none;pointer-events:all;gap:4px;flex-wrap:wrap}
#admin-bar button{background:rgba(0,0,0,.5);border:1px solid rgba(255,255,255,.15);color:rgba(255,255,255,.6);padding:5px 10px;border-radius:4px;font-size:10px;cursor:pointer;font-family:inherit;letter-spacing:1px}
#admin-bar button:active{background:rgba(255,255,255,.15)}

/* MENU */
#menu{position:fixed;top:0;left:0;width:100%;height:100%;z-index:300;display:flex;flex-direction:column;align-items:center;justify-content:center;background:linear-gradient(135deg,#1a3d24,#2b5c3a,#1e4a2d)}
.mbg{position:absolute;top:0;left:0;width:100%;height:100%;opacity:.15;background-image:radial-gradient(rgba(255,255,255,.08) 1px,transparent 1px);background-size:25px 25px}
.mt{font-size:clamp(28px,6vw,48px);font-weight:900;letter-spacing:3px;color:#fff;text-shadow:0 2px 10px rgba(0,0,0,.3);z-index:1;text-align:center}
.ms{font-size:clamp(10px,2vw,14px);letter-spacing:5px;color:rgba(255,255,255,.3);z-index:1;margin-bottom:25px;text-transform:uppercase}
.mball{font-size:50px;margin-bottom:10px;z-index:1;animation:bn 1s ease-in-out infinite}
@keyframes bn{0%,100%{transform:translateY(0)}50%{transform:translateY(-10px)}}
.mi{background:rgba(255,255,255,.08);border:1px solid rgba(255,255,255,.2);border-radius:8px;padding:11px 18px;color:#fff;font-size:15px;width:250px;margin-bottom:8px;z-index:1;outline:none;text-align:center;font-family:inherit}
.mi:focus{border-color:rgba(255,255,255,.5)}
.mi::placeholder{color:rgba(255,255,255,.2)}
.mb{background:rgba(255,255,255,.1);border:1px solid rgba(255,255,255,.25);border-radius:8px;padding:12px 30px;color:#fff;font-size:14px;font-weight:700;cursor:pointer;letter-spacing:2px;text-transform:uppercase;z-index:1;margin:4px;min-width:210px;font-family:inherit;pointer-events:all}
.mb:active{background:rgba(255,255,255,.2);transform:scale(.97)}
.mb.red{background:rgba(220,50,50,.3);border-color:rgba(220,50,50,.5);color:#ff8888}
.mb.blue{background:rgba(50,100,220,.3);border-color:rgba(50,100,220,.5);color:#88aaff}
.mb.sec{opacity:.6}
.mb.sm{min-width:auto;padding:8px 14px;font-size:10px}
#mst{margin-top:10px;font-size:11px;color:rgba(255,255,255,.25);z-index:1;min-height:16px;text-align:center}

/* LOBBY */
#lobby{position:fixed;top:0;left:0;width:100%;height:100%;z-index:300;display:none;flex-direction:column;align-items:center;justify-content:center;background:linear-gradient(135deg,#1a3d24,#2b5c3a)}
.lc{font-size:30px;font-weight:900;letter-spacing:8px;color:#fff;background:rgba(255,255,255,.1);border:1px solid rgba(255,255,255,.2);border-radius:8px;padding:8px 22px;margin:8px 0;z-index:1}
#plist{z-index:1;margin:12px 0;text-align:center;display:flex;gap:30px}
.tcol{min-width:110px}.tcol .th{font-size:11px;font-weight:700;letter-spacing:2px;margin-bottom:6px;padding-bottom:4px;border-bottom:2px solid rgba(255,255,255,.1)}
.tcol.rc .th{color:#ff6666;border-color:rgba(220,50,50,.3)}
.tcol.bc .th{color:#6688ff;border-color:rgba(50,100,220,.3)}
.pli{font-size:12px;color:rgba(255,255,255,.5);margin:3px 0;letter-spacing:1px;display:flex;align-items:center;justify-content:center;gap:6px}
.pli.self{font-weight:700}
.tcol.rc .pli.self{color:#ff8888}
.tcol.bc .pli.self{color:#88aaff}
.abtn{font-size:9px;background:rgba(255,255,255,.1);border:1px solid rgba(255,255,255,.15);border-radius:3px;padding:1px 5px;cursor:pointer;color:rgba(255,255,255,.4);pointer-events:all}
.abtn:active{background:rgba(255,255,255,.2)}
#settings{z-index:1;display:none;background:rgba(0,0,0,.3);border:1px solid rgba(255,255,255,.1);border-radius:8px;padding:12px 18px;margin:8px 0;width:280px}
#settings .sh{font-size:11px;color:rgba(255,255,255,.5);letter-spacing:2px;margin-bottom:8px;text-transform:uppercase}
.srow{display:flex;align-items:center;justify-content:space-between;margin-bottom:6px;font-size:12px;color:rgba(255,255,255,.5)}
.srow select{background:rgba(255,255,255,.08);border:1px solid rgba(255,255,255,.15);color:#fff;border-radius:4px;padding:4px 8px;font-size:12px;font-family:inherit;outline:none}
</style>
</head>
<body>
<div id="rotate-msg"><div class="ri">ğŸ“±</div>CihazÄ± yatay Ã§evirin</div>
<canvas id="field"></canvas>

<div id="score-hud"><div class="ts rsc" id="rsc">0</div><div class="dv">VS</div><div class="ts bsc" id="bsc">0</div></div>
<div id="map-name">KLASÄ°K</div>
<div id="win-tgt">20 GOL</div>
<div id="goal-ov"><div id="goal-txt">GOL!</div><div id="goal-sub"></div></div>
<div id="win-scr"><div class="wt" id="wtxt">KIRMIZI KAZANDI!</div><div class="ws" id="wsco">0 - 0</div></div>
<div id="pinfo"></div>

<div id="joy-zone"><div id="joy-base"><div id="joy-knob"></div></div></div>
<div id="kick-btn">VURUÅ</div>

<div id="admin-bar" style="display:none">
  <button onclick="hostEndMatch()">â¹ BÄ°TÄ°R</button>
  <button onclick="hostBackToLobby()">â†© LOBÄ°</button>
</div>

<div id="menu">
  <div class="mbg"></div>
  <div class="mball">âš½</div>
  <div class="mt">HAXBALL</div>
  <div class="ms">A R E N A</div>
  <input type="text" id="inp-name" class="mi" placeholder="Oyuncu AdÄ±n" maxlength="12">
  <button class="mb" id="btn-host">âš¡ ODA KUR</button>
  <input type="text" id="inp-code" class="mi" placeholder="Oda Kodu" maxlength="6" style="text-transform:uppercase;margin-top:6px">
  <button class="mb sec" id="btn-join">â†’ ODAYA KATIL</button>
  <div id="mst"></div>
</div>

<div id="lobby">
  <div class="mbg"></div>
  <div class="mt" style="font-size:24px">âš½ HAXBALL ARENA</div>
  <div style="font-size:10px;color:rgba(255,255,255,.2);z-index:1;margin:6px 0;letter-spacing:2px">ODA KODU</div>
  <div class="lc" id="lob-code">-----</div>
  <div id="plist">
    <div class="tcol rc"><div class="th">ğŸ”´ KIRMIZI</div><div id="red-list"></div></div>
    <div class="tcol bc"><div class="th">ğŸ”µ MAVÄ°</div><div id="blue-list"></div></div>
  </div>
  <div style="display:flex;gap:8px;z-index:1;margin:6px 0">
    <button class="mb sm red" onclick="switchTeam('red')">KIRMIZI</button>
    <button class="mb sm blue" onclick="switchTeam('blue')">MAVÄ°</button>
  </div>
  <div id="settings">
    <div class="sh">âš™ï¸ AYARLAR</div>
    <div class="srow"><span>Kazanma Skoru</span><select id="set-ws"><option value="5">5</option><option value="10">10</option><option value="15">15</option><option value="20" selected>20</option><option value="50">50</option></select></div>
    <div class="srow"><span>Harita</span><select id="set-map"><option value="0">Klasik</option><option value="1">GeniÅŸ Arena</option><option value="2">Mini Saha</option></select></div>
  </div>
  <button class="mb" id="btn-start" style="display:none;margin-top:6px">â–¶ BAÅLAT</button>
  <button class="mb sec" id="btn-leave" style="margin-top:4px;font-size:11px">âœ• AYRIL</button>
</div>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<script>
firebase.initializeApp({
  apiKey: "AIzaSyDHIFw7LYjMTpRMpe-ONkSm91fdXk4JWY4",
    authDomain: "gravityarena-14578.firebaseapp.com",
    databaseURL: "https://gravityarena-14578-default-rtdb.europe-west1.firebasedatabase.app",
    projectId: "gravityarena-14578",
    storageBucket: "gravityarena-14578.firebasestorage.app",
    messagingSenderId: "781898977885",
    appId: "1:781898977885:web:a047f4ed10ef296bee73b4",
});
const db=firebase.database();

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// MAPS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const MAPS=[
  {name:'KLASÄ°K',fw:900,fh:480,brd:30,goalW:12,goalH:110,cornerR:40,bg:'#3a7a4f',dark:'#2b5c3a'},
  {name:'GENÄ°Å ARENA',fw:1100,fh:560,brd:35,goalW:14,goalH:130,cornerR:50,bg:'#2d6b42',dark:'#1f4f30'},
  {name:'MÄ°NÄ° SAHA',fw:700,fh:400,brd:25,goalW:10,goalH:95,cornerR:30,bg:'#4a8f5f',dark:'#3a7a4f'}
];

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PHYSICS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const ACCEL=0.1, FRIC=0.96, MAX_SPD=4.5;
const KICK_F=7.5, KICK_RNG=8;
const BALL_FRIC=0.985, BALL_MAX=14, BALL_BNC=0.7;
const PLR_R=15, BALL_R=10;
const PLR_M=1, BALL_M=0.5;
const PLR_BNC=0.5;
const SYNC_MS=40, LERP=0.15;

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// STATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let st='menu',roomId=null,myId=null,myName='Player',isHost=false;
let roomRef=null,cvs,ctx;
let winScore=20,mapIdx=0,curMap=MAPS[0];
let hostId=null;

// Field shortcuts (updated per map)
let FW,FH,BRD,GOAL_W,GOAL_H,CORNER_R,GT,GB;

function setMap(idx){
  mapIdx=idx;curMap=MAPS[idx]||MAPS[0];
  FW=curMap.fw;FH=curMap.fh;BRD=curMap.brd;
  GOAL_W=curMap.goalW;GOAL_H=curMap.goalH;CORNER_R=curMap.cornerR;
  GT=FH/2-GOAL_H/2;GB=FH/2+GOAL_H/2;
}
setMap(0);

// Player
let me={x:300,y:240,vx:0,vy:0,team:'red',kicking:false,num:1};
let kickDown=false;

// Ball - BOTH host and clients maintain local ball for collision
// Host is authoritative and broadcasts ball state
let ball={x:FW/2,y:FH/2,vx:0,vy:0};
let ballAuth={x:FW/2,y:FH/2,vx:0,vy:0}; // host authority

// Remote
let rPlayers={},allData={};
let redScore=0,blueScore=0;
let goalCD=0,matchActive=false;

// Joy
let joyTid=null,joyOX=0,joyOY=0,joyDX=0,joyDY=0;
let keys={};
let camScale=1;
let lastSync=0;
let audioCtx=null;

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// AUDIO
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function initAudio(){if(audioCtx)return;try{audioCtx=new(window.AudioContext||window.webkitAudioContext)()}catch(e){}}
function snd(t){
  if(!audioCtx)return;try{const n=audioCtx.currentTime;
    if(t==='kick'){const o=audioCtx.createOscillator(),g=audioCtx.createGain();o.type='triangle';o.frequency.setValueAtTime(300,n);o.frequency.exponentialRampToValueAtTime(100,n+.08);g.gain.setValueAtTime(.15,n);g.gain.exponentialRampToValueAtTime(.001,n+.1);o.connect(g);g.connect(audioCtx.destination);o.start(n);o.stop(n+.1)}
    else if(t==='wall'){const o=audioCtx.createOscillator(),g=audioCtx.createGain();o.type='sine';o.frequency.value=800+Math.random()*400;g.gain.setValueAtTime(.05,n);g.gain.exponentialRampToValueAtTime(.001,n+.04);o.connect(g);g.connect(audioCtx.destination);o.start(n);o.stop(n+.04)}
    else if(t==='goal'){[523,659,784,1047].forEach((f,i)=>{const o=audioCtx.createOscillator(),g=audioCtx.createGain();o.type='sine';o.frequency.value=f;g.gain.setValueAtTime(.12,n+i*.1);g.gain.exponentialRampToValueAtTime(.001,n+i*.1+.2);o.connect(g);g.connect(audioCtx.destination);o.start(n+i*.1);o.stop(n+i*.1+.2)})}
    else if(t==='whistle'){const o=audioCtx.createOscillator(),g=audioCtx.createGain();o.type='sine';o.frequency.setValueAtTime(900,n);o.frequency.setValueAtTime(700,n+.15);o.frequency.setValueAtTime(900,n+.3);g.gain.setValueAtTime(.1,n);g.gain.exponentialRampToValueAtTime(.001,n+.5);o.connect(g);g.connect(audioCtx.destination);o.start(n);o.stop(n+.5)}
    else if(t==='bump'){const o=audioCtx.createOscillator(),g=audioCtx.createGain();o.type='sine';o.frequency.value=200;g.gain.setValueAtTime(.03,n);g.gain.exponentialRampToValueAtTime(.001,n+.04);o.connect(g);g.connect(audioCtx.destination);o.start(n);o.stop(n+.04)}
    else if(t==='win'){[523,659,784,1047,1319].forEach((f,i)=>{const o=audioCtx.createOscillator(),g=audioCtx.createGain();o.type='sine';o.frequency.value=f;g.gain.setValueAtTime(.1,n+i*.12);g.gain.exponentialRampToValueAtTime(.001,n+i*.12+.25);o.connect(g);g.connect(audioCtx.destination);o.start(n+i*.12);o.stop(n+i*.12+.25)})}
  }catch(e){}}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// HELPERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function genCode(){const c='ABCDEFGHJKLMNPQRSTUVWXYZ23456789';let r='';for(let i=0;i<4;i++)r+=c[Math.floor(Math.random()*c.length)];return r}
function setSt(m){document.getElementById('mst').textContent=m}
function sho(id,v){document.getElementById(id).style.display=v}
function dst(a,b){return Math.sqrt((a.x-b.x)**2+(a.y-b.y)**2)}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// COLLISION ENGINE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function circleCollide(a,ar,am,b,br,bm,rest){
  const dx=b.x-a.x,dy=b.y-a.y;
  const d=Math.sqrt(dx*dx+dy*dy);
  const minD=ar+br;
  if(d<minD&&d>.001){
    const nx=dx/d,ny=dy/d;
    const overlap=minD-d;
    const tm=am+bm;
    // Separate
    a.x-=nx*overlap*(bm/tm);
    a.y-=ny*overlap*(bm/tm);
    b.x+=nx*overlap*(am/tm);
    b.y+=ny*overlap*(am/tm);
    // Impulse
    const dvx=a.vx-b.vx,dvy=a.vy-b.vy;
    const dvn=dvx*nx+dvy*ny;
    if(dvn>0){
      const r2=rest!==undefined?rest:0.7;
      const j=-(1+r2)*dvn/tm;
      a.vx+=j*bm*nx;a.vy+=j*bm*ny;
      b.vx-=j*am*nx;b.vy-=j*am*ny;
    }
    return true;
  }
  return false;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// FIELD COLLISION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function fieldCollide(obj,r){
  let bounced=false;
  const inGoalY=obj.y>GT&&obj.y<GB;

  // Side walls (with goal gaps)
  if(!inGoalY||obj.x>BRD+GOAL_W){
    if(obj.x-r<BRD){obj.x=BRD+r;obj.vx=-obj.vx*BALL_BNC;bounced=true}
  }
  if(!inGoalY||obj.x<FW-BRD-GOAL_W){
    if(obj.x+r>FW-BRD){obj.x=FW-BRD-r;obj.vx=-obj.vx*BALL_BNC;bounced=true}
  }
  // Top/bottom
  if(obj.y-r<BRD){obj.y=BRD+r;obj.vy=-obj.vy*BALL_BNC;bounced=true}
  if(obj.y+r>FH-BRD){obj.y=FH-BRD-r;obj.vy=-obj.vy*BALL_BNC;bounced=true}
  // Goal backs
  if(inGoalY){
    if(obj.x-r<BRD-GOAL_W){obj.x=BRD-GOAL_W+r;obj.vx=-obj.vx*BALL_BNC;bounced=true}
    if(obj.x+r>FW-BRD+GOAL_W){obj.x=FW-BRD+GOAL_W-r;obj.vx=-obj.vx*BALL_BNC;bounced=true}
  }
  // Goal posts
  [{x:BRD,y:GT},{x:BRD,y:GB},{x:FW-BRD,y:GT},{x:FW-BRD,y:GB}].forEach(p=>{
    const dx2=obj.x-p.x,dy2=obj.y-p.y,d2=Math.sqrt(dx2*dx2+dy2*dy2);
    if(d2<r+5&&d2>.01){
      const nx=dx2/d2,ny=dy2/d2;
      obj.x=p.x+nx*(r+5);obj.y=p.y+ny*(r+5);
      const vn=obj.vx*nx+obj.vy*ny;
      obj.vx-=2*vn*nx*(1-BALL_BNC*.5);
      obj.vy-=2*vn*ny*(1-BALL_BNC*.5);
      bounced=true;
    }
  });
  // Corners
  [{x:BRD,y:BRD},{x:FW-BRD,y:BRD},{x:BRD,y:FH-BRD},{x:FW-BRD,y:FH-BRD}].forEach(c=>{
    const d3=Math.sqrt((obj.x-c.x)**2+(obj.y-c.y)**2);
    const isC=(Math.abs(obj.x-c.x)<CORNER_R+r&&Math.abs(obj.y-c.y)<CORNER_R+r);
    if(isC&&d3>0&&d3<CORNER_R){
      const nx=(obj.x-c.x)/d3,ny=(obj.y-c.y)/d3;
      obj.x=c.x+nx*(CORNER_R+r);obj.y=c.y+ny*(CORNER_R+r);
      const vn=obj.vx*nx+obj.vy*ny;
      if(vn<0){obj.vx-=2*vn*nx*BALL_BNC;obj.vy-=2*vn*ny*BALL_BNC}
      bounced=true;
    }
  });
  return bounced;
}

function playerFieldCollide(p){
  const r=PLR_R;
  if(p.x-r<BRD){p.x=BRD+r;p.vx=0}
  if(p.x+r>FW-BRD){p.x=FW-BRD-r;p.vx=0}
  if(p.y-r<BRD){p.y=BRD+r;p.vy=0}
  if(p.y+r>FH-BRD){p.y=FH-BRD-r;p.vy=0}
  [{x:BRD,y:GT},{x:BRD,y:GB},{x:FW-BRD,y:GT},{x:FW-BRD,y:GB}].forEach(post=>{
    const dx=p.x-post.x,dy=p.y-post.y,d=Math.sqrt(dx*dx+dy*dy);
    if(d<r+5&&d>.01){const nx=dx/d,ny=dy/d;p.x=post.x+nx*(r+5);p.y=post.y+ny*(r+5);const vn=p.vx*nx+p.vy*ny;if(vn<0){p.vx-=vn*nx;p.vy-=vn*ny}}
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SPAWN POSITIONS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function getSpawns(scoringTeam){
  const pos={red:[],blue:[]};
  let rc=0,bc=0;
  Object.values(allData).forEach(p=>{if(p.team==='red')rc++;else bc++});
  rc=Math.max(rc,1);bc=Math.max(bc,1);

  // Scoring team goes back, conceding team closer to center (kickoff)
  const redX=scoringTeam==='red'?FW*0.2:FW*0.38;
  const blueX=scoringTeam==='blue'?FW*0.8:FW*0.62;

  for(let i=0;i<rc;i++){
    const y=FH/2+(i-(rc-1)/2)*(70/Math.max(rc-1,1));
    pos.red.push({x:redX,y:Math.max(BRD+PLR_R+5,Math.min(FH-BRD-PLR_R-5,y))});
  }
  for(let i=0;i<bc;i++){
    const y=FH/2+(i-(bc-1)/2)*(70/Math.max(bc-1,1));
    pos.blue.push({x:blueX,y:Math.max(BRD+PLR_R+5,Math.min(FH-BRD-PLR_R-5,y))});
  }
  return pos;
}

function resetAllPositions(scoringTeam){
  const spawns=getSpawns(scoringTeam);
  // My team members sorted
  const teammates=Object.keys(allData).filter(pid=>allData[pid].team===me.team).sort();
  const myIdx=teammates.indexOf(myId);
  const idx=myIdx>=0?myIdx:0;
  const teamSp=spawns[me.team];
  const sp=teamSp[idx%teamSp.length]||{x:FW/4,y:FH/2};
  me.x=sp.x;me.y=sp.y;me.vx=0;me.vy=0;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PHYSICS UPDATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function updatePhysics(dt){
  if(st!=='playing'||!matchActive)return;

  // Input
  let ax=0,ay=0;
  if(keys['KeyW']||keys['ArrowUp'])ay=-1;
  if(keys['KeyS']||keys['ArrowDown'])ay=1;
  if(keys['KeyA']||keys['ArrowLeft'])ax=-1;
  if(keys['KeyD']||keys['ArrowRight'])ax=1;
  if(Math.abs(joyDX)>.1||Math.abs(joyDY)>.1){ax=joyDX;ay=joyDY}
  const al=Math.sqrt(ax*ax+ay*ay);if(al>1){ax/=al;ay/=al}

  me.vx+=ax*ACCEL;me.vy+=ay*ACCEL;
  me.vx*=FRIC;me.vy*=FRIC;
  const spd=Math.sqrt(me.vx*me.vx+me.vy*me.vy);
  if(spd>MAX_SPD){me.vx=me.vx/spd*MAX_SPD;me.vy=me.vy/spd*MAX_SPD}
  me.x+=me.vx;me.y+=me.vy;
  playerFieldCollide(me);

  // Player-Player collision (EVERYONE collides with everyone)
  Object.keys(rPlayers).forEach(pid=>{
    if(pid===myId)return;
    const rp=rPlayers[pid];if(!rp)return;
    const rx=rp._rx!==undefined?rp._rx:rp.x;
    const ry=rp._ry!==undefined?rp._ry:rp.y;
    // Create temp obj for collision
    const rpObj={x:rx,y:ry,vx:rp.vx||0,vy:rp.vy||0};
    if(circleCollide(me,PLR_R,PLR_M,rpObj,PLR_R,PLR_M,PLR_BNC)){
      snd('bump');
      // Push me only (remote pos is authoritative from their client)
    }
  });

  // === BALL PHYSICS ===
  // EVERYONE applies local player-ball collision for responsiveness
  // Host is authoritative for ball state
  const kicked=circleCollide(me,PLR_R,PLR_M,ball,BALL_R,BALL_M,0.7);

  // Kick boost
  if(kickDown&&!me.kicking){
    me.kicking=true;
    const d=dst(me,ball);
    if(d<PLR_R+BALL_R+KICK_RNG){
      const dx=ball.x-me.x,dy=ball.y-me.y;
      const dd=Math.sqrt(dx*dx+dy*dy);
      if(dd>.01){
        ball.vx+=(dx/dd)*KICK_F;
        ball.vy+=(dy/dd)*KICK_F;
        snd('kick');
        // Send kick event to host
        if(roomRef&&!isHost){
          roomRef.child('kicks').push({
            bx:Math.round(ball.x),by:Math.round(ball.y),
            dx:Math.round(dx/dd*1000)/1000,dy:Math.round(dy/dd*1000)/1000,
            f:KICK_F,pid:myId,t:Date.now()
          });
        }
      }
    }
  }
  if(!kickDown)me.kicking=false;

  // Ball physics (everyone runs locally for smooth feel)
  ball.vx*=BALL_FRIC;ball.vy*=BALL_FRIC;
  const bs=Math.sqrt(ball.vx*ball.vx+ball.vy*ball.vy);
  if(bs>BALL_MAX){ball.vx=ball.vx/bs*BALL_MAX;ball.vy=ball.vy/bs*BALL_MAX}
  ball.x+=ball.vx;ball.y+=ball.vy;
  if(fieldCollide(ball,BALL_R))snd('wall');

  // If HOST: also process remote player-ball collisions
  if(isHost){
    Object.values(rPlayers).forEach(rp=>{
      if(!rp)return;
      const rx=rp._rx!==undefined?rp._rx:rp.x;
      const ry=rp._ry!==undefined?rp._ry:rp.y;
      const rpObj={x:rx,y:ry,vx:rp.vx||0,vy:rp.vy||0};
      circleCollide(rpObj,PLR_R,PLR_M,ball,BALL_R,BALL_M,0.7);
    });
  }

  // Non-host: lerp ball toward authority
  if(!isHost){
    ball.x+=(ballAuth.x-ball.x)*0.08;
    ball.y+=(ballAuth.y-ball.y)*0.08;
    // If authority has very different velocity, snap
    ball.vx+=(ballAuth.vx-ball.vx)*0.1;
    ball.vy+=(ballAuth.vy-ball.vy)*0.1;
  }

  // Goal detection (HOST only)
  if(isHost&&goalCD<=0){
    if(ball.x<BRD&&ball.y>GT&&ball.y<GB)scoreGoal('blue');
    else if(ball.x>FW-BRD&&ball.y>GT&&ball.y<GB)scoreGoal('red');
  }

  if(goalCD>0)goalCD-=dt;
}

function scoreGoal(team){
  goalCD=3;snd('goal');snd('whistle');
  if(team==='red')redScore++;else blueScore++;
  document.getElementById('rsc').textContent=redScore;
  document.getElementById('bsc').textContent=blueScore;

  const ov=document.getElementById('goal-ov');
  const txt=document.getElementById('goal-txt');
  const sub=document.getElementById('goal-sub');
  txt.textContent='GOL!';
  txt.style.color=team==='red'?'#ff4444':'#4488ff';
  sub.textContent=(team==='red'?'KIRMIZI':'MAVÄ°')+' TAKIM!';
  ov.style.display='flex';

  setTimeout(()=>{
    ov.style.display='none';
    // Reset positions - scoring team goes back
    resetAllPositions(team);
    ball.x=FW/2;ball.y=FH/2;ball.vx=0;ball.vy=0;

    if(roomRef){
      roomRef.child('game').update({
        rs:redScore,bs:blueScore,
        bx:FW/2,by:FH/2,bvx:0,bvy:0,
        reset:team+'_'+Date.now()
      });
    }
  },1500);

  // Win check
  if(redScore>=winScore||blueScore>=winScore){
    setTimeout(()=>endMatch(team),2000);
  }
}

function endMatch(winTeam){
  matchActive=false;snd('win');
  const wt=document.getElementById('wtxt');
  wt.textContent=(winTeam==='red'?'KIRMIZI':'MAVÄ°')+' KAZANDI!';
  wt.className='wt '+winTeam;
  document.getElementById('wsco').textContent=redScore+' - '+blueScore;
  sho('win-scr','flex');

  if(isHost&&roomRef)roomRef.child('game/status').set('ended_'+winTeam);

  // Auto return to lobby after 4s
  setTimeout(()=>{
    goToLobby();
  },4000);
}

function goToLobby(){
  st='lobby';matchActive=false;
  sho('win-scr','none');sho('goal-ov','none');
  sho('score-hud','none');sho('map-name','none');sho('win-tgt','none');
  sho('joy-zone','none');sho('kick-btn','none');sho('pinfo','none');sho('admin-bar','none');
  sho('lobby','flex');

  if(isHost){
    sho('btn-start','inline-block');sho('settings','block');
  }

  // Detach game listeners
  if(roomRef){
    roomRef.child('game').off();
    roomRef.child('kicks').off();
    roomRef.child('status').set('lobby');
  }

  // Re-listen lobby
  listenLobby();
}

function hostEndMatch(){
  if(!isHost)return;
  const winTeam=redScore>=blueScore?'red':'blue';
  endMatch(winTeam);
}

function hostBackToLobby(){
  if(!isHost)return;
  goToLobby();
  if(roomRef)roomRef.child('game/status').set('lobby');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// RENDER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function initCanvas(){cvs=document.getElementById('field');ctx=cvs.getContext('2d');rsz();window.addEventListener('resize',rsz)}
function rsz(){cvs.width=innerWidth;cvs.height=innerHeight;const sx=cvs.width/(FW+120),sy=cvs.height/(FH+80);camScale=Math.min(sx,sy)}

function render(){
  const W=cvs.width,H=cvs.height;
  ctx.fillStyle=curMap.dark;ctx.fillRect(0,0,W,H);
  ctx.save();
  const ox=W/2-FW/2*camScale,oy=H/2-FH/2*camScale;
  ctx.translate(ox,oy);ctx.scale(camScale,camScale);

  // Field bg
  ctx.fillStyle=curMap.bg;ctx.fillRect(BRD,BRD,FW-BRD*2,FH-BRD*2);

  // Border
  ctx.beginPath();
  const cr=CORNER_R;
  ctx.moveTo(BRD+cr,BRD);ctx.lineTo(FW-BRD-cr,BRD);ctx.arc(FW-BRD-cr,BRD+cr,cr,-Math.PI/2,0);
  ctx.lineTo(FW-BRD,GT);ctx.moveTo(FW-BRD,GB);
  ctx.lineTo(FW-BRD,FH-BRD-cr);ctx.arc(FW-BRD-cr,FH-BRD-cr,cr,0,Math.PI/2);
  ctx.lineTo(BRD+cr,FH-BRD);ctx.arc(BRD+cr,FH-BRD-cr,cr,Math.PI/2,Math.PI);
  ctx.lineTo(BRD,GB);ctx.moveTo(BRD,GT);
  ctx.lineTo(BRD,BRD+cr);ctx.arc(BRD+cr,BRD+cr,cr,Math.PI,Math.PI*1.5);
  ctx.strokeStyle='rgba(255,255,255,.6)';ctx.lineWidth=2.5;ctx.stroke();

  // Center
  ctx.beginPath();ctx.moveTo(FW/2,BRD);ctx.lineTo(FW/2,FH-BRD);
  ctx.strokeStyle='rgba(255,255,255,.25)';ctx.lineWidth=1.5;ctx.stroke();
  ctx.beginPath();ctx.arc(FW/2,FH/2,60,0,Math.PI*2);ctx.stroke();
  ctx.beginPath();ctx.arc(FW/2,FH/2,4,0,Math.PI*2);ctx.fillStyle='rgba(255,255,255,.3)';ctx.fill();

  // Penalty areas
  ctx.strokeStyle='rgba(255,255,255,.2)';ctx.lineWidth=1.5;
  ctx.strokeRect(BRD,FH/2-80,60,160);ctx.strokeRect(FW-BRD-60,FH/2-80,60,160);

  // Goals
  drawGoal(BRD,GT,GB,-1,'rgba(220,50,50,');
  drawGoal(FW-BRD,GT,GB,1,'rgba(50,100,220,');

  // Posts
  [{x:BRD,y:GT},{x:BRD,y:GB},{x:FW-BRD,y:GT},{x:FW-BRD,y:GB}].forEach(p=>{
    ctx.beginPath();ctx.arc(p.x,p.y,5,0,Math.PI*2);ctx.fillStyle='#ddd';ctx.fill();ctx.strokeStyle='#999';ctx.lineWidth=1;ctx.stroke();
  });

  // Remote players
  Object.keys(rPlayers).forEach(pid=>{
    if(pid===myId)return;const rp=rPlayers[pid];if(!rp)return;
    if(rp._rx===undefined){rp._rx=rp.x;rp._ry=rp.y}
    rp._rx+=(rp.x-rp._rx)*LERP;rp._ry+=(rp.y-rp._ry)*LERP;
    drawPlayer(rp._rx,rp._ry,rp.team||'red',rp.nm||'?',rp.num||0,false,rp.kk);
  });

  // Me
  drawPlayer(me.x,me.y,me.team,myName,me.num,true,kickDown);

  // Ball
  drawBall(ball.x,ball.y);

  // Kick range
  if(kickDown){
    const d=dst(me,ball);
    if(d<PLR_R+BALL_R+KICK_RNG+15){
      ctx.beginPath();ctx.arc(me.x,me.y,PLR_R+KICK_RNG+BALL_R,0,Math.PI*2);
      ctx.strokeStyle='rgba(255,255,100,.2)';ctx.lineWidth=1;ctx.setLineDash([4,4]);ctx.stroke();ctx.setLineDash([]);
    }
  }

  ctx.restore();

  // Vignette
  const vg=ctx.createRadialGradient(W/2,H/2,W*.35,W/2,H/2,W*.7);
  vg.addColorStop(0,'transparent');vg.addColorStop(1,'rgba(0,0,0,.3)');
  ctx.fillStyle=vg;ctx.fillRect(0,0,W,H);
}

function drawGoal(gx,gt2,gb2,dir,colBase){
  const gw=GOAL_W*dir;
  ctx.fillStyle=colBase+'.12)';ctx.fillRect(dir<0?gx-GOAL_W:gx,gt2,GOAL_W,gb2-gt2);
  ctx.strokeStyle=colBase+'.5)';ctx.lineWidth=2;
  ctx.beginPath();ctx.moveTo(gx,gt2);ctx.lineTo(gx+gw,gt2);ctx.lineTo(gx+gw,gb2);ctx.lineTo(gx,gb2);ctx.stroke();
  ctx.strokeStyle=colBase+'.15)';ctx.lineWidth=.5;
  for(let ny=gt2;ny<gb2;ny+=10){ctx.beginPath();ctx.moveTo(gx,ny);ctx.lineTo(gx+gw,ny);ctx.stroke()}
  for(let nx=0;nx<GOAL_W;nx+=8){const x2=dir<0?gx-nx:gx+nx;ctx.beginPath();ctx.moveTo(x2,gt2);ctx.lineTo(x2,gb2);ctx.stroke()}
}

function drawPlayer(x,y,team,name,num,isMe,kicking){
  const col=team==='red'?'#e63946':'#457b9d';
  const lt=team==='red'?'#ff6b6b':'#6baaff';

  ctx.beginPath();ctx.ellipse(x,y+PLR_R-2,PLR_R*.8,4,0,0,Math.PI*2);ctx.fillStyle='rgba(0,0,0,.15)';ctx.fill();
  if(kicking){ctx.beginPath();ctx.arc(x,y,PLR_R+4,0,Math.PI*2);ctx.strokeStyle='rgba(255,255,100,.5)';ctx.lineWidth=2;ctx.stroke()}
  ctx.beginPath();ctx.arc(x,y,PLR_R,0,Math.PI*2);ctx.fillStyle=col;ctx.fill();
  ctx.beginPath();ctx.arc(x-3,y-3,PLR_R*.55,0,Math.PI*2);ctx.fillStyle=lt+'33';ctx.fill();
  ctx.beginPath();ctx.arc(x,y,PLR_R,0,Math.PI*2);
  ctx.strokeStyle=isMe?'#fff':'rgba(255,255,255,.35)';ctx.lineWidth=isMe?2.5:1.5;ctx.stroke();
  ctx.fillStyle='#fff';ctx.font='bold 11px Arial';ctx.textAlign='center';ctx.textBaseline='middle';ctx.fillText(num,x,y+1);
  ctx.fillStyle='rgba(255,255,255,.75)';ctx.font='bold 9px Arial';ctx.fillText(name,x,y-PLR_R-6);
}

function drawBall(x,y){
  ctx.beginPath();ctx.ellipse(x+1,y+BALL_R,BALL_R*.7,3,0,0,Math.PI*2);ctx.fillStyle='rgba(0,0,0,.2)';ctx.fill();
  ctx.beginPath();ctx.arc(x,y,BALL_R,0,Math.PI*2);ctx.fillStyle='#fff';ctx.fill();ctx.strokeStyle='#ccc';ctx.lineWidth=.8;ctx.stroke();
  for(let i=0;i<5;i++){const a=(i/5)*Math.PI*2-Math.PI/2;ctx.beginPath();ctx.arc(x+Math.cos(a)*BALL_R*.55,y+Math.sin(a)*BALL_R*.55,2.5,0,Math.PI*2);ctx.fillStyle='#aaa';ctx.fill()}
  ctx.beginPath();ctx.arc(x-2,y-2,BALL_R*.35,0,Math.PI*2);ctx.fillStyle='rgba(255,255,255,.4)';ctx.fill();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// INPUT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function initInput(){
  document.addEventListener('keydown',e=>{keys[e.code]=true;if(e.code==='Space'||e.code==='KeyX'){e.preventDefault();kickDown=true}});
  document.addEventListener('keyup',e=>{keys[e.code]=false;if(e.code==='Space'||e.code==='KeyX')kickDown=false});

  const jz=document.getElementById('joy-zone'),jb=document.getElementById('joy-base'),jk=document.getElementById('joy-knob');
  const maxD=45;
  jz.addEventListener('touchstart',e=>{e.preventDefault();if(joyTid!==null)return;initAudio();
    const t=e.changedTouches[0];joyTid=t.identifier;const r=jb.getBoundingClientRect();joyOX=r.left+r.width/2;joyOY=r.top+r.height/2},{passive:false});
  jz.addEventListener('touchmove',e=>{e.preventDefault();for(let i=0;i<e.changedTouches.length;i++){const t=e.changedTouches[i];if(t.identifier===joyTid){let dx=t.clientX-joyOX,dy=t.clientY-joyOY;const d=Math.sqrt(dx*dx+dy*dy);if(d>maxD){dx=dx/d*maxD;dy=dy/d*maxD}joyDX=dx/maxD;joyDY=dy/maxD;jk.style.transform=`translate(calc(-50% + ${dx}px),calc(-50% + ${dy}px))`}}},{passive:false});
  const ej=e=>{for(let i=0;i<e.changedTouches.length;i++){if(e.changedTouches[i].identifier===joyTid){joyTid=null;joyDX=0;joyDY=0;jk.style.transform='translate(-50%,-50%)'}}};
  jz.addEventListener('touchend',ej);jz.addEventListener('touchcancel',ej);

  const kb=document.getElementById('kick-btn');
  kb.addEventListener('touchstart',e=>{e.preventDefault();kickDown=true;kb.classList.add('active');initAudio()},{passive:false});
  kb.addEventListener('touchend',()=>{kickDown=false;kb.classList.remove('active')});
  kb.addEventListener('touchcancel',()=>{kickDown=false;kb.classList.remove('active')});
  window.addEventListener('resize',rsz);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// FIREBASE SYNC
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function syncMe(){
  if(!roomRef||st!=='playing')return;
  const now=performance.now();if(now-lastSync<SYNC_MS)return;lastSync=now;

  const u={};
  u['players/'+myId+'/x']=Math.round(me.x*10)/10;
  u['players/'+myId+'/y']=Math.round(me.y*10)/10;
  u['players/'+myId+'/vx']=Math.round(me.vx*100)/100;
  u['players/'+myId+'/vy']=Math.round(me.vy*100)/100;
  u['players/'+myId+'/kk']=kickDown;

  if(isHost){
    u['game/bx']=Math.round(ball.x*10)/10;
    u['game/by']=Math.round(ball.y*10)/10;
    u['game/bvx']=Math.round(ball.vx*100)/100;
    u['game/bvy']=Math.round(ball.vy*100)/100;
  }
  roomRef.update(u);
}

function setupGameListeners(){
  roomRef.child('players').on('value',snap=>{
    const data=snap.val()||{};allData=data;
    Object.keys(data).forEach(pid=>{if(pid!==myId)rPlayers[pid]=data[pid]});
    Object.keys(rPlayers).forEach(pid=>{if(!data[pid])delete rPlayers[pid]});
    updatePInfo();
  });

  // Ball authority from host (non-host listens)
  if(!isHost){
    roomRef.child('game').on('value',snap=>{
      const d=snap.val();if(!d)return;
      ballAuth.x=d.bx||FW/2;ballAuth.y=d.by||FH/2;
      ballAuth.vx=d.bvx||0;ballAuth.vy=d.bvy||0;
      if(d.rs!==undefined){redScore=d.rs;document.getElementById('rsc').textContent=redScore}
      if(d.bs!==undefined){blueScore=d.bs;document.getElementById('bsc').textContent=blueScore}
      if(d.reset){const parts=d.reset.split('_');resetAllPositions(parts[0])}
      if(d.status==='lobby'&&st==='playing')goToLobby();
      if(d.status&&d.status.startsWith('ended_')&&matchActive){
        const w=d.status.replace('ended_','');endMatch(w);
      }
    });
  }

  // Host processes remote kicks
  if(isHost){
    roomRef.child('kicks').on('child_added',snap=>{
      const k=snap.val();if(!k)return;
      if(Date.now()-k.t>2000){snap.ref.remove();return}
      // Apply kick force from remote player
      const d=Math.sqrt((ball.x-k.bx)**2+(ball.y-k.by)**2);
      if(d<PLR_R+BALL_R+KICK_RNG+20){
        ball.vx+=k.dx*k.f;ball.vy+=k.dy*k.f;
        snd('kick');
      }
      snap.ref.remove();
    });
  }
}

function updatePInfo(){
  let rc=0,bc=0;
  Object.values(allData).forEach(p=>{if(p.team==='red')rc++;else bc++});
  document.getElementById('pinfo').textContent='ğŸ”´ '+rc+' vs '+bc+' ğŸ”µ';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// LOBBY
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
document.getElementById('btn-host').onclick=()=>{
  myName=document.getElementById('inp-name').value.trim()||'Player';
  roomId=genCode();myId='p_'+Date.now();isHost=true;hostId=myId;
  roomRef=db.ref('rooms/'+roomId);
  me.team='red';me.num=1;
  setSt('Oda kuruluyor...');

  roomRef.set({
    host:myId,status:'lobby',winScore:20,mapIdx:0,
    players:{[myId]:{nm:myName,x:0,y:0,vx:0,vy:0,team:'red',num:1,kk:false}},
    game:{rs:0,bs:0,bx:FW/2,by:FH/2,bvx:0,bvy:0}
  }).then(()=>{
    document.getElementById('lob-code').textContent=roomId;
    sho('menu','none');sho('lobby','flex');sho('btn-start','inline-block');sho('settings','block');
    st='lobby';listenLobby();
  }).catch(e=>setSt('Hata: '+e.message));
  roomRef.child('players/'+myId).onDisconnect().remove();
};

document.getElementById('btn-join').onclick=()=>{
  myName=document.getElementById('inp-name').value.trim()||'Player';
  const code=document.getElementById('inp-code').value.trim().toUpperCase();
  if(!code||code.length<3){setSt('GeÃ§erli kod girin!');return}
  roomId=code;myId='p_'+Date.now();isHost=false;
  roomRef=db.ref('rooms/'+roomId);setSt('BaÄŸlanÄ±lÄ±yor...');

  roomRef.once('value').then(snap=>{
    const d=snap.val();
    if(!d){setSt('Oda bulunamadÄ±!');return}
    if(d.status==='playing'){setSt('MaÃ§ devam ediyor!');return}
    hostId=d.host;
    const players=d.players?Object.values(d.players):[];
    const rc=players.filter(p=>p.team==='red').length;
    const bc=players.filter(p=>p.team==='blue').length;
    me.team=bc<=rc?'blue':'red';me.num=players.length+1;

    roomRef.child('players/'+myId).set({
      nm:myName,x:0,y:0,vx:0,vy:0,team:me.team,num:me.num,kk:false
    }).then(()=>{
      document.getElementById('lob-code').textContent=roomId;
      sho('menu','none');sho('lobby','flex');sho('btn-start','none');sho('settings','none');
      st='lobby';listenLobby();
    });
    roomRef.child('players/'+myId).onDisconnect().remove();
  }).catch(e=>setSt('Hata: '+e.message));
};

function switchTeam(team){me.team=team;if(roomRef)roomRef.child('players/'+myId+'/team').set(team)}
function adminMovePlayer(pid,team){if(!isHost||!roomRef)return;roomRef.child('players/'+pid+'/team').set(team)}

function listenLobby(){
  roomRef.child('players').on('value',snap=>{
    const data=snap.val()||{};allData=data;
    const rl=document.getElementById('red-list'),bl=document.getElementById('blue-list');
    rl.innerHTML='';bl.innerHTML='';
    Object.keys(data).forEach(pid=>{
      const p=data[pid];const div=document.createElement('div');
      div.className='pli'+(pid===myId?' self':'');
      let html=(p.nm||'Player')+(pid===myId?' (Sen)':'');
      if(isHost&&pid!==myId){
        html+=p.team==='red'?` <span class="abtn" onclick="adminMovePlayer('${pid}','blue')">â†’ğŸ”µ</span>`:` <span class="abtn" onclick="adminMovePlayer('${pid}','red')">â†’ğŸ”´</span>`;
      }
      div.innerHTML=html;
      if(p.team==='blue')bl.appendChild(div);else rl.appendChild(div);
      if(pid===myId&&p.team!==me.team)me.team=p.team;
    });
  });

  roomRef.child('status').on('value',snap=>{
    const v=snap.val();
    if(v==='playing'&&st==='lobby'){
      roomRef.once('value').then(s=>{
        const d=s.val();
        winScore=d.winScore||20;
        setMap(d.mapIdx||0);
        startGame();
      });
    }
  });

  if(isHost){
    document.getElementById('set-ws').onchange=function(){winScore=parseInt(this.value);if(roomRef)roomRef.child('winScore').set(winScore)};
    document.getElementById('set-map').onchange=function(){const v=parseInt(this.value);if(roomRef)roomRef.child('mapIdx').set(v)};
  }
}

document.getElementById('btn-start').onclick=()=>{
  if(!isHost)return;
  winScore=parseInt(document.getElementById('set-ws').value)||20;
  const mi=parseInt(document.getElementById('set-map').value)||0;
  roomRef.update({winScore,mapIdx:mi,status:'playing'});
};

document.getElementById('btn-leave').onclick=()=>{
  if(roomRef)roomRef.child('players/'+myId).remove();
  roomRef=null;st='menu';sho('lobby','none');sho('menu','flex');
};

function backToMenu(){
  if(roomRef)roomRef.child('players/'+myId).remove();
  roomRef=null;st='menu';rPlayers={};
  sho('menu','flex');sho('lobby','none');sho('score-hud','none');sho('map-name','none');sho('win-tgt','none');
  sho('joy-zone','none');sho('kick-btn','none');sho('pinfo','none');sho('admin-bar','none');sho('win-scr','none');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// GAME START
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function startGame(){
  st='playing';matchActive=true;
  sho('lobby','none');sho('menu','none');sho('win-scr','none');
  sho('score-hud','flex');sho('map-name','block');sho('win-tgt','block');
  sho('joy-zone','block');sho('kick-btn','block');sho('pinfo','block');
  if(isHost)sho('admin-bar','flex');

  document.getElementById('map-name').textContent=curMap.name;
  document.getElementById('win-tgt').textContent=winScore+' GOL';
  redScore=0;blueScore=0;goalCD=0;
  document.getElementById('rsc').textContent='0';document.getElementById('bsc').textContent='0';

  rsz(); // recalculate scale for new map
  resetAllPositions(null);

  ball.x=FW/2;ball.y=FH/2;ball.vx=0;ball.vy=0;
  ballAuth.x=FW/2;ballAuth.y=FH/2;ballAuth.vx=0;ballAuth.vy=0;

  setupGameListeners();initAudio();snd('whistle');
  console.log("[HX] Oyun! Harita:"+curMap.name+" Win:"+winScore);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// LOOP
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let lastTime=0;
function gameLoop(time){
  requestAnimationFrame(gameLoop);
  const dt=Math.min((time-lastTime)/1000,.05);lastTime=time;
  if(st==='playing'){updatePhysics(dt);syncMe()}
  if(cvs)render();
}

function init(){
  console.log("[HX] HaxBall Arena V3");
  initCanvas();initInput();sho('menu','flex');
  requestAnimationFrame(gameLoop);
}
window.addEventListener('load',init);
</script>
</body>
</html>
