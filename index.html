<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no,viewport-fit=cover">
<title>HaxBall Mobile Pro v5</title>
<style>
*{margin:0;padding:0;box-sizing:border-box;-webkit-touch-callout:none;-webkit-user-select:none;user-select:none;-webkit-tap-highlight-color:transparent}
html,body{width:100%;height:100%;overflow:hidden;background:#0a0a1a;font-family:'Segoe UI',Tahoma,sans-serif;touch-action:none;position:fixed;top:0;left:0}
#rotateMsg{position:fixed;top:0;left:0;width:100%;height:100%;background:#0a0a1a;z-index:99999;display:none;align-items:center;justify-content:center;flex-direction:column;color:#fff;gap:12px;font-size:15px}
@media(max-width:640px) and (orientation:portrait){#rotateMsg{display:flex!important}}
.screen{position:absolute;top:0;left:0;width:100%;height:100%;display:none;overflow-y:auto}
#menuScreen{display:flex;flex-direction:column;align-items:center;justify-content:center;background:linear-gradient(145deg,#0b0920,#1a1545,#0d1b3e);z-index:100;padding:12px}
#menuScreen h1{color:#fff;font-size:28px;margin-bottom:3px}
#menuScreen .sub{color:#666;font-size:11px;margin-bottom:20px}
.mbox{background:rgba(255,255,255,.05);border-radius:16px;padding:20px;width:320px;max-width:92vw;border:1px solid rgba(255,255,255,.07)}
.mbox input,.mbox select{width:100%;padding:11px 14px;margin-bottom:9px;border:1px solid rgba(255,255,255,.1);border-radius:9px;background:rgba(255,255,255,.04);color:#fff;font-size:14px;outline:none;-webkit-appearance:none}
.mbox input::placeholder{color:rgba(255,255,255,.25)}
.mbox select option{background:#151530;color:#fff}
.mbox label{color:#888;font-size:11px;display:block;margin-bottom:4px;margin-top:2px}
.divider{display:flex;align-items:center;margin:12px 0;color:rgba(255,255,255,.18);font-size:11px;gap:8px}
.divider::before,.divider::after{content:'';flex:1;height:1px;background:rgba(255,255,255,.08)}
.btn{padding:11px 18px;border:none;border-radius:9px;font-size:14px;font-weight:600;cursor:pointer;text-align:center;color:#fff;display:inline-block}
.btn:active{transform:scale(.96)}
.btn-full{width:100%;margin-bottom:7px}
.btn-red{background:linear-gradient(135deg,#e74c3c,#b92d2d)}
.btn-blue{background:linear-gradient(135deg,#3498db,#2475a8)}
.btn-green{background:linear-gradient(135deg,#27ae60,#1c8a4a)}
.btn-gray{background:rgba(255,255,255,.08);color:#aaa;border:1px solid rgba(255,255,255,.08)}
.btn-small{padding:7px 14px;font-size:12px;border-radius:7px}
#lobbyScreen{flex-direction:column;align-items:center;background:linear-gradient(145deg,#0b0920,#1a1545,#0d1b3e);z-index:95;padding:14px}
#lobbyScreen h2{color:#fff;font-size:21px;margin-bottom:4px}
.room-code-box{background:rgba(243,156,18,.1);border:1px solid rgba(243,156,18,.2);color:#f39c12;font-size:15px;font-weight:700;padding:5px 16px;border-radius:8px;margin-bottom:4px}
.lobby-map-info{color:#777;font-size:11px;margin-bottom:12px}
.lobby-teams{display:flex;gap:10px;width:96%;max-width:920px;flex-wrap:wrap;justify-content:center}
.team-panel{background:rgba(255,255,255,.03);border-radius:12px;padding:12px;min-width:170px;flex:1;border:1px solid rgba(255,255,255,.05);min-height:110px}
.team-panel h3{text-align:center;margin-bottom:8px;font-size:13px;padding-bottom:6px;border-bottom:1px solid rgba(255,255,255,.06)}
.team-panel.t-red h3{color:#e74c3c}.team-panel.t-blue h3{color:#3498db}.team-panel.t-spec h3{color:#777}
.player-row{display:flex;align-items:center;justify-content:space-between;padding:5px 8px;margin-bottom:4px;border-radius:6px;background:rgba(255,255,255,.03);color:#fff;font-size:12px;gap:4px}
.player-row .p-info{display:flex;align-items:center;gap:5px;flex:1;min-width:0;overflow:hidden}
.player-row .p-name{overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.host-tag{background:#f39c12;color:#000;font-size:8px;padding:1px 4px;border-radius:3px;font-weight:700}
.pos-tag{font-size:8px;padding:1px 5px;border-radius:3px;font-weight:700}
.pos-GK{background:rgba(241,196,15,.2);color:#f1c40f}.pos-DEF{background:rgba(46,204,113,.2);color:#2ecc71}.pos-MID{background:rgba(52,152,219,.2);color:#3498db}.pos-FWD{background:rgba(231,76,60,.2);color:#e74c3c}
.admin-row-btns{display:flex;gap:2px}
.admin-row-btns button{padding:2px 5px;font-size:9px;border:none;border-radius:3px;cursor:pointer;font-weight:600;color:#fff}
.lobby-position-select{margin-top:10px;background:rgba(255,255,255,.03);border:1px solid rgba(255,255,255,.05);border-radius:10px;padding:12px;width:96%;max-width:400px}
.lobby-position-select h4{color:#ccc;font-size:12px;margin-bottom:6px}
.lobby-position-select select{width:100%;padding:9px 12px;border:1px solid rgba(255,255,255,.1);border-radius:7px;background:rgba(255,255,255,.04);color:#fff;font-size:13px;outline:none;-webkit-appearance:none}
.lobby-position-select select option{background:#151530}
.lobby-actions{margin-top:14px;display:flex;gap:7px;flex-wrap:wrap;justify-content:center}
.lobby-actions .btn{padding:9px 20px;font-size:12px}
#gameScreen{z-index:80;background:#1a472a}
#gameCanvas{display:block;width:100%;height:100%;outline:none}
#hud{position:absolute;top:0;left:50%;transform:translateX(-50%);display:flex;z-index:85;pointer-events:none;border-radius:0 0 10px 10px;overflow:hidden;box-shadow:0 2px 12px rgba(0,0,0,.5)}
.hud-score{padding:5px 18px;font-size:26px;font-weight:900;color:#fff;min-width:48px;text-align:center}
.hud-score-red{background:rgba(192,57,43,.9)}.hud-score-blue{background:rgba(41,128,185,.9)}
.hud-center{background:rgba(0,0,0,.78);padding:4px 14px;display:flex;flex-direction:column;align-items:center;justify-content:center}
.hud-timer{color:#fff;font-size:15px;font-weight:700}
.hud-status{color:#f39c12;font-size:8px;font-weight:700;text-transform:uppercase;margin-top:1px}
#pingDisp{position:absolute;top:6px;right:8px;color:rgba(255,255,255,.5);font-size:9px;z-index:86;pointer-events:none}
#joyZone{position:absolute;bottom:10px;left:10px;width:140px;height:140px;z-index:86;touch-action:none;pointer-events:auto}
#joyBase{position:absolute;bottom:10px;left:10px;width:120px;height:120px;border-radius:50%;background:rgba(255,255,255,.06);border:2px solid rgba(255,255,255,.1);pointer-events:none;z-index:87;opacity:.5}
#joyThumb{position:absolute;width:50px;height:50px;border-radius:50%;background:rgba(255,255,255,.2);border:2px solid rgba(255,255,255,.35);pointer-events:none;z-index:88;opacity:.5;display:none}
.action-btns{position:absolute;bottom:12px;right:12px;z-index:86;display:flex;flex-direction:column;gap:8px;align-items:flex-end;pointer-events:auto}
.act-btn{border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:700;touch-action:none;pointer-events:auto;opacity:.5;border:3px solid rgba(255,255,255,.25)}
.act-btn.active{opacity:.85;transform:scale(1.06)}
#btnKick{width:68px;height:68px;background:rgba(255,255,255,.1);color:rgba(255,255,255,.8);font-size:10px}
#btnPass{width:56px;height:56px;background:rgba(46,204,113,.12);border-color:rgba(46,204,113,.3);color:rgba(46,204,113,.9);font-size:9px}
#btnPower{width:56px;height:56px;background:rgba(231,76,60,.12);border-color:rgba(231,76,60,.3);color:rgba(231,76,60,.9);font-size:9px;position:relative}
#btnPower .cd-ov{position:absolute;top:0;left:0;width:100%;height:100%;border-radius:50%;background:rgba(0,0,0,.55);display:flex;align-items:center;justify-content:center;font-size:11px;color:#fff;font-weight:700}
#btnPower.ready .cd-ov{display:none}
#emojiBar{position:absolute;top:42px;left:50%;transform:translateX(-50%);z-index:88;display:flex;gap:4px;pointer-events:auto;opacity:.5}
.emoji-btn{width:30px;height:30px;border-radius:50%;background:rgba(0,0,0,.4);border:1px solid rgba(255,255,255,.08);display:flex;align-items:center;justify-content:center;font-size:15px;cursor:pointer;touch-action:none}
#chatToggle{width:30px;height:30px;border-radius:50%;background:rgba(0,0,0,.4);border:1px solid rgba(255,255,255,.08);display:flex;align-items:center;justify-content:center;font-size:13px;cursor:pointer;touch-action:none}
#chatPanel{position:absolute;top:76px;left:50%;transform:translateX(-50%);z-index:89;display:none;flex-direction:column;gap:3px;pointer-events:auto;background:rgba(0,0,0,.8);border-radius:8px;padding:6px;min-width:150px;border:1px solid rgba(255,255,255,.06)}
#chatPanel .cm{padding:6px 10px;background:rgba(255,255,255,.05);border:none;border-radius:5px;color:#fff;font-size:11px;cursor:pointer;text-align:left}
#chatLog{position:absolute;bottom:160px;left:10px;z-index:87;pointer-events:none;max-width:200px}
.ce{background:rgba(0,0,0,.55);color:#fff;padding:2px 7px;border-radius:5px;font-size:10px;margin-bottom:2px;animation:cf 4s forwards;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
@keyframes cf{0%{opacity:1}70%{opacity:1}100%{opacity:0}}
#adminPanelGame{position:absolute;top:42px;right:6px;z-index:90;display:none;pointer-events:auto}
#adminToggleBtn{background:rgba(243,156,18,.82);color:#000;border:none;padding:6px 10px;border-radius:7px;font-weight:700;font-size:10px;cursor:pointer}
#adminMenuContent{display:none;background:rgba(5,5,20,.94);border-radius:10px;padding:8px;margin-top:4px;min-width:200px;max-width:260px;border:1px solid rgba(255,255,255,.06);max-height:75vh;overflow-y:auto}
#adminMenuContent .sec{color:#888;font-size:9px;padding:5px 6px 2px;text-transform:uppercase;border-bottom:1px solid rgba(255,255,255,.04);margin-bottom:4px}
#adminMenuContent button{display:block;width:100%;padding:8px 10px;margin-bottom:4px;border:none;border-radius:5px;font-size:11px;font-weight:600;cursor:pointer;color:#fff;text-align:left}
#adminMenuContent select{width:100%;padding:7px 10px;margin-bottom:5px;border:1px solid rgba(255,255,255,.1);border-radius:5px;background:rgba(255,255,255,.05);color:#fff;font-size:11px;outline:none;-webkit-appearance:none}
#adminMenuContent select option{background:#0a0a1a}
.apr{display:flex;align-items:center;gap:3px;margin-bottom:4px;padding:4px 6px;background:rgba(255,255,255,.03);border-radius:5px;flex-wrap:wrap}
.apr .an{color:#ccc;font-size:10px;flex:1;min-width:50px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.apr button{padding:3px 6px;font-size:9px;border:none;border-radius:3px;cursor:pointer;font-weight:600;color:#fff}
.apr select{padding:2px 4px;font-size:9px;border:1px solid rgba(255,255,255,.1);border-radius:3px;background:rgba(255,255,255,.05);color:#fff;-webkit-appearance:none;width:48px}
#goalOverlay{position:absolute;top:0;left:0;width:100%;height:100%;display:none;align-items:center;justify-content:center;z-index:89;pointer-events:none;background:rgba(0,0,0,.22)}
.goal-text{font-size:52px;font-weight:900;color:#fff;text-shadow:0 0 40px rgba(255,255,255,.35);animation:ga .4s cubic-bezier(.175,.885,.32,1.275)}
@keyframes ga{0%{transform:scale(.15);opacity:0}70%{transform:scale(1.1)}100%{transform:scale(1);opacity:1}}
#winOverlay{position:absolute;top:0;left:0;width:100%;height:100%;display:none;align-items:center;justify-content:center;flex-direction:column;z-index:95;pointer-events:auto;background:rgba(0,0,0,.85)}
#winOverlay h1{font-size:42px;font-weight:900;margin-bottom:10px}
#winOverlay p{color:#ccc;font-size:16px;margin-bottom:20px}
#winOverlay button{padding:14px 40px;border:none;border-radius:10px;font-size:16px;font-weight:700;cursor:pointer;color:#fff;background:linear-gradient(135deg,#27ae60,#1c8a4a)}
#toast{position:fixed;bottom:65px;left:50%;transform:translateX(-50%);background:rgba(0,0,0,.88);color:#fff;padding:7px 18px;border-radius:18px;font-size:11px;z-index:99990;display:none;white-space:nowrap;pointer-events:none}
.hidden{display:none!important}
#connecting{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.85);z-index:99998;display:none;align-items:center;justify-content:center;flex-direction:column;color:#fff;gap:12px}
#connecting p{font-size:14px;color:#aaa}
</style>
</head>
<body>
<div id="rotateMsg"><div style="font-size:36px">üì±</div><p>L√ºtfen ekranƒ± yatay √ßevirin</p></div>
<div id="connecting"><div style="font-size:32px">‚ö°</div><p id="connectingMsg">Sunucuya baƒülanƒ±lƒ±yor...</p></div>

<div id="menuScreen" class="screen" style="display:flex">
<h1>‚öΩ HaxBall Mobile</h1><p class="sub">MULTIPLAYER FUTBOL</p>
<div class="mbox">
<input type="text" id="inpName" placeholder="Oyuncu Adƒ±n" maxlength="12">
<div class="divider">YENƒ∞ ODA</div>
<label>Harita</label>
<select id="inpMap"><option value="classic">Klasik</option><option value="big">B√ºy√ºk</option><option value="small">Mini</option><option value="hockey">Hokey</option><option value="futsal">Futsal</option></select>
<label>Gol Sƒ±nƒ±rƒ±</label>
<select id="inpGL"><option value="3">3</option><option value="5" selected>5</option><option value="10">10</option><option value="0">S√ºre Bitene Kadar</option></select>
<input type="text" id="inpPwd" placeholder="≈ûifre (opsiyonel)" maxlength="20">
<button class="btn btn-full btn-red" id="btnCreate">üèüÔ∏è Oda Kur</button>
<div class="divider">KATIL</div>
<input type="text" id="inpCode" placeholder="Oda Kodu" maxlength="6" style="text-transform:uppercase">
<input type="text" id="inpJP" placeholder="≈ûifre" maxlength="20">
<button class="btn btn-full btn-blue" id="btnJoin">üöÄ Katƒ±l</button>
</div></div>

<div id="lobbyScreen" class="screen">
<h2>üèüÔ∏è Lobi</h2>
<div class="room-code-box" id="lobbyCode">---</div>
<div class="lobby-map-info" id="lobbyMapName"></div>
<div class="lobby-teams">
<div class="team-panel t-red"><h3>üî¥ Kƒ±rmƒ±zƒ±</h3><div id="lRL"></div></div>
<div class="team-panel t-spec"><h3>üëÅÔ∏è ƒ∞zleyici</h3><div id="lSL"></div></div>
<div class="team-panel t-blue"><h3>üîµ Mavi</h3><div id="lBL"></div></div>
</div>
<div class="lobby-position-select" id="lobbyPB"><h4>üéΩ Mevki</h4>
<select id="lobbyPS"><option value="">-- Se√ß --</option><option value="GK">üß§ Kaleci</option><option value="DEF">üõ°Ô∏è Defans</option><option value="MID">üéØ Orta Saha</option><option value="FWD">‚ö° Forvet</option></select></div>
<div class="lobby-actions">
<button class="btn btn-red btn-small" id="btnTR">üî¥ Kƒ±rmƒ±zƒ±</button>
<button class="btn btn-gray btn-small" id="btnTS">üëÅÔ∏è ƒ∞zleyici</button>
<button class="btn btn-blue btn-small" id="btnTB">üîµ Mavi</button>
<button class="btn btn-green btn-small hidden" id="btnSt">üöÄ Ba≈ülat</button>
<button class="btn btn-small" id="btnLv" style="background:#7a2e2e;color:#fff">üö™ Ayrƒ±l</button>
</div></div>

<div id="gameScreen" class="screen">
<canvas id="gameCanvas" tabindex="0"></canvas>
<div id="hud">
<div class="hud-score hud-score-red" id="hudR">0</div>
<div class="hud-center"><div class="hud-timer" id="hudT">0:00</div><div class="hud-status" id="hudS"></div></div>
<div class="hud-score hud-score-blue" id="hudB">0</div>
</div>
<div id="pingDisp">-- ms</div>
<div id="joyZone"></div><div id="joyBase"></div><div id="joyThumb"></div>
<div class="action-btns">
<div class="act-btn" id="btnPower"><span>üî•</span><div class="cd-ov" id="pwCD">45</div></div>
<div class="act-btn" id="btnKick">VURU≈û</div>
<div class="act-btn" id="btnPass">PAS</div>
</div>
<div id="emojiBar">
<div class="emoji-btn" data-e="üò≠">üò≠</div>
<div class="emoji-btn" data-e="üòÇ">üòÇ</div>
<div class="emoji-btn" data-e="üëè">üëè</div>
<div class="emoji-btn" data-e="üò†">üò†</div>
<div id="chatToggle">üí¨</div>
</div>
<div id="chatPanel">
<button class="cm" data-m="Ba≈üarƒ±lar">Ba≈üarƒ±lar</button>
<button class="cm" data-m="GG">GG</button>
<button class="cm" data-m="Tebrik ederim">Tebrik ederim</button>
<button class="cm" data-m="Aƒülama oyna">Aƒülama oyna</button>
<button class="cm" data-m="Ya sabƒ±r">Ya sabƒ±r</button>
</div>
<div id="chatLog"></div>
<div id="adminPanelGame"><button id="adminToggleBtn">‚öôÔ∏è</button><div id="adminMenuContent"></div></div>
<div id="goalOverlay"><div class="goal-text" id="goalText">GOL!</div></div>
<div id="winOverlay"><h1 id="winText">üèÜ</h1><p id="winSub"></p><button id="winBtn">Lobiye D√∂n</button></div>
</div>
<div id="toast"></div>

<script src="https://cdn.socket.io/4.6.1/socket.io.min.js"></script>
<script>
(function(){
'use strict';

// !! BURAYA RENDER.COM ADRESƒ∞Nƒ∞ YAZ !!
const SERVER_URL='https://haxball-server-cwtg.onrender.com';

const MAPS={
    classic:{name:'Klasik',fw:1200,fh:600,gh:150,gd:55,bg:'#2b7530',f1:'#3a8c3a',f2:'#358535',lc:'rgba(255,255,255,.5)',cr:85,pw:130,ph:270},
    big:{name:'B√ºy√ºk',fw:1500,fh:750,gh:180,gd:60,bg:'#1a5c1a',f1:'#2a7a2a',f2:'#257225',lc:'rgba(255,255,255,.45)',cr:100,pw:150,ph:300},
    small:{name:'Mini',fw:900,fh:450,gh:120,gd:45,bg:'#2d6b2d',f1:'#3a8530',f2:'#358028',lc:'rgba(255,255,255,.5)',cr:65,pw:100,ph:200},
    hockey:{name:'Hokey',fw:1100,fh:500,gh:130,gd:50,bg:'#152a44',f1:'#1f4470',f2:'#1b3d65',lc:'rgba(255,255,255,.55)',cr:75,pw:120,ph:240},
    futsal:{name:'Futsal',fw:1000,fh:520,gh:135,gd:48,bg:'#7a5a10',f1:'#A07828',f2:'#957020',lc:'rgba(255,255,255,.55)',cr:70,pw:110,ph:230}
};

const PR=19,BR=11,PSR=6,FM=70;
const FDT=1000/60;

var $=function(id){return document.getElementById(id)};
function rcode(){var c='ABCDEFGHJKLMNPQRSTUVWXYZ23456789',s='';for(var i=0;i<5;i++)s+=c[Math.floor(Math.random()*c.length)];return s}
function toast(m,d){d=d||2000;var t=$('toast');t.textContent=m;t.style.display='block';clearTimeout(t._t);t._t=setTimeout(function(){t.style.display='none'},d)}
function lerp(a,b,t){return a+(b-a)*t}
function dst(x1,y1,x2,y2){var dx=x2-x1,dy=y2-y1;return Math.sqrt(dx*dx+dy*dy)}
function clp(v,a,b){return v<a?a:v>b?b:v}

// DURUM
var socket=null,myId='',myName='',roomCode='',isHost=false,gameState='menu';
var cmk='classic',cm=MAPS.classic,gLim=5,hostId='';
var P={},B={x:600,y:300,vx:0,vy:0,fire:false};
var mT=0,mR=false,mP=false,gF=false,rS=0,bS=0;
var myIn={dx:0,dy:0},kH=false,pH=false,pwP=false,pwCD=0;
var jTid=null,jA=false,jSX=0,jSY=0,keys={};
var canvas,ctx,cW=0,cH=0,vS=1,vOX=0,vOY=0;
var animId=null,lastFT=0,acm=0,admO=false,uG=false;
var fireParts=[],pBubs={},chatEnts=[];
var lobbyData=null;
var pingMs=0,lastPingTime=0;
// Dead reckoning i√ßin
var lastStateTime=0;

// Pre-render
var redImg=null,blueImg=null;
function prerenderPlayers(){
    var sz=PR*2+6;
    var c1=document.createElement('canvas');c1.width=sz;c1.height=sz;var x1=c1.getContext('2d');
    x1.fillStyle='#c0392b';x1.beginPath();x1.arc(sz/2,sz/2,PR,0,Math.PI*2);x1.fill();
    x1.fillStyle='rgba(255,118,117,.4)';x1.beginPath();x1.arc(sz/2-3,sz/2-3,PR*.55,0,Math.PI*2);x1.fill();
    redImg=c1;
    var c2=document.createElement('canvas');c2.width=sz;c2.height=sz;var x2=c2.getContext('2d');
    x2.fillStyle='#2980b9';x2.beginPath();x2.arc(sz/2,sz/2,PR,0,Math.PI*2);x2.fill();
    x2.fillStyle='rgba(116,185,255,.4)';x2.beginPath();x2.arc(sz/2-3,sz/2-3,PR*.55,0,Math.PI*2);x2.fill();
    blueImg=c2;
}
prerenderPlayers();

canvas=$('gameCanvas');ctx=canvas.getContext('2d',{alpha:false});

// EKRAN
function showScr(n){
    $('menuScreen').style.display='none';
    $('lobbyScreen').style.display='none';
    $('gameScreen').style.display='none';
    gameState=n;
    if(n==='menu'){$('menuScreen').style.display='flex';stopL()}
    else if(n==='lobby'){$('lobbyScreen').style.display='flex';stopL()}
    else if(n==='game'){$('gameScreen').style.display='block';resC();startL();setTimeout(function(){canvas.focus()},80)}
}
function resC(){
    cW=window.innerWidth;cH=window.innerHeight;
    canvas.width=cW;canvas.height=cH;
    var tw=cm.fw+FM*2,th=cm.fh+FM*2;
    vS=Math.min(cW/tw,cH/th);vOX=(cW-tw*vS)/2;vOY=(cH-th*vS)/2;
}
window.addEventListener('resize',function(){if(gameState==='game')resC()});
document.addEventListener('contextmenu',function(e){e.preventDefault()});
function onGe(){uG=true;if(gameState==='game'){try{if(!document.fullscreenElement)document.documentElement.requestFullscreen().catch(function(){})}catch(e){}}}
document.addEventListener('click',onGe,{passive:true});
document.addEventListener('touchend',onGe,{passive:true});

// SOCKET BAƒûLANTI
function connectSocket(){
    $('connecting').style.display='flex';
    $('connectingMsg').textContent='Sunucuya baƒülanƒ±lƒ±yor...';
    socket=io(SERVER_URL,{transports:['websocket'],reconnection:true,reconnectionDelay:1000,reconnectionAttempts:10});
    socket.on('connect',function(){
        myId=socket.id;
        $('connecting').style.display='none';
        // Ping √∂l√ß√ºm√º
        setInterval(function(){
            lastPingTime=Date.now();
            socket.emit('ping_custom');
        },2000);
    });
    socket.on('pong_custom',function(){
        pingMs=Date.now()-lastPingTime;
        $('pingDisp').textContent=pingMs+'ms';
        var col=pingMs<60?'#2ecc71':pingMs<120?'#f39c12':'#e74c3c';
        $('pingDisp').style.color=col;
    });
    socket.on('disconnect',function(){
        $('connecting').style.display='flex';
        $('connectingMsg').textContent='Baƒülantƒ± kesildi, yeniden baƒülanƒ±lƒ±yor...';
    });
    socket.on('reconnect',function(){
        $('connecting').style.display='none';
        toast('Yeniden baƒülandƒ±!');
    });
    socket.on('connect_error',function(){
        $('connectingMsg').textContent='Sunucuya ula≈üƒ±lamƒ±yor...';
    });

    // LOBI EVENTS
    socket.on('lobbyUpdate',function(data){
        lobbyData=data;hostId=data.hostId;isHost=(myId===hostId);
        cmk=data.mapKey||'classic';cm=MAPS[cmk]||MAPS.classic;
        gLim=data.goalLimit||0;
        if(gameState==='lobby')refLobby();
    });
    socket.on('newHost',function(data){
        hostId=data.hostId;isHost=(myId===hostId);
        if(gameState==='lobby')refLobby();
        if(gameState==='game')$('adminPanelGame').style.display=isHost?'block':'none';
        if(isHost)toast('Sen host oldun!');
    });
    socket.on('kicked',function(){toast('Odadan atƒ±ldƒ±n!');cleanup();showScr('menu')});
    socket.on('backToLobby',function(){
        stopL();
        gF=false;P={};B={x:cm.fw/2,y:cm.fh/2,vx:0,vy:0,fire:false};
        $('winOverlay').style.display='none';$('goalOverlay').style.display='none';
        showScr('lobby');
    });

    // OYUN EVENTS
    socket.on('gameStart',function(data){
        cmk=data.mapKey||'classic';cm=MAPS[cmk]||MAPS.classic;
        gLim=data.goalLimit||0;
        initGame(data);
        showScr('game');
    });

    // STATE - sunucudan gelen fizik durumu
    socket.on('state',function(data){
        lastStateTime=performance.now();
        applyState(data);
    });

    socket.on('goal',function(data){
        rS=data.redScore;bS=data.blueScore;
        if(data.team==='red'){$('goalText').textContent='üî¥ GOL!';$('goalText').style.color='#e74c3c'}
        else{$('goalText').textContent='üîµ GOL!';$('goalText').style.color='#3498db'}
        $('goalOverlay').style.display='flex';
        gF=true;
    });
    socket.on('resetPositions',function(data){
        gF=false;$('goalOverlay').style.display='none';
        if(data)applyState(data);
    });
    socket.on('matchEnd',function(data){
        mR=false;
        $('goalOverlay').style.display='none';
        if(data.reason==='goal'||data.reason==='time'){
            var winner=data.winner||(data.redScore>data.blueScore?'red':(data.blueScore>data.redScore?'blue':'draw'));
            if(winner==='draw'){$('winText').textContent='ü§ù BERABERE!';$('winText').style.color='#f39c12'}
            else{$('winText').textContent='üèÜ '+(winner==='red'?'KIRMIZI':'MAVƒ∞')+' KAZANDI!';$('winText').style.color=winner==='red'?'#e74c3c':'#3498db'}
            $('winSub').textContent=(data.redScore||rS)+' - '+(data.blueScore||bS);
            $('winOverlay').style.display='flex';
        }
    });
    socket.on('paused',function(p){mP=p;toast(p?'Duraklatƒ±ldƒ±':'Devam ediyor')});
    socket.on('adminReset',function(data){rS=0;bS=0;mT=0;gF=false;$('goalOverlay').style.display='none';if(data)applyState(data)});
    socket.on('mapChanged',function(data){cmk=data.mapKey;cm=MAPS[cmk]||MAPS.classic;resC();if(data.state)applyState(data.state)});
    socket.on('powerShot',function(data){
        if(data.pid===myId)pwCD=2700;
    });
    socket.on('chat',function(data){
        addChat(data.name,data.msg);
        if(data.pid&&P[data.pid])pBubs[data.pid]={text:data.msg,timer:180};
    });
    socket.on('emoji',function(data){
        if(data.pid)pBubs[data.pid]={text:data.emoji,timer:150};
    });
}

// STATE UYGULA - dead reckoning ile smooth
function applyState(data){
    if(!data)return;
    if(data.match){
        mT=data.match.time||0;
        mR=data.match.running||false;
        mP=data.match.paused||false;
        rS=data.match.redScore||0;
        bS=data.match.blueScore||0;
    }
    if(data.goalFreeze!==undefined)gF=data.goalFreeze;
    if(data.ball){
        var tb=data.ball;
        var bd=dst(B.x,B.y,tb.x,tb.y);
        if(bd>200){B.x=tb.x;B.y=tb.y;}
        else{B.tx=tb.x;B.ty=tb.y;}
        B.vx=tb.vx||0;B.vy=tb.vy||0;
        B.fire=tb.fire||false;
    }
    if(data.players){
        for(var pid in data.players){
            var rd=data.players[pid];
            if(!P[pid]){
                P[pid]={name:rd.name,team:rd.team,pos:rd.pos||'',x:rd.x,y:rd.y,vx:0,vy:0,kick:rd.kick||false,pCD:rd.pCD||0,tx:rd.x,ty:rd.y};
                continue;
            }
            var p=P[pid];
            p.team=rd.team;p.name=rd.name;p.pos=rd.pos||'';p.kick=rd.kick||false;p.pCD=rd.pCD||0;
            if(pid===myId){
                p.serverX=rd.x;p.serverY=rd.y;
                var myD=dst(p.x,p.y,rd.x,rd.y);
                if(myD>150){p.x=rd.x;p.y=rd.y;p.vx=0;p.vy=0;}
            } else {
                var pd=dst(p.x,p.y,rd.x,rd.y);
                if(pd>150){p.x=rd.x;p.y=rd.y;}
                else{p.tx=rd.x;p.ty=rd.y;}
                p.vx=rd.vx||0;p.vy=rd.vy||0;
            }
        }
        for(var pid2 in P){if(!data.players[pid2])delete P[pid2];}
    }
}

// ODA KUR
$('btnCreate').addEventListener('click',function(){
    if(!socket||!socket.connected){toast('Sunucuya baƒülanƒ±lamadƒ±!');return}
    myName=$('inpName').value.trim()||('P'+Math.random().toString(36).substr(2,4));
    if(myName.length>12)myName=myName.substr(0,12);
    var code=rcode();
    socket.emit('createRoom',{code:code,playerName:myName,mapKey:$('inpMap').value||'classic',goalLimit:parseInt($('inpGL').value)||0,password:$('inpPwd').value.trim()},function(res){
        if(res.error){toast(res.error);return}
        roomCode=res.code;isHost=true;hostId=myId;
        cmk=$('inpMap').value||'classic';cm=MAPS[cmk]||MAPS.classic;
        showScr('lobby');$('lobbyCode').textContent='ODA: '+roomCode;toast('Kod: '+roomCode);
    });
});

// ODAYA KATIL
$('btnJoin').addEventListener('click',function(){
    if(!socket||!socket.connected){toast('Sunucuya baƒülanƒ±lamadƒ±!');return}
    myName=$('inpName').value.trim()||('P'+Math.random().toString(36).substr(2,4));
    if(myName.length>12)myName=myName.substr(0,12);
    var code=$('inpCode').value.trim().toUpperCase();
    if(!code){toast('Kod girin!');return}
    socket.emit('joinRoom',{code:code,playerName:myName,password:$('inpJP').value.trim()},function(res){
        if(res.error){toast(res.error);return}
        roomCode=res.code;isHost=(myId===res.hostId);hostId=res.hostId;
        cmk=res.mapKey||'classic';cm=MAPS[cmk]||MAPS.classic;gLim=res.goalLimit||0;
        showScr('lobby');$('lobbyCode').textContent='ODA: '+roomCode;toast('Katƒ±ldƒ±n!');
    });
});

// LOBƒ∞
function refLobby(){
    if(!lobbyData||!lobbyData.players)return;
    var rD=$('lRL'),bD=$('lBL'),sD=$('lSL');
    rD.innerHTML='';bD.innerHTML='';sD.innerHTML='';
    var pl={GK:'KAL',DEF:'DEF',MID:'ORS',FWD:'FRV'};
    for(var pid in lobbyData.players){
        var p=lobbyData.players[pid];
        var r=document.createElement('div');r.className='player-row';
        var hH=pid===lobbyData.hostId?'<span class="host-tag">HOST</span>':'';
        var posH='';if(p.pos&&p.team!=='spectator')posH='<span class="pos-tag pos-'+p.pos+'">'+(pl[p.pos]||p.pos)+'</span>';
        var aH='';
        if(isHost&&pid!==myId){aH='<div class="admin-row-btns"><button style="background:#e74c3c" data-ap="'+pid+'" data-at="red">K</button><button style="background:#3498db" data-ap="'+pid+'" data-at="blue">M</button><button style="background:#555" data-ap="'+pid+'" data-at="spectator">ƒ∞</button></div>'}
        r.innerHTML='<span class="p-info">'+hH+'<span class="p-name">'+(p.name||'?')+'</span>'+posH+'</span>'+aH;
        if(p.team==='red')rD.appendChild(r);else if(p.team==='blue')bD.appendChild(r);else sD.appendChild(r);
    }
    rD.querySelectorAll('[data-ap]').forEach(function(b){b.onclick=function(){socket.emit('adminChangeTeam',{pid:b.getAttribute('data-ap'),team:b.getAttribute('data-at')})}});
    bD.querySelectorAll('[data-ap]').forEach(function(b){b.onclick=function(){socket.emit('adminChangeTeam',{pid:b.getAttribute('data-ap'),team:b.getAttribute('data-at')})}});
    sD.querySelectorAll('[data-ap]').forEach(function(b){b.onclick=function(){socket.emit('adminChangeTeam',{pid:b.getAttribute('data-ap'),team:b.getAttribute('data-at')})}});
    $('btnSt').classList.toggle('hidden',!isHost);
    $('lobbyMapName').textContent=(cm.name||'')+(gLim?' | '+gLim+' Gol':'');
    // Mevki se√ß
    var me=lobbyData.players[myId];
    if(!me||me.team==='spectator'){$('lobbyPB').style.display='none'}
    else{
        $('lobbyPB').style.display='block';
        var sel=$('lobbyPS');
        var pos=['GK','DEF','MID','FWD'],lab={GK:'üß§ Kaleci',DEF:'üõ°Ô∏è Defans',MID:'üéØ Orta Saha',FWD:'‚ö° Forvet'};
        var h='<option value="">-- Se√ß --</option>';
        for(var i=0;i<pos.length;i++){var pp=pos[i],im=me.pos===pp;h+='<option value="'+pp+'"'+(im?' selected':'')+'>'+lab[pp]+'</option>'}
        sel.innerHTML=h;
    }
}
$('lobbyPS').addEventListener('change',function(){var v=$('lobbyPS').value;if(v&&socket)socket.emit('changePos',{pos:v})});
$('btnTR').onclick=function(){if(socket)socket.emit('changeTeam',{team:'red'})};
$('btnTB').onclick=function(){if(socket)socket.emit('changeTeam',{team:'blue'})};
$('btnTS').onclick=function(){if(socket)socket.emit('changeTeam',{team:'spectator'})};
$('btnLv').onclick=function(){if(socket)socket.emit('leaveRoom');cleanup();showScr('menu')};
$('btnSt').onclick=function(){if(socket)socket.emit('startGame',function(res){if(res&&res.error)toast(res.error)})};

// OYUN BA≈ûLAT
function initGame(data){
    P={};B={x:cm.fw/2,y:cm.fh/2,vx:0,vy:0,fire:false,tx:cm.fw/2,ty:cm.fh/2};
    mT=0;mR=true;mP=false;gF=false;rS=0;bS=0;
    pwCD=0;kH=false;pH=false;pwP=false;fireParts=[];pBubs={};chatEnts=[];
    $('adminPanelGame').style.display=isHost?'block':'none';
    admO=false;$('adminMenuContent').style.display='none';
    $('goalOverlay').style.display='none';$('winOverlay').style.display='none';
    buildAdm();
    // ƒ∞lk oyuncu listesi
    if(data.players){
        for(var pid in data.players){
            var p=data.players[pid];
            P[pid]={name:p.name,team:p.team,pos:p.pos||'',x:p.x||cm.fw/2,y:p.y||cm.fh/2,vx:0,vy:0,kick:false,pCD:0,tx:p.x||cm.fw/2,ty:p.y||cm.fh/2};
        }
    }
}

// CLEANUP
function cleanup(){
    stopL();roomCode='';isHost=false;P={};lobbyData=null;
    fireParts=[];pBubs={};chatEnts=[];gF=false;
}

// OYUN D√ñNG√úS√ú
function startL(){if(animId)cancelAnimationFrame(animId);lastFT=performance.now();acm=0;tick(lastFT)}
function stopL(){if(animId){cancelAnimationFrame(animId);animId=null}}

// Input g√∂nderme
var lastInputSend=0;
var INPUT_INTERVAL=33; // ~30fps input

function tick(now){
    animId=requestAnimationFrame(tick);
    var dt=now-lastFT;lastFT=now;
    if(dt>100)dt=100;
    acm+=dt;
    while(acm>=FDT){clientUpdate(FDT);acm-=FDT}
    render();
    // Input g√∂nder
    if(now-lastInputSend>=INPUT_INTERVAL&&socket&&socket.connected){
        lastInputSend=now;
        socket.emit('input',{dx:+(myIn.dx.toFixed(2)),dy:+(myIn.dy.toFixed(2)),ik:kH,ip:pH,ipw:pwP});
        if(pwP)pwP=false;
    }
}

// CLIENT TARAFLI G√úNCELLEME (g√∂rsel smooth)
function clientUpdate(dt){
    var pf=MAPS[cmk]?MAPS[cmk].pf||.91:.91;
    var bf=MAPS[cmk]?MAPS[cmk].bf||.987:.987;

    // KENDƒ∞ OYUNCUM: tam lokal fizik
    var me=P[myId];
    if(me&&me.team!=='spectator'&&mR&&!mP&&!gF){
        var il=Math.sqrt(myIn.dx*myIn.dx+myIn.dy*myIn.dy);
        if(il>.05){
            var nx=myIn.dx/il,ny=myIn.dy/il;
            me.vx+=nx*.28*Math.min(il,1);
            me.vy+=ny*.28*Math.min(il,1);
        }
        var sp=Math.sqrt(me.vx*me.vx+me.vy*me.vy);
        if(sp>2.8){me.vx=(me.vx/sp)*2.8;me.vy=(me.vy/sp)*2.8}
        me.vx*=pf;me.vy*=pf;
        if(Math.abs(me.vx)<.003)me.vx=0;
        if(Math.abs(me.vy)<.003)me.vy=0;
        me.x+=me.vx;me.y+=me.vy;
        me.x=clp(me.x,PR,cm.fw-PR);
        me.y=clp(me.y,PR,cm.fh-PR);
        // Sunucu sapma d√ºzeltmesi
        if(me.serverX!=null){
            var diffX=me.serverX-me.x;
            var diffY=me.serverY-me.y;
            var diff=Math.sqrt(diffX*diffX+diffY*diffY);
            if(diff>60&&diff<=150){
                me.x+=diffX*.06;
                me.y+=diffY*.06;
            }
        }
    }

    // Dƒ∞ƒûER OYUNCULAR: smooth interpolasyon
    for(var pid in P){
        if(pid===myId)continue;
        var p=P[pid];
        if(p.tx==null)continue;
        var dd=dst(p.x,p.y,p.tx,p.ty);
        if(dd>150){p.x=p.tx;p.y=p.ty;}
        else if(dd>0.5){
            var spd=Math.sqrt((p.vx||0)*(p.vx||0)+(p.vy||0)*(p.vy||0));
            var iStr=Math.min(.18+spd*.012,.28);
            p.x=lerp(p.x,p.tx,iStr);
            p.y=lerp(p.y,p.ty,iStr);
        }
    }

    // TOP: sadece g√∂rsel smooth, √ßarpƒ±≈üma fiziƒüi YOK
        // TOP: direkt sunucu pozisyonuna git, s√ºr√ºkleme yok
    if(B.tx!=null&&mR&&!mP&&!gF){
        var bdd=dst(B.x,B.y,B.tx,B.ty);
        if(bdd>100){
            // Uzaksa direkt snap
            B.x=B.tx;B.y=B.ty;
        } else if(bdd>1){
            // Yakƒ±nsa hƒ±zlƒ± interpolasyon
            B.x=lerp(B.x,B.tx,.5);
            B.y=lerp(B.y,B.ty,.5);
        }
        // Hafif lokal hareket sadece √ßok yava≈ü toplar i√ßin
        if(Math.sqrt(B.vx*B.vx+B.vy*B.vy)>2){
            B.x+=B.vx*.15;B.y+=B.vy*.15;
        }
        B.vx*=bf;B.vy*=bf;
    }

    // Cooldown
    if(pwCD>0)pwCD--;
    var cdEl=$('pwCD');
    cdEl.style.display=pwCD>0?'flex':'none';
    if(pwCD>0)cdEl.textContent=Math.ceil(pwCD/60);
    $('btnPower').classList.toggle('ready',pwCD<=0);

    // Fire partik√ºller
    for(var fi=fireParts.length-1;fi>=0;fi--){
        var fp=fireParts[fi];
        fp.x+=fp.vx;fp.y+=fp.vy;fp.life--;fp.sz*=.93;
        if(fp.life<=0)fireParts.splice(fi,1);
    }
    if(B.fire&&fireParts.length<20){
        fireParts.push({x:B.x,y:B.y,vx:-B.vx*.08+(Math.random()-.5)*1.5,vy:-B.vy*.08+(Math.random()-.5)*1.5,life:15,sz:3+Math.random()*3,c:Math.random()>.5?'#ff6600':'#ffcc00'});
    }

    // Bubble & chat timer
    for(var bp in pBubs){pBubs[bp].timer--;if(pBubs[bp].timer<=0)delete pBubs[bp]}
    for(var ci=chatEnts.length-1;ci>=0;ci--){chatEnts[ci].timer--;if(chatEnts[ci].timer<=0)chatEnts.splice(ci,1)}
}

// RENDER
function render(){
    ctx.clearRect(0,0,cW,cH);
    ctx.fillStyle=cm.bg;ctx.fillRect(0,0,cW,cH);
    ctx.save();ctx.translate(vOX,vOY);ctx.scale(vS,vS);ctx.translate(FM,FM);
    drawField();drawFire();drawBall();drawPlayers();
    ctx.restore();updateHUD();
}
function drawField(){
    var FW=cm.fw,FH=cm.fh,GH=cm.gh,GD=cm.gd,gT=FH/2-GH/2,gB=FH/2+GH/2,lc=cm.lc;
    ctx.fillStyle=cm.f1;ctx.fillRect(0,0,FW,FH);
    ctx.fillStyle=cm.f2;var sw=FW/10;for(var i=0;i<10;i+=2)ctx.fillRect(i*sw,0,sw,FH);
    ctx.strokeStyle=lc;ctx.lineWidth=3;ctx.strokeRect(2,2,FW-4,FH-4);
    ctx.beginPath();ctx.moveTo(FW/2,0);ctx.lineTo(FW/2,FH);ctx.stroke();
    ctx.beginPath();ctx.arc(FW/2,FH/2,cm.cr,0,Math.PI*2);ctx.stroke();
    ctx.fillStyle=lc;ctx.beginPath();ctx.arc(FW/2,FH/2,4,0,Math.PI*2);ctx.fill();
    ctx.lineWidth=2;ctx.strokeRect(0,FH/2-cm.ph/2,cm.pw,cm.ph);ctx.strokeRect(FW-cm.pw,FH/2-cm.ph/2,cm.pw,cm.ph);
    ctx.fillStyle='rgba(231,76,60,.06)';ctx.fillRect(-GD,gT,GD,GH);
    ctx.strokeStyle='rgba(231,76,60,.65)';ctx.lineWidth=3;
    ctx.beginPath();ctx.moveTo(0,gT);ctx.lineTo(-GD,gT);ctx.lineTo(-GD,gB);ctx.lineTo(0,gB);ctx.stroke();
    ctx.fillStyle='rgba(52,152,219,.06)';ctx.fillRect(FW,gT,GD,GH);
    ctx.strokeStyle='rgba(52,152,219,.65)';
    ctx.beginPath();ctx.moveTo(FW,gT);ctx.lineTo(FW+GD,gT);ctx.lineTo(FW+GD,gB);ctx.lineTo(FW,gB);ctx.stroke();
    ctx.fillStyle='#ddd';
    [[0,gT],[0,gB],[FW,gT],[FW,gB]].forEach(function(pp){ctx.beginPath();ctx.arc(pp[0],pp[1],PSR,0,Math.PI*2);ctx.fill()});
}
function drawFire(){
    if(!fireParts.length)return;
    for(var i=0;i<fireParts.length;i++){var fp=fireParts[i];ctx.globalAlpha=fp.life/15;ctx.fillStyle=fp.c;ctx.fillRect(fp.x-fp.sz/2,fp.y-fp.sz/2,fp.sz,fp.sz)}
    ctx.globalAlpha=1;
}
function drawBall(){
    ctx.fillStyle='rgba(0,0,0,.15)';ctx.beginPath();ctx.arc(B.x+2,B.y+3,BR,0,Math.PI*2);ctx.fill();
    if(B.fire){ctx.fillStyle='rgba(255,100,0,.22)';ctx.beginPath();ctx.arc(B.x,B.y,BR*1.7,0,Math.PI*2);ctx.fill()}
    ctx.fillStyle=B.fire?'#ffaa00':'#fff';ctx.beginPath();ctx.arc(B.x,B.y,BR,0,Math.PI*2);ctx.fill();
    ctx.strokeStyle=B.fire?'#ff4400':'#999';ctx.lineWidth=1.5;ctx.beginPath();ctx.arc(B.x,B.y,BR,0,Math.PI*2);ctx.stroke();
}
function drawPlayers(){
    var psl={GK:'GK',DEF:'DF',MID:'MF',FWD:'FW'};
    var sz=PR*2+6;
    for(var pid in P){
        var p=P[pid];if(p.team==='spectator')continue;
        var isMe=(pid===myId);
        if(p.kick){
            ctx.strokeStyle=p.team==='red'?'rgba(255,80,80,.35)':'rgba(80,160,255,.35)';
            ctx.lineWidth=1.5;ctx.beginPath();ctx.arc(p.x,p.y,PR+BR+2,0,Math.PI*2);ctx.stroke();
        }
        ctx.drawImage(p.team==='red'?redImg:blueImg,p.x-sz/2,p.y-sz/2);
        if(isMe){ctx.strokeStyle='rgba(255,255,255,.9)';ctx.lineWidth=2;ctx.beginPath();ctx.arc(p.x,p.y,PR+1,0,Math.PI*2);ctx.stroke()}
        if(p.pos&&psl[p.pos]){ctx.fillStyle='rgba(255,255,255,.65)';ctx.font='bold 8px Arial';ctx.textAlign='center';ctx.textBaseline='middle';ctx.fillText(psl[p.pos],p.x,p.y)}
        ctx.fillStyle='#fff';ctx.font='bold 9px Arial';ctx.textAlign='center';ctx.textBaseline='bottom';ctx.fillText(p.name||'?',p.x,p.y-PR-3);
        if(isMe){ctx.fillStyle='rgba(255,255,255,.5)';ctx.font='7px Arial';ctx.fillText('‚ñº',p.x,p.y-PR-12)}
        if(pBubs[pid]){ctx.font='14px Arial';ctx.textAlign='center';ctx.textBaseline='bottom';ctx.fillText(pBubs[pid].text,p.x,p.y-PR-17)}
    }
}
function updateHUD(){
    $('hudR').textContent=rS;$('hudB').textContent=bS;
    var m=Math.floor(mT/60),s=Math.floor(mT%60);
    $('hudT').textContent=m+':'+(s<10?'0':'')+s;
    if(mP)$('hudS').textContent='DURAKLADI';
    else if(!mR&&mT>=180)$('hudS').textContent='Bƒ∞TTƒ∞';
    else if(gF)$('hudS').textContent='GOL!';
    else $('hudS').textContent=gLim?gLim+' GOL':'';
}

// CHAT
function addChat(n,m){chatEnts.push({name:n,msg:m,timer:240});if(chatEnts.length>5)chatEnts.shift();renderChatLog()}
function renderChatLog(){var cl=$('chatLog');cl.innerHTML='';for(var i=0;i<chatEnts.length;i++){var d=document.createElement('div');d.className='ce';d.textContent=chatEnts[i].name+': '+chatEnts[i].msg;cl.appendChild(d)}}

// ADMIN
function buildAdm(){
    if(!isHost)return;
    var mc=$('adminMenuContent');mc.innerHTML='';
    var mo='';for(var mk in MAPS)mo+='<option value="'+mk+'"'+(mk===cmk?' selected':'')+'>'+MAPS[mk].name+'</option>';
    mc.innerHTML='<div class="sec">KONTROL</div><button style="background:#f39c12" id="admP">'+(mP?'‚ñ∂':'‚è∏')+'</button><button style="background:#e74c3c" id="admR">üîÑ Sƒ±fƒ±rla</button><button style="background:#3498db" id="admL">üîô Lobi</button><div class="sec">HARƒ∞TA</div><select id="admMS">'+mo+'</select><button style="background:#27ae60" id="admMA">‚úÖ</button>';
    $('admP').onclick=function(){if(socket)socket.emit('adminPause')};
    $('admR').onclick=function(){if(socket)socket.emit('adminReset')};
    $('admL').onclick=function(){if(socket)socket.emit('adminLobby')};
    $('admMA').onclick=function(){var nk=$('admMS').value;if(socket)socket.emit('adminChangeMap',{mapKey:nk})};
}
$('adminToggleBtn').onclick=function(e){e.stopPropagation();admO=!admO;$('adminMenuContent').style.display=admO?'block':'none';if(admO)buildAdm()};
['touchstart','touchmove','touchend'].forEach(function(ev){$('adminPanelGame').addEventListener(ev,function(e){e.stopPropagation()},{passive:false})});
$('winBtn').onclick=function(){$('winOverlay').style.display='none';if(socket&&isHost)socket.emit('backToLobby')};

// JOYSTƒ∞CK
var jZ=$('joyZone'),jBs=$('joyBase'),jTh=$('joyThumb');
jZ.addEventListener('touchstart',function(e){e.preventDefault();if(jTid!==null)return;var t=e.changedTouches[0];jTid=t.identifier;jA=true;var r=jBs.getBoundingClientRect();jSX=r.left+r.width/2;jSY=r.top+r.height/2;updJ(t.clientX,t.clientY)},{passive:false});
jZ.addEventListener('touchmove',function(e){e.preventDefault();for(var i=0;i<e.changedTouches.length;i++){if(e.changedTouches[i].identifier===jTid)updJ(e.changedTouches[i].clientX,e.changedTouches[i].clientY)}},{passive:false});
jZ.addEventListener('touchend',function(e){e.preventDefault();for(var i=0;i<e.changedTouches.length;i++){if(e.changedTouches[i].identifier===jTid){jTid=null;jA=false;myIn.dx=0;myIn.dy=0;jTh.style.display='none'}}},{passive:false});
jZ.addEventListener('touchcancel',function(e){for(var i=0;i<e.changedTouches.length;i++){if(e.changedTouches[i].identifier===jTid){jTid=null;jA=false;myIn.dx=0;myIn.dy=0;jTh.style.display='none'}}},{passive:false});
function updJ(tx,ty){var dx=tx-jSX,dy=ty-jSY,mx=48,d=Math.sqrt(dx*dx+dy*dy),cd=Math.min(d,mx),a=Math.atan2(dy,dx);myIn.dx=Math.cos(a)*cd/mx;myIn.dy=Math.sin(a)*cd/mx;jTh.style.display='block';jTh.style.left=(jSX+Math.cos(a)*cd-25)+'px';jTh.style.top=(jSY+Math.sin(a)*cd-25)+'px'}

// BUTONLAR
$('btnKick').addEventListener('touchstart',function(e){e.preventDefault();e.stopPropagation();kH=true;$('btnKick').classList.add('active')},{passive:false});
$('btnKick').addEventListener('touchend',function(e){e.preventDefault();e.stopPropagation();kH=false;$('btnKick').classList.remove('active')},{passive:false});
$('btnKick').addEventListener('touchcancel',function(){kH=false;$('btnKick').classList.remove('active')});
$('btnPass').addEventListener('touchstart',function(e){e.preventDefault();e.stopPropagation();pH=true;kH=true;$('btnPass').classList.add('active')},{passive:false});
$('btnPass').addEventListener('touchend',function(e){e.preventDefault();e.stopPropagation();pH=false;kH=false;$('btnPass').classList.remove('active')},{passive:false});
$('btnPass').addEventListener('touchcancel',function(){pH=false;kH=false;$('btnPass').classList.remove('active')});
$('btnPower').addEventListener('touchstart',function(e){e.preventDefault();e.stopPropagation();if(pwCD<=0){pwP=true;kH=true;$('btnPower').classList.add('active')}else toast(Math.ceil(pwCD/60)+'s bekle')},{passive:false});
$('btnPower').addEventListener('touchend',function(e){e.preventDefault();e.stopPropagation();kH=false;$('btnPower').classList.remove('active')},{passive:false});
$('btnPower').addEventListener('touchcancel',function(){kH=false;$('btnPower').classList.remove('active')});

// EMOJƒ∞ & CHAT
document.querySelectorAll('.emoji-btn').forEach(function(btn){btn.addEventListener('touchstart',function(e){e.preventDefault();e.stopPropagation();var em=btn.getAttribute('data-e');if(!em||!socket)return;pBubs[myId]={text:em,timer:150};socket.emit('emoji',{emoji:em});socket.emit('chat',{msg:em})},{passive:false})});
var chatO=false;
function toggleChat(){chatO=!chatO;$('chatPanel').style.display=chatO?'flex':'none'}
$('chatToggle').addEventListener('touchstart',function(e){e.preventDefault();e.stopPropagation();toggleChat()},{passive:false});
$('chatToggle').addEventListener('click',function(e){e.stopPropagation();toggleChat()});
document.querySelectorAll('.cm').forEach(function(btn){
    var h=function(e){e.preventDefault();e.stopPropagation();var msg=btn.getAttribute('data-m');if(!msg||!socket)return;pBubs[myId]={text:msg,timer:180};socket.emit('emoji',{emoji:msg});socket.emit('chat',{msg:msg});chatO=false;$('chatPanel').style.display='none'};
    btn.addEventListener('touchstart',h,{passive:false});btn.addEventListener('click',h);
});
$('chatPanel').addEventListener('touchstart',function(e){e.stopPropagation()},{passive:false});

// KLAVYE
document.addEventListener('keydown',function(e){if(gameState!=='game')return;var k=e.key.toLowerCase();keys[k]=true;if(k===' '||k==='x')kH=true;if(k==='z'){pH=true;kH=true}if(k==='c'&&pwCD<=0){pwP=true;kH=true}updK()});
document.addEventListener('keyup',function(e){var k=e.key.toLowerCase();keys[k]=false;if(k===' '||k==='x')kH=false;if(k==='z'){pH=false;kH=false}if(k==='c')kH=false;updK()});
function updK(){if(jA)return;var dx=0,dy=0;if(keys['w']||keys['arrowup'])dy=-1;if(keys['s']||keys['arrowdown'])dy=1;if(keys['a']||keys['arrowleft'])dx=-1;if(keys['d']||keys['arrowright'])dx=1;myIn.dx=dx;myIn.dy=dy}
document.addEventListener('click',function(){if(gameState==='game')canvas.focus()});
window.addEventListener('beforeunload',function(){if(socket)socket.emit('leaveRoom')});

// BA≈ûLAT
$('inpName').value='Oyuncu'+Math.floor(Math.random()*900+100);
connectSocket();
showScr('menu');
})();
</script>
</body>
</html>
