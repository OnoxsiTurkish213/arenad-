<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
<title>HaxBall Arena</title>
<style>
*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent;user-select:none;-webkit-user-select:none}
html,body{width:100%;height:100%;overflow:hidden;background:#2b5c3a;font-family:'Segoe UI',Arial,sans-serif;color:#fff;touch-action:none}
canvas#field{position:fixed;top:0;left:0;z-index:1}

#rotate-msg{position:fixed;top:0;left:0;width:100%;height:100%;z-index:9999;background:#1a3d24;display:none;flex-direction:column;align-items:center;justify-content:center;font-size:16px;color:#8fc49f;text-align:center;padding:30px}
#rotate-msg .ri{font-size:50px;margin-bottom:15px;animation:rotspin 2s ease-in-out infinite}
@keyframes rotspin{0%,100%{transform:rotate(0)}50%{transform:rotate(90deg)}}
@media(orientation:portrait){#rotate-msg{display:flex!important}}

/* Score HUD */
#score-hud{position:fixed;top:0;left:50%;transform:translateX(-50%);z-index:80;display:none;align-items:center;gap:0;font-weight:900}
#score-hud .team-score{padding:8px 22px;font-size:28px;min-width:60px;text-align:center}
#score-hud .red-sc{background:rgba(220,50,50,.85);border-radius:0 0 0 10px;color:#fff}
#score-hud .blue-sc{background:rgba(50,100,220,.85);border-radius:0 0 10px 0;color:#fff}
#score-hud .divider{background:rgba(0,0,0,.6);padding:6px 10px;font-size:14px;color:rgba(255,255,255,.5);letter-spacing:2px}

/* Timer */
#timer{position:fixed;top:50px;left:50%;transform:translateX(-50%);z-index:80;display:none;font-size:13px;color:rgba(255,255,255,.4);letter-spacing:2px;background:rgba(0,0,0,.3);padding:3px 12px;border-radius:4px}

/* Goal overlay */
#goal-overlay{position:fixed;top:0;left:0;width:100%;height:100%;z-index:100;display:none;align-items:center;justify-content:center;pointer-events:none}
#goal-text{font-size:clamp(40px,10vw,80px);font-weight:900;letter-spacing:8px;text-shadow:0 4px 20px rgba(0,0,0,.5);animation:goalPop .5s ease}
@keyframes goalPop{0%{transform:scale(0);opacity:0}50%{transform:scale(1.2)}100%{transform:scale(1);opacity:1}}

/* Joystick */
#joy-zone{position:fixed;bottom:15px;left:15px;z-index:70;display:none;pointer-events:all;width:160px;height:160px}
#joy-base{width:130px;height:130px;border-radius:50%;background:rgba(255,255,255,.06);border:2px solid rgba(255,255,255,.12);position:absolute;bottom:10px;left:10px}
#joy-knob{width:54px;height:54px;border-radius:50%;background:rgba(255,255,255,.15);border:2px solid rgba(255,255,255,.2);position:absolute;top:50%;left:50%;transform:translate(-50%,-50%)}

/* Kick button */
#kick-btn{position:fixed;bottom:30px;right:30px;z-index:70;display:none;pointer-events:all;width:85px;height:85px;border-radius:50%;background:rgba(255,255,255,.1);border:3px solid rgba(255,255,255,.25);color:rgba(255,255,255,.7);font-size:13px;font-weight:900;letter-spacing:1px;cursor:pointer;line-height:85px;text-align:center;transition:all .1s;font-family:inherit}
#kick-btn:active,#kick-btn.active{background:rgba(255,255,255,.25);border-color:rgba(255,255,255,.5);transform:scale(.92)}

/* Players list */
#players-info{position:fixed;bottom:8px;left:50%;transform:translateX(-50%);z-index:75;display:none;font-size:10px;color:rgba(255,255,255,.3);letter-spacing:1px;background:rgba(0,0,0,.2);padding:3px 10px;border-radius:4px;pointer-events:none}

/* Menu */
#menu{position:fixed;top:0;left:0;width:100%;height:100%;z-index:200;display:flex;flex-direction:column;align-items:center;justify-content:center;background:linear-gradient(135deg,#1a3d24 0%,#2b5c3a 50%,#1e4a2d 100%)}
.menu-bg{position:absolute;top:0;left:0;width:100%;height:100%;opacity:.15;background-image:radial-gradient(rgba(255,255,255,.08) 1px,transparent 1px);background-size:25px 25px}
.m-title{font-size:clamp(28px,6vw,48px);font-weight:900;letter-spacing:3px;color:#fff;text-shadow:0 2px 10px rgba(0,0,0,.3);z-index:1;text-align:center}
.m-sub{font-size:clamp(10px,2vw,14px);letter-spacing:5px;color:rgba(255,255,255,.3);z-index:1;margin-bottom:30px;text-transform:uppercase}
.m-ball{font-size:50px;margin-bottom:10px;z-index:1;animation:bounce 1s ease-in-out infinite}
@keyframes bounce{0%,100%{transform:translateY(0)}50%{transform:translateY(-10px)}}
.mi{background:rgba(255,255,255,.08);border:1px solid rgba(255,255,255,.2);border-radius:8px;padding:11px 18px;color:#fff;font-size:15px;width:250px;margin-bottom:8px;z-index:1;outline:none;text-align:center;font-family:inherit;transition:border-color .3s}
.mi:focus{border-color:rgba(255,255,255,.5)}
.mi::placeholder{color:rgba(255,255,255,.2)}
.mb{background:rgba(255,255,255,.1);border:1px solid rgba(255,255,255,.25);border-radius:8px;padding:12px 30px;color:#fff;font-size:14px;font-weight:700;cursor:pointer;letter-spacing:2px;text-transform:uppercase;z-index:1;transition:all .2s;margin:4px;min-width:210px;font-family:inherit;pointer-events:all}
.mb:active{background:rgba(255,255,255,.2);transform:scale(.97)}
.mb.red{background:rgba(220,50,50,.3);border-color:rgba(220,50,50,.5);color:#ff8888}
.mb.blue{background:rgba(50,100,220,.3);border-color:rgba(50,100,220,.5);color:#88aaff}
.mb.sec{opacity:.6}
#mst{margin-top:10px;font-size:11px;color:rgba(255,255,255,.25);z-index:1;min-height:16px;text-align:center}

/* Lobby */
#lobby{position:fixed;top:0;left:0;width:100%;height:100%;z-index:200;display:none;flex-direction:column;align-items:center;justify-content:center;background:linear-gradient(135deg,#1a3d24,#2b5c3a)}
.lc{font-size:30px;font-weight:900;letter-spacing:8px;color:#fff;background:rgba(255,255,255,.1);border:1px solid rgba(255,255,255,.2);border-radius:8px;padding:8px 22px;margin:8px 0;z-index:1}
#plist{z-index:1;margin:15px 0;text-align:center;display:flex;gap:40px}
.team-col{min-width:100px}
.team-col .th{font-size:11px;font-weight:700;letter-spacing:2px;margin-bottom:6px;padding-bottom:4px;border-bottom:2px solid rgba(255,255,255,.1)}
.team-col.red-col .th{color:#ff6666;border-color:rgba(220,50,50,.3)}
.team-col.blue-col .th{color:#6688ff;border-color:rgba(50,100,220,.3)}
.pli{font-size:12px;color:rgba(255,255,255,.5);margin:3px 0;letter-spacing:1px}
.pli.self{font-weight:700}
.team-col.red-col .pli.self{color:#ff8888}
.team-col.blue-col .pli.self{color:#88aaff}
</style>
</head>
<body>
<div id="rotate-msg"><div class="ri">ğŸ“±</div>LÃ¼tfen cihazÄ± yatay Ã§evirin<br><small style="color:rgba(255,255,255,.3)">HaxBall Arena yatay modda oynanÄ±r</small></div>

<canvas id="field"></canvas>

<div id="score-hud">
  <div class="team-score red-sc" id="red-score">0</div>
  <div class="divider">VS</div>
  <div class="team-score blue-sc" id="blue-score">0</div>
</div>
<div id="timer">0:00</div>
<div id="goal-overlay"><div id="goal-text">GOL!</div></div>
<div id="players-info"></div>

<div id="joy-zone"><div id="joy-base"><div id="joy-knob"></div></div></div>
<div id="kick-btn">VURUÅ</div>

<!-- MENU -->
<div id="menu">
  <div class="menu-bg"></div>
  <div class="m-ball">âš½</div>
  <div class="m-title">HAXBALL</div>
  <div class="m-sub">A R E N A</div>
  <input type="text" id="inp-name" class="mi" placeholder="Oyuncu AdÄ±n" maxlength="12">
  <button class="mb" id="btn-host">âš¡ ODA KUR</button>
  <input type="text" id="inp-code" class="mi" placeholder="Oda Kodu" maxlength="6" style="text-transform:uppercase;margin-top:6px">
  <button class="mb sec" id="btn-join">â†’ ODAYA KATIL</button>
  <div id="mst"></div>
</div>

<!-- LOBBY -->
<div id="lobby">
  <div class="menu-bg"></div>
  <div class="m-title" style="font-size:24px">âš½ HAXBALL ARENA</div>
  <div style="font-size:10px;color:rgba(255,255,255,.2);z-index:1;margin:6px 0;letter-spacing:2px">ODA KODU</div>
  <div class="lc" id="lob-code">-----</div>
  <div id="plist">
    <div class="team-col red-col"><div class="th">ğŸ”´ KIRMIZI</div><div id="red-list"></div></div>
    <div class="team-col blue-col"><div class="th">ğŸ”µ MAVÄ°</div><div id="blue-list"></div></div>
  </div>
  <div style="display:flex;gap:8px;z-index:1;margin:8px 0">
    <button class="mb red" onclick="switchTeam('red')" style="min-width:100px;padding:8px 16px;font-size:11px">KIRMIZI</button>
    <button class="mb blue" onclick="switchTeam('blue')" style="min-width:100px;padding:8px 16px;font-size:11px">MAVÄ°</button>
  </div>
  <button class="mb" id="btn-start" style="display:none;margin-top:8px">â–¶ BAÅLAT</button>
  <button class="mb sec" id="btn-leave" style="margin-top:4px;font-size:11px">âœ• AYRIL</button>
</div>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// FIREBASE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
firebase.initializeApp({
  apiKey: "AIzaSyDHIFw7LYjMTpRMpe-ONkSm91fdXk4JWY4",
    authDomain: "gravityarena-14578.firebaseapp.com",
    databaseURL: "https://gravityarena-14578-default-rtdb.europe-west1.firebasedatabase.app",
    projectId: "gravityarena-14578",
    storageBucket: "gravityarena-14578.firebasestorage.app",
    messagingSenderId: "781898977885",
    appId: "1:781898977885:web:a047f4ed10ef296bee73b4",
});
const db=firebase.database();

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PHYSICS CONSTANTS (Haxball-like)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const ACCEL = 0.1;
const FRICTION = 0.96;
const MAX_SPEED = 4.5;
const KICK_FORCE = 8;
const KICK_RANGE = 6;
const BALL_FRICTION = 0.985;
const BALL_MAX_SPEED = 15;
const BALL_BOUNCE = 0.7;
const PLAYER_R = 15;
const BALL_R = 10;
const PLAYER_MASS = 1;
const BALL_MASS = 0.5;

// Field dimensions (world units)
const FW = 900;
const FH = 480;
const BORDER = 30;
const GOAL_W = 12;
const GOAL_H = 110;
const CORNER_R = 40;

// Net positions
const GOAL_TOP = FH/2 - GOAL_H/2;
const GOAL_BOT = FH/2 + GOAL_H/2;

// Sync
const SYNC_MS = 40;
const LERP = 0.15;

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// STATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let state = 'menu';
let roomId=null, myId=null, myName='Player', isHost=false;
let roomRef=null;
let cvs, ctx;

// Local player
let me = {x:300, y:FH/2, vx:0, vy:0, team:'red', kicking:false, num:1};
let inputX=0, inputY=0;
let kickPressed=false;

// Ball (host-authoritative)
let ball = {x:FW/2, y:FH/2, vx:0, vy:0};
let ballTarget = {x:FW/2, y:FH/2};

// Remote
let rPlayers = {};
let redScore=0, blueScore=0;
let goalCooldown=0;
let gameTime=0;

// Joystick
let joyTid=null, joyOX=0, joyOY=0, joyDX=0, joyDY=0;

// Keyboard
let keys={};

// Camera
let camScale=1;

// Last sync
let lastSync=0;

// Audio
let audioCtx=null;

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// AUDIO
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function initAudio(){
  if(audioCtx)return;
  try{audioCtx=new(window.AudioContext||window.webkitAudioContext)()}catch(e){}
}

function snd(type){
  if(!audioCtx)return;
  try{
    const t=audioCtx.currentTime;
    if(type==='kick'){
      const o=audioCtx.createOscillator(),g=audioCtx.createGain();
      o.type='triangle';o.frequency.setValueAtTime(300,t);o.frequency.exponentialRampToValueAtTime(100,t+0.08);
      g.gain.setValueAtTime(.15,t);g.gain.exponentialRampToValueAtTime(.001,t+0.1);
      o.connect(g);g.connect(audioCtx.destination);o.start(t);o.stop(t+.1);
    }else if(type==='wall'){
      const o=audioCtx.createOscillator(),g=audioCtx.createGain();
      o.type='sine';o.frequency.value=800+Math.random()*400;
      g.gain.setValueAtTime(.06,t);g.gain.exponentialRampToValueAtTime(.001,t+.04);
      o.connect(g);g.connect(audioCtx.destination);o.start(t);o.stop(t+.04);
    }else if(type==='goal'){
      [523,659,784,1047].forEach((f,i)=>{
        const o=audioCtx.createOscillator(),g=audioCtx.createGain();
        o.type='sine';o.frequency.value=f;
        g.gain.setValueAtTime(.12,t+i*.1);g.gain.exponentialRampToValueAtTime(.001,t+i*.1+.2);
        o.connect(g);g.connect(audioCtx.destination);o.start(t+i*.1);o.stop(t+i*.1+.2);
      });
    }else if(type==='whistle'){
      const o=audioCtx.createOscillator(),g=audioCtx.createGain();
      o.type='sine';o.frequency.setValueAtTime(900,t);o.frequency.setValueAtTime(700,t+.15);o.frequency.setValueAtTime(900,t+.3);
      g.gain.setValueAtTime(.1,t);g.gain.exponentialRampToValueAtTime(.001,t+.5);
      o.connect(g);g.connect(audioCtx.destination);o.start(t);o.stop(t+.5);
    }
  }catch(e){}
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// HELPERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function genCode(){const c='ABCDEFGHJKLMNPQRSTUVWXYZ23456789';let r='';for(let i=0;i<4;i++)r+=c[Math.floor(Math.random()*c.length)];return r}
function setSt(m){document.getElementById('mst').textContent=m}
function sho(id,v){document.getElementById(id).style.display=v}
function dist(a,b){return Math.sqrt((a.x-b.x)**2+(a.y-b.y)**2)}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CANVAS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function initCanvas(){
  cvs=document.getElementById('field');
  ctx=cvs.getContext('2d');
  resize();
  window.addEventListener('resize',resize);
}

function resize(){
  cvs.width=window.innerWidth;
  cvs.height=window.innerHeight;
  // Scale to fit field
  const sx=cvs.width/(FW+120);
  const sy=cvs.height/(FH+80);
  camScale=Math.min(sx,sy);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ELASTIC CIRCLE COLLISION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function resolveCircleCollision(a, ar, am, b, br, bm) {
  const dx = b.x - a.x;
  const dy = b.y - a.y;
  const d = Math.sqrt(dx*dx + dy*dy);
  const minD = ar + br;

  if (d < minD && d > 0.001) {
    // Normal
    const nx = dx/d, ny = dy/d;

    // Separate
    const overlap = minD - d;
    const totalM = am + bm;
    a.x -= nx * overlap * (bm/totalM);
    a.y -= ny * overlap * (bm/totalM);
    b.x += nx * overlap * (am/totalM);
    b.y += ny * overlap * (am/totalM);

    // Relative velocity
    const dvx = a.vx - b.vx;
    const dvy = a.vy - b.vy;
    const dvn = dvx*nx + dvy*ny;

    if (dvn > 0) {
      const restitution = 0.7;
      const j = -(1+restitution) * dvn / totalM;

      a.vx += j * bm * nx;
      a.vy += j * bm * ny;
      b.vx -= j * am * nx;
      b.vy -= j * am * ny;
    }

    return true;
  }
  return false;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// FIELD COLLISION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function fieldCollide(obj, r) {
  let bounced = false;

  // Check if in goal area
  const inGoalY = obj.y > GOAL_TOP && obj.y < GOAL_BOT;

  // Left wall
  if (!inGoalY || obj.x > BORDER + GOAL_W) {
    if (obj.x - r < BORDER) {
      obj.x = BORDER + r;
      obj.vx = -obj.vx * BALL_BOUNCE;
      bounced = true;
    }
  }

  // Right wall
  if (!inGoalY || obj.x < FW - BORDER - GOAL_W) {
    if (obj.x + r > FW - BORDER) {
      obj.x = FW - BORDER - r;
      obj.vx = -obj.vx * BALL_BOUNCE;
      bounced = true;
    }
  }

  // Top wall
  if (obj.y - r < BORDER) {
    obj.y = BORDER + r;
    obj.vy = -obj.vy * BALL_BOUNCE;
    bounced = true;
  }

  // Bottom wall
  if (obj.y + r > FH - BORDER) {
    obj.y = FH - BORDER - r;
    obj.vy = -obj.vy * BALL_BOUNCE;
    bounced = true;
  }

  // Goal backs
  if (inGoalY) {
    // Left goal back
    if (obj.x - r < BORDER - GOAL_W) {
      obj.x = BORDER - GOAL_W + r;
      obj.vx = -obj.vx * BALL_BOUNCE;
      bounced = true;
    }
    // Right goal back
    if (obj.x + r > FW - BORDER + GOAL_W) {
      obj.x = FW - BORDER + GOAL_W - r;
      obj.vx = -obj.vx * BALL_BOUNCE;
      bounced = true;
    }
  }

  // Goal post collisions (cylindrical posts)
  const posts = [
    {x: BORDER, y: GOAL_TOP},
    {x: BORDER, y: GOAL_BOT},
    {x: FW-BORDER, y: GOAL_TOP},
    {x: FW-BORDER, y: GOAL_BOT}
  ];
  const POST_R = 5;

  posts.forEach(p => {
    const dx = obj.x - p.x;
    const dy = obj.y - p.y;
    const d = Math.sqrt(dx*dx+dy*dy);
    if (d < r + POST_R && d > 0.01) {
      const nx = dx/d, ny = dy/d;
      const overlap = (r+POST_R) - d;
      obj.x += nx * overlap;
      obj.y += ny * overlap;
      const vn = obj.vx*nx + obj.vy*ny;
      obj.vx -= 2 * vn * nx * (1-BALL_BOUNCE*0.5);
      obj.vy -= 2 * vn * ny * (1-BALL_BOUNCE*0.5);
      bounced = true;
    }
  });

  // Corner rounding
  const corners = [
    {x:BORDER, y:BORDER},
    {x:FW-BORDER, y:BORDER},
    {x:BORDER, y:FH-BORDER},
    {x:FW-BORDER, y:FH-BORDER}
  ];

  corners.forEach(c => {
    const dx = obj.x - c.x;
    const dy = obj.y - c.y;
    const d = Math.sqrt(dx*dx+dy*dy);
    // Only if in corner quadrant
    const isCorner = (
      (obj.x < BORDER+CORNER_R && obj.y < BORDER+CORNER_R) ||
      (obj.x > FW-BORDER-CORNER_R && obj.y < BORDER+CORNER_R) ||
      (obj.x < BORDER+CORNER_R && obj.y > FH-BORDER-CORNER_R) ||
      (obj.x > FW-BORDER-CORNER_R && obj.y > FH-BORDER-CORNER_R)
    );

    if (isCorner && d < CORNER_R + r) {
      // Push away from corner center
      const dFromCorner = Math.sqrt((obj.x-c.x)**2+(obj.y-c.y)**2);
      if (dFromCorner > 0.01 && dFromCorner < CORNER_R) {
        const nx = (obj.x-c.x)/dFromCorner;
        const ny = (obj.y-c.y)/dFromCorner;
        obj.x = c.x + nx * (CORNER_R + r);
        obj.y = c.y + ny * (CORNER_R + r);
        const vn = obj.vx*nx + obj.vy*ny;
        if (vn < 0) {
          obj.vx -= 2*vn*nx*BALL_BOUNCE;
          obj.vy -= 2*vn*ny*BALL_BOUNCE;
        }
        bounced = true;
      }
    }
  });

  return bounced;
}

// Player-specific field collision (no goal entry)
function playerFieldCollide(p) {
  const r = PLAYER_R;

  if (p.x - r < BORDER) { p.x = BORDER + r; p.vx = 0; }
  if (p.x + r > FW - BORDER) { p.x = FW - BORDER - r; p.vx = 0; }
  if (p.y - r < BORDER) { p.y = BORDER + r; p.vy = 0; }
  if (p.y + r > FH - BORDER) { p.y = FH - BORDER - r; p.vy = 0; }

  // Goal post blocking for players
  const posts = [
    {x:BORDER, y:GOAL_TOP}, {x:BORDER, y:GOAL_BOT},
    {x:FW-BORDER, y:GOAL_TOP}, {x:FW-BORDER, y:GOAL_BOT}
  ];

  posts.forEach(post => {
    const dx=p.x-post.x, dy=p.y-post.y;
    const d=Math.sqrt(dx*dx+dy*dy);
    if(d<r+5&&d>0.01){
      const nx=dx/d, ny=dy/d;
      p.x=post.x+nx*(r+5);
      p.y=post.y+ny*(r+5);
      const vn=p.vx*nx+p.vy*ny;
      if(vn<0){p.vx-=vn*nx;p.vy-=vn*ny}
    }
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PHYSICS UPDATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function updatePhysics(dt) {
  if (state !== 'playing') return;

  // Player input â†’ acceleration
  let ax = 0, ay = 0;

  // Keyboard
  if (keys['KeyW']||keys['ArrowUp']) ay = -1;
  if (keys['KeyS']||keys['ArrowDown']) ay = 1;
  if (keys['KeyA']||keys['ArrowLeft']) ax = -1;
  if (keys['KeyD']||keys['ArrowRight']) ax = 1;

  // Joystick
  if (Math.abs(joyDX)>0.1||Math.abs(joyDY)>0.1) {
    ax = joyDX;
    ay = joyDY;
  }

  // Normalize
  const alen = Math.sqrt(ax*ax+ay*ay);
  if (alen > 1) { ax/=alen; ay/=alen; }

  // Apply acceleration
  me.vx += ax * ACCEL;
  me.vy += ay * ACCEL;

  // Friction
  me.vx *= FRICTION;
  me.vy *= FRICTION;

  // Max speed
  const spd = Math.sqrt(me.vx*me.vx+me.vy*me.vy);
  if (spd > MAX_SPEED) {
    me.vx = me.vx/spd*MAX_SPEED;
    me.vy = me.vy/spd*MAX_SPEED;
  }

  // Move
  me.x += me.vx;
  me.y += me.vy;

  // Field collision
  playerFieldCollide(me);

  // Kick
  if (kickPressed && !me.kicking) {
    me.kicking = true;
    doKick();
  }
  if (!kickPressed) me.kicking = false;

  // Host: update ball physics
  if (isHost) {
    updateBallPhysics();
  } else {
    // Non-host: lerp ball to target
    ball.x += (ballTarget.x - ball.x) * LERP;
    ball.y += (ballTarget.y - ball.y) * LERP;
  }

  // Player-ball collision (everyone does local)
  resolveCircleCollision(me, PLAYER_R, PLAYER_MASS, ball, BALL_R, BALL_MASS);

  // Goal cooldown
  if (goalCooldown > 0) goalCooldown -= dt;

  // Game time
  gameTime += dt;
  updateTimer();
}

function updateBallPhysics() {
  // Ball friction
  ball.vx *= BALL_FRICTION;
  ball.vy *= BALL_FRICTION;

  // Max speed
  const bs = Math.sqrt(ball.vx*ball.vx+ball.vy*ball.vy);
  if (bs > BALL_MAX_SPEED) {
    ball.vx = ball.vx/bs*BALL_MAX_SPEED;
    ball.vy = ball.vy/bs*BALL_MAX_SPEED;
  }

  // Move
  ball.x += ball.vx;
  ball.y += ball.vy;

  // Field collision
  if (fieldCollide(ball, BALL_R)) {
    snd('wall');
  }

  // Remote player-ball collision (host resolves)
  Object.values(rPlayers).forEach(rp => {
    if (!rp) return;
    const rpObj = {x:rp.x, y:rp.y, vx:rp.vx||0, vy:rp.vy||0};
    resolveCircleCollision(rpObj, PLAYER_R, PLAYER_MASS, ball, BALL_R, BALL_MASS);
  });

  // Goal detection
  if (goalCooldown <= 0) {
    // Left goal (red team defends)
    if (ball.x < BORDER && ball.y > GOAL_TOP && ball.y < GOAL_BOT) {
      scoreGoal('blue');
    }
    // Right goal (blue team defends)
    if (ball.x > FW - BORDER && ball.y > GOAL_TOP && ball.y < GOAL_BOT) {
      scoreGoal('red');
    }
  }
}

function doKick() {
  const d = dist(me, ball);
  if (d < PLAYER_R + BALL_R + KICK_RANGE) {
    const dx = ball.x - me.x;
    const dy = ball.y - me.y;
    const dd = Math.sqrt(dx*dx+dy*dy);
    if (dd > 0.01) {
      ball.vx += (dx/dd) * KICK_FORCE;
      ball.vy += (dy/dd) * KICK_FORCE;
      snd('kick');

      // Sync kick (host processes)
      if (roomRef) {
        roomRef.child('kicks').push({
          px:me.x, py:me.y,
          bx:ball.x, by:ball.y,
          dx:dx/dd, dy:dy/dd,
          f:KICK_FORCE, t:Date.now()
        });
      }
    }
  }
}

function scoreGoal(team) {
  goalCooldown = 3;
  snd('goal');

  if (team === 'red') redScore++;
  else blueScore++;

  document.getElementById('red-score').textContent = redScore;
  document.getElementById('blue-score').textContent = blueScore;

  // Goal animation
  const overlay = document.getElementById('goal-overlay');
  const text = document.getElementById('goal-text');
  text.textContent = 'GOL!';
  text.style.color = team === 'red' ? '#ff4444' : '#4488ff';
  overlay.style.display = 'flex';
  setTimeout(() => { overlay.style.display = 'none'; }, 1500);

  snd('whistle');

  // Reset ball
  ball.x = FW/2;
  ball.y = FH/2;
  ball.vx = 0;
  ball.vy = 0;

  // Sync
  if (roomRef && isHost) {
    roomRef.child('game').update({
      rs: redScore, bs: blueScore,
      bx: ball.x, by: ball.y, bvx: 0, bvy: 0
    });
  }
}

function updateTimer() {
  const mins = Math.floor(gameTime/60);
  const secs = Math.floor(gameTime%60);
  document.getElementById('timer').textContent = mins + ':' + (secs<10?'0':'') + secs;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// RENDERING
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function render() {
  const W = cvs.width, H = cvs.height;

  ctx.fillStyle = '#2b5c3a';
  ctx.fillRect(0, 0, W, H);

  ctx.save();

  // Center and scale
  const ox = W/2 - FW/2*camScale;
  const oy = H/2 - FH/2*camScale;
  ctx.translate(ox, oy);
  ctx.scale(camScale, camScale);

  // Field background
  ctx.fillStyle = '#3a7a4f';
  ctx.fillRect(BORDER, BORDER, FW-BORDER*2, FH-BORDER*2);

  // Field border
  ctx.strokeStyle = '#fff';
  ctx.lineWidth = 2;

  // Main border with rounded corners
  ctx.beginPath();
  const b = BORDER;
  const cr = CORNER_R;
  ctx.moveTo(b+cr, b);
  ctx.lineTo(FW-b-cr, b);
  ctx.arc(FW-b-cr, b+cr, cr, -Math.PI/2, 0);
  ctx.lineTo(FW-b, GOAL_TOP);
  // Right goal area gap
  ctx.moveTo(FW-b, GOAL_BOT);
  ctx.lineTo(FW-b, FH-b-cr);
  ctx.arc(FW-b-cr, FH-b-cr, cr, 0, Math.PI/2);
  ctx.lineTo(b+cr, FH-b);
  ctx.arc(b+cr, FH-b-cr, cr, Math.PI/2, Math.PI);
  ctx.lineTo(b, GOAL_BOT);
  // Left goal area gap
  ctx.moveTo(b, GOAL_TOP);
  ctx.lineTo(b, b+cr);
  ctx.arc(b+cr, b+cr, cr, Math.PI, Math.PI*1.5);
  ctx.strokeStyle = 'rgba(255,255,255,.7)';
  ctx.lineWidth = 2.5;
  ctx.stroke();

  // Center line
  ctx.beginPath();
  ctx.moveTo(FW/2, b);
  ctx.lineTo(FW/2, FH-b);
  ctx.strokeStyle = 'rgba(255,255,255,.3)';
  ctx.lineWidth = 1.5;
  ctx.stroke();

  // Center circle
  ctx.beginPath();
  ctx.arc(FW/2, FH/2, 60, 0, Math.PI*2);
  ctx.strokeStyle = 'rgba(255,255,255,.3)';
  ctx.lineWidth = 1.5;
  ctx.stroke();

  // Center dot
  ctx.beginPath();
  ctx.arc(FW/2, FH/2, 4, 0, Math.PI*2);
  ctx.fillStyle = 'rgba(255,255,255,.4)';
  ctx.fill();

  // Penalty areas
  ctx.strokeStyle = 'rgba(255,255,255,.25)';
  ctx.lineWidth = 1.5;

  // Left penalty
  ctx.strokeRect(b, FH/2-80, 60, 160);
  // Right penalty
  ctx.strokeRect(FW-b-60, FH/2-80, 60, 160);

  // Goals
  // Left goal (net)
  ctx.fillStyle = 'rgba(220,50,50,.15)';
  ctx.fillRect(b-GOAL_W, GOAL_TOP, GOAL_W, GOAL_H);
  ctx.strokeStyle = 'rgba(220,50,50,.5)';
  ctx.lineWidth = 2;
  ctx.beginPath();
  ctx.moveTo(b, GOAL_TOP);
  ctx.lineTo(b-GOAL_W, GOAL_TOP);
  ctx.lineTo(b-GOAL_W, GOAL_BOT);
  ctx.lineTo(b, GOAL_BOT);
  ctx.stroke();

  // Net lines
  ctx.strokeStyle = 'rgba(220,50,50,.2)';
  ctx.lineWidth = 0.5;
  for(let ny=GOAL_TOP;ny<GOAL_BOT;ny+=10){
    ctx.beginPath();ctx.moveTo(b-GOAL_W,ny);ctx.lineTo(b,ny);ctx.stroke();
  }
  for(let nx=b-GOAL_W;nx<b;nx+=8){
    ctx.beginPath();ctx.moveTo(nx,GOAL_TOP);ctx.lineTo(nx,GOAL_BOT);ctx.stroke();
  }

  // Right goal
  ctx.fillStyle = 'rgba(50,100,220,.15)';
  ctx.fillRect(FW-b, GOAL_TOP, GOAL_W, GOAL_H);
  ctx.strokeStyle = 'rgba(50,100,220,.5)';
  ctx.lineWidth = 2;
  ctx.beginPath();
  ctx.moveTo(FW-b, GOAL_TOP);
  ctx.lineTo(FW-b+GOAL_W, GOAL_TOP);
  ctx.lineTo(FW-b+GOAL_W, GOAL_BOT);
  ctx.lineTo(FW-b, GOAL_BOT);
  ctx.stroke();

  ctx.strokeStyle = 'rgba(50,100,220,.2)';
  ctx.lineWidth = 0.5;
  for(let ny=GOAL_TOP;ny<GOAL_BOT;ny+=10){
    ctx.beginPath();ctx.moveTo(FW-b,ny);ctx.lineTo(FW-b+GOAL_W,ny);ctx.stroke();
  }
  for(let nx=FW-b;nx<FW-b+GOAL_W;nx+=8){
    ctx.beginPath();ctx.moveTo(nx,GOAL_TOP);ctx.lineTo(nx,GOAL_BOT);ctx.stroke();
  }

  // Goal posts
  const posts=[{x:b,y:GOAL_TOP},{x:b,y:GOAL_BOT},{x:FW-b,y:GOAL_TOP},{x:FW-b,y:GOAL_BOT}];
  posts.forEach(p => {
    ctx.beginPath();
    ctx.arc(p.x, p.y, 5, 0, Math.PI*2);
    ctx.fillStyle = '#ddd';
    ctx.fill();
    ctx.strokeStyle = '#999';
    ctx.lineWidth = 1;
    ctx.stroke();
  });

  // Remote players
  Object.keys(rPlayers).forEach(pid => {
    if(pid===myId)return;
    const rp=rPlayers[pid];
    if(!rp)return;

    // LERP
    if(rp.rx===undefined){rp.rx=rp.x;rp.ry2=rp.y}
    rp.rx+=(rp.x-rp.rx)*LERP;
    rp.ry2+=(rp.y-rp.ry2)*LERP;

    drawPlayer(rp.rx, rp.ry2, rp.team||'red', rp.nm||'?', rp.num||0, false, rp.kicking);
  });

  // Local player
  drawPlayer(me.x, me.y, me.team, myName, me.num, true, me.kicking);

  // Ball
  drawBall(ball.x, ball.y);

  // Kick indicator
  if (me.kicking || kickPressed) {
    const d = dist(me, ball);
    if (d < PLAYER_R + BALL_R + KICK_RANGE + 10) {
      ctx.beginPath();
      ctx.arc(me.x, me.y, PLAYER_R + KICK_RANGE + BALL_R, 0, Math.PI*2);
      ctx.strokeStyle = 'rgba(255,255,100,.25)';
      ctx.lineWidth = 1;
      ctx.setLineDash([4,4]);
      ctx.stroke();
      ctx.setLineDash([]);
    }
  }

  ctx.restore();
}

function drawPlayer(x, y, team, name, num, isMe, kicking) {
  const color = team === 'red' ? '#e63946' : '#457b9d';
  const light = team === 'red' ? '#ff6b6b' : '#6baaff';

  // Shadow
  ctx.beginPath();
  ctx.ellipse(x, y+PLAYER_R-2, PLAYER_R*0.8, 4, 0, 0, Math.PI*2);
  ctx.fillStyle = 'rgba(0,0,0,.2)';
  ctx.fill();

  // Outer ring (kick indicator)
  if (kicking) {
    ctx.beginPath();
    ctx.arc(x, y, PLAYER_R+3, 0, Math.PI*2);
    ctx.strokeStyle = 'rgba(255,255,100,.6)';
    ctx.lineWidth = 2;
    ctx.stroke();
  }

  // Main circle
  ctx.beginPath();
  ctx.arc(x, y, PLAYER_R, 0, Math.PI*2);
  ctx.fillStyle = color;
  ctx.fill();

  // Highlight
  ctx.beginPath();
  ctx.arc(x-3, y-3, PLAYER_R*0.6, 0, Math.PI*2);
  ctx.fillStyle = light+'33';
  ctx.fill();

  // Border
  ctx.beginPath();
  ctx.arc(x, y, PLAYER_R, 0, Math.PI*2);
  ctx.strokeStyle = isMe ? '#fff' : 'rgba(255,255,255,.4)';
  ctx.lineWidth = isMe ? 2.5 : 1.5;
  ctx.stroke();

  // Number
  ctx.fillStyle = '#fff';
  ctx.font = 'bold 11px Arial';
  ctx.textAlign = 'center';
  ctx.textBaseline = 'middle';
  ctx.fillText(num, x, y+1);

  // Name
  ctx.fillStyle = 'rgba(255,255,255,.8)';
  ctx.font = '9px Arial';
  ctx.textAlign = 'center';
  ctx.fillText(name, x, y-PLAYER_R-6);
}

function drawBall(x, y) {
  // Shadow
  ctx.beginPath();
  ctx.ellipse(x+1, y+BALL_R, BALL_R*0.7, 3, 0, 0, Math.PI*2);
  ctx.fillStyle = 'rgba(0,0,0,.25)';
  ctx.fill();

  // Ball
  ctx.beginPath();
  ctx.arc(x, y, BALL_R, 0, Math.PI*2);
  ctx.fillStyle = '#fff';
  ctx.fill();

  // Pattern
  ctx.beginPath();
  ctx.arc(x, y, BALL_R, 0, Math.PI*2);
  ctx.strokeStyle = '#ccc';
  ctx.lineWidth = 0.8;
  ctx.stroke();

  // Pentagon pattern
  for (let i=0; i<5; i++) {
    const a = (i/5)*Math.PI*2 - Math.PI/2;
    const px2 = x + Math.cos(a)*BALL_R*0.55;
    const py2 = y + Math.sin(a)*BALL_R*0.55;
    ctx.beginPath();
    ctx.arc(px2, py2, 2.5, 0, Math.PI*2);
    ctx.fillStyle = '#aaa';
    ctx.fill();
  }

  // Highlight
  ctx.beginPath();
  ctx.arc(x-2, y-2, BALL_R*0.35, 0, Math.PI*2);
  ctx.fillStyle = 'rgba(255,255,255,.4)';
  ctx.fill();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// INPUT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function initInput() {
  // Keyboard
  document.addEventListener('keydown', e => {
    keys[e.code]=true;
    if(e.code==='Space'||e.code==='KeyX') kickPressed=true;
  });
  document.addEventListener('keyup', e => {
    keys[e.code]=false;
    if(e.code==='Space'||e.code==='KeyX') kickPressed=false;
  });

  // Joystick
  const jz=document.getElementById('joy-zone');
  const jb=document.getElementById('joy-base');
  const jk=document.getElementById('joy-knob');
  const maxD=45;

  jz.addEventListener('touchstart',e=>{
    e.preventDefault();if(joyTid!==null)return;
    initAudio();
    const t=e.changedTouches[0];joyTid=t.identifier;
    const r=jb.getBoundingClientRect();
    joyOX=r.left+r.width/2;joyOY=r.top+r.height/2;
  },{passive:false});

  jz.addEventListener('touchmove',e=>{
    e.preventDefault();
    for(let i=0;i<e.changedTouches.length;i++){
      const t=e.changedTouches[i];
      if(t.identifier===joyTid){
        let dx=t.clientX-joyOX,dy=t.clientY-joyOY;
        const d=Math.sqrt(dx*dx+dy*dy);
        if(d>maxD){dx=dx/d*maxD;dy=dy/d*maxD}
        joyDX=dx/maxD;joyDY=dy/maxD;
        jk.style.transform=`translate(calc(-50% + ${dx}px),calc(-50% + ${dy}px))`;
      }
    }
  },{passive:false});

  const ej=e=>{
    for(let i=0;i<e.changedTouches.length;i++){
      if(e.changedTouches[i].identifier===joyTid){
        joyTid=null;joyDX=0;joyDY=0;
        jk.style.transform='translate(-50%,-50%)';
      }
    }
  };
  jz.addEventListener('touchend',ej);
  jz.addEventListener('touchcancel',ej);

  // Kick button
  const kb=document.getElementById('kick-btn');
  kb.addEventListener('touchstart',e=>{
    e.preventDefault();kickPressed=true;kb.classList.add('active');initAudio();
  },{passive:false});
  kb.addEventListener('touchend',e=>{kickPressed=false;kb.classList.remove('active')});
  kb.addEventListener('touchcancel',e=>{kickPressed=false;kb.classList.remove('active')});

  window.addEventListener('resize',resize);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// FIREBASE SYNC
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function syncMe() {
  if(!roomRef||state!=='playing')return;
  const now=performance.now();
  if(now-lastSync<SYNC_MS)return;
  lastSync=now;

  const u = {};
  u['players/'+myId+'/x'] = Math.round(me.x*10)/10;
  u['players/'+myId+'/y'] = Math.round(me.y*10)/10;
  u['players/'+myId+'/vx'] = Math.round(me.vx*100)/100;
  u['players/'+myId+'/vy'] = Math.round(me.vy*100)/100;
  u['players/'+myId+'/kicking'] = kickPressed;

  // Host syncs ball
  if(isHost){
    u['game/bx'] = Math.round(ball.x*10)/10;
    u['game/by'] = Math.round(ball.y*10)/10;
    u['game/bvx'] = Math.round(ball.vx*100)/100;
    u['game/bvy'] = Math.round(ball.vy*100)/100;
  }

  roomRef.update(u);
}

function setupGameListeners() {
  // Players
  roomRef.child('players').on('value', snap => {
    const data = snap.val() || {};
    Object.keys(data).forEach(pid => {
      if(pid===myId) return;
      rPlayers[pid] = data[pid];
    });
    // Clean
    Object.keys(rPlayers).forEach(pid => {
      if(!data[pid]) delete rPlayers[pid];
    });
    updatePlayerCount();
  });

  // Ball (non-host)
  if(!isHost){
    roomRef.child('game').on('value', snap => {
      const d=snap.val();
      if(!d)return;
      ballTarget.x = d.bx||FW/2;
      ballTarget.y = d.by||FH/2;
      ball.vx = d.bvx||0;
      ball.vy = d.bvy||0;

      if(d.rs!==undefined){redScore=d.rs;document.getElementById('red-score').textContent=redScore}
      if(d.bs!==undefined){blueScore=d.bs;document.getElementById('blue-score').textContent=blueScore}
    });
  }

  // Kicks (host processes remote kicks)
  if(isHost){
    roomRef.child('kicks').on('child_added', snap => {
      const k=snap.val();
      if(!k)return;
      if(Date.now()-k.t>1000) return; // ignore old
      ball.vx += k.dx*k.f;
      ball.vy += k.dy*k.f;
      snap.ref.remove();
      snd('kick');
    });
  }

  // Score sync for host
  if(isHost){
    roomRef.child('game').update({rs:0,bs:0,bx:FW/2,by:FH/2,bvx:0,bvy:0});
  }
}

function updatePlayerCount(){
  const total = Object.keys(rPlayers).length + 1;
  document.getElementById('players-info').textContent = 'Oyuncular: '+total;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// LOBBY
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
document.getElementById('btn-host').onclick = () => {
  myName = document.getElementById('inp-name').value.trim()||'Player';
  roomId = genCode();
  myId = 'p_'+Date.now();
  isHost = true;
  roomRef = db.ref('rooms/'+roomId);

  setSt('Oda kuruluyor...');

  me.team = 'red';
  me.num = 1;

  roomRef.set({
    host:myId, status:'lobby',
    players:{[myId]:{nm:myName,x:0,y:0,vx:0,vy:0,team:'red',num:1,kicking:false}},
    game:{rs:0,bs:0,bx:FW/2,by:FH/2,bvx:0,bvy:0}
  }).then(()=>{
    console.log("[HX] Oda: "+roomId);
    document.getElementById('lob-code').textContent=roomId;
    sho('menu','none');sho('lobby','flex');
    sho('btn-start','inline-block');
    state='lobby';
    listenLobby();
  }).catch(e=>setSt('Hata: '+e.message));

  roomRef.child('players/'+myId).onDisconnect().remove();
};

document.getElementById('btn-join').onclick = () => {
  myName = document.getElementById('inp-name').value.trim()||'Player';
  const code = document.getElementById('inp-code').value.trim().toUpperCase();
  if(!code||code.length<3){setSt('GeÃ§erli kod girin!');return}

  roomId=code;myId='p_'+Date.now();isHost=false;
  roomRef=db.ref('rooms/'+roomId);
  setSt('BaÄŸlanÄ±lÄ±yor...');

  roomRef.once('value').then(snap=>{
    const d=snap.val();
    if(!d){setSt('Oda bulunamadÄ±!');return}

    const players=d.players?Object.values(d.players):[];
    const redCount=players.filter(p=>p.team==='red').length;
    const blueCount=players.filter(p=>p.team==='blue').length;
    me.team = blueCount <= redCount ? 'blue' : 'red';
    me.num = players.length + 1;

    roomRef.child('players/'+myId).set({
      nm:myName,x:0,y:0,vx:0,vy:0,team:me.team,num:me.num,kicking:false
    }).then(()=>{
      console.log("[HX] KatÄ±ldÄ±: "+roomId);
      document.getElementById('lob-code').textContent=roomId;
      sho('menu','none');sho('lobby','flex');
      sho('btn-start','none');
      state='lobby';
      listenLobby();
    });

    roomRef.child('players/'+myId).onDisconnect().remove();
  }).catch(e=>setSt('Hata: '+e.message));
};

function switchTeam(team){
  me.team=team;
  if(roomRef) roomRef.child('players/'+myId+'/team').set(team);
}

function listenLobby(){
  roomRef.child('players').on('value',snap=>{
    const data=snap.val()||{};
    const redList=document.getElementById('red-list');
    const blueList=document.getElementById('blue-list');
    redList.innerHTML='';blueList.innerHTML='';

    let rn=0,bn=0;
    Object.keys(data).forEach(pid=>{
      const p=data[pid];
      const div=document.createElement('div');
      div.className='pli'+(pid===myId?' self':'');
      div.textContent=(p.nm||'Player')+(pid===myId?' (Sen)':'');

      if(p.team==='blue'){blueList.appendChild(div);bn++}
      else{redList.appendChild(div);rn++}
    });
  });

  roomRef.child('status').on('value',snap=>{
    if(snap.val()==='playing'&&state==='lobby') startGame();
  });
}

document.getElementById('btn-start').onclick=()=>{
  if(!isHost)return;
  roomRef.child('status').set('playing');
};

document.getElementById('btn-leave').onclick=()=>{
  if(roomRef)roomRef.child('players/'+myId).remove();
  roomRef=null;state='menu';
  sho('lobby','none');sho('menu','flex');
};

function backToMenu(){
  if(roomRef)roomRef.child('players/'+myId).remove();
  roomRef=null;state='menu';
  sho('menu','flex');sho('lobby','none');
  sho('score-hud','none');sho('timer','none');
  sho('joy-zone','none');sho('kick-btn','none');
  sho('players-info','none');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// GAME START
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function startGame(){
  state='playing';
  sho('lobby','none');sho('menu','none');
  sho('score-hud','flex');sho('timer','block');
  sho('joy-zone','block');sho('kick-btn','block');
  sho('players-info','block');

  redScore=0;blueScore=0;gameTime=0;goalCooldown=0;
  document.getElementById('red-score').textContent='0';
  document.getElementById('blue-score').textContent='0';

  // Spawn position based on team
  if(me.team==='red'){
    me.x=FW*0.25;me.y=FH/2+(Math.random()-0.5)*100;
  }else{
    me.x=FW*0.75;me.y=FH/2+(Math.random()-0.5)*100;
  }
  me.vx=0;me.vy=0;

  ball.x=FW/2;ball.y=FH/2;ball.vx=0;ball.vy=0;
  ballTarget.x=FW/2;ballTarget.y=FH/2;

  setupGameListeners();
  initAudio();
  snd('whistle');

  console.log("[HX] Oyun baÅŸladÄ±! TakÄ±m: "+me.team);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// MAIN LOOP
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let lastTime=0;

function gameLoop(time){
  requestAnimationFrame(gameLoop);
  const rawDt=(time-lastTime)/1000;
  const dt=Math.min(rawDt,0.05);
  lastTime=time;

  if(state==='playing'){
    updatePhysics(dt);
    syncMe();
  }

  if(cvs) render();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// INIT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function init(){
  console.log("[HX] HaxBall Arena baÅŸlatÄ±lÄ±yor...");
  initCanvas();
  initInput();
  sho('menu','flex');
  requestAnimationFrame(gameLoop);
  console.log("[HX] HazÄ±r!");
}

window.addEventListener('load',init);
</script>
</body>
</html>
