<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, orientation=landscape">
    <meta name="screen-orientation" content="landscape">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>HaxBall Mobile</title>
    <style>
        *{margin:0;padding:0;box-sizing:border-box;font-family:'Segoe UI',sans-serif;-webkit-tap-highlight-color:transparent;touch-action:none;}
        html,body{width:100%;height:100%;overflow:hidden;background:#1a1a2e;color:#fff;position:fixed;top:0;left:0;}
        .screen{display:none;width:100%;height:100%;position:absolute;top:0;left:0;}
        .screen.active{display:flex;}

        /* MENU */
        #menuScreen{flex-direction:column;align-items:center;justify-content:center;background:linear-gradient(135deg,#1a1a2e,#16213e,#0f3460);padding:20px;}
        .game-title{font-size:clamp(36px,8vw,72px);font-weight:900;background:linear-gradient(45deg,#e94560,#f5a623,#e94560);-webkit-background-clip:text;-webkit-text-fill-color:transparent;margin-bottom:5px;letter-spacing:4px;}
        .game-subtitle{font-size:clamp(12px,2.5vw,18px);color:#888;margin-bottom:30px;}
        .menu-container{display:flex;flex-direction:column;gap:12px;width:min(90%,350px);}
        .menu-input{padding:14px 18px;border:2px solid #333;border-radius:12px;background:rgba(255,255,255,0.06);color:#fff;font-size:16px;outline:none;transition:all .3s;}
        .menu-input:focus{border-color:#e94560;background:rgba(233,69,96,0.1);}
        .menu-btn{padding:14px 24px;border:none;border-radius:12px;font-size:16px;font-weight:700;cursor:pointer;transition:all .3s;text-transform:uppercase;letter-spacing:2px;}
        .btn-create{background:linear-gradient(135deg,#e94560,#c0392b);color:#fff;}
        .btn-join{background:linear-gradient(135deg,#0984e3,#6c5ce7);color:#fff;}
        .menu-divider{text-align:center;color:#555;font-size:13px;margin:3px 0;}
        .join-section{display:flex;gap:8px;}
        .join-section .menu-input{flex:1;text-align:center;font-size:22px;letter-spacing:8px;font-weight:700;}
        .error-msg{color:#e94560;font-size:13px;text-align:center;margin-top:5px;min-height:18px;}

        /* LOBBY */
        #lobbyScreen{flex-direction:column;background:linear-gradient(135deg,#1a1a2e,#16213e);}
        .lobby-header{display:flex;justify-content:space-between;align-items:center;padding:8px 15px;background:rgba(0,0,0,0.3);border-bottom:2px solid #333;flex-shrink:0;}
        .lobby-title{font-size:18px;font-weight:700;}
        .room-code-display{display:flex;align-items:center;gap:8px;background:rgba(233,69,96,0.2);padding:6px 14px;border-radius:8px;border:1px solid #e94560;}
        .room-code-display span{font-size:22px;font-weight:900;letter-spacing:5px;color:#e94560;}
        .copy-btn{background:#e94560;color:#fff;border:none;padding:4px 10px;border-radius:5px;cursor:pointer;font-size:11px;}
        .lobby-content{display:flex;flex:1;overflow:hidden;flex-direction:row;}
        .teams-container{display:flex;flex:1;gap:0;}
        .team-panel{flex:1;display:flex;flex-direction:column;padding:10px;}
        .team-red{background:rgba(233,69,96,0.08);border-right:1px solid #333;}
        .team-blue{background:rgba(9,132,227,0.08);}
        .spectator-panel{background:rgba(255,255,255,0.03);border-left:2px solid #333;width:140px;padding:10px;overflow-y:auto;}
        .team-title{font-size:14px;font-weight:700;text-align:center;padding:6px;border-radius:6px;margin-bottom:8px;}
        .team-red .team-title{background:rgba(233,69,96,0.2);color:#e94560;}
        .team-blue .team-title{background:rgba(9,132,227,0.2);color:#0984e3;}
        .spectator-panel .team-title{background:rgba(255,255,255,0.1);color:#888;font-size:12px;}
        .player-list{flex:1;overflow-y:auto;}
        .player-item{display:flex;align-items:center;justify-content:space-between;padding:6px 8px;margin:3px 0;border-radius:6px;background:rgba(255,255,255,0.05);font-size:12px;}
        .player-name{font-weight:600;font-size:13px;}
        .player-admin{font-size:9px;background:#f5a623;color:#000;padding:1px 5px;border-radius:3px;font-weight:700;}
        .admin-move-btn{padding:2px 6px;border:none;border-radius:3px;cursor:pointer;font-size:10px;font-weight:600;margin:0 1px;}
        .move-red{background:#e94560;color:#fff;}
        .move-blue{background:#0984e3;color:#fff;}
        .move-spec{background:#555;color:#fff;}
        .kick-btn{background:#c0392b;color:#fff;}
        .team-join-btn{margin-top:6px;padding:8px;border:none;border-radius:8px;font-weight:700;font-size:13px;cursor:pointer;color:#fff;}
        .join-red-btn{background:linear-gradient(135deg,#e94560,#c0392b);}
        .join-blue-btn{background:linear-gradient(135deg,#0984e3,#6c5ce7);}
        .lobby-footer{display:flex;justify-content:space-between;align-items:center;padding:8px 15px;background:rgba(0,0,0,0.3);border-top:2px solid #333;flex-shrink:0;flex-wrap:wrap;gap:6px;}
        .lobby-footer select{padding:6px 10px;border-radius:6px;border:1px solid #444;background:#2a2a4a;color:#fff;font-size:13px;outline:none;}
        .lobby-footer label{font-size:12px;color:#888;}
        .start-btn{padding:10px 30px;background:linear-gradient(135deg,#00b894,#00cec9);color:#fff;border:none;border-radius:8px;font-size:16px;font-weight:700;cursor:pointer;text-transform:uppercase;letter-spacing:2px;}
        .start-btn:disabled{opacity:0.4;cursor:not-allowed;}
        .leave-btn{padding:8px 16px;background:#c0392b;color:#fff;border:none;border-radius:6px;cursor:pointer;font-weight:600;font-size:13px;}
        .player-count-badge{background:rgba(255,255,255,0.15);padding:1px 6px;border-radius:8px;font-size:11px;color:#aaa;}

        /* GAME */
        #gameScreen{flex-direction:column;align-items:center;justify-content:center;background:#111;position:relative;}
        .game-hud{display:flex;justify-content:center;align-items:center;gap:15px;padding:5px 10px;width:100%;background:rgba(0,0,0,0.6);position:absolute;top:0;z-index:10;pointer-events:none;}
        .hud-score{font-size:clamp(28px,5vw,42px);font-weight:900;}
        .hud-red{color:#e94560;}
        .hud-blue{color:#0984e3;}
        .hud-vs{color:#555;font-size:16px;}
        .hud-time{color:#888;font-size:16px;}
        .admin-game-controls{position:absolute;top:5px;right:10px;z-index:15;display:flex;gap:5px;}
        .admin-game-controls button{padding:6px 12px;border:none;border-radius:5px;cursor:pointer;font-weight:600;font-size:12px;}
        .pause-btn{background:#f5a623;color:#000;}
        .stop-btn{background:#c0392b;color:#fff;}
        .resume-btn{background:#00b894;color:#fff;}
        #gameCanvas{display:block;}
        .game-paused-overlay,.goal-overlay,.game-over-overlay{position:absolute;top:0;left:0;width:100%;height:100%;display:none;align-items:center;justify-content:center;z-index:20;pointer-events:none;flex-direction:column;gap:15px;}
        .game-paused-overlay.active,.goal-overlay.active,.game-over-overlay.active{display:flex;}
        .game-paused-overlay{background:rgba(0,0,0,0.7);z-index:22;}
        .game-over-overlay{background:rgba(0,0,0,0.85);z-index:30;pointer-events:auto;}
        .paused-text{font-size:clamp(28px,6vw,48px);font-weight:900;color:#f5a623;}
        .goal-text{font-size:clamp(40px,10vw,80px);font-weight:900;animation:goalAnim 1.5s ease-out forwards;}
        @keyframes goalAnim{0%{transform:scale(0);opacity:0;}30%{transform:scale(1.3);opacity:1;}100%{transform:scale(1);opacity:0;}}
        .game-over-text{font-size:clamp(24px,5vw,48px);font-weight:900;}
        .back-lobby-btn{padding:12px 24px;background:linear-gradient(135deg,#e94560,#c0392b);color:#fff;border:none;border-radius:8px;font-size:16px;font-weight:700;cursor:pointer;pointer-events:auto;}

        /* JOYSTICK */
        .joystick-zone{position:absolute;bottom:10px;left:10px;z-index:50;width:140px;height:140px;pointer-events:auto;}
        .joystick-base{width:120px;height:120px;border-radius:50%;background:rgba(255,255,255,0.08);border:3px solid rgba(255,255,255,0.15);position:absolute;bottom:10px;left:10px;display:flex;align-items:center;justify-content:center;}
        .joystick-stick{width:50px;height:50px;border-radius:50%;background:rgba(255,255,255,0.3);border:2px solid rgba(255,255,255,0.4);position:absolute;transition:none;pointer-events:none;}

        /* KICK BUTTON */
        .kick-zone{position:absolute;bottom:15px;right:15px;z-index:50;pointer-events:auto;}
        .kick-button{width:80px;height:80px;border-radius:50%;background:rgba(233,69,96,0.5);border:3px solid rgba(233,69,96,0.8);display:flex;align-items:center;justify-content:center;font-size:22px;font-weight:900;color:#fff;user-select:none;-webkit-user-select:none;}
        .kick-button.pressed{background:rgba(233,69,96,0.9);transform:scale(0.92);}

        /* CHAT TOGGLE */
        .chat-toggle-btn{position:absolute;top:5px;left:10px;z-index:15;background:rgba(255,255,255,0.1);border:1px solid #444;color:#fff;padding:5px 10px;border-radius:6px;font-size:12px;cursor:pointer;pointer-events:auto;}
        .mobile-chat{position:absolute;bottom:60px;left:0;width:100%;z-index:40;display:none;flex-direction:column;padding:5px 10px;pointer-events:auto;}
        .mobile-chat.active{display:flex;}
        .chat-messages{max-height:80px;overflow-y:auto;margin-bottom:4px;padding:3px;}
        .chat-msg{font-size:11px;padding:1px 4px;color:#ccc;text-shadow:1px 1px 2px #000;}
        .chat-msg .sender{font-weight:700;}
        .chat-input-row{display:flex;gap:4px;}
        .chat-input-row input{flex:1;padding:6px 8px;border:1px solid #444;border-radius:6px;background:rgba(0,0,0,0.6);color:#fff;font-size:13px;outline:none;}
        .chat-input-row button{padding:6px 12px;background:#e94560;color:#fff;border:none;border-radius:6px;font-size:12px;}

        ::-webkit-scrollbar{width:4px;}
        ::-webkit-scrollbar-track{background:transparent;}
        ::-webkit-scrollbar-thumb{background:#444;border-radius:2px;}

        @media (orientation:portrait){
            .rotate-msg{display:flex !important;}
        }
        .rotate-msg{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:#1a1a2e;z-index:9999;align-items:center;justify-content:center;flex-direction:column;gap:15px;}
        .rotate-msg .icon{font-size:60px;animation:rotatePhone 2s infinite;}
        .rotate-msg p{font-size:18px;color:#aaa;}
        @keyframes rotatePhone{0%,100%{transform:rotate(0deg);}50%{transform:rotate(90deg);}}
    </style>
</head>
<body>

<div class="rotate-msg" id="rotateMsg">
    <div class="icon">üì±</div>
    <p>L√ºtfen ekranƒ± yatay √ßevir</p>
</div>

<!-- MENU -->
<div id="menuScreen" class="screen active">
    <div class="game-title">HAXBALL</div>
    <div class="game-subtitle">Online Multiplayer Football</div>
    <div class="menu-container">
        <input type="text" class="menu-input" id="playerName" placeholder="Oyuncu Adƒ±n..." maxlength="12" autocomplete="off">
        <button class="menu-btn btn-create" id="createRoomBtn">Oda Olu≈ütur</button>
        <div class="menu-divider">‚îÄ‚îÄ‚îÄ veya ‚îÄ‚îÄ‚îÄ</div>
        <div class="join-section">
            <input type="text" class="menu-input" id="roomCodeInput" placeholder="Kod" maxlength="4" inputmode="numeric" autocomplete="off">
            <button class="menu-btn btn-join" id="joinRoomBtn" style="flex-shrink:0;padding:14px 20px;font-size:14px;">Katƒ±l</button>
        </div>
        <div class="error-msg" id="menuError"></div>
    </div>
</div>

<!-- LOBBY -->
<div id="lobbyScreen" class="screen">
    <div class="lobby-header">
        <div class="lobby-title">Lobi</div>
        <div class="room-code-display">
            Kod: <span id="displayRoomCode"></span>
            <button class="copy-btn" id="copyCodeBtn">Kopyala</button>
        </div>
    </div>
    <div class="lobby-content">
        <div class="teams-container">
            <div class="team-panel team-red">
                <div class="team-title">üî¥ KIRMIZI <span class="player-count-badge" id="redCount">0</span></div>
                <div class="player-list" id="redTeamList"></div>
                <button class="team-join-btn join-red-btn" id="joinRedBtn">Kƒ±rmƒ±zƒ±ya Ge√ß</button>
            </div>
            <div class="team-panel team-blue">
                <div class="team-title">üîµ MAVƒ∞ <span class="player-count-badge" id="blueCount">0</span></div>
                <div class="player-list" id="blueTeamList"></div>
                <button class="team-join-btn join-blue-btn" id="joinBlueBtn">Maviye Ge√ß</button>
            </div>
        </div>
        <div class="spectator-panel">
            <div class="team-title">üëÅ ƒ∞zleyici <span class="player-count-badge" id="specCount">0</span></div>
            <div class="player-list" id="specList"></div>
        </div>
    </div>
    <div class="lobby-footer">
        <button class="leave-btn" id="leaveBtn">Ayrƒ±l</button>
        <div style="display:flex;align-items:center;gap:6px;">
            <label>Harita:</label>
            <select id="mapSelect">
                <option value="classic">Klasik</option>
                <option value="big">B√ºy√ºk</option>
                <option value="small">K√º√ß√ºk</option>
                <option value="hockey">Hokey</option>
                <option value="futsal">Futsal</option>
            </select>
        </div>
        <div style="display:flex;align-items:center;gap:6px;">
            <label>Gol:</label>
            <select id="scoreLimitSelect">
                <option value="3">3</option>
                <option value="5">5</option>
                <option value="7">7</option>
                <option value="10">10</option>
                <option value="0">‚àû</option>
            </select>
        </div>
        <button class="start-btn" id="startGameBtn" disabled>BA≈ûLAT</button>
    </div>
</div>

<!-- GAME -->
<div id="gameScreen" class="screen">
    <div class="game-hud">
        <span class="hud-score hud-red" id="hudRedScore">0</span>
        <span class="hud-vs">-</span>
        <span class="hud-score hud-blue" id="hudBlueScore">0</span>
        <span class="hud-time" id="hudTime">0:00</span>
    </div>
    <div class="admin-game-controls" id="adminControls" style="display:none;">
        <button class="pause-btn" id="pauseBtn">‚è∏</button>
        <button class="resume-btn" id="resumeBtn" style="display:none;">‚ñ∂</button>
        <button class="stop-btn" id="stopBtn">‚èπ</button>
    </div>
    <canvas id="gameCanvas"></canvas>

    <div class="game-paused-overlay" id="pausedOverlay"><div class="paused-text">DURAKLATILDI</div></div>
    <div class="goal-overlay" id="goalOverlay"><div class="goal-text" id="goalText">GOL!</div></div>
    <div class="game-over-overlay" id="gameOverOverlay">
        <div class="game-over-text" id="gameOverText"></div>
        <button class="back-lobby-btn" id="backToLobbyBtn">Lobiye D√∂n</button>
    </div>

    <!-- JOYSTICK -->
    <div class="joystick-zone" id="joystickZone">
        <div class="joystick-base" id="joystickBase">
            <div class="joystick-stick" id="joystickStick"></div>
        </div>
    </div>

    <!-- KICK -->
    <div class="kick-zone">
        <div class="kick-button" id="kickButton">≈ûUTTT</div>
    </div>

    <!-- CHAT -->
    <button class="chat-toggle-btn" id="chatToggle">üí¨</button>
    <div class="mobile-chat" id="mobileChat">
        <div class="chat-messages" id="chatMessages"></div>
        <div class="chat-input-row">
            <input type="text" id="chatInput" placeholder="Mesaj..." maxlength="80" autocomplete="off">
            <button id="chatSendBtn">G√∂nder</button>
        </div>
    </div>
</div>

<!-- FIREBASE -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<script>
// ====================== FIREBASE CONFIG ======================
const firebaseConfig = {
    apiKey: "AIzaSyDXgndR3i2p0ovRXVxqGb24d7lMXdTTX9I",
    authDomain: "mobilgame1-f03ac.firebaseapp.com",
    databaseURL: "https://mobilgame1-f03ac-default-rtdb.europe-west1.firebasedatabase.app",
    projectId: "mobilgame1-f03ac",
    storageBucket: "mobilgame1-f03ac.firebasestorage.app",
    messagingSenderId: "123456",
    appId: "1:188464433527:web:baed82070bfed9652df972"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

// ====================== STATE ======================
let myId = genId();
let myName = '';
let currentRoom = null;
let isAdmin = false;
let roomRef = null;
let listeners = [];
let canvas, ctx;
let gameLoop = null;
let renderLoop = null;
let nonAdminInterval = null;
let localState = null;

// Joystick
let joystickInput = { dx: 0, dy: 0 };
let kicking = false;
let joystickActive = false;
let joystickTouchId = null;

// Maps
const MAPS = {
    classic: { w: 840, h: 400, gs: 90, name: "Klasik" },
    big: { w: 1000, h: 500, gs: 110, name: "B√ºy√ºk" },
    small: { w: 640, h: 320, gs: 80, name: "K√º√ß√ºk" },
    hockey: { w: 840, h: 400, gs: 100, name: "Hokey" },
    futsal: { w: 700, h: 360, gs: 85, name: "Futsal" }
};

const BR = 8;     // ball radius
const PR = 15;    // player radius
const BF = 0.985; // ball friction
const PF = 0.92;  // player friction
const PS = 3.5;   // player speed
const KF = 12;    // kick force
const GD = 30;    // goal depth

// ====================== UTIL ======================
function genId(){ return Math.random().toString(36).substr(2,9)+Date.now().toString(36); }
function genCode(){ return Math.floor(1000+Math.random()*9000).toString(); }
function showScreen(id){ document.querySelectorAll('.screen').forEach(s=>s.classList.remove('active')); document.getElementById(id).classList.add('active'); }
function showErr(m){ const e=document.getElementById('menuError'); e.textContent=m; setTimeout(()=>e.textContent='',3000); }
function dist(a,b){ return Math.sqrt((a.x-b.x)**2+(a.y-b.y)**2); }

// ====================== ORIENTATION CHECK ======================
function checkOrientation(){
    const rm = document.getElementById('rotateMsg');
    if(window.innerHeight > window.innerWidth){ rm.style.display='flex'; }
    else { rm.style.display='none'; }
}
window.addEventListener('resize', checkOrientation);
window.addEventListener('orientationchange', ()=> setTimeout(checkOrientation,200));
checkOrientation();

// ====================== MENU ======================
document.getElementById('createRoomBtn').addEventListener('click', createRoom);
document.getElementById('joinRoomBtn').addEventListener('click', joinRoom);
document.getElementById('roomCodeInput').addEventListener('input', function(){ this.value=this.value.replace(/[^0-9]/g,''); });

async function createRoom(){
    myName = document.getElementById('playerName').value.trim();
    if(!myName){ showErr('ƒ∞sim gir!'); return; }
    if(myName.length<2){ showErr('ƒ∞sim en az 2 harf!'); return; }
    let code = genCode();
    let snap = await db.ref('rooms/'+code).once('value');
    while(snap.exists()){ code=genCode(); snap=await db.ref('rooms/'+code).once('value'); }
    const room = { code, admin:myId, state:'lobby', map:'classic', scoreLimit:3, redScore:0, blueScore:0, gameTime:0, created:firebase.database.ServerValue.TIMESTAMP, players:{}, ball:null, chat:{} };
    room.players[myId] = { id:myId, name:myName, team:'spectator', x:0, y:0, vx:0, vy:0, online:true };
    await db.ref('rooms/'+code).set(room);
    currentRoom=code; isAdmin=true;
    enterLobby();
}

async function joinRoom(){
    myName = document.getElementById('playerName').value.trim();
    if(!myName){ showErr('ƒ∞sim gir!'); return; }
    const code = document.getElementById('roomCodeInput').value.trim();
    if(code.length!==4){ showErr('4 haneli kod gir!'); return; }
    const snap = await db.ref('rooms/'+code).once('value');
    if(!snap.exi
