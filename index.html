<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<title>HaxBall Mobile Clone</title>
<style>
*{margin:0;padding:0;box-sizing:border-box;-webkit-touch-callout:none;-webkit-user-select:none;user-select:none;-webkit-tap-highlight-color:transparent;}
html,body{width:100%;height:100%;overflow:hidden;background:#0a0a1a;font-family:'Segoe UI',Arial,sans-serif;touch-action:none;position:fixed;top:0;left:0;}

/* MENU SCREEN */
#menuScreen{position:absolute;top:0;left:0;width:100%;height:100%;display:flex;flex-direction:column;align-items:center;justify-content:center;background:linear-gradient(135deg,#0f0c29,#302b63,#24243e);z-index:100;overflow-y:auto;}
#menuScreen h1{color:#fff;font-size:28px;margin-bottom:4px;text-shadow:0 0 30px rgba(255,200,0,0.3);}
#menuScreen h1 .ball-icon{display:inline-block;animation:spinBall 2s linear infinite;}
@keyframes spinBall{0%{transform:rotate(0deg);}100%{transform:rotate(360deg);}}
#menuScreen .subtitle{color:#888;font-size:13px;margin-bottom:24px;}
#menuScreen .menu-box{background:rgba(255,255,255,0.06);border-radius:16px;padding:20px;width:300px;max-width:88vw;backdrop-filter:blur(12px);border:1px solid rgba(255,255,255,0.08);}
#menuScreen input{width:100%;padding:11px 14px;margin-bottom:10px;border:1px solid rgba(255,255,255,0.12);border-radius:10px;background:rgba(255,255,255,0.05);color:#fff;font-size:14px;outline:none;transition:border 0.3s;}
#menuScreen input:focus{border-color:rgba(255,255,255,0.35);}
#menuScreen input::placeholder{color:rgba(255,255,255,0.3);}
.btn{padding:12px 20px;border:none;border-radius:10px;font-size:15px;font-weight:600;cursor:pointer;transition:all 0.2s;letter-spacing:0.3px;text-align:center;}
.btn:active{transform:scale(0.97);}
.btn-full{width:100%;margin-bottom:8px;}
.btn-create{background:linear-gradient(135deg,#e74c3c,#c0392b);color:#fff;}
.btn-join{background:linear-gradient(135deg,#3498db,#2980b9);color:#fff;}
.btn-green{background:linear-gradient(135deg,#27ae60,#1e8449);color:#fff;}
.btn-gray{background:rgba(255,255,255,0.1);color:#ccc;border:1px solid rgba(255,255,255,0.1);}
.btn-orange{background:linear-gradient(135deg,#f39c12,#e67e22);color:#fff;}
.btn-leave{background:linear-gradient(135deg,#e74c3c,#c0392b);color:#fff;}
.divider{display:flex;align-items:center;margin:14px 0;color:rgba(255,255,255,0.25);font-size:12px;}
.divider::before,.divider::after{content:'';flex:1;height:1px;background:rgba(255,255,255,0.1);}
.divider::before{margin-right:10px;}
.divider::after{margin-left:10px;}

/* LOBBY SCREEN */
#lobbyScreen{position:absolute;top:0;left:0;width:100%;height:100%;display:none;flex-direction:column;align-items:center;background:linear-gradient(135deg,#0f0c29,#302b63,#24243e);z-index:90;overflow-y:auto;padding:16px;}
#lobbyScreen h2{color:#fff;font-size:22px;margin-bottom:2px;}
.room-code-display{color:#f39c12;font-size:16px;margin-bottom:16px;font-weight:700;background:rgba(243,156,18,0.1);padding:6px 16px;border-radius:8px;border:1px solid rgba(243,156,18,0.2);}
.lobby-container{display:flex;gap:12px;width:94%;max-width:850px;flex-wrap:wrap;justify-content:center;}
.team-panel{background:rgba(255,255,255,0.04);border-radius:12px;padding:12px;min-width:180px;flex:1;border:1px solid rgba(255,255,255,0.06);min-height:120px;}
.team-panel h3{text-align:center;margin-bottom:10px;font-size:14px;padding-bottom:6px;border-bottom:1px solid rgba(255,255,255,0.08);}
.team-red h3{color:#e74c3c;}
.team-blue h3{color:#3498db;}
.team-spec h3{color:#888;}
.player-item{display:flex;align-items:center;justify-content:space-between;padding:6px 10px;margin-bottom:4px;border-radius:6px;background:rgba(255,255,255,0.04);color:#fff;font-size:13px;}
.player-item .pname{display:flex;align-items:center;gap:6px;}
.host-badge{background:#f39c12;color:#000;font-size:9px;padding:1px 5px;border-radius:3px;font-weight:700;}
.admin-btns{display:flex;gap:3px;}
.admin-btns button{padding:3px 6px;font-size:10px;border:none;border-radius:3px;cursor:pointer;font-weight:600;}
.to-red{background:#e74c3c;color:#fff;}
.to-blue{background:#3498db;color:#fff;}
.to-spec{background:#555;color:#fff;}
.lobby-bottom{margin-top:16px;display:flex;gap:8px;flex-wrap:wrap;justify-content:center;}
.lobby-bottom .btn{padding:10px 22px;font-size:13px;}

/* GAME SCREEN */
#gameScreen{position:absolute;top:0;left:0;width:100%;height:100%;display:none;z-index:80;background:#1a472a;}
#gameCanvas{display:block;width:100%;height:100%;}

/* HUD */
#gameHUD{position:absolute;top:0;left:50%;transform:translateX(-50%);display:flex;align-items:stretch;z-index:85;pointer-events:none;border-radius:0 0 10px 10px;overflow:hidden;box-shadow:0 2px 10px rgba(0,0,0,0.4);}
.hud-team{padding:6px 18px;font-size:26px;font-weight:800;color:#fff;min-width:50px;text-align:center;display:flex;align-items:center;justify-content:center;}
.hud-red{background:rgba(192,57,43,0.9);}
.hud-blue{background:rgba(41,128,185,0.9);}
.hud-mid{background:rgba(0,0,0,0.75);padding:4px 14px;display:flex;flex-direction:column;align-items:center;justify-content:center;}
.hud-time{color:#fff;font-size:16px;font-weight:700;font-variant-numeric:tabular-nums;}
.hud-status{color:#f39c12;font-size:9px;font-weight:600;text-transform:uppercase;margin-top:1px;}

/* MOBILE CONTROLS */
#kickBtn{position:absolute;bottom:24px;right:24px;width:76px;height:76px;border-radius:50%;background:rgba(255,255,255,0.1);border:3px solid rgba(255,255,255,0.3);z-index:86;display:flex;align-items:center;justify-content:center;color:rgba(255,255,255,0.8);font-size:12px;font-weight:700;backdrop-filter:blur(4px);touch-action:none;pointer-events:auto;transition:transform 0.1s,background 0.1s;}
#kickBtn.active{background:rgba(255,255,255,0.35);border-color:#fff;transform:scale(1.08);}
#joystickZone{position:absolute;bottom:0;left:0;width:45%;height:60%;z-index:86;touch-action:none;pointer-events:auto;}
#joyBase{position:absolute;width:110px;height:110px;border-radius:50%;background:rgba(255,255,255,0.06);border:2px solid rgba(255,255,255,0.1);pointer-events:none;display:none;}
#joyThumb{position:absolute;width:46px;height:46px;border-radius:50%;background:rgba(255,255,255,0.2);border:2px solid rgba(255,255,255,0.4);pointer-events:none;display:none;}

/* ADMIN PANEL */
#adminPanel{position:absolute;top:44px;right:8px;z-index:88;display:none;pointer-events:auto;}
#adminToggle{background:rgba(243,156,18,0.85);color:#000;border:none;padding:7px 10px;border-radius:7px;font-weight:700;font-size:11px;cursor:pointer;}
#adminMenu{display:none;background:rgba(0,0,0,0.88);border-radius:8px;padding:8px;margin-top:4px;min-width:130px;backdrop-filter:blur(10px);border:1px solid rgba(255,255,255,0.08);}
#adminMenu button{display:block;width:100%;padding:9px;margin-bottom:4px;border:none;border-radius:5px;font-size:11px;font-weight:600;cursor:pointer;color:#fff;}
#adminMenu button:last-child{margin-bottom:0;}
.abtn-pause{background:#f39c12;}
.abtn-reset{background:#e74c3c;}
.abtn-lobby{background:#3498db;}

/* GOAL OVERLAY */
#goalOverlay{position:absolute;top:0;left:0;width:100%;height:100%;display:none;align-items:center;justify-content:center;z-index:89;pointer-events:none;background:rgba(0,0,0,0.25);}
.goal-text{font-size:52px;font-weight:900;color:#fff;text-shadow:0 0 40px rgba(255,255,255,0.4),0 4px 20px rgba(0,0,0,0.5);animation:goalPop 0.4s cubic-bezier(0.175,0.885,0.32,1.275);}
@keyframes goalPop{0%{transform:scale(0.2);opacity:0;}100%{transform:scale(1);opacity:1;}}

/* MAP SELECT */
.map-select{margin:10px 0;}
.map-select label{color:#aaa;font-size:12px;display:block;margin-bottom:4px;}
.map-select select{width:100%;padding:9px 12px;border:1px solid rgba(255,255,255,0.12);border-radius:8px;background:rgba(255,255,255,0.05);color:#fff;font-size:13px;outline:none;-webkit-appearance:none;}

/* TOAST */
#toast{position:fixed;bottom:70px;left:50%;transform:translateX(-50%);background:rgba(0,0,0,0.85);color:#fff;padding:8px 18px;border-radius:20px;font-size:12px;z-index:9998;display:none;white-space:nowrap;backdrop-filter:blur(6px);}

/* ROTATE MESSAGE */
#rotateMsg{position:fixed;top:0;left:0;width:100%;height:100%;background:#0a0a1a;z-index:9999;display:none;align-items:center;justify-content:center;flex-direction:column;color:#fff;gap:12px;}
@media(max-width:600px) and (orientation:portrait){
#rotateMsg{display:flex!important;}
}
.rotate-icon{width:50px;height:50px;animation:rotAnim 2s ease-in-out infinite;}
@keyframes rotAnim{0%,100%{transform:rotate(0deg);}50%{transform:rotate(90deg);}}

.hidden{display:none!important;}
</style>
</head>
<body>

<div id="rotateMsg">
<svg class="rotate-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="4" y="2" width="16" height="20" rx="2"/><circle cx="12" cy="18" r="1"/></svg>
<p style="font-size:14px;">L√ºtfen ekranƒ± yatay √ßevirin</p>
</div>

<div id="menuScreen">
<h1><span class="ball-icon">‚öΩ</span> HaxBall Mobile</h1>
<p class="subtitle">Ger√ßek Zamanlƒ± √áok Oyunculu Futbol</p>
<div class="menu-box">
<input type="text" id="playerName" placeholder="Oyuncu Adƒ±n" maxlength="12">
<div class="divider">YENƒ∞ ODA OLU≈ûTUR</div>
<div class="map-select">
<label>Harita Se√ßimi</label>
<select id="mapSelect">
<option value="classic">Klasik Saha</option>
<option value="big">B√ºy√ºk Saha</option>
<option value="small">Mini Saha</option>
<option value="hockey">Buz Hokeyi</option>
<option value="futsal">Futsal</option>
</select>
</div>
<input type="text" id="roomPassword" placeholder="Oda ≈ûifresi (opsiyonel)" maxlength="20">
<button class="btn btn-full btn-create" id="btnCreate">üèüÔ∏è Oda Kur</button>
<div class="divider">ODAYA KATIL</div>
<input type="text" id="roomCodeInput" placeholder="Oda Kodu (5 harf)" maxlength="6" style="text-transform:uppercase;">
<input type="text" id="joinPassword" placeholder="≈ûifre (varsa)" maxlength="20">
<button class="btn btn-full btn-join" id="btnJoin">üöÄ Katƒ±l</button>
</div>
</div>

<div id="lobbyScreen">
<h2>üèüÔ∏è Oyun Lobisi</h2>
<div class="room-code-display" id="lobbyRoomCode">Oda: ---</div>
<div id="lobbyMapInfo" style="color:#aaa;font-size:12px;margin-bottom:12px;"></div>
<div class="lobby-container">
<div class="team-panel team-red" id="panelRed"><h3>üî¥ Kƒ±rmƒ±zƒ± Takƒ±m</h3><div id="listRed"></div></div>
<div class="team-panel team-spec" id="panelSpec"><h3>üëÅÔ∏è ƒ∞zleyiciler</h3><div id="listSpec"></div></div>
<div class="team-panel team-blue" id="panelBlue"><h3>üîµ Mavi Takƒ±m</h3><div id="listBlue"></div></div>
</div>
<div class="lobby-bottom">
<button class="btn btn-create" id="btnJoinRed">üî¥ Kƒ±rmƒ±zƒ±</button>
<button class="btn btn-gray" id="btnJoinSpec">üëÅÔ∏è ƒ∞zleyici</button>
<button class="btn btn-join" id="btnJoinBlue">üîµ Mavi</button>
<button class="btn btn-green hidden" id="btnStartGame">üöÄ Ma√ßƒ± Ba≈ülat</button>
<button class="btn btn-leave" id="btnLeave">üö™ Ayrƒ±l</button>
</div>
</div>

<div id="gameScreen">
<canvas id="gameCanvas"></canvas>
<div id="gameHUD">
<div class="hud-team hud-red" id="hudRedScore">0</div>
<div class="hud-mid">
<div class="hud-time" id="hudTime">0:00</div>
<div class="hud-status" id="hudStatus"></div>
</div>
<div class="hud-team hud-blue" id="hudBlueScore">0</div>
</div>
<div id="joystickZone"></div>
<div id="joyBase"></div>
<div id="joyThumb"></div>
<div id="kickBtn">VURU≈û</div>
<div id="adminPanel">
<button id="adminToggle">‚öôÔ∏è Admin</button>
<div id="adminMenu">
<button class="abtn-pause" id="abtnPause">‚è∏ Duraklat</button>
<button class="abtn-reset" id="abtnReset">üîÑ Skor Sƒ±fƒ±rla</button>
<button class="abtn-lobby" id="abtnLobby">üîô Lobiye D√∂n</button>
</div>
</div>
<div id="goalOverlay"><div class="goal-text" id="goalText">GOL!</div></div>
</div>

<div id="toast"></div>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
<script>
(function(){
"use strict";

// =============================================
// FIREBASE INIT
// =============================================
const firebaseConfig = {
    apiKey: "AIzaSyDXgndR3i2p0ovRXVxqGb24d7lMXdTTX9I",
    authDomain: "mobilgame1-f03ac.firebaseapp.com",
    databaseURL: "https://mobilgame1-f03ac-default-rtdb.europe-west1.firebasedatabase.app",
    projectId: "mobilgame1-f03ac",
    storageBucket: "mobilgame1-f03ac.firebasestorage.app",
    messagingSenderId: "188464433527",
    appId: "1:188464433527:web:baed82070bfed9652df972"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

// =============================================
// UTILITIES
// =============================================
function genId(){ return Math.random().toString(36).substr(2,10); }
function genRoomCode(){
    const c='ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
    let s='';for(let i=0;i<5;i++)s+=c[Math.floor(Math.random()*c.length)];return s;
}
function showToast(msg,dur){
    dur=dur||2200;
    const t=document.getElementById('toast');
    t.textContent=msg;t.style.display='block';
    clearTimeout(t._t);t._t=setTimeout(()=>{t.style.display='none';},dur);
}
function lerp(a,b,t){return a+(b-a)*t;}
function dist(x1,y1,x2,y2){const dx=x2-x1,dy=y2-y1;return Math.sqrt(dx*dx+dy*dy);}
function clamp(v,mn,mx){return Math.max(mn,Math.min(mx,v));}
function normalize(x,y){const l=Math.sqrt(x*x+y*y);if(l<0.001)return{x:0,y:0};return{x:x/l,y:y/l};}

// =============================================
// MAP DEFINITIONS
// =============================================
const MAPS = {
    classic: {
        name: 'Klasik Saha',
        fieldW: 1200, fieldH: 600,
        goalH: 150, goalD: 55,
        bgColor: '#2d7a2d', lineColor: 'rgba(255,255,255,0.55)',
        floorColor: '#3a8c3a', floorColor2: '#358535',
        centerR: 85, penaltyW: 130, penaltyH: 270,
        friction: 0.985, playerFriction: 0.92
    },
    big: {
        name: 'B√ºy√ºk Saha',
        fieldW: 1500, fieldH: 750,
        goalH: 180, goalD: 60,
        bgColor: '#1a5c1a', lineColor: 'rgba(255,255,255,0.5)',
        floorColor: '#2a7a2a', floorColor2: '#257225',
        centerR: 100, penaltyW: 150, penaltyH: 300,
        friction: 0.987, playerFriction: 0.93
    },
    small: {
        name: 'Mini Saha',
        fieldW: 900, fieldH: 450,
        goalH: 120, goalD: 45,
        bgColor: '#2d6b2d', lineColor: 'rgba(255,255,255,0.5)',
        floorColor: '#3a8530', floorColor2: '#358028',
        centerR: 65, penaltyW: 100, penaltyH: 200,
        friction: 0.983, playerFriction: 0.91
    },
    hockey: {
        name: 'Buz Hokeyi',
        fieldW: 1100, fieldH: 500,
        goalH: 130, goalD: 50,
        bgColor: '#1a3a5c', lineColor: 'rgba(255,255,255,0.6)',
        floorColor: '#2a5a8a', floorColor2: '#255580',
        centerR: 75, penaltyW: 120, penaltyH: 240,
        friction: 0.994, playerFriction: 0.96
    },
    futsal: {
        name: 'Futsal',
        fieldW: 1000, fieldH: 520,
        goalH: 135, goalD: 48,
        bgColor: '#8B6914', lineColor: 'rgba(255,255,255,0.6)',
        floorColor: '#A07828', floorColor2: '#957020',
        centerR: 70, penaltyW: 110, penaltyH: 230,
        friction: 0.982, playerFriction: 0.90
    }
};

// =============================================
// PHYSICS CONSTANTS
// =============================================
const FIELD_MARGIN = 70;
const PLAYER_RADIUS = 19;
const BALL_RADIUS = 11;
const KICK_RADIUS = 36;
const KICK_FORCE = 5.5;
const PLAYER_ACCEL = 0.32;
const PLAYER_MAX_SPEED = 3.2;
const BALL_MAX_SPEED = 11;
const BOUNCE_DAMP = 0.65;
const PLAYER_BOUNCE_DAMP = 0.3;
const PUSH_FORCE = 0.4;
const MATCH_TIME = 180;
const NET_SEND_INTERVAL = 40;
const GOAL_RESET_DELAY = 1800;
const POST_RADIUS = 6;

// =============================================
// GAME STATE VARIABLES
// =============================================
let myId = genId();
let myName = '';
let roomCode = '';
let roomRef = null;
let isHost = false;
let gameState = 'menu';
let roomData = null;
let currentMap = MAPS.classic;
let currentMapKey = 'classic';

let localPlayers = {};
let localBall = {x:0,y:0,vx:0,vy:0};
let matchTime = 0;
let matchRunning = false;
let matchPaused = false;
let goalScored = false;
let goalResetTimer = 0;
let lastNetSend = 0;
let redScore = 0;
let blueScore = 0;

let myInput = {dx:0,dy:0,kick:false};
let joyTouchId = null;
let joyActive = false;
let joyStartX = 0;
let joyStartY = 0;
let kickTouchId = null;
let keysDown = {};

let canvas, ctx;
let canvasW = 0, canvasH = 0;
let scale = 1, offsetX = 0, offsetY = 0;
let animId = null;
let lastFrameTime = 0;
let accumulator = 0;
const FIXED_DT = 1000/60;

let roomListener = null;
let inputListener = null;
let adminMenuOpen = false;
let hasUserGesture = false;

// DOM
const $=id=>document.getElementById(id);
const menuScreen=$('menuScreen');
const lobbyScreen=$('lobbyScreen');
const gameScreen=$('gameScreen');
const playerNameInput=$('playerName');
const roomPasswordInput=$('roomPassword');
const roomCodeInputEl=$('roomCodeInput');
const joinPasswordInput=$('joinPassword');
const mapSelectEl=$('mapSelect');
const lobbyRoomCodeEl=$('lobbyRoomCode');
const lobbyMapInfo=$('lobbyMapInfo');
const listRed=$('listRed');
const listBlue=$('listBlue');
const listSpec=$('listSpec');
const btnStartGame=$('btnStartGame');
const hudRedScore=$('hudRedScore');
const hudBlueScore=$('hudBlueScore');
const hudTime=$('hudTime');
const hudStatus=$('hudStatus');
const kickBtnEl=$('kickBtn');
const joyZone=$('joystickZone');
const joyBaseEl=$('joyBase');
const joyThumbEl=$('joyThumb');
const adminPanel=$('adminPanel');
const adminToggleEl=$('adminToggle');
const adminMenuEl=$('adminMenu');
const goalOverlay=$('goalOverlay');
const goalTextEl=$('goalText');

canvas=$('gameCanvas');
ctx=canvas.getContext('2d');

// =============================================
// SCREEN MANAGEMENT
// =============================================
function showScreen(s){
    menuScreen.style.display='none';
    lobbyScreen.style.display='none';
    gameScreen.style.display='none';
    if(s==='menu'){menuScreen.style.display='flex';gameState='menu';stopLoop();}
    else if(s==='lobby'){lobbyScreen.style.display='flex';gameState='lobby';stopLoop();}
    else if(s==='game'){gameScreen.style.display='block';gameState='game';resizeCanvas();startLoop();}
}

// =============================================
// CANVAS RESIZE
// =============================================
function resizeCanvas(){
    canvasW=window.innerWidth;
    canvasH=window.innerHeight;
    canvas.width=canvasW;
    canvas.height=canvasH;
    const totalW=currentMap.fieldW+FIELD_MARGIN*2;
    const totalH=currentMap.fieldH+FIELD_MARGIN*2;
    const sx=canvasW/totalW;
    const sy=canvasH/totalH;
    scale=Math.min(sx,sy);
    offsetX=(canvasW-totalW*scale)/2;
    offsetY=(canvasH-totalH*scale)/2;
}
window.addEventListener('resize',()=>{if(gameState==='game')resizeCanvas();});

function worldToScreen(x,y){return{x:offsetX+(x+FIELD_MARGIN)*scale,y:offsetY+(y+FIELD_MARGIN)*scale};}

// =============================================
// FULLSCREEN (only on user gesture)
// =============================================
function tryFullscreen(){
    if(!hasUserGesture)return;
    try{
        const el=document.documentElement;
        if(!document.fullscreenElement&&!document.webkitFullscreenElement){
            if(el.requestFullscreen)el.requestFullscreen().catch(()=>{});
            else if(el.webkitRequestFullscreen)el.webkitRequestFullscreen();
        }
        if(screen.orientation&&screen.orientation.lock){
            screen.orientation.lock('landscape').catch(()=>{});
        }
    }catch(e){}
}

function onUserGesture(){
    hasUserGesture=true;
    if(gameState==='game')tryFullscreen();
}

document.addEventListener('click',onUserGesture,{passive:true});
document.addEventListener('touchstart',onUserGesture,{passive:true,once:false});
document.addEventListener('contextmenu',e=>e.preventDefault());

// =============================================
// ROOM CREATION
// =============================================
$('btnCreate').addEventListener('click',async()=>{
    myName=playerNameInput.value.trim()||('P'+myId.substr(0,4));
    if(myName.length>12)myName=myName.substr(0,12);
    const pwd=roomPasswordInput.value.trim();
    currentMapKey=mapSelectEl.value;
    currentMap=MAPS[currentMapKey]||MAPS.classic;
    roomCode=genRoomCode();

    const initData={
        code:roomCode,
        password:pwd,
        hostId:myId,
        state:'lobby',
        mapKey:currentMapKey,
        createdAt:firebase.database.ServerValue.TIMESTAMP,
        players:{},
        match:{redScore:0,blueScore:0,time:0,running:false,paused:false,
            ball:{x:currentMap.fieldW/2,y:currentMap.fieldH/2,vx:0,vy:0}}
    };
    initData.players[myId]={
        name:myName,team:'spectator',
        x:currentMap.fieldW/2,y:currentMap.fieldH/2,
        vx:0,vy:0,kick:false,
        idx:0,idy:0,ik:false,online:true
    };

    roomRef=db.ref('rooms/'+roomCode);
    try{
        await roomRef.set(initData);
        isHost=true;
        setupListeners();
        setupDisconnect();
        showScreen('lobby');
        lobbyRoomCodeEl.textContent='Oda: '+roomCode;
        lobbyMapInfo.textContent='Harita: '+currentMap.name;
        showToast('Oda kuruldu! Kod: '+roomCode);
    }catch(e){showToast('Hata: '+e.message);}
});

// =============================================
// JOIN ROOM
// =============================================
$('btnJoin').addEventListener('click',async()=>{
    myName=playerNameInput.value.trim()||('P'+myId.substr(0,4));
    if(myName.length>12)myName=myName.substr(0,12);
    const code=roomCodeInputEl.value.trim().toUpperCase();
    const pwd=joinPasswordInput.value.trim();
    if(!code||code.length<3){showToast('Oda kodu girin!');return;}

    const ref=db.ref('rooms/'+code);
    try{
        const snap=await ref.once('value');
        if(!snap.exists()){showToast('Oda bulunamadƒ±!');return;}
        const data=snap.val();
        if(data.password&&data.password!==pwd){showToast('Yanlƒ±≈ü ≈üifre!');return;}

        roomCode=code;
        roomRef=ref;
        isHost=false;
        currentMapKey=data.mapKey||'classic';
        currentMap=MAPS[currentMapKey]||MAPS.classic;

        const pData={
            name:myName,team:'spectator',
            x:currentMap.fieldW/2,y:currentMap.fieldH/2,
            vx:0,vy:0,kick:false,
            idx:0,idy:0,ik:false,online:true
        };
        await roomRef.child('players/'+myId).set(pData);
        setupListeners();
        setupDisconnect();
        showScreen('lobby');
        lobbyRoomCodeEl.textContent='Oda: '+roomCode;
        lobbyMapInfo.textContent='Harita: '+currentMap.name;
        showToast('Odaya katƒ±ldƒ±n!');
    }catch(e){showToast('Hata: '+e.message);}
});

// =============================================
// DISCONNECT HANDLER
// =============================================
function setupDisconnect(){
    if(!roomRef)return;
    roomRef.child('players/'+myId).onDisconnect().update({online:false});
}

// =============================================
// ROOM LISTENERS
// =============================================
function setupListeners(){
    if(roomListener&&roomRef)roomRef.off('value',roomListener);

    roomListener=roomRef.on('value',snap=>{
        if(!snap.exists()){
            showToast('Oda kapandƒ±!');
            cleanup();showScreen('menu');return;
        }
        roomData=snap.val();

        // Host migration
        if(roomData.hostId&&roomData.players){
            const hostP=roomData.players[roomData.hostId];
            if(!hostP||hostP.online===false){
                const online=Object.keys(roomData.players).filter(p=>roomData.players[p].online!==false);
                if(online.length>0&&online[0]===myId){
                    isHost=true;
                    roomRef.update({hostId:myId});
                    showToast('Sen yeni hostsun!');
                }
            }
        }
        isHost=(roomData.hostId===myId);

        // Map sync
        if(roomData.mapKey&&MAPS[roomData.mapKey]){
            currentMapKey=roomData.mapKey;
            currentMap=MAPS[currentMapKey];
        }

        if(gameState==='lobby'){
            updateLobbyUI();
            if(roomData.state==='playing'){
                initGame();showScreen('game');
            }
        }else if(gameState==='game'){
            if(roomData.state==='lobby'){
                stopLoop();showScreen('lobby');return;
            }
            // Client state sync
            if(!isHost){
                syncClientState();
            }
            // Score sync
            if(roomData.match){
                redScore=roomData.match.redScore||0;
                blueScore=roomData.match.blueScore||0;
            }
        }
    });

    // If host, also listen to player inputs specifically
    if(isHost){
        setupInputListeners();
    }
}

function setupInputListeners(){
    // Host reads all player inputs in the main listener above
}

// =============================================
// LOBBY UI
// =============================================
function updateLobbyUI(){
    if(!roomData||!roomData.players)return;
    listRed.innerHTML='';listBlue.innerHTML='';listSpec.innerHTML='';
    const ps=roomData.players;
    for(const pid in ps){
        const p=ps[pid];
        if(p.online===false)continue;
        const div=document.createElement('div');
        div.className='player-item';
        let badge=pid===roomData.hostId?'<span class="host-badge">HOST</span>':'';
        let admBtns='';
        if(isHost&&pid!==myId){
            admBtns=`<div class="admin-btns">
                <button class="to-red" data-pid="${pid}" data-team="red">K</button>
                <button class="to-blue" data-pid="${pid}" data-team="blue">M</button>
                <button class="to-spec" data-pid="${pid}" data-team="spectator">ƒ∞</button>
            </div>`;
        }
        div.innerHTML=`<span class="pname">${badge} ${p.name||'?'}</span>${admBtns}`;
        if(p.team==='red')listRed.appendChild(div);
        else if(p.team==='blue')listBlue.appendChild(div);
        else listSpec.appendChild(div);
    }
    // Admin move buttons
    document.querySelectorAll('.admin-btns button').forEach(btn=>{
        btn.addEventListener('click',()=>{
            const pid=btn.getAttribute('data-pid');
            const team=btn.getAttribute('data-team');
            if(isHost&&roomRef)roomRef.child('players/'+pid).update({team:team});
        });
    });
    btnStartGame.classList.toggle('hidden',!isHost);
    lobbyMapInfo.textContent='Harita: '+currentMap.name;
}

// =============================================
// LOBBY BUTTONS
// =============================================
$('btnJoinRed').addEventListener('click',()=>{if(roomRef)roomRef.child('players/'+myId).update({team:'red'});});
$('btnJoinBlue').addEventListener('click',()=>{if(roomRef)roomRef.child('players/'+myId).update({team:'blue'});});
$('btnJoinSpec').addEventListener('click',()=>{if(roomRef)roomRef.child('players/'+myId).update({team:'spectator'});});
$('btnLeave').addEventListener('click',()=>{cleanup();showScreen('menu');});

btnStartGame.addEventListener('click',()=>{
    if(!isHost||!roomRef||!roomData)return;
    const ps=roomData.players;
    let rc=0,bc=0;
    for(const pid in ps){if(ps[pid].online===false)continue;if(ps[pid].team==='red')rc++;if(ps[pid].team==='blue')bc++;}
    if(rc===0||bc===0){showToast('Her takƒ±mda en az 1 oyuncu lazƒ±m!');return;}

    const ups={};
    let ri=0,bi=0;
    for(const pid in ps){
        if(ps[pid].online===false)continue;
        if(ps[pid].team==='red'){
            const pos=startPos('red',ri,rc);
            ups['players/'+pid+'/x']=pos.x;ups['players/'+pid+'/y']=pos.y;
            ups['players/'+pid+'/vx']=0;ups['players/'+pid+'/vy']=0;
            ri++;
        }else if(ps[pid].team==='blue'){
            const pos=startPos('blue',bi,bc);
            ups['players/'+pid+'/x']=pos.x;ups['players/'+pid+'/y']=pos.y;
            ups['players/'+pid+'/vx']=0;ups['players/'+pid+'/vy']=0;
            bi++;
        }
    }
    ups['state']='playing';
    ups['match/redScore']=0;ups['match/blueScore']=0;
    ups['match/time']=0;ups['match/running']=true;ups['match/paused']=false;
    ups['match/ball']={x:currentMap.fieldW/2,y:currentMap.fieldH/2,vx:0,vy:0};
    roomRef.update(ups);
});

function startPos(team,idx,total){
    const FW=currentMap.fieldW,FH=currentMap.fieldH;
    const cx=team==='red'?FW*0.25:FW*0.75;
    const sp=Math.min(70,(FH-80)/Math.max(total,1));
    const sy=FH/2-(total-1)*sp/2;
    return{x:cx,y:sy+idx*sp};
}

// =============================================
// INIT GAME
// =============================================
function initGame(){
    if(!roomData)return;
    localPlayers={};
    if(roomData.players){
        for(const pid in roomData.players){
            const p=roomData.players[pid];
            if(p.online===false)continue;
            localPlayers[pid]={
                name:p.name,team:p.team,
                x:p.x||currentMap.fieldW/2,y:p.y||currentMap.fieldH/2,
                vx:p.vx||0,vy:p.vy||0,
                kick:false,kickTimer:0,
                idx:0,idy:0,ik:false,
                prevX:p.x||currentMap.fieldW/2,prevY:p.y||currentMap.fieldH/2
            };
        }
    }
    const b=(roomData.match&&roomData.match.ball)||{};
    localBall={x:b.x||currentMap.fieldW/2,y:b.y||currentMap.fieldH/2,vx:b.vx||0,vy:b.vy||0};
    matchTime=(roomData.match&&roomData.match.time)||0;
    matchRunning=(roomData.match&&roomData.match.running)||false;
    matchPaused=(roomData.match&&roomData.match.paused)||false;
    redScore=(roomData.match&&roomData.match.redScore)||0;
    blueScore=(roomData.match&&roomData.match.blueScore)||0;
    goalScored=false;goalResetTimer=0;lastNetSend=0;
    adminPanel.style.display=isHost?'block':'none';
    adminMenuOpen=false;adminMenuEl.style.display='none';
    goalOverlay.style.display='none';
}

// =============================================
// CLIENT STATE SYNC
// =============================================
function syncClientState(){
    if(!roomData||!roomData.match)return;
    matchRunning=roomData.match.running||false;
    matchPaused=roomData.match.paused||false;
    matchTime=roomData.match.time||0;

    // Ball interpolation
    if(roomData.match.ball){
        const tb=roomData.match.ball;
        localBall.x=lerp(localBall.x,tb.x,0.35);
        localBall.y=lerp(localBall.y,tb.y,0.35);
        localBall.vx=lerp(localBall.vx,tb.vx||0,0.4);
        localBall.vy=lerp(localBall.vy,tb.vy||0,0.4);
    }

    // Players interpolation
    if(roomData.players){
        for(const pid in roomData.players){
            const rd=roomData.players[pid];
            if(rd.online===false){delete localPlayers[pid];continue;}
            if(!localPlayers[pid]){
                localPlayers[pid]={
                    name:rd.name,team:rd.team,
                    x:rd.x||currentMap.fieldW/2,y:rd.y||currentMap.fieldH/2,
                    vx:0,vy:0,kick:false,kickTimer:0,
                    idx:0,idy:0,ik:false,
                    prevX:rd.x||currentMap.fieldW/2,prevY:rd.y||currentMap.fieldH/2
                };
            }
            const lp=localPlayers[pid];
            lp.team=rd.team;lp.name=rd.name;
            lp.kick=rd.kick||false;

            if(pid===myId&&lp.team!=='spectator'){
                // Local prediction for own player
                const il=Math.sqrt(myInput.dx*myInput.dx+myInput.dy*myInput.dy);
                if(il>0.05){
                    const n=normalize(myInput.dx,myInput.dy);
                    lp.vx+=n.x*PLAYER_ACCEL*Math.min(il,1);
                    lp.vy+=n.y*PLAYER_ACCEL*Math.min(il,1);
                }
                const sp=Math.sqrt(lp.vx*lp.vx+lp.vy*lp.vy);
                if(sp>PLAYER_MAX_SPEED){lp.vx=(lp.vx/sp)*PLAYER_MAX_SPEED;lp.vy=(lp.vy/sp)*PLAYER_MAX_SPEED;}
                lp.vx*=currentMap.playerFriction;lp.vy*=currentMap.playerFriction;
                lp.x+=lp.vx;lp.y+=lp.vy;
                // Blend with server
                if(rd.x!==undefined){
                    lp.x=lerp(lp.x,rd.x,0.12);
                    lp.y=lerp(lp.y,rd.y,0.12);
                }
                lp.x=clamp(lp.x,PLAYER_RADIUS,currentMap.fieldW-PLAYER_RADIUS);
                lp.y=clamp(lp.y,PLAYER_RADIUS,currentMap.fieldH-PLAYER_RADIUS);
                lp.kick=myInput.kick;
            }else{
                // Other players - interpolate
                if(rd.x!==undefined){
                    lp.x=lerp(lp.x,rd.x,0.25);
                    lp.y=lerp(lp.y,rd.y,0.25);
                }
            }
        }
        // Remove gone players
        for(const pid in localPlayers){
            if(!roomData.players[pid]||roomData.players[pid].online===false){
                delete localPlayers[pid];
            }
        }
    }
}

// =============================================
// CLEANUP
// =============================================
function cleanup(){
    if(roomRef){
        if(roomListener)roomRef.off('value',roomListener);
        roomListener=null;
        roomRef.child('players/'+myId).remove();
        roomRef=null;
    }
    stopLoop();roomData=null;roomCode='';isHost=false;localPlayers={};
}

// =============================================
// GAME LOOP
// =============================================
function startLoop(){
    if(animId)cancelAnimationFrame(animId);
    lastFrameTime=performance.now();accumulator=0;
    tick(lastFrameTime);
}
function stopLoop(){if(animId){cancelAnimationFrame(animId);animId=null;}}

function tick(now){
    animId=requestAnimationFrame(tick);
    let dt=now-lastFrameTime;
    lastFrameTime=now;
    if(dt>80)dt=80;
    accumulator+=dt;
    while(accumulator>=FIXED_DT){
        fixedUpdate(FIXED_DT/1000);
        accumulator-=FIXED_DT;
    }
    render();
    netTick(now);
}

// =============================================
// NETWORK TICK
// =============================================
function netTick(now){
    if(!roomRef)return;
    if(now-lastNetSend<NET_SEND_INTERVAL)return;
    lastNetSend=now;

    if(isHost){
        const u={};
        u['match/ball']={
            x:Math.round(localBall.x*10)/10,
            y:Math.round(localBall.y*10)/10,
            vx:Math.round(localBall.vx*100)/100,
            vy:Math.round(localBall.vy*100)/100
        };
        u['match/time']=Math.round(matchTime*10)/10;
        u['match/running']=matchRunning;
        u['match/paused']=matchPaused;
        u['match/redScore']=redScore;
        u['match/blueScore']=blueScore;

        for(const pid in localPlayers){
            const p=localPlayers[pid];
            if(p.team==='spectator')continue;
            u['players/'+pid+'/x']=Math.round(p.x*10)/10;
            u['players/'+pid+'/y']=Math.round(p.y*10)/10;
            u['players/'+pid+'/vx']=Math.round(p.vx*100)/100;
            u['players/'+pid+'/vy']=Math.round(p.vy*100)/100;
            u['players/'+pid+'/kick']=p.kick||false;
        }
        roomRef.update(u);
    }else{
        // Client sends only input
        roomRef.child('players/'+myId).update({
            idx:Math.round(myInput.dx*100)/100,
            idy:Math.round(myInput.dy*100)/100,
            ik:myInput.kick
        });
    }
}

// =============================================
// FIXED UPDATE (PHYSICS) - HOST ONLY DOES REAL PHYSICS
// =============================================
function fixedUpdate(dtSec){
    if(isHost){
        hostPhysics(dtSec);
    }
    // Client updates in syncClientState via Firebase listener
}

function hostPhysics(dtSec){
    const FW=currentMap.fieldW,FH=currentMap.fieldH;
    const GH=currentMap.goalH,GD=currentMap.goalD;
    const goalTop=FH/2-GH/2;
    const goalBot=FH/2+GH/2;

    // Time
    if(matchRunning&&!matchPaused&&!goalScored){
        matchTime+=dtSec;
        if(matchTime>=MATCH_TIME){
            matchRunning=false;matchTime=MATCH_TIME;
            if(roomRef)roomRef.update({'match/running':false});
        }
    }

    // Goal reset
    if(goalScored){
        goalResetTimer-=dtSec*1000;
        if(goalResetTimer<=0){
            goalScored=false;
            resetPositions();
            goalOverlay.style.display='none';
        }
        return;
    }
    if(matchPaused||!matchRunning)return;

    // Read inputs from roomData
    if(roomData&&roomData.players){
        for(const pid in localPlayers){
            if(pid===myId){
                localPlayers[pid].idx=myInput.dx;
                localPlayers[pid].idy=myInput.dy;
                localPlayers[pid].ik=myInput.kick;
            }else{
                const rd=roomData.players[pid];
                if(rd){
                    localPlayers[pid].idx=rd.idx||0;
                    localPlayers[pid].idy=rd.idy||0;
                    localPlayers[pid].ik=rd.ik||false;
                }
            }
        }
    }

    // Sync new/disconnected players
    if(roomData&&roomData.players){
        for(const pid in roomData.players){
            const rd=roomData.players[pid];
            if(rd.online===false){delete localPlayers[pid];continue;}
            if(!localPlayers[pid]){
                const pos=startPos(rd.team,0,1);
                localPlayers[pid]={
                    name:rd.name,team:rd.team,
                    x:pos.x,y:pos.y,vx:0,vy:0,
                    kick:false,kickTimer:0,
                    idx:0,idy:0,ik:false,
                    prevX:pos.x,prevY:pos.y
                };
            }
            localPlayers[pid].team=rd.team;
            localPlayers[pid].name=rd.name;
        }
        for(const pid in localPlayers){
            if(!roomData.players[pid]||roomData.players[pid].online===false){
                delete localPlayers[pid];
            }
        }
    }

    // ---- PLAYER PHYSICS ----
    const activePids=Object.keys(localPlayers).filter(p=>localPlayers[p].team!=='spectator');

    for(const pid of activePids){
        const p=localPlayers[pid];
        // Input
        const il=Math.sqrt(p.idx*p.idx+p.idy*p.idy);
        if(il>0.05){
            const strength=Math.min(il,1);
            const n=normalize(p.idx,p.idy);
            p.vx+=n.x*PLAYER_ACCEL*strength;
            p.vy+=n.y*PLAYER_ACCEL*strength;
        }
        // Speed cap
        const sp=Math.sqrt(p.vx*p.vx+p.vy*p.vy);
        if(sp>PLAYER_MAX_SPEED){
            p.vx=(p.vx/sp)*PLAYER_MAX_SPEED;
            p.vy=(p.vy/sp)*PLAYER_MAX_SPEED;
        }
        // Friction
        p.vx*=currentMap.playerFriction;
        p.vy*=currentMap.playerFriction;
        // Tiny velocity kill
        if(Math.abs(p.vx)<0.005)p.vx=0;
        if(Math.abs(p.vy)<0.005)p.vy=0;
        // Move
        p.x+=p.vx;
        p.y+=p.vy;
        // Kick
        if(p.ik){p.kick=true;p.kickTimer=6;}
        if(p.kickTimer>0){p.kickTimer--;p.kick=true;}else{p.kick=false;}
        // Bounds
        p.x=clamp(p.x,PLAYER_RADIUS,FW-PLAYER_RADIUS);
        p.y=clamp(p.y,PLAYER_RADIUS,FH-PLAYER_RADIUS);
    }

    // ---- PLAYER-PLAYER COLLISION (soft, no strong push) ----
    for(let i=0;i<activePids.length;i++){
        for(let j=i+1;j<activePids.length;j++){
            const a=localPlayers[activePids[i]];
            const b=localPlayers[activePids[j]];
            const d=dist(a.x,a.y,b.x,b.y);
            const minD=PLAYER_RADIUS*2;
            if(d<minD&&d>0.001){
                const nx=(b.x-a.x)/d;
                const ny=(b.y-a.y)/d;
                const overlap=minD-d;
                // Separate equally
                a.x-=nx*overlap*0.5;
                a.y-=ny*overlap*0.5;
                b.x+=nx*overlap*0.5;
                b.y+=ny*overlap*0.5;
                // Very soft velocity exchange (no strong push)
                const dvx=a.vx-b.vx;
                const dvy=a.vy-b.vy;
                const dvn=dvx*nx+dvy*ny;
                if(dvn>0){
                    a.vx-=dvn*nx*PLAYER_BOUNCE_DAMP;
                    a.vy-=dvn*ny*PLAYER_BOUNCE_DAMP;
                    b.vx+=dvn*nx*PLAYER_BOUNCE_DAMP;
                    b.vy+=dvn*ny*PLAYER_BOUNCE_DAMP;
                }
            }
        }
    }

    // ---- BALL PHYSICS ----
    localBall.vx*=currentMap.friction;
    localBall.vy*=currentMap.friction;
    if(Math.abs(localBall.vx)<0.005)localBall.vx=0;
    if(Math.abs(localBall.vy)<0.005)localBall.vy=0;
    localBall.x+=localBall.vx;
    localBall.y+=localBall.vy;

    // Ball speed cap
    const bs=Math.sqrt(localBall.vx*localBall.vx+localBall.vy*localBall.vy);
    if(bs>BALL_MAX_SPEED){
        localBall.vx=(localBall.vx/bs)*BALL_MAX_SPEED;
        localBall.vy=(localBall.vy/bs)*BALL_MAX_SPEED;
    }

    // ---- BALL-PLAYER COLLISION ----
    for(const pid of activePids){
        const p=localPlayers[pid];
        const d=dist(p.x,p.y,localBall.x,localBall.y);
        const minD=PLAYER_RADIUS+BALL_RADIUS;
        if(d<minD&&d>0.001){
            const nx=(localBall.x-p.x)/d;
            const ny=(localBall.y-p.y)/d;
            // Separate ball
            const overlap=minD-d;
            localBall.x+=nx*overlap*1.0;
            localBall.y+=ny*overlap*1.0;
            // Relative vel
            const dvx=localBall.vx-p.vx;
            const dvy=localBall.vy-p.vy;
            const dvn=dvx*nx+dvy*ny;
            if(dvn<0){
                localBall.vx-=dvn*nx*0.8;
                localBall.vy-=dvn*ny*0.8;
            }
            if(p.kick){
                // Kick: moderate force
                localBall.vx+=nx*KICK_FORCE;
                localBall.vy+=ny*KICK_FORCE;
            }else{
                // Gentle push (dribbling) - very soft
                localBall.vx+=nx*PUSH_FORCE;
                localBall.vy+=ny*PUSH_FORCE;
            }
        }
    }

    // ---- BALL-WALL + GOAL LOGIC ----
    // Goal posts as circles
    const posts=[
        {x:0,y:goalTop},{x:0,y:goalBot},
        {x:FW,y:goalTop},{x:FW,y:goalBot}
    ];
    for(const post of posts){
        const pd=dist(localBall.x,localBall.y,post.x,post.y);
        if(pd<BALL_RADIUS+POST_RADIUS&&pd>0.001){
            const pnx=(localBall.x-post.x)/pd;
            const pny=(localBall.y-post.y)/pd;
            const pOverlap=BALL_RADIUS+POST_RADIUS-pd;
            localBall.x+=pnx*pOverlap;
            localBall.y+=pny*pOverlap;
            // Reflect
            const dot=localBall.vx*pnx+localBall.vy*pny;
            if(dot<0){
                localBall.vx-=2*dot*pnx*BOUNCE_DAMP;
                localBall.vy-=2*dot*pny*BOUNCE_DAMP;
            }
        }
    }

    // Top wall
    if(localBall.y-BALL_RADIUS<0){
        localBall.y=BALL_RADIUS;
        localBall.vy=Math.abs(localBall.vy)*BOUNCE_DAMP;
    }
    // Bottom wall
    if(localBall.y+BALL_RADIUS>FH){
        localBall.y=FH-BALL_RADIUS;
        localBall.vy=-Math.abs(localBall.vy)*BOUNCE_DAMP;
    }

    // Left side
    if(localBall.x-BALL_RADIUS<0){
        if(localBall.y>goalTop&&localBall.y<goalBot){
            // In goal mouth
            // Back wall
            if(localBall.x-BALL_RADIUS<-GD){
                // GOL! for blue
                doGoal('blue');return;
            }
            // Goal top/bottom inner walls
            if(localBall.x<0){
                if(localBall.y-BALL_RADIUS<goalTop){
                    localBall.y=goalTop+BALL_RADIUS;
                    localBall.vy=Math.abs(localBall.vy)*BOUNCE_DAMP;
                }
                if(localBall.y+BALL_RADIUS>goalBot){
                    localBall.y=goalBot-BALL_RADIUS;
                    localBall.vy=-Math.abs(localBall.vy)*BOUNCE_DAMP;
                }
            }
        }else{
            // Normal left wall
            localBall.x=BALL_RADIUS;
            localBall.vx=Math.abs(localBall.vx)*BOUNCE_DAMP;
        }
    }

    // Right side
    if(localBall.x+BALL_RADIUS>FW){
        if(localBall.y>goalTop&&localBall.y<goalBot){
            if(localBall.x+BALL_RADIUS>FW+GD){
                doGoal('red');return;
            }
            if(localBall.x>FW){
                if(localBall.y-BALL_RADIUS<goalTop){
                    localBall.y=goalTop+BALL_RADIUS;
                    localBall.vy=Math.abs(localBall.vy)*BOUNCE_DAMP;
                }
                if(localBall.y+BALL_RADIUS>goalBot){
                    localBall.y=goalBot-BALL_RADIUS;
                    localBall.vy=-Math.abs(localBall.vy)*BOUNCE_DAMP;
                }
            }
        }else{
            localBall.x=FW-BALL_RADIUS;
            localBall.vx=-Math.abs(localBall.vx)*BOUNCE_DAMP;
        }
    }

    // Goal back walls (if ball inside goal area)
    if(localBall.x<0&&localBall.y>goalTop&&localBall.y<goalBot){
        if(localBall.x-BALL_RADIUS<-GD){
            localBall.x=-GD+BALL_RADIUS;
            localBall.vx=Math.abs(localBall.vx)*BOUNCE_DAMP;
        }
    }
    if(localBall.x>FW&&localBall.y>goalTop&&localBall.y<goalBot){
        if(localBall.x+BALL_RADIUS>FW+GD){
            localBall.x=FW+GD-BALL_RADIUS;
            localBall.vx=-Math.abs(localBall.vx)*BOUNCE_DAMP;
        }
    }
}

function doGoal(team){
    goalScored=true;
    goalResetTimer=GOAL_RESET_DELAY;
    if(team==='red'){
        redScore++;
        goalTextEl.textContent='üî¥ GOL!';
        goalTextEl.style.color='#e74c3c';
    }else{
        blueScore++;
        goalTextEl.textContent='üîµ GOL!';
        goalTextEl.style.color='#3498db';
    }
    goalOverlay.style.display='flex';
    localBall.vx=0;localBall.vy=0;
    // Freeze players
    for(const pid in localPlayers){
        localPlayers[pid].vx=0;localPlayers[pid].vy=0;
    }
    if(roomRef){
        roomRef.update({'match/redScore':redScore,'match/blueScore':blueScore});
    }
}

function resetPositions(){
    const FW=currentMap.fieldW,FH=currentMap.fieldH;
    localBall.x=FW/2;localBall.y=FH/2;localBall.vx=0;localBall.vy=0;
    let ri=0,bi=0,rc=0,bc=0;
    for(const pid in localPlayers){
        if(localPlayers[pid].team==='red')rc++;
        if(localPlayers[pid].team==='blue')bc++;
    }
    for(const pid in localPlayers){
        const p=localPlayers[pid];
        if(p.team==='red'){
            const pos=startPos('red',ri,rc);
            p.x=pos.x;p.y=pos.y;p.vx=0;p.vy=0;ri++;
        }else if(p.team==='blue'){
            const pos=startPos('blue',bi,bc);
            p.x=pos.x;p.y=pos.y;p.vx=0;p.vy=0;bi++;
        }
    }
}

// =============================================
// RENDER
// =============================================
function render(){
    ctx.clearRect(0,0,canvasW,canvasH);

    // BG
    ctx.fillStyle=currentMap.bgColor;
    ctx.fillRect(0,0,canvasW,canvasH);

    ctx.save();
    ctx.translate(offsetX,offsetY);
    ctx.scale(scale,scale);
    ctx.translate(FIELD_MARGIN,FIELD_MARGIN);

    drawField();
    drawBall();
    drawPlayers();

    ctx.restore();
    drawHUD();
}

function drawField(){
    const FW=currentMap.fieldW,FH=currentMap.fieldH;
    const GH=currentMap.goalH,GD=currentMap.goalD;
    const goalTop=FH/2-GH/2,goalBot=FH/2+GH/2;
    const lc=currentMap.lineColor;

    // Floor
    ctx.fillStyle=currentMap.floorColor;
    ctx.fillRect(0,0,FW,FH);

    // Striped pattern
    ctx.fillStyle=currentMap.floorColor2;
    const stripeW=FW/12;
    for(let i=0;i<12;i+=2){
        ctx.fillRect(i*stripeW,0,stripeW,FH);
    }

    // Field border
    ctx.strokeStyle=lc;ctx.lineWidth=3;
    ctx.strokeRect(0,0,FW,FH);

    // Center line
    ctx.beginPath();ctx.moveTo(FW/2,0);ctx.lineTo(FW/2,FH);ctx.stroke();

    // Center circle
    ctx.beginPath();ctx.arc(FW/2,FH/2,currentMap.centerR,0,Math.PI*2);ctx.stroke();

    // Center dot
    ctx.fillStyle=lc;
    ctx.beginPath();ctx.arc(FW/2,FH/2,5,0,Math.PI*2);ctx.fill();

    // Penalty areas
    ctx.lineWidth=2;ctx.strokeStyle=lc;
    ctx.strokeRect(0,FH/2-currentMap.penaltyH/2,currentMap.penaltyW,currentMap.penaltyH);
    ctx.strokeRect(FW-currentMap.penaltyW,FH/2-currentMap.penaltyH/2,currentMap.penaltyW,currentMap.penaltyH);

    // Penalty dots
    ctx.fillStyle=lc;
    ctx.beginPath();ctx.arc(currentMap.penaltyW*0.75,FH/2,4,0,Math.PI*2);ctx.fill();
    ctx.beginPath();ctx.arc(FW-currentMap.penaltyW*0.75,FH/2,4,0,Math.PI*2);ctx.fill();

    // Corner arcs
    ctx.lineWidth=2;ctx.strokeStyle=lc;
    const cr=25;
    ctx.beginPath();ctx.arc(0,0,cr,0,Math.PI/2);ctx.stroke();
    ctx.beginPath();ctx.arc(FW,0,cr,Math.PI/2,Math.PI);ctx.stroke();
    ctx.beginPath();ctx.arc(0,FH,cr,-Math.PI/2,0);ctx.stroke();
    ctx.beginPath();ctx.arc(FW,FH,cr,Math.PI,Math.PI*1.5);ctx.stroke();

    // ---- LEFT GOAL ----
    // Goal background
    ctx.fillStyle='rgba(231,76,60,0.1)';
    ctx.fillRect(-GD,goalTop,GD,GH);

    // Goal net pattern
    ctx.strokeStyle='rgba(231,76,60,0.15)';ctx.lineWidth=1;
    for(let y=goalTop;y<=goalBot;y+=12){
        ctx.beginPath();ctx.moveTo(-GD,y);ctx.lineTo(0,y);ctx.stroke();
    }
    for(let x=-GD;x<=0;x+=12){
        ctx.beginPath();ctx.moveTo(x,goalTop);ctx.lineTo(x,goalBot);ctx.stroke();
    }

    // Goal frame
    ctx.strokeStyle='rgba(231,76,60,0.8)';ctx.lineWidth=4;
    ctx.beginPath();
    ctx.moveTo(0,goalTop);ctx.lineTo(-GD,goalTop);ctx.lineTo(-GD,goalBot);ctx.lineTo(0,goalBot);
    ctx.stroke();

    // ---- RIGHT GOAL ----
    ctx.fillStyle='rgba(52,152,219,0.1)';
    ctx.fillRect(FW,goalTop,GD,GH);

    ctx.strokeStyle='rgba(52,152,219,0.15)';ctx.lineWidth=1;
    for(let y=goalTop;y<=goalBot;y+=12){
        ctx.beginPath();ctx.moveTo(FW,y);ctx.lineTo(FW+GD,y);ctx.stroke();
    }
    for(let x=FW;x<=FW+GD;x+=12){
        ctx.beginPath();ctx.moveTo(x,goalTop);ctx.lineTo(x,goalBot);ctx.stroke();
    }

    ctx.strokeStyle='rgba(52,152,219,0.8)';ctx.lineWidth=4;
    ctx.beginPath();
    ctx.moveTo(FW,goalTop);ctx.lineTo(FW+GD,goalTop);ctx.lineTo(FW+GD,goalBot);ctx.lineTo(FW,goalBot);
    ctx.stroke();

    // Goal posts (circles)
    const postColor='#ddd';
    ctx.fillStyle=postColor;ctx.strokeStyle='#999';ctx.lineWidth=1.5;
    // Left top
    ctx.beginPath();ctx.arc(0,goalTop,POST_RADIUS,0,Math.PI*2);ctx.fill();ctx.stroke();
    // Left bottom
    ctx.beginPath();ctx.arc(0,goalBot,POST_RADIUS,0,Math.PI*2);ctx.fill();ctx.stroke();
    // Right top
    ctx.beginPath();ctx.arc(FW,goalTop,POST_RADIUS,0,Math.PI*2);ctx.fill();ctx.stroke();
    // Right bottom
    ctx.beginPath();ctx.arc(FW,goalBot,POST_RADIUS,0,Math.PI*2);ctx.fill();ctx.stroke();

    // Half circle decorations (penalty arcs)
    ctx.strokeStyle=lc;ctx.lineWidth=2;
    ctx.beginPath();
    ctx.arc(currentMap.penaltyW,FH/2,currentMap.penaltyH*0.3,Math.PI*1.5,Math.PI*0.5);
    ctx.stroke();
    ctx.beginPath();
    ctx.arc(FW-currentMap.penaltyW,FH/2,currentMap.penaltyH*0.3,Math.PI*0.5,Math.PI*1.5);
    ctx.stroke();
}

function drawBall(){
    // Shadow
    ctx.fillStyle='rgba(0,0,0,0.18)';
    ctx.beginPath();ctx.arc(localBall.x+2,localBall.y+3,BALL_RADIUS,0,Math.PI*2);ctx.fill();

    // Ball body
    const g=ctx.createRadialGradient(localBall.x-2,localBall.y-2,1,localBall.x,localBall.y,BALL_RADIUS);
    g.addColorStop(0,'#ffffff');g.addColorStop(1,'#dddddd');
    ctx.fillStyle=g;
    ctx.beginPath();ctx.arc(localBall.x,localBall.y,BALL_RADIUS,0,Math.PI*2);ctx.fill();

    // Ball outline
    ctx.strokeStyle='#aaa';ctx.lineWidth=1.2;
    ctx.beginPath();ctx.arc(localBall.x,localBall.y,BALL_RADIUS,0,Math.PI*2);ctx.stroke();

    // Pentagon pattern
    ctx.fillStyle='rgba(0,0,0,0.08)';
    for(let i=0;i<5;i++){
        const a=(i/5)*Math.PI*2-Math.PI/2;
        const px=localBall.x+Math.cos(a)*BALL_RADIUS*0.55;
        const py=localBall.y+Math.sin(a)*BALL_RADIUS*0.55;
        ctx.beginPath();ctx.arc(px,py,BALL_RADIUS*0.22,0,Math.PI*2);ctx.fill();
    }

    // Speed trail
    const bSpeed=Math.sqrt(localBall.vx*localBall.vx+localBall.vy*localBall.vy);
    if(bSpeed>3){
        const alpha=Math.min((bSpeed-3)/10,0.3);
        ctx.strokeStyle=`rgba(255,255,255,${alpha})`;
        ctx.lineWidth=2;
        ctx.beginPath();
        ctx.moveTo(localBall.x,localBall.y);
        ctx.lineTo(localBall.x-localBall.vx*3,localBall.y-localBall.vy*3);
        ctx.stroke();
    }
}

function drawPlayers(){
    for(const pid in localPlayers){
        const p=localPlayers[pid];
        if(p.team==='spectator')continue;

        const isMe=pid===myId;

        // Kick halo
        if(p.kick){
            ctx.save();
            const haloG=ctx.createRadialGradient(p.x,p.y,PLAYER_RADIUS,p.x,p.y,KICK_RADIUS);
            haloG.addColorStop(0,'rgba(255,255,255,0.15)');
            haloG.addColorStop(1,'rgba(255,255,255,0)');
            ctx.fillStyle=haloG;
            ctx.beginPath();ctx.arc(p.x,p.y,KICK_RADIUS,0,Math.PI*2);ctx.fill();

            ctx.strokeStyle='rgba(255,255,255,0.5)';ctx.lineWidth=2.5;
            ctx.setLineDash([4,4]);
            ctx.beginPath();ctx.arc(p.x,p.y,KICK_RADIUS,0,Math.PI*2);ctx.stroke();
            ctx.setLineDash([]);
            ctx.restore();
        }

        // Shadow
        ctx.fillStyle='rgba(0,0,0,0.15)';
        ctx.beginPath();ctx.arc(p.x+2,p.y+3,PLAYER_RADIUS,0,Math.PI*2);ctx.fill();

        // Body
        let grad;
        if(p.team==='red'){
            grad=ctx.createRadialGradient(p.x-4,p.y-4,2,p.x,p.y,PLAYER_RADIUS);
            grad.addColorStop(0,'#ff7675');grad.addColorStop(1,'#c0392b');
        }else{
            grad=ctx.createRadialGradient(p.x-4,p.y-4,2,p.x,p.y,PLAYER_RADIUS);
            grad.addColorStop(0,'#74b9ff');grad.addColorStop(1,'#2980b9');
        }
        ctx.fillStyle=grad;
        ctx.beginPath();ctx.arc(p.x,p.y,PLAYER_RADIUS,0,Math.PI*2);ctx.fill();

        // Border
        ctx.strokeStyle=isMe?'#fff':'rgba(255,255,255,0.35)';
        ctx.lineWidth=isMe?2.5:1.5;
        ctx.beginPath();ctx.arc(p.x,p.y,PLAYER_RADIUS,0,Math.PI*2);ctx.stroke();

        // Direction dot
        const sp=Math.sqrt(p.vx*p.vx+p.vy*p.vy);
        if(sp>0.3){
            const dn=normalize(p.vx,p.vy);
            ctx.fillStyle='rgba(255,255,255,0.55)';
            ctx.beginPath();
            ctx.arc(p.x+dn.x*PLAYER_RADIUS*0.6,p.y+dn.y*PLAYER_RADIUS*0.6,3,0,Math.PI*2);
            ctx.fill();
        }

        // Shirt number (inner circle)
        ctx.fillStyle='rgba(0,0,0,0.15)';
        ctx.beginPath();ctx.arc(p.x,p.y,PLAYER_RADIUS*0.5,0,Math.PI*2);ctx.fill();

        // Name
        ctx.fillStyle='#fff';
        ctx.font='bold 10px Arial';
        ctx.textAlign='center';ctx.textBaseline='bottom';
        ctx.strokeStyle='rgba(0,0,0,0.6)';ctx.lineWidth=2.5;
        ctx.strokeText(p.name||'?',p.x,p.y-PLAYER_RADIUS-4);
        ctx.fillText(p.name||'?',p.x,p.y-PLAYER_RADIUS-4);

        // "You" arrow
        if(isMe){
            ctx.fillStyle='rgba(255,255,255,0.6)';
            ctx.font='9px Arial';
            ctx.fillText('‚ñº',p.x,p.y-PLAYER_RADIUS-14);
        }
    }
}

function drawHUD(){
    hudRedScore.textContent=redScore;
    hudBlueScore.textContent=blueScore;
    const mins=Math.floor(matchTime/60);
    const secs=Math.floor(matchTime%60);
    hudTime.textContent=mins+':'+(secs<10?'0':'')+secs;

    if(matchPaused)hudStatus.textContent='DURAKLATILDI';
    else if(!matchRunning&&matchTime>=MATCH_TIME)hudStatus.textContent='MA√á Bƒ∞TTƒ∞';
    else if(goalScored)hudStatus.textContent='GOL!';
    else hudStatus.textContent='';
}

// =============================================
// TOUCH CONTROLS
// =============================================
joyZone.addEventListener('touchstart',e=>{
    e.preventDefault();e.stopPropagation();
    if(joyTouchId!==null)return;
    const t=e.changedTouches[0];
    joyTouchId=t.identifier;joyActive=true;
    joyStartX=t.clientX;joyStartY=t.clientY;
    showJoy(t.clientX,t.clientY,t.clientX,t.clientY);
},{passive:false});

joyZone.addEventListener('touchmove',e=>{
    e.preventDefault();e.stopPropagation();
    for(let i=0;i<e.changedTouches.length;i++){
        const t=e.changedTouches[i];
        if(t.identifier!==joyTouchId)continue;
        const dx=t.clientX-joyStartX;
        const dy=t.clientY-joyStartY;
        const maxD=50;
        const d=Math.sqrt(dx*dx+dy*dy);
        const cd=Math.min(d,maxD);
        const ang=Math.atan2(dy,dx);
        const cx=Math.cos(ang)*cd;
        const cy=Math.sin(ang)*cd;
        myInput.dx=cx/maxD;
        myInput.dy=cy/maxD;
        showJoy(joyStartX,joyStartY,joyStartX+cx,joyStartY+cy);
    }
},{passive:false});

joyZone.addEventListener('touchend',e=>{
    e.preventDefault();e.stopPropagation();
    for(let i=0;i<e.changedTouches.length;i++){
        if(e.changedTouches[i].identifier===joyTouchId){
            joyTouchId=null;joyActive=false;
            myInput.dx=0;myInput.dy=0;
            hideJoy();
        }
    }
},{passive:false});

joyZone.addEventListener('touchcancel',e=>{
    for(let i=0;i<e.changedTouches.length;i++){
        if(e.changedTouches[i].identifier===joyTouchId){
            joyTouchId=null;joyActive=false;
            myInput.dx=0;myInput.dy=0;
            hideJoy();
        }
    }
},{passive:false});

function showJoy(bx,by,tx,ty){
    joyBaseEl.style.display='block';
    joyBaseEl.style.left=(bx-55)+'px';joyBaseEl.style.top=(by-55)+'px';
    joyThumbEl.style.display='block';
    joyThumbEl.style.left=(tx-23)+'px';joyThumbEl.style.top=(ty-23)+'px';
}
function hideJoy(){
    joyBaseEl.style.display='none';
    joyThumbEl.style.display='none';
}

// Kick button
kickBtnEl.addEventListener('touchstart',e=>{
    e.preventDefault();e.stopPropagation();
    kickTouchId=e.changedTouches[0].identifier;
    myInput.kick=true;
    kickBtnEl.classList.add('active');
},{passive:false});

kickBtnEl.addEventListener('touchend',e=>{
    e.preventDefault();e.stopPropagation();
    for(let i=0;i<e.changedTouches.length;i++){
        if(e.changedTouches[i].identifier===kickTouchId){
            kickTouchId=null;myInput.kick=false;
            kickBtnEl.classList.remove('active');
        }
    }
},{passive:false});

kickBtnEl.addEventListener('touchcancel',e=>{
    kickTouchId=null;myInput.kick=false;
    kickBtnEl.classList.remove('active');
},{passive:false});

// =============================================
// KEYBOARD CONTROLS (DESKTOP)
// =============================================
document.addEventListener('keydown',e=>{
    if(gameState!=='game')return;
    keysDown[e.key.toLowerCase()]=true;
    if(e.key===' '||e.key==='x'||e.key==='X')myInput.kick=true;
    updateKeys();
});
document.addEventListener('keyup',e=>{
    keysDown[e.key.toLowerCase()]=false;
    if(e.key===' '||e.key==='x'||e.key==='X')myInput.kick=false;
    updateKeys();
});

function updateKeys(){
    if(joyActive)return;
    let dx=0,dy=0;
    if(keysDown['w']||keysDown['arrowup'])dy=-1;
    if(keysDown['s']||keysDown['arrowdown'])dy=1;
    if(keysDown['a']||keysDown['arrowleft'])dx=-1;
    if(keysDown['d']||keysDown['arrowright'])dx=1;
    myInput.dx=dx;myInput.dy=dy;
}

// Ensure focus on canvas/document for keyboard (fix: non-host keyboard issue)
document.addEventListener('click',()=>{
    if(gameState==='game'){
        canvas.focus();
    }
});

// Make canvas focusable
canvas.setAttribute('tabindex','0');
canvas.style.outline='none';

// When game screen shows, focus canvas
const origShowScreen=showScreen;
showScreen=function(s){
    menuScreen.style.display='none';
    lobbyScreen.style.display='none';
    gameScreen.style.display='none';
    if(s==='menu'){menuScreen.style.display='flex';gameState='menu';stopLoop();}
    else if(s==='lobby'){lobbyScreen.style.display='flex';gameState='lobby';stopLoop();}
    else if(s==='game'){
        gameScreen.style.display='block';gameState='game';resizeCanvas();startLoop();
        setTimeout(()=>{canvas.focus();},100);
    }
};

// =============================================
// ADMIN PANEL
// =============================================
adminToggleEl.addEventListener('click',e=>{
    e.stopPropagation();
    adminMenuOpen=!adminMenuOpen;
    adminMenuEl.style.display=adminMenuOpen?'block':'none';
});
adminToggleEl.addEventListener('touchstart',e=>e.stopPropagation(),{passive:false});

$('abtnPause').addEventListener('click',()=>{
    if(!isHost||!roomRef)return;
    matchPaused=!matchPaused;
    roomRef.update({'match/paused':matchPaused});
    $('abtnPause').textContent=matchPaused?'‚ñ∂ Devam':'‚è∏ Duraklat';
    showToast(matchPaused?'Duraklatƒ±ldƒ±':'Devam ediyor');
});

$('abtnReset').addEventListener('click',()=>{
    if(!isHost||!roomRef)return;
    redScore=0;blueScore=0;matchTime=0;
    roomRef.update({'match/redScore':0,'match/blueScore':0,'match/time':0});
    resetPositions();
    showToast('Skor sƒ±fƒ±rlandƒ±');
});

$('abtnLobby').addEventListener('click',()=>{
    if(!isHost||!roomRef)return;
    matchRunning=false;matchPaused=false;goalScored=false;
    roomRef.update({state:'lobby','match/running':false,'match/paused':false});
    stopLoop();showScreen('lobby');
    showToast('Lobiye d√∂n√ºld√º');
});

adminPanel.addEventListener('touchstart',e=>e.stopPropagation(),{passive:false});
adminPanel.addEventListener('touchmove',e=>e.stopPropagation(),{passive:false});
adminPanel.addEventListener('touchend',e=>e.stopPropagation(),{passive:false});

// =============================================
// PREVENT DEFAULT BEHAVIORS
// =============================================
document.addEventListener('gesturestart',e=>e.preventDefault());
document.addEventListener('gesturechange',e=>e.preventDefault());
document.addEventListener('gestureend',e=>e.preventDefault());

// =============================================
// WINDOW UNLOAD
// =============================================
window.addEventListener('beforeunload',()=>{
    if(roomRef)roomRef.child('players/'+myId).update({online:false});
});

// =============================================
// DEFAULT NAME
// =============================================
playerNameInput.value='Oyuncu'+Math.floor(Math.random()*900+100);

// =============================================
// INIT
// =============================================
showScreen('menu');
hideJoy();

})();
</script>
</body>
</html>
