<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no">
<title>Neon Bumper Arena</title>
<style>
*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent;user-select:none}
body{background:#0a0a14;font-family:'Segoe UI',sans-serif;color:#eee;overflow:hidden;position:fixed;inset:0}
#menuWrap{position:fixed;inset:0;display:flex;flex-direction:column;align-items:center;justify-content:center;z-index:50;background:#0a0a14}
#menuWrap.hide{display:none}
.mTitle{font-size:28px;font-weight:900;text-align:center;background:linear-gradient(135deg,#0ff,#f0f,#ff0);-webkit-background-clip:text;-webkit-text-fill-color:transparent;margin-bottom:4px}
.mSub{font-size:10px;color:#555;letter-spacing:3px;text-transform:uppercase;margin-bottom:18px}
#dbSt{font-size:11px;padding:6px 14px;border-radius:8px;margin-bottom:14px;font-weight:600}
#dbSt.ok{background:#2ecc7115;color:#2ecc71;border:1px solid #2ecc7120}
#dbSt.no{background:#e74c3c15;color:#e74c3c;border:1px solid #e74c3c20}
#dbSt.wt{background:#f39c1215;color:#f39c12;border:1px solid #f39c1220}
.mBox{width:280px;display:flex;flex-direction:column;gap:10px}
.mBox input{padding:11px;border:2px solid #1e1e30;border-radius:10px;background:#0d0d18;color:#eee;font-size:14px;font-weight:700;text-align:center;outline:none}
.mBox input:focus{border-color:#0ff}
.mBox input::placeholder{color:#333}
.mbtn{padding:13px;border:none;border-radius:12px;font-size:14px;font-weight:700;cursor:pointer;transition:transform .1s}
.mbtn:active{transform:scale(.96)}
.mbtn:disabled{opacity:.3}
.mbtn.g1{background:linear-gradient(135deg,#0ff,#00bcd4);color:#000}
.mbtn.g2{background:#151525;color:#aaa;border:1px solid #252540}
.mbtn.g3{background:linear-gradient(135deg,#6f6,#2a2);color:#000}
.mbtn.g4{background:linear-gradient(135deg,#f55,#a22);color:#fff}
.mErr{color:#f55;font-size:10px;text-align:center;min-height:14px}
.lobby{width:280px;margin-top:8px}
.lobby h4{font-size:10px;color:#555;margin-bottom:5px}
.lobbyP{display:flex;flex-wrap:wrap;gap:4px}
.lobbyP div{padding:3px 8px;border-radius:6px;font-size:10px;font-weight:600;background:#111120;border:1px solid #222}
.lobbyP div.me{border-color:#0ff;color:#0ff}
.rules{width:280px;margin-top:14px;padding:10px;background:#0d0d18;border-radius:8px;border:1px solid #151525;font-size:9px;color:#444;line-height:1.8}
.rules b{color:#0ff}
#gameCanvas{position:fixed;inset:0;width:100%;height:100%;touch-action:none}
#hud{position:fixed;top:8px;left:50%;transform:translateX(-50%);display:flex;gap:16px;font-size:11px;font-weight:700;z-index:10;pointer-events:none}
#hud.hide{display:none}
.hudI{padding:4px 10px;border-radius:6px;background:#0008;backdrop-filter:blur(4px)}
.hudI.t{color:#ff0}
.hudI.a{color:#0f0}
.hudI.r{color:#f0f}
#specMsg{position:fixed;bottom:60px;left:50%;transform:translateX(-50%);padding:8px 18px;background:#e74c3ccc;color:#fff;font-size:12px;font-weight:700;border-radius:8px;z-index:10;display:none}
#quitBtn{position:fixed;top:8px;right:8px;padding:6px 12px;background:#f553;border:1px solid #f554;color:#f88;font-size:10px;font-weight:700;border-radius:6px;cursor:pointer;z-index:10;display:none}
.toast{position:fixed;top:40px;left:50%;transform:translateX(-50%);padding:5px 14px;border-radius:7px;font-size:10px;font-weight:700;z-index:200;opacity:0;transition:opacity .2s;pointer-events:none}
.toast.sh{opacity:1}
.toast.tg{background:#0ffe0;color:#000}
.toast.tr{background:#f55e0;color:#fff}
.toast.tb{background:#38fe0;color:#fff}
</style>
</head>
<body>

<div id="menuWrap">
<div class="mTitle">‚ö° Neon Bumper Arena</div>
<div class="mSub">Multiplayer Aksiyon</div>
<div id="dbSt" class="wt">üîÑ Baƒülanƒ±yor...</div>

<!-- SCREEN 0: MAIN MENU -->
<div class="mBox" id="scr0">
<input type="text" id="inpName" placeholder="Adƒ±n..." maxlength="10">
<button class="mbtn g1" id="btnC" onclick="createRoom()" disabled>üèüÔ∏è Arena Kur</button>
<button class="mbtn g2" id="btnJ" onclick="showJoin()" disabled>üö™ Katƒ±l</button>
<div class="rules">
<b>‚ö° Kurallar:</b><br>
‚Ä¢ Joystick ile arabayƒ± kontrol et<br>
‚Ä¢ Rakipleri arena dƒ±≈üƒ±na it<br>
‚Ä¢ Ortadaki topu rakip kaleye sok (+1 puan)<br>
‚Ä¢ Arena dƒ±≈üƒ±na d√º≈üen elenir<br>
‚Ä¢ Son kalan kazanƒ±r!
</div>
</div>

<!-- SCREEN 1: JOIN -->
<div class="mBox" id="scr1" style="display:none">
<button class="mbtn g2" onclick="showMain()" style="padding:8px;font-size:11px">‚Üê Geri</button>
<input type="text" id="inpCode" placeholder="4 haneli kod" maxlength="4" inputmode="numeric">
<div class="mErr" id="jErr"></div>
<button class="mbtn g1" onclick="joinRoom()">üö™ Katƒ±l</button>
</div>

<!-- SCREEN 2: LOBBY HOST -->
<div class="mBox" id="scr2" style="display:none">
<button class="mbtn g2" onclick="exitLobby()" style="padding:8px;font-size:11px">‚Üê Geri</button>
<div style="text-align:center">
<div style="font-size:10px;color:#555">Arena Kodu</div>
<div style="font-size:36px;font-weight:900;letter-spacing:8px;color:#0ff" id="dispCode">----</div>
<div style="font-size:10px;color:#555;margin-top:4px" id="lobbyWait">‚è≥ Bekleniyor...</div>
</div>
<div class="lobby"><h4>Oyuncular</h4><div class="lobbyP" id="lobbyList"></div></div>
<button class="mbtn g3" onclick="startMatch()" id="startBtn" disabled>‚öîÔ∏è Ba≈ülat</button>
</div>

<!-- SCREEN 3: LOBBY GUEST -->
<div class="mBox" id="scr3" style="display:none">
<button class="mbtn g2" onclick="exitGuest()" style="padding:8px;font-size:11px">‚Üê Geri</button>
<div style="text-align:center">
<div style="font-size:10px;color:#555">Arena</div>
<div style="font-size:36px;font-weight:900;letter-spacing:8px;color:#0ff" id="dispCode2">----</div>
<div style="font-size:10px;color:#555;margin-top:4px">‚è≥ Kurucu ba≈ülatacak...</div>
</div>
<div class="lobby"><h4>Oyuncular</h4><div class="lobbyP" id="lobbyList2"></div></div>
</div>
</div>

<!-- GAME -->
<canvas id="gameCanvas"></canvas>
<div id="hud" class="hide">
<div class="hudI r">Tur <span id="hudR">1</span></div>
<div class="hudI a">Kalan <span id="hudA">0</span></div>
<div class="hudI t">Skor <span id="hudS">0-0</span></div>
</div>
<div id="specMsg">üëÅÔ∏è ƒ∞zliyorsun</div>
<div id="quitBtn" onclick="quitGame()">‚úï √áƒ±k</div>

<!-- RESULT OVERLAY -->
<div id="resOv" style="display:none;position:fixed;inset:0;background:#000c;z-index:100;align-items:center;justify-content:center;backdrop-filter:blur(4px)">
<div style="background:#0e0e18;border-radius:16px;padding:22px;text-align:center;max-width:300px;width:90%;border:1px solid #1e1e30">
<div style="font-size:46px;margin-bottom:8px" id="resIc">üèÜ</div>
<h2 style="font-size:18px;font-weight:900" id="resTi">Kazandƒ±n!</h2>
<p style="font-size:11px;color:#666;margin:6px 0" id="resSu"></p>
<div style="display:flex;flex-direction:column;gap:8px;margin-top:12px">
<button class="mbtn g3" onclick="rematch()" id="remBtn">üîÑ Tekrar</button>
<button class="mbtn g1" onclick="goMenu()">üè† Men√º</button>
</div>
</div>
</div>

<script>
// ============================================
// FIREBASE REST API (XHR - file:// uyumlu)
// ============================================
var DB="https://mobilgame1-f03ac-default-rtdb.europe-west1.firebasedatabase.app";

function fb(method,path,data,cb){
var x=new XMLHttpRequest();
x.open(method,DB+"/"+path+".json",true);
if(data!==null)x.setRequestHeader("Content-Type","application/json");
x.onload=function(){
if(x.status>=200&&x.status<300){
try{if(cb)cb(true,JSON.parse(x.responseText))}
catch(e){if(cb)cb(true,null)}
}else{if(cb)cb(false,null)}};
x.onerror=function(){if(cb)cb(false,null)};
x.send(data!==null?JSON.stringify(data):null)}

function fbPut(p,d,cb){fb("PUT",p,d,cb)}
function fbPatch(p,d,cb){fb("PATCH",p,d,cb)}
function fbGet(p,cb){fb("GET",p,null,cb)}
function fbDel(p,cb){fb("DELETE",p,null,cb)}

// ============================================
// CONNECTION TEST
// ============================================
function testConn(){
document.getElementById("dbSt").className="wt";
document.getElementById("dbSt").textContent="üîÑ Test ediliyor...";
fbPut("_t",{ok:1},function(ok){
if(ok){fbDel("_t");
document.getElementById("dbSt").className="ok";
document.getElementById("dbSt").textContent="‚úÖ Baƒülƒ±!";
document.getElementById("btnC").disabled=false;
document.getElementById("btnJ").disabled=false}
else{document.getElementById("dbSt").className="no";
document.getElementById("dbSt").textContent="‚ùå Baƒülantƒ± ba≈üarƒ±sƒ±z!"}})}

// ============================================
// GAME CONSTANTS
// ============================================
var ARENA_W=1200,ARENA_H=700,PLAYER_R=22,BALL_R=14;
var MAX_SPEED=4.5,ACCEL=0.35,FRICTION=0.94;
var PUSH_FORCE=1.8,BALL_FRICTION=0.985,BALL_PUSH=1.2;
var GOAL_W=80,GOAL_H=120;
var COLS=["#0ff","#f0f","#ff0","#0f0","#f80","#f44","#48f","#4ff","#f4f","#8f4"];
var MP=10,SEND_RATE=80; // ms between sends

// ============================================
// STATE
// ============================================
var room=null,rl=null,ms=null,pN="";
var pollT=null,sendT=null;
var pls={},myP=null,ball=null;
var myAlive=true,phase="menu";
var score={a:0,b:0};
var joyActive=false,joyX=0,joyY=0,joyStartX=0,joyStartY=0;
var joyTouchId=null;
var canvas,ctx,camX=0,camY=0;
var lastTime=0,gameLoop=null;

// ============================================
// UTILS
// ============================================
function rc(){return String(1000+Math.floor(Math.random()*9000))}
function gn(){var v=document.getElementById("inpName").value.trim();return v||("P"+Math.floor(Math.random()*99))}
function toast(m,c){var d=document.createElement("div");d.className="toast t"+c;d.textContent=m;document.body.appendChild(d);
setTimeout(function(){d.classList.add("sh")},10);setTimeout(function(){d.classList.remove("sh");setTimeout(function(){d.remove()},300)},2e3)}

function showScr(id){["scr0","scr1","scr2","scr3"].forEach(function(s){document.getElementById(s).style.display="none"});
document.getElementById(id).style.display="flex"}
function showMain(){showScr("scr0")}
function showJoin(){showScr("scr1")}

function sP(){if(pollT){clearInterval(pollT);pollT=null}}
function sSend(){if(sendT){clearInterval(sendT);sendT=null}}
function clean(){sP();sSend();if(gameLoop){cancelAnimationFrame(gameLoop);gameLoop=null}
room=null;rl=null;ms=null;pls={};myP=null;ball=null;myAlive=true;phase="menu";score={a:0,b:0};
document.getElementById("menuWrap").classList.remove("hide");
document.getElementById("hud").classList.add("hide");
document.getElementById("specMsg").style.display="none";
document.getElementById("quitBtn").style.display="none";
document.getElementById("resOv").style.display="none";
document.getElementById("inpCode").value="";document.getElementById("jErr").textContent=""}

function poll(cb){sP();function go(){if(!room)return;fbGet("games/"+room,function(ok,d){if(ok&&d)cb(d)})}go();pollT=setInterval(go,900)}

function lerp(a,b,t){return a+(b-a)*t}
function dist(x1,y1,x2,y2){var dx=x2-x1,dy=y2-y1;return Math.sqrt(dx*dx+dy*dy)}

// ============================================
// CREATE ROOM
// ============================================
function createRoom(){
pN=gn();document.getElementById("inpName").value=pN;
var code=rc();room=code;rl="host";ms="p0";
var data={status:"lobby",host:pN,phase:"lobby",score:{a:0,b:0},
ball:{x:ARENA_W/2,y:ARENA_H/2,vx:0,vy:0},
p0:{name:pN,x:ARENA_W*0.25,y:ARENA_H/2,vx:0,vy:0,alive:true,team:"a",ready:false}};
fbPut("games/"+code,data,function(ok){
if(!ok){toast("Hata!","r");room=null;return}
document.getElementById("dispCode").textContent=code;
showScr("scr2");toast("Kod: "+code,"g");
poll(function(d){
if(d.status==="lobby")updLobby(d,"lobbyList");
if(d.status==="playing"){sP();startGameLocal(d)}})})}

// ============================================
// JOIN
// ============================================
function joinRoom(){
var code=document.getElementById("inpCode").value.trim();
pN=gn();document.getElementById("inpName").value=pN;
var err=document.getElementById("jErr");
if(code.length!==4){err.textContent="4 haneli kod girin.";return}
fbGet("games/"+code,function(ok,d){
if(!ok||!d){err.textContent="Bulunamadƒ±.";return}
if(d.status!=="lobby"){err.textContent="Ma√ß ba≈ülamƒ±≈ü.";return}
var sl=null;for(var i=0;i<MP;i++){if(!d["p"+i]){sl="p"+i;break}}
if(!sl){err.textContent="Dolu!";return}
room=code;rl="guest";ms=sl;err.textContent="";
var team=parseInt(sl.substring(1))%2===0?"a":"b";
var sx=team==="a"?ARENA_W*0.25:ARENA_W*0.75;
var sy=ARENA_H/2+(Math.random()-0.5)*200;
var u={};u[sl]={name:pN,x:sx,y:sy,vx:0,vy:0,alive:true,team:team,ready:false};
fbPatch("games/"+code,u,function(ok2){
if(!ok2){err.textContent="Hata!";room=null;return}
document.getElementById("dispCode2").textContent=code;
showScr("scr3");toast("Katƒ±ldƒ±n!","b");
poll(function(d2){
if(!d2){toast("Silindi!","r");clean();return}
if(d2.status==="lobby")updLobby(d2,"lobbyList2");
if(d2.status==="playing"){sP();startGameLocal(d2)}})})})}

function updLobby(d,el){
var h="",c=0;
for(var i=0;i<MP;i++){var p=d["p"+i];if(p){c++;
h+='<div class="'+("p"+i===ms?"me":"")+'" style="border-left:3px solid '+COLS[i]+'">'+p.name+' ['+(p.team||"a").toUpperCase()+']</div>'}}
var e=document.getElementById(el);if(e)e.innerHTML=h;
var w=document.getElementById("lobbyWait");if(w)w.textContent=c+"/10";
var sb=document.getElementById("startBtn");if(sb){sb.disabled=c<2;sb.textContent="‚öîÔ∏è Ba≈ülat ("+c+")"}}

// ============================================
// START MATCH
// ============================================
function startMatch(){
if(rl!=="host"||!room)return;
fbGet("games/"+room,function(ok,d){
if(!ok||!d)return;
var cnt=0;for(var i=0;i<MP;i++)if(d["p"+i])cnt++;
if(cnt<2){toast("Min 2!","r");return}
var u={status:"playing",phase:"playing",score:{a:0,b:0},
ball:{x:ARENA_W/2,y:ARENA_H/2,vx:0,vy:0}};
// Place teams
var ta=0,tb=0;
for(var i=0;i<MP;i++){var p=d["p"+i];if(p){
var team=p.team||"a";
if(team==="a"){u["p"+i+"/x"]=150+ta*60;u["p"+i+"/y"]=ARENA_H/2-100+ta*80;ta++}
else{u["p"+i+"/x"]=ARENA_W-150-tb*60;u["p"+i+"/y"]=ARENA_H/2-100+tb*80;tb++}
u["p"+i+"/vx"]=0;u["p"+i+"/vy"]=0;u["p"+i+"/alive"]=true}}
fbPatch("games/"+room,u)})}

// ============================================
// GAME INIT
// ============================================
function startGameLocal(d){
phase="playing";
pls={};for(var i=0;i<MP;i++){var p=d["p"+i];if(p){
pls["p"+i]={name:p.name,x:p.x,y:p.y,tx:p.x,ty:p.y,vx:0,vy:0,alive:p.alive!==false,team:p.team||"a",idx:i}}}
myP=pls[ms];if(myP)myAlive=myP.alive;
ball={x:d.ball?d.ball.x:ARENA_W/2,y:d.ball?d.ball.y:ARENA_H/2,tx:ARENA_W/2,ty:ARENA_H/2,vx:0,vy:0};
score=d.score||{a:0,b:0};

document.getElementById("menuWrap").classList.add("hide");
document.getElementById("hud").classList.remove("hide");
document.getElementById("quitBtn").style.display="block";
document.getElementById("specMsg").style.display=myAlive?"none":"block";

initCanvas();
setupTouch();
startSendLoop();
startPollGame();
lastTime=performance.now();
gameLoop=requestAnimationFrame(tick)}

// ============================================
// CANVAS
// ============================================
function initCanvas(){
canvas=document.getElementById("gameCanvas");
ctx=canvas.getContext("2d");
resizeCanvas();window.addEventListener("resize",resizeCanvas)}

function resizeCanvas(){
canvas.width=window.innerWidth;canvas.height=window.innerHeight}

// ============================================
// TOUCH / JOYSTICK
// ============================================
function setupTouch(){
canvas.addEventListener("touchstart",onTS,{passive:false});
canvas.addEventListener("touchmove",onTM,{passive:false});
canvas.addEventListener("touchend",onTE,{passive:false});
canvas.addEventListener("mousedown",onMD);
canvas.addEventListener("mousemove",onMM);
canvas.addEventListener("mouseup",onMU)}

function onTS(e){e.preventDefault();if(joyTouchId!==null)return;
var t=e.changedTouches[0];joyTouchId=t.identifier;
joyStartX=t.clientX;joyStartY=t.clientY;joyActive=true;joyX=0;joyY=0}
function onTM(e){e.preventDefault();for(var i=0;i<e.changedTouches.length;i++){
var t=e.changedTouches[i];if(t.identifier===joyTouchId){
var dx=t.clientX-joyStartX,dy=t.clientY-joyStartY;
var d=Math.sqrt(dx*dx+dy*dy);var maxR=60;
if(d>maxR){dx=dx/d*maxR;dy=dy/d*maxR;d=maxR}
joyX=dx/maxR;joyY=dy/maxR}}}
function onTE(e){for(var i=0;i<e.changedTouches.length;i++){
if(e.changedTouches[i].identifier===joyTouchId){joyTouchId=null;joyActive=false;joyX=0;joyY=0}}}

function onMD(e){joyStartX=e.clientX;joyStartY=e.clientY;joyActive=true;joyX=0;joyY=0}
function onMM(e){if(!joyActive)return;
var dx=e.clientX-joyStartX,dy=e.clientY-joyStartY;
var d=Math.sqrt(dx*dx+dy*dy);var maxR=60;
if(d>maxR){dx=dx/d*maxR;dy=dy/d*maxR}
joyX=dx/maxR;joyY=dy/maxR}
function onMU(){joyActive=false;joyX=0;joyY=0}

// ============================================
// GAME LOOP
// ============================================
function tick(now){
if(phase!=="playing"){return}
var dt=Math.min((now-lastTime)/16.67,3);lastTime=now;

// Update my player
if(myP&&myAlive){
myP.vx+=joyX*ACCEL*dt;myP.vy+=joyY*ACCEL*dt;
var spd=Math.sqrt(myP.vx*myP.vx+myP.vy*myP.vy);
if(spd>MAX_SPEED){myP.vx=myP.vx/spd*MAX_SPEED;myP.vy=myP.vy/spd*MAX_SPEED}
myP.vx*=Math.pow(FRICTION,dt);myP.vy*=Math.pow(FRICTION,dt);
myP.x+=myP.vx*dt;myP.y+=myP.vy*dt;

// Collision with other players
for(var k in pls){if(k===ms)continue;var o=pls[k];if(!o.alive)continue;
var dx=o.x-myP.x,dy=o.y-myP.y;var d=dist(myP.x,myP.y,o.x,o.y);
var minD=PLAYER_R*2;
if(d<minD&&d>0.1){
var nx=dx/d,ny=dy/d;var ov=(minD-d)/2;
myP.x-=nx*ov;myP.y-=ny*ov;
var dvx=myP.vx-o.vx,dvy=myP.vy-o.vy;
var dot=dvx*nx+dvy*ny;
myP.vx-=dot*nx*PUSH_FORCE*0.5;myP.vy-=dot*ny*PUSH_FORCE*0.5}}

// Ball collision (host updates ball)
if(rl==="host"&&ball){
var bd=dist(myP.x,myP.y,ball.x,ball.y);
if(bd<PLAYER_R+BALL_R&&bd>0.1){
var bnx=(ball.x-myP.x)/bd,bny=(ball.y-myP.y)/bd;
var bov=(PLAYER_R+BALL_R-bd);
ball.x+=bnx*bov;ball.y+=bny*bov;
ball.vx+=bnx*BALL_PUSH+myP.vx*0.5;ball.vy+=bny*BALL_PUSH+myP.vy*0.5}}

// Check arena bounds
var cx=ARENA_W/2,cy=ARENA_H/2;
// Allow going through goal areas
var inGoalA=myP.x<50&&Math.abs(myP.y-ARENA_H/2)<GOAL_H/2;
var inGoalB=myP.x>ARENA_W-50&&Math.abs(myP.y-ARENA_H/2)<GOAL_H/2;
if(!inGoalA&&!inGoalB){
if(myP.x<PLAYER_R){myP.x=PLAYER_R;myP.vx*=-0.5}
if(myP.x>ARENA_W-PLAYER_R){myP.x=ARENA_W-PLAYER_R;myP.vx*=-0.5}
}
if(myP.y<PLAYER_R){myP.y=PLAYER_R;myP.vy*=-0.5}
if(myP.y>ARENA_H-PLAYER_R){myP.y=ARENA_H-PLAYER_R;myP.vy*=-0.5}

// Elimination check
if(myP.x<-PLAYER_R*3||myP.x>ARENA_W+PLAYER_R*3||myP.y<-PLAYER_R*3||myP.y>ARENA_H+PLAYER_R*3){
myP.alive=false;myAlive=false;
document.getElementById("specMsg").style.display="block";
toast("Elendin!","r")}}

// Host updates ball physics
if(rl==="host"&&ball){
ball.vx*=Math.pow(BALL_FRICTION,dt);ball.vy*=Math.pow(BALL_FRICTION,dt);
ball.x+=ball.vx*dt;ball.y+=ball.vy*dt;
// Ball-player collisions for all players
for(var k in pls){var o=pls[k];if(!o.alive||k===ms)continue;
var bd2=dist(o.x,o.y,ball.x,ball.y);
if(bd2<PLAYER_R+BALL_R&&bd2>0.1){
var bnx2=(ball.x-o.x)/bd2,bny2=(ball.y-o.y)/bd2;
ball.x=o.x+bnx2*(PLAYER_R+BALL_R);ball.y=o.y+bny2*(PLAYER_R+BALL_R);
ball.vx+=bnx2*BALL_PUSH*0.8;ball.vy+=bny2*BALL_PUSH*0.8}}
// Ball walls
if(ball.y<BALL_R){ball.y=BALL_R;ball.vy*=-0.8}
if(ball.y>ARENA_H-BALL_R){ball.y=ARENA_H-BALL_R;ball.vy*=-0.8}
// Ball - goal detection
var inGA=ball.x<10&&Math.abs(ball.y-ARENA_H/2)<GOAL_H/2;
var inGB=ball.x>ARENA_W-10&&Math.abs(ball.y-ARENA_H/2)<GOAL_H/2;
if(inGA){score.b++;toast("GOL! Takƒ±m B +1","g");resetBall()}
if(inGB){score.a++;toast("GOL! Takƒ±m A +1","g");resetBall()}
if(ball.x<-BALL_R*3||ball.x>ARENA_W+BALL_R*3){resetBall()}}

// Lerp other players
for(var k in pls){if(k===ms)continue;var o=pls[k];
o.x=lerp(o.x,o.tx,0.15*dt);o.y=lerp(o.y,o.ty,0.15*dt)}
// Lerp ball (non-host)
if(rl!=="host"&&ball){ball.x=lerp(ball.x,ball.tx,0.15*dt);ball.y=lerp(ball.y,ball.ty,0.15*dt)}

// HUD
uAlive();
document.getElementById("hudS").textContent=score.a+"-"+score.b;

// Render
render();
gameLoop=requestAnimationFrame(tick)}

function resetBall(){
if(ball){ball.x=ARENA_W/2;ball.y=ARENA_H/2;ball.vx=0;ball.vy=0;ball.tx=ball.x;ball.ty=ball.y}}

function uAlive(){var c=0;for(var k in pls)if(pls[k].alive)c++;
document.getElementById("hudA").textContent=c}

// ============================================
// RENDER
// ============================================
function render(){
var W=canvas.width,H=canvas.height;
ctx.clearRect(0,0,W,H);

// Camera follow my player
var target=myP||{x:ARENA_W/2,y:ARENA_H/2};
var tCamX=target.x-W/2;var tCamY=target.y-H/2;
camX=lerp(camX,tCamX,0.08);camY=lerp(camY,tCamY,0.08);

ctx.save();ctx.translate(-camX,-camY);

// Background
ctx.fillStyle="#060610";ctx.fillRect(-500,-500,ARENA_W+1000,ARENA_H+1000);

// Arena floor
var ag=ctx.createRadialGradient(ARENA_W/2,ARENA_H/2,0,ARENA_W/2,ARENA_H/2,ARENA_W/2);
ag.addColorStop(0,"#0e0e1e");ag.addColorStop(1,"#080812");
ctx.fillStyle=ag;ctx.fillRect(0,0,ARENA_W,ARENA_H);

// Grid
ctx.strokeStyle="#ffffff08";ctx.lineWidth=1;
for(var gx=0;gx<=ARENA_W;gx+=50){ctx.beginPath();ctx.moveTo(gx,0);ctx.lineTo(gx,ARENA_H);ctx.stroke()}
for(var gy=0;gy<=ARENA_H;gy+=50){ctx.beginPath();ctx.moveTo(0,gy);ctx.lineTo(ARENA_W,gy);ctx.stroke()}

// Arena border
ctx.strokeStyle="#0ff3";ctx.lineWidth=3;ctx.strokeRect(0,0,ARENA_W,ARENA_H);

// Goals
ctx.fillStyle="#0f04";ctx.fillRect(-20,ARENA_H/2-GOAL_H/2,40,GOAL_H);
ctx.strokeStyle="#0f0";ctx.lineWidth=2;ctx.strokeRect(-20,ARENA_H/2-GOAL_H/2,40,GOAL_H);
ctx.fillStyle="#f0f4";ctx.fillRect(ARENA_W-20,ARENA_H/2-GOAL_H/2,40,GOAL_H);
ctx.strokeStyle="#f0f";ctx.strokeRect(ARENA_W-20,ARENA_H/2-GOAL_H/2,40,GOAL_H);

// Center line
ctx.strokeStyle="#fff1";ctx.lineWidth=1;ctx.setLineDash([5,5]);
ctx.beginPath();ctx.moveTo(ARENA_W/2,0);ctx.lineTo(ARENA_W/2,ARENA_H);ctx.stroke();
ctx.beginPath();ctx.arc(ARENA_W/2,ARENA_H/2,60,0,Math.PI*2);ctx.stroke();
ctx.setLineDash([]);

// Ball
if(ball){
ctx.shadowColor="#ff0";ctx.shadowBlur=15;
ctx.fillStyle="#ff0";ctx.beginPath();ctx.arc(ball.x,ball.y,BALL_R,0,Math.PI*2);ctx.fill();
ctx.shadowBlur=0;
ctx.strokeStyle="#fff8";ctx.lineWidth=1.5;ctx.beginPath();ctx.arc(ball.x,ball.y,BALL_R,0,Math.PI*2);ctx.stroke();
// Ball highlight
ctx.fillStyle="rgba(255,255,255,0.3)";ctx.beginPath();ctx.arc(ball.x-3,ball.y-3,BALL_R*0.35,0,Math.PI*2);ctx.fill()}

// Players
for(var k in pls){var p=pls[k];if(!p.alive)continue;
var col=COLS[p.idx];var isMe=k===ms;

// Glow
ctx.shadowColor=col;ctx.shadowBlur=isMe?20:12;

// Body
var g=ctx.createRadialGradient(p.x-4,p.y-4,2,p.x,p.y,PLAYER_R);
g.addColorStop(0,"#fff3");g.addColorStop(1,col);
ctx.fillStyle=g;ctx.beginPath();ctx.arc(p.x,p.y,PLAYER_R,0,Math.PI*2);ctx.fill();

ctx.shadowBlur=0;

// Ring
ctx.strokeStyle=isMe?"#fff":"#fff4";ctx.lineWidth=isMe?2.5:1;
ctx.beginPath();ctx.arc(p.x,p.y,PLAYER_R,0,Math.PI*2);ctx.stroke();

// Team indicator
ctx.fillStyle=p.team==="a"?"#0f08":"#f0f8";
ctx.beginPath();ctx.arc(p.x,p.y,PLAYER_R*0.4,0,Math.PI*2);ctx.fill();

// Direction indicator (for me)
if(isMe&&joyActive){
var aLen=PLAYER_R+15;
ctx.strokeStyle="#fff6";ctx.lineWidth=2;
ctx.beginPath();ctx.moveTo(p.x,p.y);
ctx.lineTo(p.x+joyX*aLen,p.y+joyY*aLen);ctx.stroke()}

// Name
ctx.fillStyle=isMe?"#fff":"#aaa";ctx.font="bold 9px sans-serif";ctx.textAlign="center";
ctx.fillText(p.name,p.x,p.y-PLAYER_R-5);

// Team label
ctx.fillStyle=p.team==="a"?"#0f0":"#f0f";ctx.font="bold 7px sans-serif";
ctx.fillText(p.team==="a"?"A":"B",p.x,p.y+3)}

ctx.restore();

// Joystick UI overlay
if(joyActive){
ctx.fillStyle="#fff1";ctx.beginPath();ctx.arc(joyStartX,joyStartY,60,0,Math.PI*2);ctx.fill();
ctx.strokeStyle="#fff3";ctx.lineWidth=2;ctx.beginPath();ctx.arc(joyStartX,joyStartY,60,0,Math.PI*2);ctx.stroke();
ctx.fillStyle="#fff4";ctx.beginPath();ctx.arc(joyStartX+joyX*50,joyStartY+joyY*50,18,0,Math.PI*2);ctx.fill()}}

// ============================================
// SEND DATA TO FIREBASE
// ============================================
function startSendLoop(){
sSend();
sendT=setInterval(function(){
if(!room||!ms||!myP||phase!=="playing")return;
var u={};
u[ms+"/x"]=Math.round(myP.x*10)/10;
u[ms+"/y"]=Math.round(myP.y*10)/10;
u[ms+"/vx"]=Math.round(myP.vx*100)/100;
u[ms+"/vy"]=Math.round(myP.vy*100)/100;
u[ms+"/alive"]=myP.alive;
if(rl==="host"&&ball){
u["ball/x"]=Math.round(ball.x*10)/10;
u["ball/y"]=Math.round(ball.y*10)/10;
u["ball/vx"]=Math.round(ball.vx*100)/100;
u["ball/vy"]=Math.round(ball.vy*100)/100;
u["score"]=score}
fbPatch("games/"+room,u)},SEND_RATE)}

// ============================================
// POLL GAME STATE
// ============================================
function startPollGame(){
poll(function(d){
if(!d){toast("Arena kapandƒ±!","r");stopGame();return}
if(d.phase==="done"){showResult(d);return}
// Update other players
for(var i=0;i<MP;i++){var k="p"+i;var pd=d[k];
if(!pd)continue;
if(k===ms)continue;
if(!pls[k]){pls[k]={name:pd.name,x:pd.x,y:pd.y,tx:pd.x,ty:pd.y,vx:0,vy:0,alive:pd.alive!==false,team:pd.team||"a",idx:i}}
else{pls[k].tx=pd.x;pls[k].ty=pd.y;pls[k].alive=pd.alive!==false;pls[k].vx=pd.vx||0;pls[k].vy=pd.vy||0}}
// Update ball (non-host)
if(rl!=="host"&&d.ball){ball.tx=d.ball.x;ball.ty=d.ball.y;ball.vx=d.ball.vx||0;ball.vy=d.ball.vy||0}
// Score
if(d.score){score=d.score}

// Check win condition (host)
if(rl==="host"){
var alive=[];for(var k in pls)if(pls[k].alive)alive.push(k);
// If only one team alive or score limit
if(score.a>=5||score.b>=5){
var winner=score.a>=5?"Takƒ±m A":"Takƒ±m B";
fbPatch("games/"+room,{phase:"done",winner:winner})}}
})}

function stopGame(){
sP();sSend();if(gameLoop){cancelAnimationFrame(gameLoop);gameLoop=null}phase="menu"}

// ============================================
// RESULT
// ============================================
function showResult(d){
stopGame();
var w=d.winner||"?";
var myTeam=myP?myP.team:"a";
var isWin=(w==="Takƒ±m A"&&myTeam==="a")||(w==="Takƒ±m B"&&myTeam==="b");
document.getElementById("resIc").textContent=isWin?"üèÜ":"üíÄ";
document.getElementById("resTi").textContent=isWin?"KAZANDIN!":"Kaybettin!";
document.getElementById("resTi").style.color=isWin?"#0ff":"#f55";
document.getElementById("resSu").textContent="Kazanan: "+w+" | Skor: "+score.a+"-"+score.b;
document.getElementById("remBtn").style.display=rl==="host"?"block":"none";
document.getElementById("resOv").style.display="flex";
if(isWin)confetti()}

function rematch(){
if(!room)return;
document.getElementById("resOv").style.display="none";
fbGet("games/"+room,function(ok,d){
if(!ok||!d){toast("Arena yok!","r");clean();return}
var u={status:"playing",phase:"playing",score:{a:0,b:0},winner:null,
ball:{x:ARENA_W/2,y:ARENA_H/2,vx:0,vy:0}};
var ta=0,tb=0;
for(var i=0;i<MP;i++){var p=d["p"+i];if(p){
var team=p.team||"a";
if(team==="a"){u["p"+i+"/x"]=150+ta*60;u["p"+i+"/y"]=ARENA_H/2-100+ta*80;ta++}
else{u["p"+i+"/x"]=ARENA_W-150-tb*60;u["p"+i+"/y"]=ARENA_H/2-100+tb*80;tb++}
u["p"+i+"/vx"]=0;u["p"+i+"/vy"]=0;u["p"+i+"/alive"]=true}}
fbPatch("games/"+room,u,function(){
score={a:0,b:0};myAlive=true;phase="playing";
for(var k in pls){pls[k].alive=true}
if(myP)myP.alive=true;
document.getElementById("specMsg").style.display="none";
startSendLoop();startPollGame();
lastTime=performance.now();gameLoop=requestAnimationFrame(tick)})})}

function goMenu(){
document.getElementById("resOv").style.display="none";
if(room&&rl==="host")fbDel("games/"+room);clean();showMain()}

function confetti(){var cols=["#0ff","#f0f","#ff0","#0f0","#f80"];for(var i=0;i<50;i++){var p=document.createElement("div");p.style.cssText="position:fixed;z-index:300;pointer-events:none;left:"+Math.random()*100+"vw;top:-10px;background:"+cols[Math.floor(Math.random()*cols.length)]+";width:"+(4+Math.random()*6)+"px;height:"+(4+Math.random()*6)+"px;border-radius:"+(Math.random()>.5?"50%":"2px");document.body.appendChild(p);p.animate([{transform:"translateY(0) rotate(0)",opacity:1},{transform:"translateY("+window.innerHeight+"px) translateX("+(Math.random()-.5)*200+"px) rotate("+Math.random()*720+"deg)",opacity:0}],{duration:1200+Math.random()*1800,easing:"ease-out"}).onfinish=function(){this.effect.target.remove()}}}

// ============================================
// LEAVE
// ============================================
function exitLobby(){if(room)fbDel("games/"+room);clean();showMain()}
function exitGuest(){if(room&&ms)fbDel("games/"+room+"/"+ms);clean();showMain()}
function quitGame(){
if(room&&ms)fbPut("games/"+room+"/"+ms+"/alive",false);
if(room&&rl==="host")fbDel("games/"+room);
stopGame();clean();showMain();toast("Ayrƒ±ldƒ±n.","b")}

// ============================================
// INIT
// ============================================
testConn();
</script>
</body>
</html>
